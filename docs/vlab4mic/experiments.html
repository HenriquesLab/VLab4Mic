<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>vlab4mic.experiments API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../vlab4mic.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;vlab4mic</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#IN_COLAB">IN_COLAB</a>
            </li>
            <li>
                    <a class="class" href="#ExperimentParametrisation">ExperimentParametrisation</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ExperimentParametrisation.__init__">ExperimentParametrisation</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.experiment_id">experiment_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.structure_id">structure_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.structure_format">structure_format</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.configuration_path">configuration_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.structure_label">structure_label</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.fluorophore_id">fluorophore_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.coordinate_field_id">coordinate_field_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.selected_mods">selected_mods</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.imaging_modalities">imaging_modalities</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.probe_parameters">probe_parameters</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.structural_integrity_eps">structural_integrity_eps</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.sweep_pars">sweep_pars</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.objects_created">objects_created</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.output_directory">output_directory</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.example_structures">example_structures</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExperimentParametrisation.example_modalities">example_modalities</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.select_structure">select_structure</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.clear_structure">clear_structure</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.add_modality">add_modality</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.update_modality">update_modality</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.set_modality_acq">set_modality_acq</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.clear_modalities">clear_modalities</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.reset_to_defaults">reset_to_defaults</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.generators_status">generators_status</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.build">build</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.clear_labelled_structure">clear_labelled_structure</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.clear_virtual_sample">clear_virtual_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.create_example_experiment">create_example_experiment</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.clear_experiment">clear_experiment</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.run_simulation">run_simulation</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.remove_probes">remove_probes</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.add_probe">add_probe</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.add_fluorophore_parameters">add_fluorophore_parameters</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.set_virtualsample_params">set_virtualsample_params</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.use_image_for_positioning">use_image_for_positioning</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.current_settings">current_settings</a>
                        </li>
                        <li>
                                <a class="function" href="#ExperimentParametrisation.expand_virtual_sample">expand_virtual_sample</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#generate_virtual_sample">generate_virtual_sample</a>
            </li>
            <li>
                    <a class="function" href="#build_virtual_microscope">build_virtual_microscope</a>
            </li>
            <li>
                    <a class="function" href="#image_vsample">image_vsample</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../vlab4mic.html">vlab4mic</a><wbr>.experiments    </h1>

                
                        <input id="mod-experiments-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-experiments-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fields</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">vlab4mic</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.workflows</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a>    <span class="n">load_structure</span><span class="p">,</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a>    <span class="n">create_imaging_system</span><span class="p">,</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>    <span class="n">particle_from_structure</span><span class="p">,</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a>    <span class="n">field_from_particle</span><span class="p">,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>    <span class="n">generate_multi_imaging_modalities</span><span class="p">,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="p">)</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.generate</span><span class="w"> </span><span class="kn">import</span> <span class="n">coordinates_field</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.utils.data_format.structural_format</span><span class="w"> </span><span class="kn">import</span> <span class="n">label_builder_format</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.utils.data_format</span><span class="w"> </span><span class="kn">import</span> <span class="n">configuration_format</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">vlab4mic.utils.io.yaml_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_yaml</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">vlab4mic.utils.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">yaml_functions</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">io</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="n">IN_COLAB</span> <span class="o">=</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>    <span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;/content/vlab4mic_outputs&quot;</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="k">else</span><span class="p">:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>    <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;vlab4mic_outputs&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="nd">@dataclass</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ExperimentParametrisation</span><span class="p">:</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>    <span class="n">experiment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;vLab4mic_experiment&quot;</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>    <span class="n">structure_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1XI5&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>    <span class="n">structure_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CIF&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>    <span class="n">configuration_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>    <span class="n">structure_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>    <span class="n">fluorophore_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>    <span class="n">coordinate_field_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;square1x1um_randomised&quot;</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="n">selected_mods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="n">imaging_modalities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="n">probe_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="n">structural_integrity_eps</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="n">sweep_pars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="n">objects_created</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="n">output_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>    <span class="n">example_structures</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;3J3Y&quot;</span><span class="p">,</span> <span class="s2">&quot;7R5K&quot;</span><span class="p">,</span> <span class="s2">&quot;1XI5&quot;</span><span class="p">,</span> <span class="s2">&quot;8GMO&quot;</span><span class="p">]</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="n">example_modalities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Widefield&quot;</span><span class="p">,</span> <span class="s2">&quot;Confocal&quot;</span><span class="p">,</span> <span class="s2">&quot;AiryScan&quot;</span><span class="p">,</span> <span class="s2">&quot;STED&quot;</span><span class="p">,</span> <span class="s2">&quot;SMLM&quot;</span><span class="p">]</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>        <span class="n">pck_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">vlab4mic</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pck_dir</span><span class="p">,</span> <span class="s2">&quot;configs&quot;</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span> <span class="o">=</span> <span class="n">local_dir</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="c1"># keep track of objects created</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>            <span class="n">structure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>            <span class="n">particle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>            <span class="n">exported_coordinate_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>            <span class="n">coordinate_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>            <span class="n">imager</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>            <span class="n">output_reference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>        <span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="c1"># read information of local modalities configuration</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="n">modalities_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="s2">&quot;modalities&quot;</span><span class="p">)</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="n">modalities_names_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="n">modality_parameters</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_modalities</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="k">for</span> <span class="n">mods</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">modalities_dir</span><span class="p">):</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">mods</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>                <span class="ow">and</span> <span class="s2">&quot;_template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mods</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>            <span class="p">):</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>                <span class="n">modalities_names_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">mods</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">modalities_names_list</span><span class="p">:</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>            <span class="n">mod_info</span><span class="p">,</span> <span class="n">mod_configuration</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>                <span class="n">configuration_format</span><span class="o">.</span><span class="n">compile_modality_parameters</span><span class="p">(</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>                    <span class="n">mod</span><span class="p">,</span> <span class="n">local_dir</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>                <span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>            <span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>            <span class="n">modality_parameters</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_info</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config_modalities</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_configuration</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_names</span> <span class="o">=</span> <span class="n">modalities_names_list</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span> <span class="o">=</span> <span class="n">modality_parameters</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="n">probes_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="s2">&quot;probes&quot;</span><span class="p">)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="n">structure_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="s2">&quot;structures&quot;</span><span class="p">)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_models_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_global_probes_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_per_structure_names</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="k">for</span> <span class="n">p_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">probes_dir</span><span class="p">):</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">p_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>                <span class="ow">and</span> <span class="s2">&quot;_template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_file</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>            <span class="p">):</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>                <span class="n">label_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">probes_dir</span><span class="p">,</span> <span class="n">p_file</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>                <span class="n">label_parmeters</span> <span class="o">=</span> <span class="n">vlab4mic</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="n">label_config_path</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>                <span class="c1"># print(label_parmeters)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>                <span class="n">lablname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">p_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>                <span class="k">if</span> <span class="s2">&quot;Mock&quot;</span> <span class="ow">in</span> <span class="n">label_parmeters</span><span class="p">[</span><span class="s2">&quot;known_targets&quot;</span><span class="p">]:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_models_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lablname</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">lablname</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_parmeters</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>                <span class="k">elif</span> <span class="s2">&quot;Generic&quot;</span> <span class="ow">in</span> <span class="n">label_parmeters</span><span class="p">[</span><span class="s2">&quot;known_targets&quot;</span><span class="p">]:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_global_probes_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lablname</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">lablname</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_parmeters</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">lablname</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_parmeters</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>                    <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="n">label_parmeters</span><span class="p">[</span><span class="s2">&quot;known_targets&quot;</span><span class="p">]:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>                        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>                            <span class="n">struct</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>                            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_per_structure_names</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>                        <span class="p">):</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_per_structure_names</span><span class="p">[</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>                                <span class="n">struct</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>                            <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lablname</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_per_structure_names</span><span class="p">[</span><span class="n">struct</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>                                <span class="n">lablname</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>                            <span class="p">]</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">demo_structures</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="c1"># get available structure IDs</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structures_info_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>        <span class="n">structure_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;structures&quot;</span><span class="p">)</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="n">fluorophores_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;fluorophores&quot;</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fluorophores_dir</span><span class="p">):</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>                <span class="ow">and</span> <span class="s2">&quot;_template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>            <span class="p">):</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>                <span class="n">fluorophore_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophore_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fluorophores_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                <span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters_template</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fluorophores_dir</span><span class="p">,</span> <span class="s2">&quot;_template_.yaml&quot;</span><span class="p">)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="n">probes_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;probes&quot;</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="n">modalities_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;modalities&quot;</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">structure_dir</span><span class="p">):</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>                <span class="ow">and</span> <span class="s2">&quot;_template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="p">):</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>                <span class="n">structure_params</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">structure_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>                <span class="n">struct_id</span> <span class="o">=</span> <span class="n">structure_params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>                <span class="k">if</span> <span class="n">struct_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">example_structures</span><span class="p">:</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>                    <span class="n">strict_title</span> <span class="o">=</span> <span class="n">structure_params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>                    <span class="n">id_title</span> <span class="o">=</span> <span class="n">struct_id</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">strict_title</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">structures_info_list</span><span class="p">[</span><span class="n">id_title</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct_id</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">demo_structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_title</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_directories</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>            <span class="n">structure</span><span class="o">=</span><span class="n">structure_dir</span><span class="p">,</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            <span class="n">fluorophores</span><span class="o">=</span><span class="n">fluorophores_dir</span><span class="p">,</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="n">probes</span><span class="o">=</span><span class="n">probes_dir</span><span class="p">,</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>            <span class="n">modalities</span><span class="o">=</span><span class="n">modalities_dir</span><span class="p">,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>        <span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="n">param_settings_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config_directories</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">],</span> <span class="s2">&quot;parameter_settings.yaml&quot;</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param_settings</span> <span class="o">=</span> <span class="n">yaml_functions</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="n">param_settings_file</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create_example_experiment</span><span class="p">()</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modality_noise_images</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">select_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure_id</span><span class="o">=</span><span class="s2">&quot;1XI5&quot;</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">structure_path</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">        Select a molecular structure by its identifier and optionally build the structure module.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">        Parameters</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">        ----------</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">        :param structure_id : str, optional</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">            The identifier of the structure to select. Default is &quot;1XI5&quot;.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">        :param build : bool, optional</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">            If True, triggers the build process for the structure module. Default is True.</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">        Returns</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        -------</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        None</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>        <span class="k">if</span> <span class="n">structure_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="n">structure_path</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="n">structure_id</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_format</span> <span class="o">=</span> <span class="n">structure_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="n">structure_id</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="k">if</span> <span class="n">build</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">])</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">        Clear the current structure by resetting the structure ID and related parameters.</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">        This method sets the structure ID to None and resets the structure object if it exists.</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">        Returns</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">        -------</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">        None</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Structure cleared&quot;</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_modality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">modality_template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">        Add a new imaging modality to the experiment.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">        If the specified modality name exists in the local modalities, it copies the parameters from the local template.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">        Otherwise, it uses the &#39;Widefield&#39; modality parameters as a template to create a new modality.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">        Additional parameters for the modality can be specified via keyword arguments and will override the defaults.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">        Optionally, the modality output can be saved by setting `save` to True.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">        Parameters</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">        ----------</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="sd">            The name of the modality to add.</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">            If True, saves the modality output. Default is False.</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a><span class="sd">            Arbitrary keyword arguments to override or set specific modality parameters.</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">        Returns</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="sd">        -------</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">        None</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_names</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>            <span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>                <span class="sa">f</span><span class="s2">&quot;Modality </span><span class="si">{</span><span class="n">modality_name</span><span class="si">}</span><span class="s2"> not found in demo modalities. Using template to create new.&quot;</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="k">if</span> <span class="n">modality_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>                <span class="n">template_modality</span> <span class="o">=</span> <span class="n">modality_template</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                <span class="n">template_modality</span> <span class="o">=</span> <span class="s2">&quot;Widefield&quot;</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">template_modality</span><span class="si">}</span><span class="s2"> as template.&quot;</span><span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">template_modality</span><span class="p">]</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;modality&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modality_name</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modality_name</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>            <span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_modality</span><span class="p">(</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="n">modality_name</span><span class="p">,</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="n">pixelsize_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="n">lateral_resolution_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="n">axial_resolution_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>        <span class="n">psf_voxel_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="n">depth_of_field_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>    <span class="p">):</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        Update or remove an imaging modality&#39;s parameters.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">        This method allows updating specific parameters of an imaging modality, such as pixel size, lateral and axial resolution, and PSF voxel size.</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">        If `remove` is True, the modality is removed from the internal dictionaries.</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        Parameters</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">        ----------</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">            The name of the imaging modality to update or remove.</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">        :param pixelsize_nm : int, optional</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">            The new pixel size in nanometers. If provided, updates the detector pixel size.</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">        :param lateral_resolution_nm : int, optional</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">            The new lateral resolution in nanometers. If provided, updates the lateral standard deviations of the PSF.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">        :param axial_resolution_nm : int, optional</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="sd">            The new axial resolution in nanometers. If provided, updates the axial standard deviation of the PSF.</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">        :param psf_voxel_nm : int, optional</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">            The new PSF voxel size in nanometers. If provided, updates the PSF voxel size for all axes.</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a><span class="sd">        :param remove : bool, optional</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">            If True, removes the specified modality from the internal dictionaries. Default is False.</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">        Notes</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a><span class="sd">        -----</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="sd">        After updating any parameters, the imaging modality is reconfigured in the imager.</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>            <span class="n">changes</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>            <span class="k">if</span> <span class="n">pixelsize_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;detector&quot;</span><span class="p">][</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>                    <span class="s2">&quot;pixelsize&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixelsize_nm</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>            <span class="k">if</span> <span class="n">lateral_resolution_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>                <span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lateral_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>                <span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lateral_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="k">if</span> <span class="n">axial_resolution_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>                <span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">axial_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="k">if</span> <span class="n">psf_voxel_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                    <span class="s2">&quot;voxelsize&quot;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                <span class="p">]</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>            <span class="k">if</span> <span class="n">depth_of_field_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                <span class="n">depth_in_slices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                <span class="n">depth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">depth_of_field_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>                    <span class="s2">&quot;depth&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="n">depth</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>            <span class="k">if</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">set_imaging_modality</span><span class="p">(</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                <span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_modality_acq</span><span class="p">(</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>        <span class="n">modality_name</span><span class="p">,</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>        <span class="n">exp_time</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="n">noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>        <span class="n">nframes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>        <span class="n">channels</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="s2">&quot;ch0&quot;</span><span class="p">,</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>        <span class="p">],</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>    <span class="p">):</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">        Configure and set acquisition parameters for a specified imaging modality.</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">        Parameters</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        ----------</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">            The name of the imaging modality to configure.</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">        :param exp_time : float, optional</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">            Exposure time for the acquisition in seconds. Default is 0.001.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">        :param noise : bool, optional</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">            Whether to include noise in the acquisition. Default is True.</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">            Whether to save the acquired data. Default is False.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">        :param nframes : int, optional</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">            Number of frames to acquire. Default is 1.</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">        :param channels : list of str, optional</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">            List of channel names to use. Default is [&quot;ch0&quot;].</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">            Additional keyword arguments for modality-specific parameters.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">        Notes</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">        -----</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        If the specified modality is not available in `self.imaging_modalities`, a message is printed and no action is taken.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">        Acquisition parameters are formatted using `configuration_format.format_modality_acquisition_params` and stored in `self.selected_mods`.</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>                <span class="n">configuration_format</span><span class="o">.</span><span class="n">format_modality_acquisition_params</span><span class="p">(</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>                    <span class="n">exp_time</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nframes</span><span class="p">,</span> <span class="n">channels</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>                <span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>            <span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modality not selected&quot;</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_modalities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        Clear all selected imaging modalities and their acquisition parameters.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">        This method resets the `imaging_modalities` and `selected_mods` dictionaries to empty states,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        effectively removing all configured modalities from the experiment.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">        Returns</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        -------</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        None</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>        <span class="n">modality_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">modality_names</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_modality</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;imager&quot;</span><span class="p">):</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imager</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;imager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All modalities cleared&quot;</span><span class="p">)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_to_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;acquisitions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">        Reset acquisition parameters or other module settings to their default values.</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">        Parameters</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">        ----------</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">        :param module : str, optional</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">            The module to reset. Default is &quot;acquisitions&quot;.</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="sd">            Additional keyword arguments passed to the reset function.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">        Returns</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">        -------</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="sd">        None</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;acquisitions&quot;</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">        Build the structure object for the experiment.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="sd">        Parameters</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">        ----------</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="sd">            If True, store the structure in the experiment. Default is True.</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">        Returns</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">        -------</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">        None</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span><span class="p">:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="n">struct</span><span class="p">,</span> <span class="n">struct_param</span> <span class="o">=</span> <span class="n">load_structure</span><span class="p">(</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_format</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">struct</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="p">:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="n">struct</span><span class="p">,</span> <span class="n">struct_param</span> <span class="o">=</span> <span class="n">load_structure</span><span class="p">(</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">struct</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No structure ID&quot;</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lab_eff</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        Create a list with one dictionary with the setup info for creating a label.</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        Assumes there is only one label stored in the attribute &quot;structure_label&quot; and one in &quot;fluorophore_id&quot;.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">        Parameters</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">        ----------</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        :param lab_eff : float, optional</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">            Labelling efficiency. Default is 1.</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">            If True, keep the label. Default is False.</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">            Additional keyword arguments for label creation.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">        Returns</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">        -------</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">        list</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">            List of label dictionaries.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="n">labels_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="k">for</span> <span class="n">probe_name</span><span class="p">,</span> <span class="n">probe_params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>            <span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>                <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="p">[</span><span class="n">probe_name</span><span class="p">])</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                <span class="c1">#</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="k">return</span> <span class="n">labels_list</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_if_structural_integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">        Check if structural_integrity parameters are set and update the use_structural_integrity flag.</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">        Returns</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">        -------</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">        None</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;structural_integrity&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps1&quot;</span><span class="p">]</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps2&quot;</span><span class="p">]</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="p">):</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_particle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lab_eff</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">structural_integrity_build</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">        Build the particle object for the experiment, optionally adding structural_integritys.</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="sd">        Parameters</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">        ----------</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">        :param lab_eff : float, optional</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">            Labelling efficiency. Default is 1.0.</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        :param structural_integrity_build : float or None, optional</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">            Defect parameter to use. Default is None.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">            If True, store the particle in the experiment. Default is False.</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">        Returns</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">        -------</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        particle or None</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">            The particle object if created, else None.</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_structural_integrity</span><span class="p">()</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>            <span class="n">labels_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_label</span><span class="p">(</span><span class="n">lab_eff</span><span class="o">=</span><span class="n">lab_eff</span><span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>                <span class="n">particle</span><span class="p">,</span> <span class="n">label_params_list</span> <span class="o">=</span> <span class="n">particle_from_structure</span><span class="p">(</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">labels_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                <span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                    <span class="k">if</span> <span class="n">structural_integrity_build</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                        <span class="n">structural_integrity</span> <span class="o">=</span> <span class="n">structural_integrity_build</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>                        <span class="n">structural_integrity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;structural_integrity&quot;</span><span class="p">]</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                    <span class="n">particle</span><span class="o">.</span><span class="n">add_structural_integrity</span><span class="p">(</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>                        <span class="n">eps1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps1&quot;</span><span class="p">],</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                        <span class="n">xmer_neigh_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps2&quot;</span><span class="p">],</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>                        <span class="n">integrity</span><span class="o">=</span><span class="n">structural_integrity</span><span class="p">,</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                    <span class="p">)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                    <span class="n">particle</span><span class="o">.</span><span class="n">add_structural_integrity</span><span class="p">(</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                        <span class="n">integrity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>                    <span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">particle</span> <span class="o">=</span> <span class="n">particle</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;particle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                <span class="k">return</span> <span class="n">particle</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_coordinate_field</span><span class="p">(</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="n">use_self_particle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>        <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>        <span class="n">coordinate_field_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>    <span class="p">):</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">        Build the coordinate field for the experiment, either from the current particle or as a minimal field.</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">        Parameters</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">        ----------</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">        :param use_self_particle : bool, optional</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">            If True, use the current particle to build the field. Default is True.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">            If True, store the field in the experiment. Default is False.</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">        :param coordinate_field_path : str or None, optional</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">            Path to a coordinate field file. Default is None.</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="sd">            Additional keyword arguments for field creation.</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">        Returns</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">        -------</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="sd">        exported_field or None</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">            The exported field if created, else None.</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="k">if</span> <span class="n">use_self_particle</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;particle&quot;</span><span class="p">):</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating field from existing particle&quot;</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>            <span class="n">exported_field</span><span class="p">,</span> <span class="n">fieldobject</span> <span class="o">=</span> <span class="n">field_from_particle</span><span class="p">(</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">particle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>            <span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                <span class="n">fieldobject</span><span class="o">.</span><span class="n">molecules_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>            <span class="p">)</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="n">exported_field</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;exported_coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span> <span class="o">=</span> <span class="n">fieldobject</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>            <span class="k">return</span> <span class="n">exported_field</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>            <span class="c1"># create minimal field</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="n">fieldobject</span> <span class="o">=</span> <span class="n">coordinates_field</span><span class="o">.</span><span class="n">create_min_field</span><span class="p">(</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>            <span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="n">exported_field</span> <span class="o">=</span> <span class="n">fieldobject</span><span class="o">.</span><span class="n">export_field</span><span class="p">()</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="n">exported_field</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;exported_coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span> <span class="o">=</span> <span class="n">fieldobject</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_imager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_local_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prints</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="sd">        Build the imager object for the experiment using the selected imaging modalities.</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a><span class="sd">        Parameters</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">        ----------</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">        :param use_local_field : bool, optional</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">            If True, use the local exported coordinate field. Default is False.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">        :param prints : bool, optional</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">            If True, print status messages. Default is True.</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">        Returns</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">        -------</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">        None</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>            <span class="c1"># print(f&quot;Using selected mods: {self.imaging_modalities.keys()}&quot;)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>            <span class="n">mods_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>            <span class="k">if</span> <span class="n">use_local_field</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                <span class="s2">&quot;exported_coordinate_field&quot;</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="p">):</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span> <span class="n">modality_parameters</span> <span class="o">=</span> <span class="n">create_imaging_system</span><span class="p">(</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>                    <span class="n">exported_field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span><span class="p">,</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>                    <span class="n">modalities_id_list</span><span class="o">=</span><span class="n">mods_list</span><span class="p">,</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                    <span class="n">mod_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">,</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>                    <span class="n">config_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                    <span class="n">fluorophore_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">,</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                <span class="p">)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                <span class="k">if</span> <span class="n">prints</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                        <span class="s2">&quot;Local field missing or unused. Creating imager without particles&quot;</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                    <span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span> <span class="n">modality_parameters</span> <span class="o">=</span> <span class="n">create_imaging_system</span><span class="p">(</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                    <span class="n">modalities_id_list</span><span class="o">=</span><span class="n">mods_list</span><span class="p">,</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                    <span class="n">mod_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">,</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>                    <span class="n">config_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                    <span class="n">fluorophore_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>                <span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="c1"># update the base acquisition parameters to consider all channels</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>            <span class="n">imager_channels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="n">anymod</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>            <span class="k">for</span> <span class="n">chann</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">modalities</span><span class="p">[</span><span class="n">anymod</span><span class="p">][</span><span class="s2">&quot;filters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                <span class="n">imager_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chann</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>            <span class="n">nchannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imager_channels</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reset_to_defaults</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s2">&quot;acquisitions&quot;</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">imager_channels</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;imager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imager</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No modalities&quot;</span><span class="p">)</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_modality_noise_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">modality_noise_images</span><span class="p">[</span><span class="n">modality_name</span><span class="p">],</span> <span class="n">_beads</span><span class="p">,</span> <span class="n">_im_noiseless</span><span class="p">,</span> <span class="n">_b_noiseless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">generate_imaging</span><span class="p">(</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>                <span class="n">modality</span><span class="o">=</span><span class="n">modality_name</span><span class="p">,</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>                <span class="n">noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exp_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generators_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator_name</span><span class="p">):</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="sd">        Return the status of the specified generator.</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="sd">        Parameters</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">        ----------</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a><span class="sd">        :param generator_name : str</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">            The name of the generator whose status is to be retrieved.</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        Returns</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">        -------</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">        object</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">            The status or object associated with the given generator name from the objects_created dictionary.</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">        Raises</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">        ------</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">        KeyError</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">            If the specified generator_name does not exist in objects_created.</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="n">generator_name</span><span class="p">]</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>        <span class="n">use_locals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="n">modules</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>            <span class="s2">&quot;all&quot;</span><span class="p">,</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="p">],</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>    <span class="p">):</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">        Build various simulation objects based on the specified modules.</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">        Parameters</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">        ----------</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">        :param use_locals : bool, optional</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">            Determines whether to use local variables or attributes when building objects. Default is True.</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">        :param modules : list, optional</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">            List of module names to build. If &quot;all&quot; is included, builds all available modules: &quot;structure&quot;, &quot;particle&quot;, &quot;coordinate_field&quot;, and &quot;imager&quot;. Default is [&quot;all&quot;].</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">            Additional keyword arguments for building modules.</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">        Notes</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">        -----</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">        The order of building is: structure, particle, coordinate_field, imager.</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building objects&quot;</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>            <span class="n">build_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                <span class="s2">&quot;structure&quot;</span><span class="p">,</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                <span class="s2">&quot;particle&quot;</span><span class="p">,</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                <span class="s2">&quot;coordinate_field&quot;</span><span class="p">,</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                <span class="s2">&quot;imager&quot;</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>            <span class="p">]</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>            <span class="n">build_list</span> <span class="o">=</span> <span class="n">modules</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="k">if</span> <span class="s2">&quot;structure&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_structure</span><span class="p">()</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>        <span class="k">if</span> <span class="s2">&quot;particle&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_particle</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="n">use_locals</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="k">if</span> <span class="s2">&quot;coordinate_field&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_coordinate_field</span><span class="p">(</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                <span class="n">use_self_particle</span><span class="o">=</span><span class="n">use_locals</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="n">use_locals</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>        <span class="k">if</span> <span class="s2">&quot;imager&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_imager</span><span class="p">(</span><span class="n">use_local_field</span><span class="o">=</span><span class="n">use_locals</span><span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_reference</span><span class="p">(</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ref_acq_pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modality_wise</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>    <span class="p">):</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">        Calculate a reference image of the virtual sample by using the ideal parameters for each of the parameters to sweep.</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">        Requires the dictionary of the params2sweep. If modality_wise is True (default), a reference is calculated for each modality with that modality&#39;s parameters. Otherwise, it will use the Reference modality configuration to generate an idealised image as reference.</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">        Parameters</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">        ----------</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">        :param write : bool, optional</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">            Whether to write the reference image to disk. Default is False.</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">            If True, store the reference in the experiment. Default is False.</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">        :param ref_acq_pars : dict or None, optional</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">            Acquisition parameters for the reference. Default is None.</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">        :param modality_wise : bool, optional</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">            If True, calculate reference for each modality. Default is False.</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">        Returns</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">        -------</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">        tuple</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">            (_reference, _reference_parameters)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="n">reference_pars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>        <span class="n">output_name</span> <span class="o">=</span> <span class="s2">&quot;REFERENCE_&quot;</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="c1"># get ideal parameters for virtual sample</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_settings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_pars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>            <span class="n">reference_pars</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_settings</span><span class="p">[</span><span class="s2">&quot;ideal&quot;</span><span class="p">]</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">reference_pars</span><span class="p">)</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>        <span class="c1"># generate particle</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>        <span class="n">tmp_particle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_particle</span><span class="p">(</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>            <span class="n">lab_eff</span><span class="o">=</span><span class="n">reference_pars</span><span class="p">[</span><span class="s2">&quot;labelling_efficiency&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="p">)</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="c1"># use particle to create new field</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="n">tmp_exported_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_coordinate_field</span><span class="p">()</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="c1"># create ideal image modality</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="k">if</span> <span class="n">modality_wise</span><span class="p">:</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">import_field</span><span class="p">(</span><span class="o">**</span><span class="n">tmp_exported_field</span><span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="n">_reference</span> <span class="o">=</span> <span class="n">generate_multi_imaging_modalities</span><span class="p">(</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="n">image_generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                <span class="n">experiment_name</span><span class="o">=</span><span class="n">output_name</span><span class="p">,</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                <span class="n">savingdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>                <span class="n">write</span><span class="o">=</span><span class="n">write</span><span class="p">,</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="n">reference_imager</span><span class="p">,</span> <span class="n">ref_modality_parameters</span> <span class="o">=</span> <span class="n">create_imaging_system</span><span class="p">(</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                <span class="n">modalities_id_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">],</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                <span class="n">config_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                <span class="n">fluorophore_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="p">)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="n">reference_imager</span><span class="o">.</span><span class="n">import_field</span><span class="p">(</span><span class="o">**</span><span class="n">tmp_exported_field</span><span class="p">)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="c1"># make a copy</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="n">_reference</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="n">_reference_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>            <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                <span class="n">_reference_iteration</span> <span class="o">=</span> <span class="n">generate_multi_imaging_modalities</span><span class="p">(</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                    <span class="n">image_generator</span><span class="o">=</span><span class="n">reference_imager</span><span class="p">,</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                    <span class="n">experiment_name</span><span class="o">=</span><span class="n">output_name</span><span class="p">,</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                    <span class="n">acquisition_param</span><span class="o">=</span><span class="n">ref_acq_pars</span><span class="p">,</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                    <span class="n">savingdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                    <span class="n">write</span><span class="o">=</span><span class="n">write</span><span class="p">,</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                <span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>                <span class="n">_reference</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_reference_iteration</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                <span class="n">imager_scale</span> <span class="o">=</span> <span class="n">reference_imager</span><span class="o">.</span><span class="n">roi_params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                <span class="n">scalefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                    <span class="n">imager_scale</span> <span class="o">/</span> <span class="mf">1e-9</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                <span class="p">)</span>  <span class="c1"># resulting pixel size in nanometers</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                <span class="n">_reference_parameters</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                    <span class="n">ref_pixelsize</span><span class="o">=</span><span class="n">reference_imager</span><span class="o">.</span><span class="n">modalities</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">][</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                        <span class="s2">&quot;detector&quot;</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                    <span class="p">][</span><span class="s2">&quot;pixelsize&quot;</span><span class="p">]</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                    <span class="o">*</span> <span class="n">scalefactor</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                <span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">experiment_reference</span> <span class="o">=</span> <span class="n">_reference</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;output_reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="k">return</span> <span class="n">_reference</span><span class="p">,</span> <span class="n">_reference_parameters</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_labelled_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">remove_probes</span><span class="p">()</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_virtual_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">):</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;exported_coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Virtual sample cleared&quot;</span><span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_example_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">capture_output</span><span class="p">()</span> <span class="k">as</span> <span class="n">captured</span><span class="p">:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">select_structure</span><span class="p">(</span><span class="s2">&quot;1XI5&quot;</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_probe</span><span class="p">()</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_virtualsample_params</span><span class="p">()</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">example_modalities</span><span class="p">:</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">modality_name</span><span class="p">)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Experiment created with default parameters&quot;</span><span class="p">)</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a><span class="sd">        Clear the current experiment by resetting all parameters and objects.</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_structure</span><span class="p">()</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_labelled_structure</span><span class="p">()</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_virtual_sample</span><span class="p">()</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_modalities</span><span class="p">()</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">(</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vlab4mic_experiment&quot;</span><span class="p">,</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="n">acq_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>        <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>    <span class="p">):</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">        Run a simulation for the specified imaging modality or all modalities.</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">        Parameters</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">        ----------</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="sd">        :param name : str, optional</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">            Name of the experiment or simulation. Default is &quot;vlab4mic_experiment&quot;.</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">        :param acq_params : dict or None, optional</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">            Acquisition parameters for the simulation. If None and modality is &quot;All&quot;, uses self.selected_mods.</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">            Whether to save the simulation output to disk. Default is False.</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">        :param modality : str, optional</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">            The imaging modality to simulate. If &quot;All&quot;, simulates all available modalities. Default is &quot;All&quot;.</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a><span class="sd">            Additional keyword arguments passed to the imaging generator.</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="sd">        Returns</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="sd">        -------</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">        dict or None</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">            Simulation output as a dictionary mapping modality names to results. Returns None if the imager could not be created.</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;imager&quot;</span><span class="p">):</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="s2">&quot;imager&quot;</span><span class="p">)</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Imager not created. Cannot run simulation.&quot;</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="k">if</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span><span class="p">:</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulating all modalities&quot;</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>            <span class="k">if</span> <span class="n">acq_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>                <span class="n">acq_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">:</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span> <span class="o">=</span> <span class="n">generate_multi_imaging_modalities</span><span class="p">(</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                <span class="n">image_generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                <span class="n">experiment_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                <span class="n">savingdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                <span class="n">write</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                <span class="n">acquisition_param</span><span class="o">=</span><span class="n">acq_params</span><span class="p">,</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="p">)</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">simulation_output</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="k">return</span> <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulating: </span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>            <span class="n">acq_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>            <span class="n">timeseries_noise</span><span class="p">,</span> <span class="n">beads_noise</span><span class="p">,</span> <span class="n">timeseries_noiseless</span><span class="p">,</span> <span class="n">beads_noiseless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">generate_imaging</span><span class="p">(</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                <span class="n">modality</span><span class="o">=</span><span class="n">modality</span><span class="p">,</span> <span class="o">**</span><span class="n">acq_p</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>            <span class="p">)</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>            <span class="n">simulation_output</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>            <span class="n">simulation_output_noiseless</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>            <span class="n">simulation_output</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries_noise</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>            <span class="n">simulation_output_noiseless</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries_noiseless</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>            <span class="k">return</span> <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_probes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a><span class="sd">        Remove all probe-related parameters and update the internal state accordingly.</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">        This method clears the probe parameters, updates the probes, and resets the</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">        particle and structure objects if their respective generators are active.</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="sd">        It also clears any labels associated with the structure.</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">        Returns</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        -------</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        None</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_probes</span><span class="p">()</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;particle&quot;</span><span class="p">):</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">particle</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;particle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Labelled structure cleared&quot;</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">_clear_labels</span><span class="p">()</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Probes removed from experiment&quot;</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_probe</span><span class="p">(</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span><span class="p">,</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="n">probe_target_option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>        <span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>        <span class="n">probe_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        <span class="n">probe_steric_hindrance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>        <span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">probe_wobble_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        <span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="n">as_primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="n">peptide_motif</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        <span class="n">fluorophore_parameters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>    <span class="p">):</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        Add a probe configuration to the experiment.</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        This method loads a probe configuration from a YAML file, updates its parameters based on the provided arguments,</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">        and stores it in the experiment&#39;s probe parameters. It supports customization of probe properties such as target type,</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">        fluorophore, model, conjugation details, and more.</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">        Parameters</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">        ----------</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">        :param probe_name : str, optional</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">            Name of the probe. Default is &quot;NHS_ester&quot;.</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">        :param probe_target_type : str, optional</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">            Type of the probe target (e.g., &quot;Primary&quot;, &quot;Secondary&quot;).</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">        :param probe_target_value : str, optional</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">            Value or identifier of the probe target.</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">        :param probe_target_option : str, optional</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">            Additional option for the probe target, used for secondary epitopes.</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">        :param probe_distance_to_epitope : float, optional</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">            Distance from the probe to the epitope.</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">        :param probe_model : str, optional</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">            List of model identifiers for the probe.</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">        :param probe_fluorophore : str, optional</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">            Identifier for the fluorophore. Default is &quot;AF647&quot;.</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">        :param probe_steric_hindrance : Any, optional</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">            Steric hindrance value or configuration.</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">        :param probe_paratope : str, optional</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">            Paratope identifier or information.</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">        :param probe_conjugation_target_info : Any, optional</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">            Information about the conjugation target.</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">        :param probe_DoL : float, optional</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">            Efficiency of the probe conjugation.</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">        :param probe_seconday_epitope : Any, optional</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">            Information about a secondary epitope target.</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">        :param probe_wobbling : bool, optional</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">            Whether to enable probe wobbling. Default is False.</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">        :param labelling_efficiency : float, optional</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">            Efficiency of probe labelling. Default is 1.0.</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">        :param as_primary : bool, optional</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">            Whether to treat the probe as a primary linker. Default is False.</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">            Additional keyword arguments for future extensions.</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">        Raises</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">        ------</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">        FileNotFoundError</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="sd">            If the probe configuration YAML file does not exist.</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">        KeyError</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="sd">            If required keys are missing in the configuration or probe parameters.</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">        Notes</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">        -----</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">        Updates the ``probe_parameters`` attribute with the new or modified probe configuration and calls the :meth:`_update_probes` method to refresh internal probe state.</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="n">probe_configuration</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">probe_template</span><span class="p">]</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="p">)</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>        <span class="k">if</span> <span class="n">probe_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>            <span class="n">probe_name</span> <span class="o">=</span> <span class="n">probe_template</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_name</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="k">if</span> <span class="n">peptide_motif</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>            <span class="n">protein_name</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_peptide_motif</span><span class="p">(</span><span class="o">**</span><span class="n">peptide_motif</span><span class="p">)</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            <span class="p">)</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>                <span class="n">probe_target_type</span> <span class="o">=</span> <span class="s2">&quot;Sequence&quot;</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                <span class="n">probe_target_value</span> <span class="o">=</span> <span class="n">sequence</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="k">if</span> <span class="n">probe_target_type</span> <span class="ow">and</span> <span class="n">probe_target_value</span><span class="p">:</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>                <span class="nb">type</span><span class="o">=</span><span class="n">probe_target_type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">probe_target_value</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>            <span class="p">)</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>            <span class="k">if</span> <span class="n">probe_target_type</span> <span class="o">==</span> <span class="s2">&quot;Primary&quot;</span> <span class="ow">and</span> <span class="n">probe_target_option</span><span class="p">:</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                <span class="k">if</span> <span class="n">probe_target_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                        <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">probe_target_option</span><span class="si">}</span><span class="s2"> as epitope on </span><span class="si">{</span><span class="n">probe_target_value</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>                    <span class="p">)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="p">[</span><span class="n">probe_target_value</span><span class="p">][</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>                        <span class="s2">&quot;probe_seconday_epitope&quot;</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">probe_target_option</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>            <span class="ow">or</span> <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="p">):</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>                <span class="s2">&quot;No target info provided for the probe. Retrieving random sequence.&quot;</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="p">)</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>            <span class="c1"># probe has no target info</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>            <span class="c1"># a random target will be used</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>            <span class="n">protein_name</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_peptide_motif</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="s2">&quot;cterminal&quot;</span><span class="p">)</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="p">)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Sequence&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sequence</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="p">)</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>            <span class="c1"># probe_configuration[&quot;target&quot;][&quot;type&quot;] = &quot;Sequence&quot;</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>            <span class="c1"># probe_configuration[&quot;target&quot;][&quot;value&quot;] = sequence</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="k">if</span> <span class="n">probe_distance_to_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;distance_to_epitope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>                <span class="n">probe_distance_to_epitope</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>            <span class="p">)</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="k">if</span> <span class="n">probe_fluorophore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;fluorophore_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_fluorophore</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="k">if</span> <span class="n">fluorophore_parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_fluorophore_parameters</span><span class="p">(</span><span class="n">fluorophoe_id</span><span class="o">=</span><span class="n">probe_fluorophore</span><span class="p">,</span> <span class="o">**</span><span class="n">fluorophore_parameters</span><span class="p">)</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>        <span class="k">if</span> <span class="n">labelling_efficiency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;labelling_efficiency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelling_efficiency</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="k">if</span> <span class="n">probe_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;model_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_model</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="k">if</span> <span class="n">probe_paratope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;paratope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_paratope</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="k">if</span> <span class="n">probe_conjugation_target_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>                <span class="n">probe_conjugation_target_info</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="p">)</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>                <span class="n">probe_conjugation_target_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>            <span class="p">)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>                <span class="n">probe_conjugation_target_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            <span class="p">)</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="k">if</span> <span class="n">probe_DoL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting probe DoL to: </span><span class="si">{</span><span class="n">probe_DoL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;DoL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                <span class="n">probe_DoL</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>            <span class="p">)</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Add_probe: Using default probe DoL from template&quot;</span><span class="p">)</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>        <span class="k">if</span> <span class="n">probe_seconday_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;epitope_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_seconday_epitope</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="k">if</span> <span class="n">probe_wobble_theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;enable_wobble&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;wobble_theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_wobble_theta</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="k">if</span> <span class="n">as_primary</span><span class="p">:</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding probe as primary linker&quot;</span><span class="p">)</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;as_linker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;as_linker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="k">if</span> <span class="n">probe_steric_hindrance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;distance_between_epitope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>                <span class="n">probe_steric_hindrance</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>            <span class="p">)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;binding&quot;</span><span class="p">][</span><span class="s2">&quot;distance&quot;</span><span class="p">][</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>                <span class="s2">&quot;between_targets&quot;</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">probe_steric_hindrance</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="p">[</span><span class="n">probe_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_configuration</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_probes</span><span class="p">()</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_probes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">        Update the structure_label attribute based on the current probe_parameters.</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">        Returns</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">        -------</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="sd">        None</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_fluorophore_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                                <span class="n">fluorophoe_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>                                <span class="n">emission</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>                                <span class="n">blinking_rates</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="k">if</span> <span class="n">fluorophoe_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;kon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;koff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;kbleach&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;initial_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;photons_per_blink&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>        <span class="k">if</span> <span class="n">emission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">emission</span><span class="p">)</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        <span class="k">if</span> <span class="n">blinking_rates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blinking_rates</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_virtualsample_params</span><span class="p">(</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>        <span class="n">virtualsample_template</span><span class="o">=</span><span class="s2">&quot;square1x1um_randomised&quot;</span><span class="p">,</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>        <span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>        <span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        <span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>        <span class="n">random_orientations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="n">random_placing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>        <span class="n">minimal_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>        <span class="n">update_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="n">random_rotations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>        <span class="n">rotation_angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>        <span class="n">xy_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>        <span class="n">xz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>        <span class="n">yz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>        <span class="n">axial_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>    <span class="p">):</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">        Set parameters for the virtual sample by loading a template configuration and optionally overriding specific values.</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">        Parameters</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">        ----------</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">        :param virtualsample_template : str, optional</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">            Name of the virtual sample template YAML file (without extension) to load. Default is &quot;square1x1um_randomised&quot;.</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">        :param sample_dimensions : list of int, optional</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">            Dimensions of the sample to override the template value.</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">        :param number_of_particles : int, optional</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="sd">            Number of particles to override the template value.</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">        :param particle_positions : list, optional</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a><span class="sd">            List of particle positions to override the template value.</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="sd">        :param random_orientations : bool, optional</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">            Whether to randomize particle orientations, overrides the template value.</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">        :param random_placing : bool, optional</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">            Whether to randomize particle placement, overrides the template value.</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">            Additional keyword arguments (currently unused).</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">        Returns</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">        -------</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">        None</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="c1"># load default configuration for virtual sample</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>            <span class="n">particle_minimal_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span><span class="o">.</span><span class="n">molecules_params</span><span class="p">[</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>                <span class="s2">&quot;minimal_distance&quot;</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>            <span class="p">]</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>            <span class="n">particle_minimal_distance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>        <span class="k">if</span> <span class="n">update_mode</span><span class="p">:</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>            <span class="k">pass</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="n">virtual_sample_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                <span class="s2">&quot;virtualsample&quot;</span><span class="p">,</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>                <span class="n">virtualsample_template</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>            <span class="p">)</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">virtual_sample_template</span><span class="p">)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>        <span class="k">if</span> <span class="n">sample_dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;sample_dimensions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_dimensions</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        <span class="k">if</span> <span class="n">number_of_particles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;number_of_particles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_of_particles</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="k">if</span> <span class="n">particle_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;relative_positions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_positions</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>        <span class="k">if</span> <span class="n">random_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_orientations</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="k">if</span> <span class="n">random_placing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_placing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_placing</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="k">if</span> <span class="n">minimal_distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minimal_distance</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>                <span class="n">particle_minimal_distance</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>            <span class="p">)</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_rotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_rotations</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="k">if</span> <span class="n">rotation_angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;rotation_angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_angles</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>        <span class="k">if</span> <span class="n">xy_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;xy_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_orientations</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="k">if</span> <span class="n">xz_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;xz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz_orientations</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>        <span class="k">if</span> <span class="n">yz_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;yz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz_orientations</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="k">if</span> <span class="n">axial_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;axial_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axial_offset</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">use_image_for_positioning</span><span class="p">(</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>        <span class="n">img</span><span class="p">,</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;localmaxima&quot;</span><span class="p">,</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>        <span class="n">background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        <span class="n">pixelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>        <span class="n">min_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>    <span class="p">):</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a><span class="sd">        Generate and set relative positions for a virtual sample based on features detected in an input image.</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a><span class="sd">        This method processes the provided image to extract feature coordinates using the specified detection mode</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a><span class="sd">        and parameters. The resulting positions are stored in `self.virtualsample_params[&quot;relative_positions&quot;]`,</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a><span class="sd">        and the sample&#39;s physical dimensions are updated accordingly. The method then triggers the build process</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a><span class="sd">        for the &#39;coordinate_field&#39; and &#39;imager&#39; modules.</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a><span class="sd">        Parameters</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a><span class="sd">        ----------</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a><span class="sd">        :param img : array-like</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a><span class="sd">            The input image (as a NumPy array or compatible format) to be analyzed for feature detection.</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a><span class="sd">        :param mode : str, optional</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a><span class="sd">            The feature detection mode to use (e.g., &quot;localmaxima&quot;). Default is &quot;localmaxima&quot;.</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a><span class="sd">        :param sigma : float or None, optional</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a><span class="sd">            Standard deviation for Gaussian smoothing. If None, no smoothing is applied.</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a><span class="sd">        :param background : float or None, optional</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a><span class="sd">            Background intensity to subtract from the image. If None, no subtraction.</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a><span class="sd">        :param threshold : float or None, optional</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a><span class="sd">            Minimum intensity threshold for feature detection. If None, uses default.</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a><span class="sd">        :param pixelsize : float or None, optional</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">            Pixel size of the input image. If None, uses default.</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">        :param min_distance : float or None, optional</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a><span class="sd">            Minimum distance between detected features. If None, uses default.</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">        :param **kwargs</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">            Additional keyword arguments passed to the feature detection function.</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">        Returns</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">        -------</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">        None</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">        Notes</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">        -----</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">        Updates `self.virtualsample_params` with new relative positions and sample dimensions. Calls `self.build()` for the specified modules.</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="n">xyz_relative</span><span class="p">,</span> <span class="n">image_physical_size</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>            <span class="n">coordinates_field</span><span class="o">.</span><span class="n">gen_positions_from_image</span><span class="p">(</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>                <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>                <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>                <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">,</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>                <span class="n">min_distance</span><span class="o">=</span><span class="n">min_distance</span><span class="p">,</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>            <span class="p">)</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>        <span class="p">)</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_virtualsample_params</span><span class="p">(</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>            <span class="n">sample_dimensions</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>                <span class="n">image_physical_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>                <span class="n">image_physical_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>                <span class="mi">100</span><span class="p">,</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>            <span class="p">],</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>            <span class="n">particle_positions</span><span class="o">=</span><span class="n">xyz_relative</span><span class="p">,</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>            <span class="n">number_of_particles</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_relative</span><span class="p">),</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>            <span class="n">random_orientations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>            <span class="n">random_placing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>            <span class="n">minimal_distance</span><span class="o">=</span><span class="n">min_distance</span><span class="p">,</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>        <span class="p">)</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="c1"># self.virtualsample_params[&quot;relative_positions&quot;] = xyz_relative</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>        <span class="c1"># self.virtualsample_params[&quot;sample_dimensions&quot;] = [</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>        <span class="c1">#    image_physical_size[0],</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>        <span class="c1">#    image_physical_size[1],</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="c1">#    100,</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>        <span class="c1"># ]</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">,</span> <span class="s2">&quot;imager&quot;</span><span class="p">])</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">current_settings</span><span class="p">(</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">,</span> <span class="n">modalities_acq_params</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>    <span class="p">):</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="sd">        Print the current settings of the experiment, including structure, particle, coordinate field, and imaging modalities.</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a><span class="sd">    Returns</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="sd">    -------</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">    None</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>        <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Current settings of the experiment:&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Structure ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Probes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Virtual sample: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;Imaging Modalities: &quot;</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>        <span class="k">for</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">acqparams</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">modality_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>            <span class="k">if</span> <span class="n">modalities_acq_params</span><span class="p">:</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>                <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">acqparams</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="n">newline</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">as_string</span><span class="p">:</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="k">return</span> <span class="n">string</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expand_virtual_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>        <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span><span class="o">.</span><span class="n">expand_isotropically</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;imager&quot;</span><span class="p">,])</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_virtual_sample</span><span class="p">(</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>    <span class="n">structure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1XI5&quot;</span><span class="p">,</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>    <span class="n">structure_is_path</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>    <span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span><span class="p">,</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>    <span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>    <span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>    <span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>    <span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>    <span class="n">probe_model</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>    <span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>    <span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>    <span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>    <span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>    <span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>    <span class="n">probe_wobble_theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>    <span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>    <span class="n">structural_integrity_small_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>    <span class="n">structural_integrity_large_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>    <span class="n">structural_integrity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>    <span class="n">virtual_sample_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;square1x1um_randomised&quot;</span><span class="p">,</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>    <span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>    <span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>    <span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>    <span class="n">random_orientations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>    <span class="n">xy_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>    <span class="n">xz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>    <span class="n">yz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>    <span class="n">axial_offset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>    <span class="n">random_placing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>    <span class="n">random_rotations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>    <span class="n">rotation_angles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>    <span class="n">expansion_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>    <span class="n">clear_probes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>    <span class="n">clear_experiment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>    <span class="c1"># secondary</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    <span class="n">primary_probe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>    <span class="n">secondary_probe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>    <span class="n">probe_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="p">):</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a><span class="sd">    Create a virtual sample from a structure model.</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a><span class="sd">    Parameters</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="sd">    ----------</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a><span class="sd">    :param structure : str, optional</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a><span class="sd">        4-letter ID of PDB/CIF model. Default is &quot;1XI5&quot;.</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a><span class="sd">    :param structure_is_path : logical</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a><span class="sd">        Use structure value as absolute path for the PDB/CIF file.</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a><span class="sd">    :param probe_name : str, optional</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="sd">        Name ID of probe configuration file (filename).</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a><span class="sd">    :param probe_target_type : str, optional</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a><span class="sd">        Options: &quot;Sequence&quot;, &quot;Atom_residue&quot;, or &quot;Primary&quot;.</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a><span class="sd">    :param probe_target_value : str or dict, optional</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a><span class="sd">        For target type &quot;Sequence&quot; or &quot;Primary&quot;, a string. For &quot;Atom_residue&quot;, a dictionary with keys &quot;Atom&quot; and &quot;Residue&quot;.</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a><span class="sd">    :param probe_distance_to_epitope : float, optional</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a><span class="sd">        Minimal distance set from epitope and probe paratope.</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a><span class="sd">    :param probe_model : list of str, optional</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a><span class="sd">        4-letter ID(s) of PDB/CIF model(s).</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a><span class="sd">    :param probe_fluorophore : str, optional</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="sd">        Fluorophore name (e.g., &quot;AF647&quot;). Default is &quot;AF647&quot;.</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a><span class="sd">    :param probe_paratope : str, optional</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a><span class="sd">        Sequence of the paratope site for when probe includes a model.</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a><span class="sd">    :param probe_conjugation_target_info : Any, optional</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a><span class="sd">        Information about the probe conjugation target.</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a><span class="sd">    :param probe_DoL : float, optional</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a><span class="sd">        Efficiency of conjugation of emitters.</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a><span class="sd">    :param probe_seconday_epitope : str, optional</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="sd">        Sequence within probe model to be used as epitope for a secondary.</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a><span class="sd">    :param probe_wobbling : bool, optional</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a><span class="sd">        Enable probe wobbling. Default is False.</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a><span class="sd">    :param labelling_efficiency : float, optional</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a><span class="sd">        Labelling efficiency of probe. Default is 1.0.</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a><span class="sd">    :param structural_integrity_small_cluster : float, optional</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a><span class="sd">        In , distance used to group epitopes into multimers.</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a><span class="sd">    :param structural_integrity_large_cluster : float, optional</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a><span class="sd">        In , distance within multimers to consider neighbors.</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="sd">    :param structural_integrity : float, optional</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a><span class="sd">        Fraction of structural_integrity to model.</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a><span class="sd">    :param virtual_sample_template : str, optional</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a><span class="sd">        Name of the configuration file for template. Default is &quot;square1x1um_randomised&quot;.</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a><span class="sd">    :param sample_dimensions : list of float, optional</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a><span class="sd">        In nanometers, define the X, Y, and Z sizes of the field.</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="sd">    :param number_of_particles : int, optional</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">        Number of independent copies of a particle to create and distribute.</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a><span class="sd">    :param particle_positions : list of np.array, optional</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">        Relative positions of particles in the field.</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a><span class="sd">    :param random_orientations : bool, optional</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">        If True, each particle will be randomly assigned a new orientation. Default is False.</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a><span class="sd">    :param random_placing : bool, optional</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="sd">        Define if position in field is random or the center of field. Default is False.</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">    :param clear_probes : bool, optional</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">        If True, default parameters will be cleared. Default is False.</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a><span class="sd">    :param **kwargs</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a><span class="sd">        Additional keyword arguments.</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a><span class="sd">    Returns</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a><span class="sd">    -------</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a><span class="sd">    tuple</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a><span class="sd">        - dict: The virtual sample as exported format. This can be used as input for the `image_vsample` method.</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">        - ExperimentParametrisation: The experiment containing all modules that were generated to build the virtual sample, and the virtual sample module itself. This experiment can be further used and tweaked for subsequent analysis or branching workflows.</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>    <span class="n">myexperiment</span> <span class="o">=</span> <span class="n">ExperimentParametrisation</span><span class="p">()</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>    <span class="k">if</span> <span class="n">clear_experiment</span><span class="p">:</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">clear_experiment</span><span class="p">()</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>    <span class="c1"># select structure</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>    <span class="k">if</span> <span class="n">structure_is_path</span><span class="p">:</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selecting structure from path: </span><span class="si">{</span><span class="n">structure</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">select_structure</span><span class="p">(</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>            <span class="n">structure_id</span><span class="o">=</span><span class="n">structure</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>            <span class="n">structure_path</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>            <span class="n">build</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>        <span class="p">)</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selecting structure from ID:&quot;</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">select_structure</span><span class="p">(</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>            <span class="n">structure_id</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> 
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>            <span class="n">structure_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="n">build</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        <span class="p">)</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>    <span class="c1"># load default configuration for probe</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">primary_probe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">secondary_probe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding primary and secondary probes&quot;</span><span class="p">)</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">add_probe</span><span class="p">(</span><span class="n">as_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">primary_probe</span><span class="p">)</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">add_probe</span><span class="p">(</span><span class="n">as_primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">secondary_probe</span><span class="p">)</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>    <span class="k">elif</span> <span class="n">probe_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="k">for</span> <span class="n">probe</span> <span class="ow">in</span> <span class="n">probe_list</span><span class="p">:</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding probe: </span><span class="si">{</span><span class="n">probe</span><span class="p">[</span><span class="s1">&#39;probe_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>            <span class="n">myexperiment</span><span class="o">.</span><span class="n">add_probe</span><span class="p">(</span><span class="o">**</span><span class="n">probe</span><span class="p">)</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">clear_probes</span><span class="p">:</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">probe_template</span><span class="p">)</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>            <span class="n">probe_configuration_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>                <span class="n">myexperiment</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;probes&quot;</span><span class="p">,</span> <span class="n">probe_template</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>            <span class="p">)</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>            <span class="n">probe_configuration</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">probe_configuration_file</span><span class="p">)</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_template</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>            <span class="k">if</span> <span class="n">probe_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>                <span class="n">probe_name</span> <span class="o">=</span> <span class="n">probe_template</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_name</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>            <span class="k">if</span> <span class="n">probe_target_type</span> <span class="ow">and</span> <span class="n">probe_target_value</span><span class="p">:</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">probe_target_type</span><span class="p">,</span> <span class="n">probe_target_value</span><span class="p">)</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_target_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_target_type</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_target_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_target_value</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>            <span class="k">if</span> <span class="n">probe_distance_to_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;distance_to_epitope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>                    <span class="n">probe_distance_to_epitope</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>                <span class="p">)</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>            <span class="k">if</span> <span class="n">probe_fluorophore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;fluorophore_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_fluorophore</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>            <span class="k">if</span> <span class="n">labelling_efficiency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;labelling_efficiency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelling_efficiency</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>            <span class="k">if</span> <span class="n">probe_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;model_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_model</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>            <span class="k">if</span> <span class="n">probe_paratope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;paratope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_paratope</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>            <span class="k">if</span> <span class="n">probe_conjugation_target_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>                    <span class="n">probe_conjugation_target_info</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>                <span class="p">)</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>            <span class="k">if</span> <span class="n">probe_DoL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_DoL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>                    <span class="n">probe_DoL</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>                <span class="p">)</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>            <span class="k">if</span> <span class="n">probe_seconday_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;epitope_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_seconday_epitope</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>            <span class="k">if</span> <span class="n">probe_wobble_theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_wobble_theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_wobble_theta</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>            <span class="n">myexperiment</span><span class="o">.</span><span class="n">add_probe</span><span class="p">(</span><span class="o">**</span><span class="n">probe_configuration</span><span class="p">)</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>    <span class="c1"># load default configuration for virtual sample</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>    <span class="n">virtual_sample_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        <span class="s2">&quot;virtualsample&quot;</span><span class="p">,</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>        <span class="n">virtual_sample_template</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>    <span class="p">)</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>    <span class="n">vsample_configuration</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">virtual_sample_template</span><span class="p">)</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>    <span class="c1">#myexperiment.configuration_path</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>    <span class="k">if</span> <span class="n">structural_integrity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">structural_integrity_large_cluster</span> <span class="ow">and</span> <span class="n">structural_integrity_small_cluster</span><span class="p">:</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structural_integrity_small_cluster</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structural_integrity_large_cluster</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structural_integrity</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>    <span class="k">if</span> <span class="n">sample_dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;sample_dimensions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_dimensions</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>    <span class="k">if</span> <span class="n">number_of_particles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;number_of_particles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_of_particles</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>    <span class="k">if</span> <span class="n">particle_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;relative_positions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_positions</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>    <span class="k">if</span> <span class="n">random_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;random_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_orientations</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>    <span class="k">if</span> <span class="n">random_placing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;random_placing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_placing</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>    <span class="k">if</span> <span class="n">random_rotations</span><span class="p">:</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;random_rotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_rotations</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;rotation_angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_angles</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;xy_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_orientations</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;xz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz_orientations</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;yz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz_orientations</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;axial_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axial_offset</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>    <span class="n">myexperiment</span><span class="o">.</span><span class="n">virtualsample_params</span> <span class="o">=</span> <span class="n">vsample_configuration</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>    <span class="n">myexperiment</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>                <span class="s2">&quot;particle&quot;</span><span class="p">,</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>                <span class="s2">&quot;coordinate_field&quot;</span><span class="p">,</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>                <span class="s2">&quot;imager&quot;</span><span class="p">],</span> <span class="n">use_locals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>    <span class="k">if</span> <span class="n">expansion_factor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">expand_virtual_sample</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="n">expansion_factor</span><span class="p">)</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>    <span class="c1"># myexperiment.coordinate_field_id = virtual_sample</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>    <span class="k">return</span> <span class="n">myexperiment</span><span class="o">.</span><span class="n">exported_coordinate_field</span><span class="p">,</span> <span class="n">myexperiment</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a><span class="k">def</span><span class="w"> </span><span class="nf">build_virtual_microscope</span><span class="p">(</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>    <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;STED&quot;</span><span class="p">,</span> <span class="n">multimodal</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a><span class="p">):</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a><span class="sd">    Initialise a virtual microscope for single or multimodal imaging.</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a><span class="sd">    Parameters</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a><span class="sd">    ----------</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a><span class="sd">    :param modality : str, optional</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a><span class="sd">        Modality name. Default is &quot;STED&quot;.</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a><span class="sd">    :param multimodal : list of str, optional</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a><span class="sd">        List of modality names. Overrides the `modality` parameter if provided.</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a><span class="sd">    :param experiment : ExperimentParametrisation, optional</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a><span class="sd">        An Experiment object. If None, a new one is created.</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a><span class="sd">    :param **kwargs</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a><span class="sd">        Additional arguments passed to `add_modality`.</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="sd">    Returns</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a><span class="sd">    -------</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="sd">    tuple</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a><span class="sd">        - Imager: The virtual microscope with the specified modality models. Contains a default sample.</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a><span class="sd">        - ExperimentParametrisation: The experiment containing the virtual microscope. All other modules are not initialised. This experiment can be further used and tweaked for subsequent analysis or branching workflows.</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>    <span class="k">if</span> <span class="n">experiment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="n">experiment</span> <span class="o">=</span> <span class="n">ExperimentParametrisation</span><span class="p">()</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>    <span class="k">if</span> <span class="n">multimodal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">multimodal</span><span class="p">:</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="n">experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>        <span class="n">experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">modality</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>    <span class="k">if</span> <span class="s2">&quot;use_local_field&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>        <span class="n">experiment</span><span class="o">.</span><span class="n">_build_imager</span><span class="p">(</span><span class="n">use_local_field</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;use_local_field&quot;</span><span class="p">])</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>        <span class="n">experiment</span><span class="o">.</span><span class="n">_build_imager</span><span class="p">()</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>    <span class="k">return</span> <span class="n">experiment</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span> <span class="n">experiment</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a><span class="k">def</span><span class="w"> </span><span class="nf">image_vsample</span><span class="p">(</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>    <span class="n">vsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>    <span class="n">modality</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;STED&quot;</span><span class="p">,</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>    <span class="n">multimodal</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>    <span class="n">run_simulation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>    <span class="n">structure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1XI5&quot;</span><span class="p">,</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>    <span class="n">structure_is_path</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>    <span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span><span class="p">,</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>    <span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>    <span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>    <span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>    <span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>    <span class="n">probe_model</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>    <span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>    <span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>    <span class="n">probe_conjugation_target_info</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>    <span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>    <span class="n">probe_seconday_epitope</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>    <span class="n">probe_wobble_theta</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>    <span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>    <span class="n">structural_integrity_small_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>    <span class="n">structural_integrity_large_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>    <span class="n">structural_integrity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>    <span class="n">virtual_sample_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;square1x1um_randomised&quot;</span><span class="p">,</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>    <span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>    <span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>    <span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>    <span class="n">random_orientations</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>    <span class="n">xy_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>    <span class="n">xz_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>    <span class="n">yz_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>    <span class="n">axial_offset</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>    <span class="n">random_placing</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>    <span class="n">random_rotations</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>    <span class="n">rotation_angles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>    <span class="n">expansion_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>    <span class="n">clear_probes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>    <span class="n">clear_experiment</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>    <span class="n">primary_probe</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>    <span class="n">secondary_probe</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>    <span class="n">probe_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>    <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a><span class="p">):</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a><span class="sd">    Generate imaging simulations of the specified virtual sample and imaging modalities.</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a><span class="sd">    This function can either:</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a><span class="sd">    1. Take an existing virtual sample (as a dictionary) and wrap it in a new experiment, adding the specified imaging modalities.</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="sd">    2. Or, generate a new virtual sample and experiment from scratch using the provided parameters (matching those of `generate_virtual_sample`).</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a><span class="sd">    Parameters</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="sd">    ----------</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a><span class="sd">    :param vsample : dict, optional</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a><span class="sd">        Dictionary specifying sample parameters. Corresponds to Experiment attribute &quot;exported_coordinate_field&quot;. If None, a new sample is generated.</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a><span class="sd">    :param modality : str, optional</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a><span class="sd">        Modality name to use for imaging. Default is &quot;STED&quot;.</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a><span class="sd">    :param multimodal : list of str, optional</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a><span class="sd">        List of modality names. If provided, overrides the `modality` parameter and adds all listed modalities.</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a><span class="sd">    :param run_simulation : bool, optional</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a><span class="sd">        If True, generates image simulation for each modality set. Default is True.</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a><span class="sd">    </span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a><span class="sd">    ### Parameters for virtual sample generation (see `generate_virtual_sample` for details):</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a><span class="sd">    </span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a><span class="sd">    :param structure : str, optional</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a><span class="sd">        4-letter ID of PDB/CIF model. Default is &quot;1XI5&quot;.</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a><span class="sd">    :param structure_is_path : bool, optional</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a><span class="sd">        Use structure value as absolute path for the PDB/CIF file.</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a><span class="sd">    :param probe_template : str, optional</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a><span class="sd">        Name of probe configuration file (filename). Default is &quot;NHS_ester&quot;.</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a><span class="sd">    :param probe_name : str, optional</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a><span class="sd">        Name for the probe configuration.</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a><span class="sd">    :param probe_target_type : str, optional</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a><span class="sd">        Options: &quot;Sequence&quot;, &quot;Atom_residue&quot;, or &quot;Primary&quot;.</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a><span class="sd">    :param probe_target_value : str or dict, optional</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a><span class="sd">        For target type &quot;Sequence&quot; or &quot;Primary&quot;, a string. For &quot;Atom_residue&quot;, a dictionary with keys &quot;Atom&quot; and &quot;Residue&quot;.</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a><span class="sd">    :param probe_distance_to_epitope : float, optional</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a><span class="sd">        Minimal distance set from epitope and probe paratope.</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a><span class="sd">    :param probe_model : list, optional</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a><span class="sd">        4-letter ID(s) of PDB/CIF model(s).</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a><span class="sd">    :param probe_fluorophore : str, optional</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a><span class="sd">        Fluorophore name (e.g., &quot;AF647&quot;). Default is &quot;AF647&quot;.</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a><span class="sd">    :param probe_paratope : str, optional</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a><span class="sd">        Sequence of the paratope site for when probe includes a model.</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a><span class="sd">    :param probe_conjugation_target_info : any, optional</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a><span class="sd">        Information about the probe conjugation target.</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a><span class="sd">    :param probe_DoL : float, optional</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a><span class="sd">        Efficiency of conjugation of emitters.</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a><span class="sd">    :param probe_seconday_epitope : str, optional</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a><span class="sd">        Sequence within probe model to be used as epitope for a secondary.</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a><span class="sd">    :param probe_wobble_theta : any, optional</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a><span class="sd">        Enable probe wobbling.</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a><span class="sd">    :param labelling_efficiency : float, optional</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a><span class="sd">        Labelling efficiency of probe. Default is 1.0.</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a><span class="sd">    :param structural_integrity_small_cluster : float, optional</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a><span class="sd">        In , distance used to group epitopes into multimers.</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a><span class="sd">    :param structural_integrity_large_cluster : float, optional</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a><span class="sd">        In , distance within multimers to consider neighbors.</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a><span class="sd">    :param structural_integrity : float, optional</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a><span class="sd">        Fraction of structural_integrity to model.</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="sd">    :param virtual_sample_template : str, optional</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a><span class="sd">        Name of the configuration file for template. Default is &quot;square1x1um_randomised&quot;.</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a><span class="sd">    :param sample_dimensions : list, optional</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a><span class="sd">        In nanometers, define the X, Y, and Z sizes of the field.</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a><span class="sd">    :param number_of_particles : int, optional</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a><span class="sd">        Number of independent copies of a particle to create and distribute.</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a><span class="sd">    :param particle_positions : list, optional</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a><span class="sd">        Relative positions of particles in the field.</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a><span class="sd">    :param random_orientations : bool, optional</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a><span class="sd">        If True, each particle will be randomly assigned a new orientation. Default is False.</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a><span class="sd">    :param xy_orientations, xz_orientations, yz_orientations : any, optional</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a><span class="sd">        Orientation parameters for the sample.</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a><span class="sd">    :param axial_offset : any, optional</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a><span class="sd">        Axial offset for the sample.</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a><span class="sd">    :param random_placing : bool, optional</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a><span class="sd">        Define if position in field is random or the center of field. Default is False.</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a><span class="sd">    :param random_rotations : bool, optional</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="sd">        If True, apply random rotations to particles. Default is False.</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a><span class="sd">    :param rotation_angles : any, optional</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a><span class="sd">        Rotation angles for the sample.</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a><span class="sd">    :param clear_probes : bool, optional</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a><span class="sd">        If True, default probe parameters will be cleared. Default is False.</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a><span class="sd">    :param clear_experiment : bool, optional</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a><span class="sd">        If True, clear the experiment before generating a new sample. Default is False.</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a><span class="sd">    :param primary_probe, secondary_probe : any, optional</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a><span class="sd">        Dictionaries for primary and secondary probe configuration.</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a><span class="sd">    Returns</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a><span class="sd">    -------</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="sd">    tuple</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="sd">        - dict: Image simulations (per modality).</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">        - dict: Noiseless image simulations (per modality).</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="sd">        - ExperimentParametrisation: The experiment object containing all modules and configuration.</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>    <span class="k">if</span> <span class="n">vsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>        <span class="n">vsample</span><span class="p">,</span> <span class="n">sample_experiment</span> <span class="o">=</span> <span class="n">generate_virtual_sample</span><span class="p">(</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>            <span class="n">structure_is_path</span><span class="o">=</span><span class="n">structure_is_path</span><span class="p">,</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>            <span class="n">probe_template</span><span class="o">=</span><span class="n">probe_template</span><span class="p">,</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>            <span class="n">probe_name</span><span class="o">=</span><span class="n">probe_name</span><span class="p">,</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>            <span class="n">probe_target_type</span><span class="o">=</span><span class="n">probe_target_type</span><span class="p">,</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>            <span class="n">probe_target_value</span><span class="o">=</span><span class="n">probe_target_value</span><span class="p">,</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>            <span class="n">probe_distance_to_epitope</span><span class="o">=</span><span class="n">probe_distance_to_epitope</span><span class="p">,</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>            <span class="n">probe_model</span><span class="o">=</span><span class="n">probe_model</span><span class="p">,</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>            <span class="n">probe_fluorophore</span><span class="o">=</span><span class="n">probe_fluorophore</span><span class="p">,</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>            <span class="n">probe_paratope</span><span class="o">=</span><span class="n">probe_paratope</span><span class="p">,</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>            <span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="n">probe_conjugation_target_info</span><span class="p">,</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>            <span class="n">probe_DoL</span><span class="o">=</span><span class="n">probe_DoL</span><span class="p">,</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>            <span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="n">probe_seconday_epitope</span><span class="p">,</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>            <span class="n">probe_wobble_theta</span><span class="o">=</span><span class="n">probe_wobble_theta</span><span class="p">,</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>            <span class="n">labelling_efficiency</span><span class="o">=</span><span class="n">labelling_efficiency</span><span class="p">,</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>            <span class="n">structural_integrity_small_cluster</span><span class="o">=</span><span class="n">structural_integrity_small_cluster</span><span class="p">,</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>            <span class="n">structural_integrity_large_cluster</span><span class="o">=</span><span class="n">structural_integrity_large_cluster</span><span class="p">,</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>            <span class="n">structural_integrity</span><span class="o">=</span><span class="n">structural_integrity</span><span class="p">,</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>            <span class="n">virtual_sample_template</span><span class="o">=</span><span class="n">virtual_sample_template</span><span class="p">,</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>            <span class="n">sample_dimensions</span><span class="o">=</span><span class="n">sample_dimensions</span><span class="p">,</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>            <span class="n">number_of_particles</span><span class="o">=</span><span class="n">number_of_particles</span><span class="p">,</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>            <span class="n">particle_positions</span><span class="o">=</span><span class="n">particle_positions</span><span class="p">,</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>            <span class="n">random_orientations</span><span class="o">=</span><span class="n">random_orientations</span><span class="p">,</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>            <span class="n">xy_orientations</span><span class="o">=</span><span class="n">xy_orientations</span><span class="p">,</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>            <span class="n">xz_orientations</span><span class="o">=</span><span class="n">xz_orientations</span><span class="p">,</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>            <span class="n">yz_orientations</span><span class="o">=</span><span class="n">yz_orientations</span><span class="p">,</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>            <span class="n">axial_offset</span><span class="o">=</span><span class="n">axial_offset</span><span class="p">,</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>            <span class="n">random_placing</span><span class="o">=</span><span class="n">random_placing</span><span class="p">,</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>            <span class="n">random_rotations</span><span class="o">=</span><span class="n">random_rotations</span><span class="p">,</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>            <span class="n">rotation_angles</span><span class="o">=</span><span class="n">rotation_angles</span><span class="p">,</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>            <span class="n">clear_probes</span><span class="o">=</span><span class="n">clear_probes</span><span class="p">,</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>            <span class="n">clear_experiment</span><span class="o">=</span><span class="n">clear_experiment</span><span class="p">,</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>            <span class="n">primary_probe</span><span class="o">=</span><span class="n">primary_probe</span><span class="p">,</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>            <span class="n">secondary_probe</span><span class="o">=</span><span class="n">secondary_probe</span><span class="p">,</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>            <span class="n">probe_list</span><span class="o">=</span><span class="n">probe_list</span><span class="p">,</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>            <span class="n">expansion_factor</span><span class="o">=</span><span class="n">expansion_factor</span><span class="p">,</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>        <span class="p">)</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>        <span class="n">sample_experiment</span><span class="o">.</span><span class="n">clear_modalities</span><span class="p">()</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>        <span class="k">if</span> <span class="n">multimodal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>            <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">multimodal</span><span class="p">:</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>                    <span class="n">mod_template</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="s2">&quot;modality_template&quot;</span><span class="p">]</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding modality: </span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">mod_template</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>                    <span class="n">sample_experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">modality_template</span><span class="o">=</span><span class="n">mod_template</span><span class="p">)</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>                    <span class="n">sample_experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>            <span class="n">sample_experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">modality</span><span class="p">)</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>        <span class="n">sample_experiment</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>            <span class="n">modules</span><span class="o">=</span><span class="p">[</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>                <span class="s2">&quot;imager&quot;</span><span class="p">,</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>            <span class="p">]</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>        <span class="p">)</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">sample_experiment</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>            <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>                <span class="n">sample_experiment</span><span class="o">.</span><span class="n">update_modality</span><span class="p">(</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>                    <span class="n">modality_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>                <span class="p">)</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>                <span class="n">sample_experiment</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>                    <span class="n">modality_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>                <span class="p">)</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>        <span class="c1"># need to create an experiment for it</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>        <span class="k">if</span> <span class="n">multimodal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>            <span class="n">vmicroscope</span><span class="p">,</span> <span class="n">sample_experiment</span> <span class="o">=</span> <span class="n">build_virtual_microscope</span><span class="p">(</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>                <span class="n">multimodal</span><span class="o">=</span><span class="n">multimodal</span><span class="p">,</span> <span class="n">use_local_field</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>            <span class="p">)</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>            <span class="n">vmicroscope</span><span class="p">,</span> <span class="n">sample_experiment</span> <span class="o">=</span> <span class="n">build_virtual_microscope</span><span class="p">(</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>                <span class="n">modality</span><span class="o">=</span><span class="n">modality</span><span class="p">,</span> <span class="n">use_local_field</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>            <span class="p">)</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">sample_experiment</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>            <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>                <span class="n">sample_experiment</span><span class="o">.</span><span class="n">update_modality</span><span class="p">(</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>                    <span class="n">modality_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>                <span class="p">)</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>                <span class="n">sample_experiment</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>                    <span class="n">modality_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>                <span class="p">)</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>        <span class="n">sample_experiment</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">import_field</span><span class="p">(</span><span class="o">**</span><span class="n">vsample</span><span class="p">)</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>    <span class="n">imaging_output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>    <span class="n">imaging_output_noiseless</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>    <span class="k">if</span> <span class="n">run_simulation</span><span class="p">:</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>        <span class="n">imaging_output</span><span class="p">,</span> <span class="n">imaging_output_noiseless</span> <span class="o">=</span> <span class="n">sample_experiment</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>    <span class="k">return</span> <span class="n">imaging_output</span><span class="p">,</span> <span class="n">imaging_output_noiseless</span><span class="p">,</span> <span class="n">sample_experiment</span>
</span></pre></div>


            </section>
                <section id="IN_COLAB">
                    <div class="attr variable">
            <span class="name">IN_COLAB</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#IN_COLAB"></a>
    
    

                </section>
                <section id="ExperimentParametrisation">
                            <input id="ExperimentParametrisation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">ExperimentParametrisation</span>:

                <label class="view-source-button" for="ExperimentParametrisation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation-37"><a href="#ExperimentParametrisation-37"><span class="linenos">  37</span></a><span class="nd">@dataclass</span>
</span><span id="ExperimentParametrisation-38"><a href="#ExperimentParametrisation-38"><span class="linenos">  38</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ExperimentParametrisation</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-39"><a href="#ExperimentParametrisation-39"><span class="linenos">  39</span></a>    <span class="n">experiment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;vLab4mic_experiment&quot;</span>
</span><span id="ExperimentParametrisation-40"><a href="#ExperimentParametrisation-40"><span class="linenos">  40</span></a>    <span class="n">structure_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1XI5&quot;</span>
</span><span id="ExperimentParametrisation-41"><a href="#ExperimentParametrisation-41"><span class="linenos">  41</span></a>    <span class="n">structure_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CIF&quot;</span>
</span><span id="ExperimentParametrisation-42"><a href="#ExperimentParametrisation-42"><span class="linenos">  42</span></a>    <span class="n">configuration_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="ExperimentParametrisation-43"><a href="#ExperimentParametrisation-43"><span class="linenos">  43</span></a>    <span class="n">structure_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span>
</span><span id="ExperimentParametrisation-44"><a href="#ExperimentParametrisation-44"><span class="linenos">  44</span></a>    <span class="n">fluorophore_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span>
</span><span id="ExperimentParametrisation-45"><a href="#ExperimentParametrisation-45"><span class="linenos">  45</span></a>    <span class="n">coordinate_field_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;square1x1um_randomised&quot;</span>
</span><span id="ExperimentParametrisation-46"><a href="#ExperimentParametrisation-46"><span class="linenos">  46</span></a>    <span class="n">selected_mods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-47"><a href="#ExperimentParametrisation-47"><span class="linenos">  47</span></a>    <span class="n">imaging_modalities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-48"><a href="#ExperimentParametrisation-48"><span class="linenos">  48</span></a>    <span class="n">probe_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-49"><a href="#ExperimentParametrisation-49"><span class="linenos">  49</span></a>    <span class="n">structural_integrity_eps</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-50"><a href="#ExperimentParametrisation-50"><span class="linenos">  50</span></a>    <span class="n">sweep_pars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-51"><a href="#ExperimentParametrisation-51"><span class="linenos">  51</span></a>    <span class="n">objects_created</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-52"><a href="#ExperimentParametrisation-52"><span class="linenos">  52</span></a>    <span class="n">output_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-53"><a href="#ExperimentParametrisation-53"><span class="linenos">  53</span></a>    <span class="n">example_structures</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;3J3Y&quot;</span><span class="p">,</span> <span class="s2">&quot;7R5K&quot;</span><span class="p">,</span> <span class="s2">&quot;1XI5&quot;</span><span class="p">,</span> <span class="s2">&quot;8GMO&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-54"><a href="#ExperimentParametrisation-54"><span class="linenos">  54</span></a>    <span class="n">example_modalities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Widefield&quot;</span><span class="p">,</span> <span class="s2">&quot;Confocal&quot;</span><span class="p">,</span> <span class="s2">&quot;AiryScan&quot;</span><span class="p">,</span> <span class="s2">&quot;STED&quot;</span><span class="p">,</span> <span class="s2">&quot;SMLM&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-55"><a href="#ExperimentParametrisation-55"><span class="linenos">  55</span></a>
</span><span id="ExperimentParametrisation-56"><a href="#ExperimentParametrisation-56"><span class="linenos">  56</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-57"><a href="#ExperimentParametrisation-57"><span class="linenos">  57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-58"><a href="#ExperimentParametrisation-58"><span class="linenos">  58</span></a>        <span class="n">pck_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">vlab4mic</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="ExperimentParametrisation-59"><a href="#ExperimentParametrisation-59"><span class="linenos">  59</span></a>        <span class="n">local_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pck_dir</span><span class="p">,</span> <span class="s2">&quot;configs&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-60"><a href="#ExperimentParametrisation-60"><span class="linenos">  60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span> <span class="o">=</span> <span class="n">local_dir</span>
</span><span id="ExperimentParametrisation-61"><a href="#ExperimentParametrisation-61"><span class="linenos">  61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-62"><a href="#ExperimentParametrisation-62"><span class="linenos">  62</span></a>        <span class="c1"># keep track of objects created</span>
</span><span id="ExperimentParametrisation-63"><a href="#ExperimentParametrisation-63"><span class="linenos">  63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-64"><a href="#ExperimentParametrisation-64"><span class="linenos">  64</span></a>            <span class="n">structure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-65"><a href="#ExperimentParametrisation-65"><span class="linenos">  65</span></a>            <span class="n">particle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-66"><a href="#ExperimentParametrisation-66"><span class="linenos">  66</span></a>            <span class="n">exported_coordinate_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-67"><a href="#ExperimentParametrisation-67"><span class="linenos">  67</span></a>            <span class="n">coordinate_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-68"><a href="#ExperimentParametrisation-68"><span class="linenos">  68</span></a>            <span class="n">imager</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-69"><a href="#ExperimentParametrisation-69"><span class="linenos">  69</span></a>            <span class="n">output_reference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-70"><a href="#ExperimentParametrisation-70"><span class="linenos">  70</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-71"><a href="#ExperimentParametrisation-71"><span class="linenos">  71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-72"><a href="#ExperimentParametrisation-72"><span class="linenos">  72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-73"><a href="#ExperimentParametrisation-73"><span class="linenos">  73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-74"><a href="#ExperimentParametrisation-74"><span class="linenos">  74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-75"><a href="#ExperimentParametrisation-75"><span class="linenos">  75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation-76"><a href="#ExperimentParametrisation-76"><span class="linenos">  76</span></a>        <span class="c1"># read information of local modalities configuration</span>
</span><span id="ExperimentParametrisation-77"><a href="#ExperimentParametrisation-77"><span class="linenos">  77</span></a>        <span class="n">modalities_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="s2">&quot;modalities&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-78"><a href="#ExperimentParametrisation-78"><span class="linenos">  78</span></a>        <span class="n">modalities_names_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ExperimentParametrisation-79"><a href="#ExperimentParametrisation-79"><span class="linenos">  79</span></a>        <span class="n">modality_parameters</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ExperimentParametrisation-80"><a href="#ExperimentParametrisation-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_modalities</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-81"><a href="#ExperimentParametrisation-81"><span class="linenos">  81</span></a>        <span class="k">for</span> <span class="n">mods</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">modalities_dir</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-82"><a href="#ExperimentParametrisation-82"><span class="linenos">  82</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-83"><a href="#ExperimentParametrisation-83"><span class="linenos">  83</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">mods</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="ExperimentParametrisation-84"><a href="#ExperimentParametrisation-84"><span class="linenos">  84</span></a>                <span class="ow">and</span> <span class="s2">&quot;_template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mods</span>
</span><span id="ExperimentParametrisation-85"><a href="#ExperimentParametrisation-85"><span class="linenos">  85</span></a>            <span class="p">):</span>
</span><span id="ExperimentParametrisation-86"><a href="#ExperimentParametrisation-86"><span class="linenos">  86</span></a>                <span class="n">modalities_names_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">mods</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ExperimentParametrisation-87"><a href="#ExperimentParametrisation-87"><span class="linenos">  87</span></a>        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">modalities_names_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-88"><a href="#ExperimentParametrisation-88"><span class="linenos">  88</span></a>            <span class="n">mod_info</span><span class="p">,</span> <span class="n">mod_configuration</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-89"><a href="#ExperimentParametrisation-89"><span class="linenos">  89</span></a>                <span class="n">configuration_format</span><span class="o">.</span><span class="n">compile_modality_parameters</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-90"><a href="#ExperimentParametrisation-90"><span class="linenos">  90</span></a>                    <span class="n">mod</span><span class="p">,</span> <span class="n">local_dir</span>
</span><span id="ExperimentParametrisation-91"><a href="#ExperimentParametrisation-91"><span class="linenos">  91</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-92"><a href="#ExperimentParametrisation-92"><span class="linenos">  92</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-93"><a href="#ExperimentParametrisation-93"><span class="linenos">  93</span></a>            <span class="n">modality_parameters</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_info</span>
</span><span id="ExperimentParametrisation-94"><a href="#ExperimentParametrisation-94"><span class="linenos">  94</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config_modalities</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_configuration</span>
</span><span id="ExperimentParametrisation-95"><a href="#ExperimentParametrisation-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_names</span> <span class="o">=</span> <span class="n">modalities_names_list</span>
</span><span id="ExperimentParametrisation-96"><a href="#ExperimentParametrisation-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span> <span class="o">=</span> <span class="n">modality_parameters</span>
</span><span id="ExperimentParametrisation-97"><a href="#ExperimentParametrisation-97"><span class="linenos">  97</span></a>        <span class="n">probes_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="s2">&quot;probes&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-98"><a href="#ExperimentParametrisation-98"><span class="linenos">  98</span></a>        <span class="n">structure_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="s2">&quot;structures&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-99"><a href="#ExperimentParametrisation-99"><span class="linenos">  99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ExperimentParametrisation-100"><a href="#ExperimentParametrisation-100"><span class="linenos"> 100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_models_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ExperimentParametrisation-101"><a href="#ExperimentParametrisation-101"><span class="linenos"> 101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_global_probes_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ExperimentParametrisation-102"><a href="#ExperimentParametrisation-102"><span class="linenos"> 102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_per_structure_names</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ExperimentParametrisation-103"><a href="#ExperimentParametrisation-103"><span class="linenos"> 103</span></a>        <span class="k">for</span> <span class="n">p_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">probes_dir</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-104"><a href="#ExperimentParametrisation-104"><span class="linenos"> 104</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-105"><a href="#ExperimentParametrisation-105"><span class="linenos"> 105</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">p_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="ExperimentParametrisation-106"><a href="#ExperimentParametrisation-106"><span class="linenos"> 106</span></a>                <span class="ow">and</span> <span class="s2">&quot;_template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_file</span>
</span><span id="ExperimentParametrisation-107"><a href="#ExperimentParametrisation-107"><span class="linenos"> 107</span></a>            <span class="p">):</span>
</span><span id="ExperimentParametrisation-108"><a href="#ExperimentParametrisation-108"><span class="linenos"> 108</span></a>                <span class="n">label_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">probes_dir</span><span class="p">,</span> <span class="n">p_file</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-109"><a href="#ExperimentParametrisation-109"><span class="linenos"> 109</span></a>                <span class="n">label_parmeters</span> <span class="o">=</span> <span class="n">vlab4mic</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="n">label_config_path</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-110"><a href="#ExperimentParametrisation-110"><span class="linenos"> 110</span></a>                <span class="c1"># print(label_parmeters)</span>
</span><span id="ExperimentParametrisation-111"><a href="#ExperimentParametrisation-111"><span class="linenos"> 111</span></a>                <span class="n">lablname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">p_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-112"><a href="#ExperimentParametrisation-112"><span class="linenos"> 112</span></a>                <span class="k">if</span> <span class="s2">&quot;Mock&quot;</span> <span class="ow">in</span> <span class="n">label_parmeters</span><span class="p">[</span><span class="s2">&quot;known_targets&quot;</span><span class="p">]:</span>
</span><span id="ExperimentParametrisation-113"><a href="#ExperimentParametrisation-113"><span class="linenos"> 113</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_models_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lablname</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-114"><a href="#ExperimentParametrisation-114"><span class="linenos"> 114</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">lablname</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_parmeters</span>
</span><span id="ExperimentParametrisation-115"><a href="#ExperimentParametrisation-115"><span class="linenos"> 115</span></a>                <span class="k">elif</span> <span class="s2">&quot;Generic&quot;</span> <span class="ow">in</span> <span class="n">label_parmeters</span><span class="p">[</span><span class="s2">&quot;known_targets&quot;</span><span class="p">]:</span>
</span><span id="ExperimentParametrisation-116"><a href="#ExperimentParametrisation-116"><span class="linenos"> 116</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_global_probes_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lablname</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-117"><a href="#ExperimentParametrisation-117"><span class="linenos"> 117</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">lablname</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_parmeters</span>
</span><span id="ExperimentParametrisation-118"><a href="#ExperimentParametrisation-118"><span class="linenos"> 118</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-119"><a href="#ExperimentParametrisation-119"><span class="linenos"> 119</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">lablname</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_parmeters</span>
</span><span id="ExperimentParametrisation-120"><a href="#ExperimentParametrisation-120"><span class="linenos"> 120</span></a>                    <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="n">label_parmeters</span><span class="p">[</span><span class="s2">&quot;known_targets&quot;</span><span class="p">]:</span>
</span><span id="ExperimentParametrisation-121"><a href="#ExperimentParametrisation-121"><span class="linenos"> 121</span></a>                        <span class="k">if</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-122"><a href="#ExperimentParametrisation-122"><span class="linenos"> 122</span></a>                            <span class="n">struct</span>
</span><span id="ExperimentParametrisation-123"><a href="#ExperimentParametrisation-123"><span class="linenos"> 123</span></a>                            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_per_structure_names</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-124"><a href="#ExperimentParametrisation-124"><span class="linenos"> 124</span></a>                        <span class="p">):</span>
</span><span id="ExperimentParametrisation-125"><a href="#ExperimentParametrisation-125"><span class="linenos"> 125</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_per_structure_names</span><span class="p">[</span>
</span><span id="ExperimentParametrisation-126"><a href="#ExperimentParametrisation-126"><span class="linenos"> 126</span></a>                                <span class="n">struct</span>
</span><span id="ExperimentParametrisation-127"><a href="#ExperimentParametrisation-127"><span class="linenos"> 127</span></a>                            <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lablname</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-128"><a href="#ExperimentParametrisation-128"><span class="linenos"> 128</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-129"><a href="#ExperimentParametrisation-129"><span class="linenos"> 129</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_per_structure_names</span><span class="p">[</span><span class="n">struct</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ExperimentParametrisation-130"><a href="#ExperimentParametrisation-130"><span class="linenos"> 130</span></a>                                <span class="n">lablname</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-131"><a href="#ExperimentParametrisation-131"><span class="linenos"> 131</span></a>                            <span class="p">]</span>
</span><span id="ExperimentParametrisation-132"><a href="#ExperimentParametrisation-132"><span class="linenos"> 132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">demo_structures</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ExperimentParametrisation-133"><a href="#ExperimentParametrisation-133"><span class="linenos"> 133</span></a>        <span class="c1"># get available structure IDs</span>
</span><span id="ExperimentParametrisation-134"><a href="#ExperimentParametrisation-134"><span class="linenos"> 134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structures_info_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-135"><a href="#ExperimentParametrisation-135"><span class="linenos"> 135</span></a>        <span class="n">structure_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;structures&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-136"><a href="#ExperimentParametrisation-136"><span class="linenos"> 136</span></a>        <span class="n">fluorophores_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-137"><a href="#ExperimentParametrisation-137"><span class="linenos"> 137</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;fluorophores&quot;</span>
</span><span id="ExperimentParametrisation-138"><a href="#ExperimentParametrisation-138"><span class="linenos"> 138</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-139"><a href="#ExperimentParametrisation-139"><span class="linenos"> 139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-140"><a href="#ExperimentParametrisation-140"><span class="linenos"> 140</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fluorophores_dir</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-141"><a href="#ExperimentParametrisation-141"><span class="linenos"> 141</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-142"><a href="#ExperimentParametrisation-142"><span class="linenos"> 142</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="ExperimentParametrisation-143"><a href="#ExperimentParametrisation-143"><span class="linenos"> 143</span></a>                <span class="ow">and</span> <span class="s2">&quot;_template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span>
</span><span id="ExperimentParametrisation-144"><a href="#ExperimentParametrisation-144"><span class="linenos"> 144</span></a>            <span class="p">):</span>
</span><span id="ExperimentParametrisation-145"><a href="#ExperimentParametrisation-145"><span class="linenos"> 145</span></a>                <span class="n">fluorophore_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-146"><a href="#ExperimentParametrisation-146"><span class="linenos"> 146</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophore_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-147"><a href="#ExperimentParametrisation-147"><span class="linenos"> 147</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fluorophores_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-148"><a href="#ExperimentParametrisation-148"><span class="linenos"> 148</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-149"><a href="#ExperimentParametrisation-149"><span class="linenos"> 149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters_template</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-150"><a href="#ExperimentParametrisation-150"><span class="linenos"> 150</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fluorophores_dir</span><span class="p">,</span> <span class="s2">&quot;_template_.yaml&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-151"><a href="#ExperimentParametrisation-151"><span class="linenos"> 151</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-152"><a href="#ExperimentParametrisation-152"><span class="linenos"> 152</span></a>        <span class="n">probes_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;probes&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-153"><a href="#ExperimentParametrisation-153"><span class="linenos"> 153</span></a>        <span class="n">modalities_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;modalities&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-154"><a href="#ExperimentParametrisation-154"><span class="linenos"> 154</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">structure_dir</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-155"><a href="#ExperimentParametrisation-155"><span class="linenos"> 155</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-156"><a href="#ExperimentParametrisation-156"><span class="linenos"> 156</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="ExperimentParametrisation-157"><a href="#ExperimentParametrisation-157"><span class="linenos"> 157</span></a>                <span class="ow">and</span> <span class="s2">&quot;_template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span>
</span><span id="ExperimentParametrisation-158"><a href="#ExperimentParametrisation-158"><span class="linenos"> 158</span></a>            <span class="p">):</span>
</span><span id="ExperimentParametrisation-159"><a href="#ExperimentParametrisation-159"><span class="linenos"> 159</span></a>                <span class="n">structure_params</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">structure_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
</span><span id="ExperimentParametrisation-160"><a href="#ExperimentParametrisation-160"><span class="linenos"> 160</span></a>                <span class="n">struct_id</span> <span class="o">=</span> <span class="n">structure_params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-161"><a href="#ExperimentParametrisation-161"><span class="linenos"> 161</span></a>                <span class="k">if</span> <span class="n">struct_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">example_structures</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-162"><a href="#ExperimentParametrisation-162"><span class="linenos"> 162</span></a>                    <span class="n">strict_title</span> <span class="o">=</span> <span class="n">structure_params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-163"><a href="#ExperimentParametrisation-163"><span class="linenos"> 163</span></a>                    <span class="n">id_title</span> <span class="o">=</span> <span class="n">struct_id</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">strict_title</span>
</span><span id="ExperimentParametrisation-164"><a href="#ExperimentParametrisation-164"><span class="linenos"> 164</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">structures_info_list</span><span class="p">[</span><span class="n">id_title</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct_id</span>
</span><span id="ExperimentParametrisation-165"><a href="#ExperimentParametrisation-165"><span class="linenos"> 165</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">demo_structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_title</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-166"><a href="#ExperimentParametrisation-166"><span class="linenos"> 166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_directories</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-167"><a href="#ExperimentParametrisation-167"><span class="linenos"> 167</span></a>            <span class="n">structure</span><span class="o">=</span><span class="n">structure_dir</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-168"><a href="#ExperimentParametrisation-168"><span class="linenos"> 168</span></a>            <span class="n">fluorophores</span><span class="o">=</span><span class="n">fluorophores_dir</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-169"><a href="#ExperimentParametrisation-169"><span class="linenos"> 169</span></a>            <span class="n">probes</span><span class="o">=</span><span class="n">probes_dir</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-170"><a href="#ExperimentParametrisation-170"><span class="linenos"> 170</span></a>            <span class="n">modalities</span><span class="o">=</span><span class="n">modalities_dir</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-171"><a href="#ExperimentParametrisation-171"><span class="linenos"> 171</span></a>            <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-172"><a href="#ExperimentParametrisation-172"><span class="linenos"> 172</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-173"><a href="#ExperimentParametrisation-173"><span class="linenos"> 173</span></a>        <span class="n">param_settings_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-174"><a href="#ExperimentParametrisation-174"><span class="linenos"> 174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config_directories</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">],</span> <span class="s2">&quot;parameter_settings.yaml&quot;</span>
</span><span id="ExperimentParametrisation-175"><a href="#ExperimentParametrisation-175"><span class="linenos"> 175</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-176"><a href="#ExperimentParametrisation-176"><span class="linenos"> 176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param_settings</span> <span class="o">=</span> <span class="n">yaml_functions</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="n">param_settings_file</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-177"><a href="#ExperimentParametrisation-177"><span class="linenos"> 177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-178"><a href="#ExperimentParametrisation-178"><span class="linenos"> 178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">create_example_experiment</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-179"><a href="#ExperimentParametrisation-179"><span class="linenos"> 179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modality_noise_images</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-180"><a href="#ExperimentParametrisation-180"><span class="linenos"> 180</span></a>
</span><span id="ExperimentParametrisation-181"><a href="#ExperimentParametrisation-181"><span class="linenos"> 181</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">select_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure_id</span><span class="o">=</span><span class="s2">&quot;1XI5&quot;</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">structure_path</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-182"><a href="#ExperimentParametrisation-182"><span class="linenos"> 182</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-183"><a href="#ExperimentParametrisation-183"><span class="linenos"> 183</span></a><span class="sd">        Select a molecular structure by its identifier and optionally build the structure module.</span>
</span><span id="ExperimentParametrisation-184"><a href="#ExperimentParametrisation-184"><span class="linenos"> 184</span></a>
</span><span id="ExperimentParametrisation-185"><a href="#ExperimentParametrisation-185"><span class="linenos"> 185</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-186"><a href="#ExperimentParametrisation-186"><span class="linenos"> 186</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-187"><a href="#ExperimentParametrisation-187"><span class="linenos"> 187</span></a><span class="sd">        :param structure_id : str, optional</span>
</span><span id="ExperimentParametrisation-188"><a href="#ExperimentParametrisation-188"><span class="linenos"> 188</span></a><span class="sd">            The identifier of the structure to select. Default is &quot;1XI5&quot;.</span>
</span><span id="ExperimentParametrisation-189"><a href="#ExperimentParametrisation-189"><span class="linenos"> 189</span></a><span class="sd">        :param build : bool, optional</span>
</span><span id="ExperimentParametrisation-190"><a href="#ExperimentParametrisation-190"><span class="linenos"> 190</span></a><span class="sd">            If True, triggers the build process for the structure module. Default is True.</span>
</span><span id="ExperimentParametrisation-191"><a href="#ExperimentParametrisation-191"><span class="linenos"> 191</span></a>
</span><span id="ExperimentParametrisation-192"><a href="#ExperimentParametrisation-192"><span class="linenos"> 192</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-193"><a href="#ExperimentParametrisation-193"><span class="linenos"> 193</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-194"><a href="#ExperimentParametrisation-194"><span class="linenos"> 194</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-195"><a href="#ExperimentParametrisation-195"><span class="linenos"> 195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-196"><a href="#ExperimentParametrisation-196"><span class="linenos"> 196</span></a>        <span class="k">if</span> <span class="n">structure_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-197"><a href="#ExperimentParametrisation-197"><span class="linenos"> 197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="n">structure_path</span>
</span><span id="ExperimentParametrisation-198"><a href="#ExperimentParametrisation-198"><span class="linenos"> 198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="n">structure_id</span>
</span><span id="ExperimentParametrisation-199"><a href="#ExperimentParametrisation-199"><span class="linenos"> 199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_format</span> <span class="o">=</span> <span class="n">structure_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-200"><a href="#ExperimentParametrisation-200"><span class="linenos"> 200</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-201"><a href="#ExperimentParametrisation-201"><span class="linenos"> 201</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="n">structure_id</span>
</span><span id="ExperimentParametrisation-202"><a href="#ExperimentParametrisation-202"><span class="linenos"> 202</span></a>        <span class="k">if</span> <span class="n">build</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-203"><a href="#ExperimentParametrisation-203"><span class="linenos"> 203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">])</span>
</span><span id="ExperimentParametrisation-204"><a href="#ExperimentParametrisation-204"><span class="linenos"> 204</span></a>
</span><span id="ExperimentParametrisation-205"><a href="#ExperimentParametrisation-205"><span class="linenos"> 205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-206"><a href="#ExperimentParametrisation-206"><span class="linenos"> 206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-207"><a href="#ExperimentParametrisation-207"><span class="linenos"> 207</span></a><span class="sd">        Clear the current structure by resetting the structure ID and related parameters.</span>
</span><span id="ExperimentParametrisation-208"><a href="#ExperimentParametrisation-208"><span class="linenos"> 208</span></a><span class="sd">        This method sets the structure ID to None and resets the structure object if it exists.</span>
</span><span id="ExperimentParametrisation-209"><a href="#ExperimentParametrisation-209"><span class="linenos"> 209</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-210"><a href="#ExperimentParametrisation-210"><span class="linenos"> 210</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-211"><a href="#ExperimentParametrisation-211"><span class="linenos"> 211</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-212"><a href="#ExperimentParametrisation-212"><span class="linenos"> 212</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-213"><a href="#ExperimentParametrisation-213"><span class="linenos"> 213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-214"><a href="#ExperimentParametrisation-214"><span class="linenos"> 214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-215"><a href="#ExperimentParametrisation-215"><span class="linenos"> 215</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-216"><a href="#ExperimentParametrisation-216"><span class="linenos"> 216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-217"><a href="#ExperimentParametrisation-217"><span class="linenos"> 217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation-218"><a href="#ExperimentParametrisation-218"><span class="linenos"> 218</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Structure cleared&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-219"><a href="#ExperimentParametrisation-219"><span class="linenos"> 219</span></a>
</span><span id="ExperimentParametrisation-220"><a href="#ExperimentParametrisation-220"><span class="linenos"> 220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_modality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">modality_template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-221"><a href="#ExperimentParametrisation-221"><span class="linenos"> 221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-222"><a href="#ExperimentParametrisation-222"><span class="linenos"> 222</span></a><span class="sd">        Add a new imaging modality to the experiment.</span>
</span><span id="ExperimentParametrisation-223"><a href="#ExperimentParametrisation-223"><span class="linenos"> 223</span></a>
</span><span id="ExperimentParametrisation-224"><a href="#ExperimentParametrisation-224"><span class="linenos"> 224</span></a><span class="sd">        If the specified modality name exists in the local modalities, it copies the parameters from the local template.</span>
</span><span id="ExperimentParametrisation-225"><a href="#ExperimentParametrisation-225"><span class="linenos"> 225</span></a><span class="sd">        Otherwise, it uses the &#39;Widefield&#39; modality parameters as a template to create a new modality.</span>
</span><span id="ExperimentParametrisation-226"><a href="#ExperimentParametrisation-226"><span class="linenos"> 226</span></a><span class="sd">        Additional parameters for the modality can be specified via keyword arguments and will override the defaults.</span>
</span><span id="ExperimentParametrisation-227"><a href="#ExperimentParametrisation-227"><span class="linenos"> 227</span></a><span class="sd">        Optionally, the modality output can be saved by setting `save` to True.</span>
</span><span id="ExperimentParametrisation-228"><a href="#ExperimentParametrisation-228"><span class="linenos"> 228</span></a>
</span><span id="ExperimentParametrisation-229"><a href="#ExperimentParametrisation-229"><span class="linenos"> 229</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-230"><a href="#ExperimentParametrisation-230"><span class="linenos"> 230</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-231"><a href="#ExperimentParametrisation-231"><span class="linenos"> 231</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="ExperimentParametrisation-232"><a href="#ExperimentParametrisation-232"><span class="linenos"> 232</span></a><span class="sd">            The name of the modality to add.</span>
</span><span id="ExperimentParametrisation-233"><a href="#ExperimentParametrisation-233"><span class="linenos"> 233</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="ExperimentParametrisation-234"><a href="#ExperimentParametrisation-234"><span class="linenos"> 234</span></a><span class="sd">            If True, saves the modality output. Default is False.</span>
</span><span id="ExperimentParametrisation-235"><a href="#ExperimentParametrisation-235"><span class="linenos"> 235</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-236"><a href="#ExperimentParametrisation-236"><span class="linenos"> 236</span></a><span class="sd">            Arbitrary keyword arguments to override or set specific modality parameters.</span>
</span><span id="ExperimentParametrisation-237"><a href="#ExperimentParametrisation-237"><span class="linenos"> 237</span></a>
</span><span id="ExperimentParametrisation-238"><a href="#ExperimentParametrisation-238"><span class="linenos"> 238</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-239"><a href="#ExperimentParametrisation-239"><span class="linenos"> 239</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-240"><a href="#ExperimentParametrisation-240"><span class="linenos"> 240</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-241"><a href="#ExperimentParametrisation-241"><span class="linenos"> 241</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-242"><a href="#ExperimentParametrisation-242"><span class="linenos"> 242</span></a>        <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_names</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-243"><a href="#ExperimentParametrisation-243"><span class="linenos"> 243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-244"><a href="#ExperimentParametrisation-244"><span class="linenos"> 244</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-245"><a href="#ExperimentParametrisation-245"><span class="linenos"> 245</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-246"><a href="#ExperimentParametrisation-246"><span class="linenos"> 246</span></a>            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-247"><a href="#ExperimentParametrisation-247"><span class="linenos"> 247</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="ExperimentParametrisation-248"><a href="#ExperimentParametrisation-248"><span class="linenos"> 248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-249"><a href="#ExperimentParametrisation-249"><span class="linenos"> 249</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-250"><a href="#ExperimentParametrisation-250"><span class="linenos"> 250</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-251"><a href="#ExperimentParametrisation-251"><span class="linenos"> 251</span></a>                <span class="sa">f</span><span class="s2">&quot;Modality </span><span class="si">{</span><span class="n">modality_name</span><span class="si">}</span><span class="s2"> not found in demo modalities. Using template to create new.&quot;</span>
</span><span id="ExperimentParametrisation-252"><a href="#ExperimentParametrisation-252"><span class="linenos"> 252</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-253"><a href="#ExperimentParametrisation-253"><span class="linenos"> 253</span></a>            <span class="k">if</span> <span class="n">modality_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-254"><a href="#ExperimentParametrisation-254"><span class="linenos"> 254</span></a>                <span class="n">template_modality</span> <span class="o">=</span> <span class="n">modality_template</span>
</span><span id="ExperimentParametrisation-255"><a href="#ExperimentParametrisation-255"><span class="linenos"> 255</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-256"><a href="#ExperimentParametrisation-256"><span class="linenos"> 256</span></a>                <span class="n">template_modality</span> <span class="o">=</span> <span class="s2">&quot;Widefield&quot;</span>
</span><span id="ExperimentParametrisation-257"><a href="#ExperimentParametrisation-257"><span class="linenos"> 257</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">template_modality</span><span class="si">}</span><span class="s2"> as template.&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-258"><a href="#ExperimentParametrisation-258"><span class="linenos"> 258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-259"><a href="#ExperimentParametrisation-259"><span class="linenos"> 259</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">template_modality</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-260"><a href="#ExperimentParametrisation-260"><span class="linenos"> 260</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-261"><a href="#ExperimentParametrisation-261"><span class="linenos"> 261</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;modality&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modality_name</span>
</span><span id="ExperimentParametrisation-262"><a href="#ExperimentParametrisation-262"><span class="linenos"> 262</span></a>            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-263"><a href="#ExperimentParametrisation-263"><span class="linenos"> 263</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="ExperimentParametrisation-264"><a href="#ExperimentParametrisation-264"><span class="linenos"> 264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-265"><a href="#ExperimentParametrisation-265"><span class="linenos"> 265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modality_name</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-266"><a href="#ExperimentParametrisation-266"><span class="linenos"> 266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-267"><a href="#ExperimentParametrisation-267"><span class="linenos"> 267</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-268"><a href="#ExperimentParametrisation-268"><span class="linenos"> 268</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-269"><a href="#ExperimentParametrisation-269"><span class="linenos"> 269</span></a>
</span><span id="ExperimentParametrisation-270"><a href="#ExperimentParametrisation-270"><span class="linenos"> 270</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_modality</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-271"><a href="#ExperimentParametrisation-271"><span class="linenos"> 271</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-272"><a href="#ExperimentParametrisation-272"><span class="linenos"> 272</span></a>        <span class="n">modality_name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-273"><a href="#ExperimentParametrisation-273"><span class="linenos"> 273</span></a>        <span class="n">pixelsize_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-274"><a href="#ExperimentParametrisation-274"><span class="linenos"> 274</span></a>        <span class="n">lateral_resolution_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-275"><a href="#ExperimentParametrisation-275"><span class="linenos"> 275</span></a>        <span class="n">axial_resolution_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-276"><a href="#ExperimentParametrisation-276"><span class="linenos"> 276</span></a>        <span class="n">psf_voxel_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-277"><a href="#ExperimentParametrisation-277"><span class="linenos"> 277</span></a>        <span class="n">depth_of_field_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-278"><a href="#ExperimentParametrisation-278"><span class="linenos"> 278</span></a>        <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-279"><a href="#ExperimentParametrisation-279"><span class="linenos"> 279</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-280"><a href="#ExperimentParametrisation-280"><span class="linenos"> 280</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-281"><a href="#ExperimentParametrisation-281"><span class="linenos"> 281</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-282"><a href="#ExperimentParametrisation-282"><span class="linenos"> 282</span></a><span class="sd">        Update or remove an imaging modality&#39;s parameters.</span>
</span><span id="ExperimentParametrisation-283"><a href="#ExperimentParametrisation-283"><span class="linenos"> 283</span></a>
</span><span id="ExperimentParametrisation-284"><a href="#ExperimentParametrisation-284"><span class="linenos"> 284</span></a><span class="sd">        This method allows updating specific parameters of an imaging modality, such as pixel size, lateral and axial resolution, and PSF voxel size.</span>
</span><span id="ExperimentParametrisation-285"><a href="#ExperimentParametrisation-285"><span class="linenos"> 285</span></a><span class="sd">        If `remove` is True, the modality is removed from the internal dictionaries.</span>
</span><span id="ExperimentParametrisation-286"><a href="#ExperimentParametrisation-286"><span class="linenos"> 286</span></a>
</span><span id="ExperimentParametrisation-287"><a href="#ExperimentParametrisation-287"><span class="linenos"> 287</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-288"><a href="#ExperimentParametrisation-288"><span class="linenos"> 288</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-289"><a href="#ExperimentParametrisation-289"><span class="linenos"> 289</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="ExperimentParametrisation-290"><a href="#ExperimentParametrisation-290"><span class="linenos"> 290</span></a><span class="sd">            The name of the imaging modality to update or remove.</span>
</span><span id="ExperimentParametrisation-291"><a href="#ExperimentParametrisation-291"><span class="linenos"> 291</span></a><span class="sd">        :param pixelsize_nm : int, optional</span>
</span><span id="ExperimentParametrisation-292"><a href="#ExperimentParametrisation-292"><span class="linenos"> 292</span></a><span class="sd">            The new pixel size in nanometers. If provided, updates the detector pixel size.</span>
</span><span id="ExperimentParametrisation-293"><a href="#ExperimentParametrisation-293"><span class="linenos"> 293</span></a><span class="sd">        :param lateral_resolution_nm : int, optional</span>
</span><span id="ExperimentParametrisation-294"><a href="#ExperimentParametrisation-294"><span class="linenos"> 294</span></a><span class="sd">            The new lateral resolution in nanometers. If provided, updates the lateral standard deviations of the PSF.</span>
</span><span id="ExperimentParametrisation-295"><a href="#ExperimentParametrisation-295"><span class="linenos"> 295</span></a><span class="sd">        :param axial_resolution_nm : int, optional</span>
</span><span id="ExperimentParametrisation-296"><a href="#ExperimentParametrisation-296"><span class="linenos"> 296</span></a><span class="sd">            The new axial resolution in nanometers. If provided, updates the axial standard deviation of the PSF.</span>
</span><span id="ExperimentParametrisation-297"><a href="#ExperimentParametrisation-297"><span class="linenos"> 297</span></a><span class="sd">        :param psf_voxel_nm : int, optional</span>
</span><span id="ExperimentParametrisation-298"><a href="#ExperimentParametrisation-298"><span class="linenos"> 298</span></a><span class="sd">            The new PSF voxel size in nanometers. If provided, updates the PSF voxel size for all axes.</span>
</span><span id="ExperimentParametrisation-299"><a href="#ExperimentParametrisation-299"><span class="linenos"> 299</span></a><span class="sd">        :param remove : bool, optional</span>
</span><span id="ExperimentParametrisation-300"><a href="#ExperimentParametrisation-300"><span class="linenos"> 300</span></a><span class="sd">            If True, removes the specified modality from the internal dictionaries. Default is False.</span>
</span><span id="ExperimentParametrisation-301"><a href="#ExperimentParametrisation-301"><span class="linenos"> 301</span></a>
</span><span id="ExperimentParametrisation-302"><a href="#ExperimentParametrisation-302"><span class="linenos"> 302</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation-303"><a href="#ExperimentParametrisation-303"><span class="linenos"> 303</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation-304"><a href="#ExperimentParametrisation-304"><span class="linenos"> 304</span></a><span class="sd">        After updating any parameters, the imaging modality is reconfigured in the imager.</span>
</span><span id="ExperimentParametrisation-305"><a href="#ExperimentParametrisation-305"><span class="linenos"> 305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-306"><a href="#ExperimentParametrisation-306"><span class="linenos"> 306</span></a>        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-307"><a href="#ExperimentParametrisation-307"><span class="linenos"> 307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-308"><a href="#ExperimentParametrisation-308"><span class="linenos"> 308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-309"><a href="#ExperimentParametrisation-309"><span class="linenos"> 309</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-310"><a href="#ExperimentParametrisation-310"><span class="linenos"> 310</span></a>            <span class="n">changes</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation-311"><a href="#ExperimentParametrisation-311"><span class="linenos"> 311</span></a>            <span class="k">if</span> <span class="n">pixelsize_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-312"><a href="#ExperimentParametrisation-312"><span class="linenos"> 312</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;detector&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-313"><a href="#ExperimentParametrisation-313"><span class="linenos"> 313</span></a>                    <span class="s2">&quot;pixelsize&quot;</span>
</span><span id="ExperimentParametrisation-314"><a href="#ExperimentParametrisation-314"><span class="linenos"> 314</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixelsize_nm</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-315"><a href="#ExperimentParametrisation-315"><span class="linenos"> 315</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-316"><a href="#ExperimentParametrisation-316"><span class="linenos"> 316</span></a>            <span class="k">if</span> <span class="n">lateral_resolution_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-317"><a href="#ExperimentParametrisation-317"><span class="linenos"> 317</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-318"><a href="#ExperimentParametrisation-318"><span class="linenos"> 318</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="ExperimentParametrisation-319"><a href="#ExperimentParametrisation-319"><span class="linenos"> 319</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-320"><a href="#ExperimentParametrisation-320"><span class="linenos"> 320</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-321"><a href="#ExperimentParametrisation-321"><span class="linenos"> 321</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="ExperimentParametrisation-322"><a href="#ExperimentParametrisation-322"><span class="linenos"> 322</span></a>                <span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lateral_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-323"><a href="#ExperimentParametrisation-323"><span class="linenos"> 323</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-324"><a href="#ExperimentParametrisation-324"><span class="linenos"> 324</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="ExperimentParametrisation-325"><a href="#ExperimentParametrisation-325"><span class="linenos"> 325</span></a>                <span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lateral_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-326"><a href="#ExperimentParametrisation-326"><span class="linenos"> 326</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-327"><a href="#ExperimentParametrisation-327"><span class="linenos"> 327</span></a>            <span class="k">if</span> <span class="n">axial_resolution_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-328"><a href="#ExperimentParametrisation-328"><span class="linenos"> 328</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-329"><a href="#ExperimentParametrisation-329"><span class="linenos"> 329</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="ExperimentParametrisation-330"><a href="#ExperimentParametrisation-330"><span class="linenos"> 330</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-331"><a href="#ExperimentParametrisation-331"><span class="linenos"> 331</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-332"><a href="#ExperimentParametrisation-332"><span class="linenos"> 332</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="ExperimentParametrisation-333"><a href="#ExperimentParametrisation-333"><span class="linenos"> 333</span></a>                <span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">axial_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-334"><a href="#ExperimentParametrisation-334"><span class="linenos"> 334</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-335"><a href="#ExperimentParametrisation-335"><span class="linenos"> 335</span></a>            <span class="k">if</span> <span class="n">psf_voxel_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-336"><a href="#ExperimentParametrisation-336"><span class="linenos"> 336</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-337"><a href="#ExperimentParametrisation-337"><span class="linenos"> 337</span></a>                    <span class="s2">&quot;voxelsize&quot;</span>
</span><span id="ExperimentParametrisation-338"><a href="#ExperimentParametrisation-338"><span class="linenos"> 338</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ExperimentParametrisation-339"><a href="#ExperimentParametrisation-339"><span class="linenos"> 339</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-340"><a href="#ExperimentParametrisation-340"><span class="linenos"> 340</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-341"><a href="#ExperimentParametrisation-341"><span class="linenos"> 341</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-342"><a href="#ExperimentParametrisation-342"><span class="linenos"> 342</span></a>                <span class="p">]</span>
</span><span id="ExperimentParametrisation-343"><a href="#ExperimentParametrisation-343"><span class="linenos"> 343</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-344"><a href="#ExperimentParametrisation-344"><span class="linenos"> 344</span></a>            <span class="k">if</span> <span class="n">depth_of_field_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-345"><a href="#ExperimentParametrisation-345"><span class="linenos"> 345</span></a>                <span class="n">depth_in_slices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-346"><a href="#ExperimentParametrisation-346"><span class="linenos"> 346</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-347"><a href="#ExperimentParametrisation-347"><span class="linenos"> 347</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="ExperimentParametrisation-348"><a href="#ExperimentParametrisation-348"><span class="linenos"> 348</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-349"><a href="#ExperimentParametrisation-349"><span class="linenos"> 349</span></a>                <span class="n">depth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">depth_of_field_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-350"><a href="#ExperimentParametrisation-350"><span class="linenos"> 350</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-351"><a href="#ExperimentParametrisation-351"><span class="linenos"> 351</span></a>                    <span class="s2">&quot;depth&quot;</span>
</span><span id="ExperimentParametrisation-352"><a href="#ExperimentParametrisation-352"><span class="linenos"> 352</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="n">depth</span>
</span><span id="ExperimentParametrisation-353"><a href="#ExperimentParametrisation-353"><span class="linenos"> 353</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-354"><a href="#ExperimentParametrisation-354"><span class="linenos"> 354</span></a>            <span class="k">if</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-355"><a href="#ExperimentParametrisation-355"><span class="linenos"> 355</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">set_imaging_modality</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-356"><a href="#ExperimentParametrisation-356"><span class="linenos"> 356</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-357"><a href="#ExperimentParametrisation-357"><span class="linenos"> 357</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-358"><a href="#ExperimentParametrisation-358"><span class="linenos"> 358</span></a>
</span><span id="ExperimentParametrisation-359"><a href="#ExperimentParametrisation-359"><span class="linenos"> 359</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_modality_acq</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-360"><a href="#ExperimentParametrisation-360"><span class="linenos"> 360</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-361"><a href="#ExperimentParametrisation-361"><span class="linenos"> 361</span></a>        <span class="n">modality_name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-362"><a href="#ExperimentParametrisation-362"><span class="linenos"> 362</span></a>        <span class="n">exp_time</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-363"><a href="#ExperimentParametrisation-363"><span class="linenos"> 363</span></a>        <span class="n">noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-364"><a href="#ExperimentParametrisation-364"><span class="linenos"> 364</span></a>        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-365"><a href="#ExperimentParametrisation-365"><span class="linenos"> 365</span></a>        <span class="n">nframes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-366"><a href="#ExperimentParametrisation-366"><span class="linenos"> 366</span></a>        <span class="n">channels</span><span class="o">=</span><span class="p">[</span>
</span><span id="ExperimentParametrisation-367"><a href="#ExperimentParametrisation-367"><span class="linenos"> 367</span></a>            <span class="s2">&quot;ch0&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-368"><a href="#ExperimentParametrisation-368"><span class="linenos"> 368</span></a>        <span class="p">],</span>
</span><span id="ExperimentParametrisation-369"><a href="#ExperimentParametrisation-369"><span class="linenos"> 369</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-370"><a href="#ExperimentParametrisation-370"><span class="linenos"> 370</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-371"><a href="#ExperimentParametrisation-371"><span class="linenos"> 371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-372"><a href="#ExperimentParametrisation-372"><span class="linenos"> 372</span></a><span class="sd">        Configure and set acquisition parameters for a specified imaging modality.</span>
</span><span id="ExperimentParametrisation-373"><a href="#ExperimentParametrisation-373"><span class="linenos"> 373</span></a>
</span><span id="ExperimentParametrisation-374"><a href="#ExperimentParametrisation-374"><span class="linenos"> 374</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-375"><a href="#ExperimentParametrisation-375"><span class="linenos"> 375</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-376"><a href="#ExperimentParametrisation-376"><span class="linenos"> 376</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="ExperimentParametrisation-377"><a href="#ExperimentParametrisation-377"><span class="linenos"> 377</span></a><span class="sd">            The name of the imaging modality to configure.</span>
</span><span id="ExperimentParametrisation-378"><a href="#ExperimentParametrisation-378"><span class="linenos"> 378</span></a><span class="sd">        :param exp_time : float, optional</span>
</span><span id="ExperimentParametrisation-379"><a href="#ExperimentParametrisation-379"><span class="linenos"> 379</span></a><span class="sd">            Exposure time for the acquisition in seconds. Default is 0.001.</span>
</span><span id="ExperimentParametrisation-380"><a href="#ExperimentParametrisation-380"><span class="linenos"> 380</span></a><span class="sd">        :param noise : bool, optional</span>
</span><span id="ExperimentParametrisation-381"><a href="#ExperimentParametrisation-381"><span class="linenos"> 381</span></a><span class="sd">            Whether to include noise in the acquisition. Default is True.</span>
</span><span id="ExperimentParametrisation-382"><a href="#ExperimentParametrisation-382"><span class="linenos"> 382</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="ExperimentParametrisation-383"><a href="#ExperimentParametrisation-383"><span class="linenos"> 383</span></a><span class="sd">            Whether to save the acquired data. Default is False.</span>
</span><span id="ExperimentParametrisation-384"><a href="#ExperimentParametrisation-384"><span class="linenos"> 384</span></a><span class="sd">        :param nframes : int, optional</span>
</span><span id="ExperimentParametrisation-385"><a href="#ExperimentParametrisation-385"><span class="linenos"> 385</span></a><span class="sd">            Number of frames to acquire. Default is 1.</span>
</span><span id="ExperimentParametrisation-386"><a href="#ExperimentParametrisation-386"><span class="linenos"> 386</span></a><span class="sd">        :param channels : list of str, optional</span>
</span><span id="ExperimentParametrisation-387"><a href="#ExperimentParametrisation-387"><span class="linenos"> 387</span></a><span class="sd">            List of channel names to use. Default is [&quot;ch0&quot;].</span>
</span><span id="ExperimentParametrisation-388"><a href="#ExperimentParametrisation-388"><span class="linenos"> 388</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-389"><a href="#ExperimentParametrisation-389"><span class="linenos"> 389</span></a><span class="sd">            Additional keyword arguments for modality-specific parameters.</span>
</span><span id="ExperimentParametrisation-390"><a href="#ExperimentParametrisation-390"><span class="linenos"> 390</span></a>
</span><span id="ExperimentParametrisation-391"><a href="#ExperimentParametrisation-391"><span class="linenos"> 391</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation-392"><a href="#ExperimentParametrisation-392"><span class="linenos"> 392</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation-393"><a href="#ExperimentParametrisation-393"><span class="linenos"> 393</span></a><span class="sd">        If the specified modality is not available in `self.imaging_modalities`, a message is printed and no action is taken.</span>
</span><span id="ExperimentParametrisation-394"><a href="#ExperimentParametrisation-394"><span class="linenos"> 394</span></a><span class="sd">        Acquisition parameters are formatted using `configuration_format.format_modality_acquisition_params` and stored in `self.selected_mods`.</span>
</span><span id="ExperimentParametrisation-395"><a href="#ExperimentParametrisation-395"><span class="linenos"> 395</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-396"><a href="#ExperimentParametrisation-396"><span class="linenos"> 396</span></a>        <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-397"><a href="#ExperimentParametrisation-397"><span class="linenos"> 397</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-398"><a href="#ExperimentParametrisation-398"><span class="linenos"> 398</span></a>                <span class="n">configuration_format</span><span class="o">.</span><span class="n">format_modality_acquisition_params</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-399"><a href="#ExperimentParametrisation-399"><span class="linenos"> 399</span></a>                    <span class="n">exp_time</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nframes</span><span class="p">,</span> <span class="n">channels</span>
</span><span id="ExperimentParametrisation-400"><a href="#ExperimentParametrisation-400"><span class="linenos"> 400</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-401"><a href="#ExperimentParametrisation-401"><span class="linenos"> 401</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-402"><a href="#ExperimentParametrisation-402"><span class="linenos"> 402</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-403"><a href="#ExperimentParametrisation-403"><span class="linenos"> 403</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modality not selected&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-404"><a href="#ExperimentParametrisation-404"><span class="linenos"> 404</span></a>
</span><span id="ExperimentParametrisation-405"><a href="#ExperimentParametrisation-405"><span class="linenos"> 405</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_modalities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-406"><a href="#ExperimentParametrisation-406"><span class="linenos"> 406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-407"><a href="#ExperimentParametrisation-407"><span class="linenos"> 407</span></a><span class="sd">        Clear all selected imaging modalities and their acquisition parameters.</span>
</span><span id="ExperimentParametrisation-408"><a href="#ExperimentParametrisation-408"><span class="linenos"> 408</span></a><span class="sd">        This method resets the `imaging_modalities` and `selected_mods` dictionaries to empty states,</span>
</span><span id="ExperimentParametrisation-409"><a href="#ExperimentParametrisation-409"><span class="linenos"> 409</span></a><span class="sd">        effectively removing all configured modalities from the experiment.</span>
</span><span id="ExperimentParametrisation-410"><a href="#ExperimentParametrisation-410"><span class="linenos"> 410</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-411"><a href="#ExperimentParametrisation-411"><span class="linenos"> 411</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-412"><a href="#ExperimentParametrisation-412"><span class="linenos"> 412</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-413"><a href="#ExperimentParametrisation-413"><span class="linenos"> 413</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-414"><a href="#ExperimentParametrisation-414"><span class="linenos"> 414</span></a>        <span class="n">modality_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="ExperimentParametrisation-415"><a href="#ExperimentParametrisation-415"><span class="linenos"> 415</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">modality_names</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-416"><a href="#ExperimentParametrisation-416"><span class="linenos"> 416</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_modality</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-417"><a href="#ExperimentParametrisation-417"><span class="linenos"> 417</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;imager&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-418"><a href="#ExperimentParametrisation-418"><span class="linenos"> 418</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imager</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-419"><a href="#ExperimentParametrisation-419"><span class="linenos"> 419</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;imager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation-420"><a href="#ExperimentParametrisation-420"><span class="linenos"> 420</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All modalities cleared&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-421"><a href="#ExperimentParametrisation-421"><span class="linenos"> 421</span></a>
</span><span id="ExperimentParametrisation-422"><a href="#ExperimentParametrisation-422"><span class="linenos"> 422</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_to_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;acquisitions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-423"><a href="#ExperimentParametrisation-423"><span class="linenos"> 423</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-424"><a href="#ExperimentParametrisation-424"><span class="linenos"> 424</span></a><span class="sd">        Reset acquisition parameters or other module settings to their default values.</span>
</span><span id="ExperimentParametrisation-425"><a href="#ExperimentParametrisation-425"><span class="linenos"> 425</span></a>
</span><span id="ExperimentParametrisation-426"><a href="#ExperimentParametrisation-426"><span class="linenos"> 426</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-427"><a href="#ExperimentParametrisation-427"><span class="linenos"> 427</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-428"><a href="#ExperimentParametrisation-428"><span class="linenos"> 428</span></a><span class="sd">        :param module : str, optional</span>
</span><span id="ExperimentParametrisation-429"><a href="#ExperimentParametrisation-429"><span class="linenos"> 429</span></a><span class="sd">            The module to reset. Default is &quot;acquisitions&quot;.</span>
</span><span id="ExperimentParametrisation-430"><a href="#ExperimentParametrisation-430"><span class="linenos"> 430</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-431"><a href="#ExperimentParametrisation-431"><span class="linenos"> 431</span></a><span class="sd">            Additional keyword arguments passed to the reset function.</span>
</span><span id="ExperimentParametrisation-432"><a href="#ExperimentParametrisation-432"><span class="linenos"> 432</span></a>
</span><span id="ExperimentParametrisation-433"><a href="#ExperimentParametrisation-433"><span class="linenos"> 433</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-434"><a href="#ExperimentParametrisation-434"><span class="linenos"> 434</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-435"><a href="#ExperimentParametrisation-435"><span class="linenos"> 435</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-436"><a href="#ExperimentParametrisation-436"><span class="linenos"> 436</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-437"><a href="#ExperimentParametrisation-437"><span class="linenos"> 437</span></a>        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;acquisitions&quot;</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-438"><a href="#ExperimentParametrisation-438"><span class="linenos"> 438</span></a>            <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-439"><a href="#ExperimentParametrisation-439"><span class="linenos"> 439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-440"><a href="#ExperimentParametrisation-440"><span class="linenos"> 440</span></a>
</span><span id="ExperimentParametrisation-441"><a href="#ExperimentParametrisation-441"><span class="linenos"> 441</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-442"><a href="#ExperimentParametrisation-442"><span class="linenos"> 442</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-443"><a href="#ExperimentParametrisation-443"><span class="linenos"> 443</span></a><span class="sd">        Build the structure object for the experiment.</span>
</span><span id="ExperimentParametrisation-444"><a href="#ExperimentParametrisation-444"><span class="linenos"> 444</span></a>
</span><span id="ExperimentParametrisation-445"><a href="#ExperimentParametrisation-445"><span class="linenos"> 445</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-446"><a href="#ExperimentParametrisation-446"><span class="linenos"> 446</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-447"><a href="#ExperimentParametrisation-447"><span class="linenos"> 447</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="ExperimentParametrisation-448"><a href="#ExperimentParametrisation-448"><span class="linenos"> 448</span></a><span class="sd">            If True, store the structure in the experiment. Default is True.</span>
</span><span id="ExperimentParametrisation-449"><a href="#ExperimentParametrisation-449"><span class="linenos"> 449</span></a>
</span><span id="ExperimentParametrisation-450"><a href="#ExperimentParametrisation-450"><span class="linenos"> 450</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-451"><a href="#ExperimentParametrisation-451"><span class="linenos"> 451</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-452"><a href="#ExperimentParametrisation-452"><span class="linenos"> 452</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-453"><a href="#ExperimentParametrisation-453"><span class="linenos"> 453</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-454"><a href="#ExperimentParametrisation-454"><span class="linenos"> 454</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-455"><a href="#ExperimentParametrisation-455"><span class="linenos"> 455</span></a>            <span class="n">struct</span><span class="p">,</span> <span class="n">struct_param</span> <span class="o">=</span> <span class="n">load_structure</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-456"><a href="#ExperimentParametrisation-456"><span class="linenos"> 456</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_format</span>
</span><span id="ExperimentParametrisation-457"><a href="#ExperimentParametrisation-457"><span class="linenos"> 457</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-458"><a href="#ExperimentParametrisation-458"><span class="linenos"> 458</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">struct</span>
</span><span id="ExperimentParametrisation-459"><a href="#ExperimentParametrisation-459"><span class="linenos"> 459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-460"><a href="#ExperimentParametrisation-460"><span class="linenos"> 460</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-461"><a href="#ExperimentParametrisation-461"><span class="linenos"> 461</span></a>            <span class="n">struct</span><span class="p">,</span> <span class="n">struct_param</span> <span class="o">=</span> <span class="n">load_structure</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-462"><a href="#ExperimentParametrisation-462"><span class="linenos"> 462</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span>
</span><span id="ExperimentParametrisation-463"><a href="#ExperimentParametrisation-463"><span class="linenos"> 463</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-464"><a href="#ExperimentParametrisation-464"><span class="linenos"> 464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">struct</span>
</span><span id="ExperimentParametrisation-465"><a href="#ExperimentParametrisation-465"><span class="linenos"> 465</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-466"><a href="#ExperimentParametrisation-466"><span class="linenos"> 466</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-467"><a href="#ExperimentParametrisation-467"><span class="linenos"> 467</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No structure ID&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-468"><a href="#ExperimentParametrisation-468"><span class="linenos"> 468</span></a>
</span><span id="ExperimentParametrisation-469"><a href="#ExperimentParametrisation-469"><span class="linenos"> 469</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lab_eff</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-470"><a href="#ExperimentParametrisation-470"><span class="linenos"> 470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-471"><a href="#ExperimentParametrisation-471"><span class="linenos"> 471</span></a><span class="sd">        Create a list with one dictionary with the setup info for creating a label.</span>
</span><span id="ExperimentParametrisation-472"><a href="#ExperimentParametrisation-472"><span class="linenos"> 472</span></a>
</span><span id="ExperimentParametrisation-473"><a href="#ExperimentParametrisation-473"><span class="linenos"> 473</span></a><span class="sd">        Assumes there is only one label stored in the attribute &quot;structure_label&quot; and one in &quot;fluorophore_id&quot;.</span>
</span><span id="ExperimentParametrisation-474"><a href="#ExperimentParametrisation-474"><span class="linenos"> 474</span></a>
</span><span id="ExperimentParametrisation-475"><a href="#ExperimentParametrisation-475"><span class="linenos"> 475</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-476"><a href="#ExperimentParametrisation-476"><span class="linenos"> 476</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-477"><a href="#ExperimentParametrisation-477"><span class="linenos"> 477</span></a><span class="sd">        :param lab_eff : float, optional</span>
</span><span id="ExperimentParametrisation-478"><a href="#ExperimentParametrisation-478"><span class="linenos"> 478</span></a><span class="sd">            Labelling efficiency. Default is 1.</span>
</span><span id="ExperimentParametrisation-479"><a href="#ExperimentParametrisation-479"><span class="linenos"> 479</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="ExperimentParametrisation-480"><a href="#ExperimentParametrisation-480"><span class="linenos"> 480</span></a><span class="sd">            If True, keep the label. Default is False.</span>
</span><span id="ExperimentParametrisation-481"><a href="#ExperimentParametrisation-481"><span class="linenos"> 481</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-482"><a href="#ExperimentParametrisation-482"><span class="linenos"> 482</span></a><span class="sd">            Additional keyword arguments for label creation.</span>
</span><span id="ExperimentParametrisation-483"><a href="#ExperimentParametrisation-483"><span class="linenos"> 483</span></a>
</span><span id="ExperimentParametrisation-484"><a href="#ExperimentParametrisation-484"><span class="linenos"> 484</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-485"><a href="#ExperimentParametrisation-485"><span class="linenos"> 485</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-486"><a href="#ExperimentParametrisation-486"><span class="linenos"> 486</span></a><span class="sd">        list</span>
</span><span id="ExperimentParametrisation-487"><a href="#ExperimentParametrisation-487"><span class="linenos"> 487</span></a><span class="sd">            List of label dictionaries.</span>
</span><span id="ExperimentParametrisation-488"><a href="#ExperimentParametrisation-488"><span class="linenos"> 488</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-489"><a href="#ExperimentParametrisation-489"><span class="linenos"> 489</span></a>        <span class="n">labels_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ExperimentParametrisation-490"><a href="#ExperimentParametrisation-490"><span class="linenos"> 490</span></a>        <span class="k">for</span> <span class="n">probe_name</span><span class="p">,</span> <span class="n">probe_params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-491"><a href="#ExperimentParametrisation-491"><span class="linenos"> 491</span></a>            <span class="n">labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-492"><a href="#ExperimentParametrisation-492"><span class="linenos"> 492</span></a>                <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="p">[</span><span class="n">probe_name</span><span class="p">])</span>
</span><span id="ExperimentParametrisation-493"><a href="#ExperimentParametrisation-493"><span class="linenos"> 493</span></a>                <span class="c1">#</span>
</span><span id="ExperimentParametrisation-494"><a href="#ExperimentParametrisation-494"><span class="linenos"> 494</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-495"><a href="#ExperimentParametrisation-495"><span class="linenos"> 495</span></a>        <span class="k">return</span> <span class="n">labels_list</span>
</span><span id="ExperimentParametrisation-496"><a href="#ExperimentParametrisation-496"><span class="linenos"> 496</span></a>
</span><span id="ExperimentParametrisation-497"><a href="#ExperimentParametrisation-497"><span class="linenos"> 497</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_if_structural_integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-498"><a href="#ExperimentParametrisation-498"><span class="linenos"> 498</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-499"><a href="#ExperimentParametrisation-499"><span class="linenos"> 499</span></a><span class="sd">        Check if structural_integrity parameters are set and update the use_structural_integrity flag.</span>
</span><span id="ExperimentParametrisation-500"><a href="#ExperimentParametrisation-500"><span class="linenos"> 500</span></a>
</span><span id="ExperimentParametrisation-501"><a href="#ExperimentParametrisation-501"><span class="linenos"> 501</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-502"><a href="#ExperimentParametrisation-502"><span class="linenos"> 502</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-503"><a href="#ExperimentParametrisation-503"><span class="linenos"> 503</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-504"><a href="#ExperimentParametrisation-504"><span class="linenos"> 504</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-505"><a href="#ExperimentParametrisation-505"><span class="linenos"> 505</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-506"><a href="#ExperimentParametrisation-506"><span class="linenos"> 506</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;structural_integrity&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-507"><a href="#ExperimentParametrisation-507"><span class="linenos"> 507</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps1&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-508"><a href="#ExperimentParametrisation-508"><span class="linenos"> 508</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps2&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-509"><a href="#ExperimentParametrisation-509"><span class="linenos"> 509</span></a>        <span class="p">):</span>
</span><span id="ExperimentParametrisation-510"><a href="#ExperimentParametrisation-510"><span class="linenos"> 510</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-511"><a href="#ExperimentParametrisation-511"><span class="linenos"> 511</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-512"><a href="#ExperimentParametrisation-512"><span class="linenos"> 512</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation-513"><a href="#ExperimentParametrisation-513"><span class="linenos"> 513</span></a>
</span><span id="ExperimentParametrisation-514"><a href="#ExperimentParametrisation-514"><span class="linenos"> 514</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_particle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lab_eff</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">structural_integrity_build</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-515"><a href="#ExperimentParametrisation-515"><span class="linenos"> 515</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-516"><a href="#ExperimentParametrisation-516"><span class="linenos"> 516</span></a><span class="sd">        Build the particle object for the experiment, optionally adding structural_integritys.</span>
</span><span id="ExperimentParametrisation-517"><a href="#ExperimentParametrisation-517"><span class="linenos"> 517</span></a>
</span><span id="ExperimentParametrisation-518"><a href="#ExperimentParametrisation-518"><span class="linenos"> 518</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-519"><a href="#ExperimentParametrisation-519"><span class="linenos"> 519</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-520"><a href="#ExperimentParametrisation-520"><span class="linenos"> 520</span></a><span class="sd">        :param lab_eff : float, optional</span>
</span><span id="ExperimentParametrisation-521"><a href="#ExperimentParametrisation-521"><span class="linenos"> 521</span></a><span class="sd">            Labelling efficiency. Default is 1.0.</span>
</span><span id="ExperimentParametrisation-522"><a href="#ExperimentParametrisation-522"><span class="linenos"> 522</span></a><span class="sd">        :param structural_integrity_build : float or None, optional</span>
</span><span id="ExperimentParametrisation-523"><a href="#ExperimentParametrisation-523"><span class="linenos"> 523</span></a><span class="sd">            Defect parameter to use. Default is None.</span>
</span><span id="ExperimentParametrisation-524"><a href="#ExperimentParametrisation-524"><span class="linenos"> 524</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="ExperimentParametrisation-525"><a href="#ExperimentParametrisation-525"><span class="linenos"> 525</span></a><span class="sd">            If True, store the particle in the experiment. Default is False.</span>
</span><span id="ExperimentParametrisation-526"><a href="#ExperimentParametrisation-526"><span class="linenos"> 526</span></a>
</span><span id="ExperimentParametrisation-527"><a href="#ExperimentParametrisation-527"><span class="linenos"> 527</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-528"><a href="#ExperimentParametrisation-528"><span class="linenos"> 528</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-529"><a href="#ExperimentParametrisation-529"><span class="linenos"> 529</span></a><span class="sd">        particle or None</span>
</span><span id="ExperimentParametrisation-530"><a href="#ExperimentParametrisation-530"><span class="linenos"> 530</span></a><span class="sd">            The particle object if created, else None.</span>
</span><span id="ExperimentParametrisation-531"><a href="#ExperimentParametrisation-531"><span class="linenos"> 531</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-532"><a href="#ExperimentParametrisation-532"><span class="linenos"> 532</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-533"><a href="#ExperimentParametrisation-533"><span class="linenos"> 533</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_structural_integrity</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-534"><a href="#ExperimentParametrisation-534"><span class="linenos"> 534</span></a>            <span class="n">labels_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_label</span><span class="p">(</span><span class="n">lab_eff</span><span class="o">=</span><span class="n">lab_eff</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-535"><a href="#ExperimentParametrisation-535"><span class="linenos"> 535</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-536"><a href="#ExperimentParametrisation-536"><span class="linenos"> 536</span></a>                <span class="n">particle</span><span class="p">,</span> <span class="n">label_params_list</span> <span class="o">=</span> <span class="n">particle_from_structure</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-537"><a href="#ExperimentParametrisation-537"><span class="linenos"> 537</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">labels_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span>
</span><span id="ExperimentParametrisation-538"><a href="#ExperimentParametrisation-538"><span class="linenos"> 538</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-539"><a href="#ExperimentParametrisation-539"><span class="linenos"> 539</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]:</span>
</span><span id="ExperimentParametrisation-540"><a href="#ExperimentParametrisation-540"><span class="linenos"> 540</span></a>                    <span class="k">if</span> <span class="n">structural_integrity_build</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-541"><a href="#ExperimentParametrisation-541"><span class="linenos"> 541</span></a>                        <span class="n">structural_integrity</span> <span class="o">=</span> <span class="n">structural_integrity_build</span>
</span><span id="ExperimentParametrisation-542"><a href="#ExperimentParametrisation-542"><span class="linenos"> 542</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-543"><a href="#ExperimentParametrisation-543"><span class="linenos"> 543</span></a>                        <span class="n">structural_integrity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;structural_integrity&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-544"><a href="#ExperimentParametrisation-544"><span class="linenos"> 544</span></a>                    <span class="n">particle</span><span class="o">.</span><span class="n">add_structural_integrity</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-545"><a href="#ExperimentParametrisation-545"><span class="linenos"> 545</span></a>                        <span class="n">eps1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps1&quot;</span><span class="p">],</span>
</span><span id="ExperimentParametrisation-546"><a href="#ExperimentParametrisation-546"><span class="linenos"> 546</span></a>                        <span class="n">xmer_neigh_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps2&quot;</span><span class="p">],</span>
</span><span id="ExperimentParametrisation-547"><a href="#ExperimentParametrisation-547"><span class="linenos"> 547</span></a>                        <span class="n">integrity</span><span class="o">=</span><span class="n">structural_integrity</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-548"><a href="#ExperimentParametrisation-548"><span class="linenos"> 548</span></a>                    <span class="p">)</span>
</span><span id="ExperimentParametrisation-549"><a href="#ExperimentParametrisation-549"><span class="linenos"> 549</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-550"><a href="#ExperimentParametrisation-550"><span class="linenos"> 550</span></a>                    <span class="n">particle</span><span class="o">.</span><span class="n">add_structural_integrity</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-551"><a href="#ExperimentParametrisation-551"><span class="linenos"> 551</span></a>                        <span class="n">integrity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-552"><a href="#ExperimentParametrisation-552"><span class="linenos"> 552</span></a>                    <span class="p">)</span>
</span><span id="ExperimentParametrisation-553"><a href="#ExperimentParametrisation-553"><span class="linenos"> 553</span></a>                <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-554"><a href="#ExperimentParametrisation-554"><span class="linenos"> 554</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">particle</span> <span class="o">=</span> <span class="n">particle</span>
</span><span id="ExperimentParametrisation-555"><a href="#ExperimentParametrisation-555"><span class="linenos"> 555</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;particle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-556"><a href="#ExperimentParametrisation-556"><span class="linenos"> 556</span></a>                <span class="k">return</span> <span class="n">particle</span>
</span><span id="ExperimentParametrisation-557"><a href="#ExperimentParametrisation-557"><span class="linenos"> 557</span></a>
</span><span id="ExperimentParametrisation-558"><a href="#ExperimentParametrisation-558"><span class="linenos"> 558</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_coordinate_field</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-559"><a href="#ExperimentParametrisation-559"><span class="linenos"> 559</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-560"><a href="#ExperimentParametrisation-560"><span class="linenos"> 560</span></a>        <span class="n">use_self_particle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-561"><a href="#ExperimentParametrisation-561"><span class="linenos"> 561</span></a>        <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-562"><a href="#ExperimentParametrisation-562"><span class="linenos"> 562</span></a>        <span class="n">coordinate_field_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-563"><a href="#ExperimentParametrisation-563"><span class="linenos"> 563</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-564"><a href="#ExperimentParametrisation-564"><span class="linenos"> 564</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-565"><a href="#ExperimentParametrisation-565"><span class="linenos"> 565</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-566"><a href="#ExperimentParametrisation-566"><span class="linenos"> 566</span></a><span class="sd">        Build the coordinate field for the experiment, either from the current particle or as a minimal field.</span>
</span><span id="ExperimentParametrisation-567"><a href="#ExperimentParametrisation-567"><span class="linenos"> 567</span></a>
</span><span id="ExperimentParametrisation-568"><a href="#ExperimentParametrisation-568"><span class="linenos"> 568</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-569"><a href="#ExperimentParametrisation-569"><span class="linenos"> 569</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-570"><a href="#ExperimentParametrisation-570"><span class="linenos"> 570</span></a><span class="sd">        :param use_self_particle : bool, optional</span>
</span><span id="ExperimentParametrisation-571"><a href="#ExperimentParametrisation-571"><span class="linenos"> 571</span></a><span class="sd">            If True, use the current particle to build the field. Default is True.</span>
</span><span id="ExperimentParametrisation-572"><a href="#ExperimentParametrisation-572"><span class="linenos"> 572</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="ExperimentParametrisation-573"><a href="#ExperimentParametrisation-573"><span class="linenos"> 573</span></a><span class="sd">            If True, store the field in the experiment. Default is False.</span>
</span><span id="ExperimentParametrisation-574"><a href="#ExperimentParametrisation-574"><span class="linenos"> 574</span></a><span class="sd">        :param coordinate_field_path : str or None, optional</span>
</span><span id="ExperimentParametrisation-575"><a href="#ExperimentParametrisation-575"><span class="linenos"> 575</span></a><span class="sd">            Path to a coordinate field file. Default is None.</span>
</span><span id="ExperimentParametrisation-576"><a href="#ExperimentParametrisation-576"><span class="linenos"> 576</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-577"><a href="#ExperimentParametrisation-577"><span class="linenos"> 577</span></a><span class="sd">            Additional keyword arguments for field creation.</span>
</span><span id="ExperimentParametrisation-578"><a href="#ExperimentParametrisation-578"><span class="linenos"> 578</span></a>
</span><span id="ExperimentParametrisation-579"><a href="#ExperimentParametrisation-579"><span class="linenos"> 579</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-580"><a href="#ExperimentParametrisation-580"><span class="linenos"> 580</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-581"><a href="#ExperimentParametrisation-581"><span class="linenos"> 581</span></a><span class="sd">        exported_field or None</span>
</span><span id="ExperimentParametrisation-582"><a href="#ExperimentParametrisation-582"><span class="linenos"> 582</span></a><span class="sd">            The exported field if created, else None.</span>
</span><span id="ExperimentParametrisation-583"><a href="#ExperimentParametrisation-583"><span class="linenos"> 583</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-584"><a href="#ExperimentParametrisation-584"><span class="linenos"> 584</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-585"><a href="#ExperimentParametrisation-585"><span class="linenos"> 585</span></a>        <span class="k">if</span> <span class="n">use_self_particle</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;particle&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-586"><a href="#ExperimentParametrisation-586"><span class="linenos"> 586</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating field from existing particle&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-587"><a href="#ExperimentParametrisation-587"><span class="linenos"> 587</span></a>            <span class="n">exported_field</span><span class="p">,</span> <span class="n">fieldobject</span> <span class="o">=</span> <span class="n">field_from_particle</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-588"><a href="#ExperimentParametrisation-588"><span class="linenos"> 588</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">particle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="ExperimentParametrisation-589"><a href="#ExperimentParametrisation-589"><span class="linenos"> 589</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-590"><a href="#ExperimentParametrisation-590"><span class="linenos"> 590</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-591"><a href="#ExperimentParametrisation-591"><span class="linenos"> 591</span></a>                <span class="n">fieldobject</span><span class="o">.</span><span class="n">molecules_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-592"><a href="#ExperimentParametrisation-592"><span class="linenos"> 592</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-593"><a href="#ExperimentParametrisation-593"><span class="linenos"> 593</span></a>            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-594"><a href="#ExperimentParametrisation-594"><span class="linenos"> 594</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="n">exported_field</span>
</span><span id="ExperimentParametrisation-595"><a href="#ExperimentParametrisation-595"><span class="linenos"> 595</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;exported_coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-596"><a href="#ExperimentParametrisation-596"><span class="linenos"> 596</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span> <span class="o">=</span> <span class="n">fieldobject</span>
</span><span id="ExperimentParametrisation-597"><a href="#ExperimentParametrisation-597"><span class="linenos"> 597</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-598"><a href="#ExperimentParametrisation-598"><span class="linenos"> 598</span></a>            <span class="k">return</span> <span class="n">exported_field</span>
</span><span id="ExperimentParametrisation-599"><a href="#ExperimentParametrisation-599"><span class="linenos"> 599</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-600"><a href="#ExperimentParametrisation-600"><span class="linenos"> 600</span></a>            <span class="c1"># create minimal field</span>
</span><span id="ExperimentParametrisation-601"><a href="#ExperimentParametrisation-601"><span class="linenos"> 601</span></a>            <span class="n">fieldobject</span> <span class="o">=</span> <span class="n">coordinates_field</span><span class="o">.</span><span class="n">create_min_field</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-602"><a href="#ExperimentParametrisation-602"><span class="linenos"> 602</span></a>                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="ExperimentParametrisation-603"><a href="#ExperimentParametrisation-603"><span class="linenos"> 603</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-604"><a href="#ExperimentParametrisation-604"><span class="linenos"> 604</span></a>            <span class="n">exported_field</span> <span class="o">=</span> <span class="n">fieldobject</span><span class="o">.</span><span class="n">export_field</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-605"><a href="#ExperimentParametrisation-605"><span class="linenos"> 605</span></a>            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-606"><a href="#ExperimentParametrisation-606"><span class="linenos"> 606</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="n">exported_field</span>
</span><span id="ExperimentParametrisation-607"><a href="#ExperimentParametrisation-607"><span class="linenos"> 607</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;exported_coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-608"><a href="#ExperimentParametrisation-608"><span class="linenos"> 608</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span> <span class="o">=</span> <span class="n">fieldobject</span>
</span><span id="ExperimentParametrisation-609"><a href="#ExperimentParametrisation-609"><span class="linenos"> 609</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-610"><a href="#ExperimentParametrisation-610"><span class="linenos"> 610</span></a>
</span><span id="ExperimentParametrisation-611"><a href="#ExperimentParametrisation-611"><span class="linenos"> 611</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_imager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_local_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prints</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-612"><a href="#ExperimentParametrisation-612"><span class="linenos"> 612</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-613"><a href="#ExperimentParametrisation-613"><span class="linenos"> 613</span></a><span class="sd">        Build the imager object for the experiment using the selected imaging modalities.</span>
</span><span id="ExperimentParametrisation-614"><a href="#ExperimentParametrisation-614"><span class="linenos"> 614</span></a>
</span><span id="ExperimentParametrisation-615"><a href="#ExperimentParametrisation-615"><span class="linenos"> 615</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-616"><a href="#ExperimentParametrisation-616"><span class="linenos"> 616</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-617"><a href="#ExperimentParametrisation-617"><span class="linenos"> 617</span></a><span class="sd">        :param use_local_field : bool, optional</span>
</span><span id="ExperimentParametrisation-618"><a href="#ExperimentParametrisation-618"><span class="linenos"> 618</span></a><span class="sd">            If True, use the local exported coordinate field. Default is False.</span>
</span><span id="ExperimentParametrisation-619"><a href="#ExperimentParametrisation-619"><span class="linenos"> 619</span></a><span class="sd">        :param prints : bool, optional</span>
</span><span id="ExperimentParametrisation-620"><a href="#ExperimentParametrisation-620"><span class="linenos"> 620</span></a><span class="sd">            If True, print status messages. Default is True.</span>
</span><span id="ExperimentParametrisation-621"><a href="#ExperimentParametrisation-621"><span class="linenos"> 621</span></a>
</span><span id="ExperimentParametrisation-622"><a href="#ExperimentParametrisation-622"><span class="linenos"> 622</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-623"><a href="#ExperimentParametrisation-623"><span class="linenos"> 623</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-624"><a href="#ExperimentParametrisation-624"><span class="linenos"> 624</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-625"><a href="#ExperimentParametrisation-625"><span class="linenos"> 625</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-626"><a href="#ExperimentParametrisation-626"><span class="linenos"> 626</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-627"><a href="#ExperimentParametrisation-627"><span class="linenos"> 627</span></a>            <span class="c1"># print(f&quot;Using selected mods: {self.imaging_modalities.keys()}&quot;)</span>
</span><span id="ExperimentParametrisation-628"><a href="#ExperimentParametrisation-628"><span class="linenos"> 628</span></a>            <span class="n">mods_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="ExperimentParametrisation-629"><a href="#ExperimentParametrisation-629"><span class="linenos"> 629</span></a>            <span class="k">if</span> <span class="n">use_local_field</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-630"><a href="#ExperimentParametrisation-630"><span class="linenos"> 630</span></a>                <span class="s2">&quot;exported_coordinate_field&quot;</span>
</span><span id="ExperimentParametrisation-631"><a href="#ExperimentParametrisation-631"><span class="linenos"> 631</span></a>            <span class="p">):</span>
</span><span id="ExperimentParametrisation-632"><a href="#ExperimentParametrisation-632"><span class="linenos"> 632</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span> <span class="n">modality_parameters</span> <span class="o">=</span> <span class="n">create_imaging_system</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-633"><a href="#ExperimentParametrisation-633"><span class="linenos"> 633</span></a>                    <span class="n">exported_field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-634"><a href="#ExperimentParametrisation-634"><span class="linenos"> 634</span></a>                    <span class="n">modalities_id_list</span><span class="o">=</span><span class="n">mods_list</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-635"><a href="#ExperimentParametrisation-635"><span class="linenos"> 635</span></a>                    <span class="n">mod_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-636"><a href="#ExperimentParametrisation-636"><span class="linenos"> 636</span></a>                    <span class="n">config_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-637"><a href="#ExperimentParametrisation-637"><span class="linenos"> 637</span></a>                    <span class="n">fluorophore_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-638"><a href="#ExperimentParametrisation-638"><span class="linenos"> 638</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-639"><a href="#ExperimentParametrisation-639"><span class="linenos"> 639</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-640"><a href="#ExperimentParametrisation-640"><span class="linenos"> 640</span></a>                <span class="k">if</span> <span class="n">prints</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-641"><a href="#ExperimentParametrisation-641"><span class="linenos"> 641</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-642"><a href="#ExperimentParametrisation-642"><span class="linenos"> 642</span></a>                        <span class="s2">&quot;Local field missing or unused. Creating imager without particles&quot;</span>
</span><span id="ExperimentParametrisation-643"><a href="#ExperimentParametrisation-643"><span class="linenos"> 643</span></a>                    <span class="p">)</span>
</span><span id="ExperimentParametrisation-644"><a href="#ExperimentParametrisation-644"><span class="linenos"> 644</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span> <span class="n">modality_parameters</span> <span class="o">=</span> <span class="n">create_imaging_system</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-645"><a href="#ExperimentParametrisation-645"><span class="linenos"> 645</span></a>                    <span class="n">modalities_id_list</span><span class="o">=</span><span class="n">mods_list</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-646"><a href="#ExperimentParametrisation-646"><span class="linenos"> 646</span></a>                    <span class="n">mod_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-647"><a href="#ExperimentParametrisation-647"><span class="linenos"> 647</span></a>                    <span class="n">config_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-648"><a href="#ExperimentParametrisation-648"><span class="linenos"> 648</span></a>                    <span class="n">fluorophore_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span>
</span><span id="ExperimentParametrisation-649"><a href="#ExperimentParametrisation-649"><span class="linenos"> 649</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-650"><a href="#ExperimentParametrisation-650"><span class="linenos"> 650</span></a>            <span class="c1"># update the base acquisition parameters to consider all channels</span>
</span><span id="ExperimentParametrisation-651"><a href="#ExperimentParametrisation-651"><span class="linenos"> 651</span></a>            <span class="n">imager_channels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ExperimentParametrisation-652"><a href="#ExperimentParametrisation-652"><span class="linenos"> 652</span></a>            <span class="n">anymod</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-653"><a href="#ExperimentParametrisation-653"><span class="linenos"> 653</span></a>            <span class="k">for</span> <span class="n">chann</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">modalities</span><span class="p">[</span><span class="n">anymod</span><span class="p">][</span><span class="s2">&quot;filters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-654"><a href="#ExperimentParametrisation-654"><span class="linenos"> 654</span></a>                <span class="n">imager_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chann</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-655"><a href="#ExperimentParametrisation-655"><span class="linenos"> 655</span></a>            <span class="n">nchannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imager_channels</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-656"><a href="#ExperimentParametrisation-656"><span class="linenos"> 656</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reset_to_defaults</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s2">&quot;acquisitions&quot;</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">imager_channels</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-657"><a href="#ExperimentParametrisation-657"><span class="linenos"> 657</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;imager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-658"><a href="#ExperimentParametrisation-658"><span class="linenos"> 658</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-659"><a href="#ExperimentParametrisation-659"><span class="linenos"> 659</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imager</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-660"><a href="#ExperimentParametrisation-660"><span class="linenos"> 660</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No modalities&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-661"><a href="#ExperimentParametrisation-661"><span class="linenos"> 661</span></a>
</span><span id="ExperimentParametrisation-662"><a href="#ExperimentParametrisation-662"><span class="linenos"> 662</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_modality_noise_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-663"><a href="#ExperimentParametrisation-663"><span class="linenos"> 663</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-664"><a href="#ExperimentParametrisation-664"><span class="linenos"> 664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">modality_noise_images</span><span class="p">[</span><span class="n">modality_name</span><span class="p">],</span> <span class="n">_beads</span><span class="p">,</span> <span class="n">_im_noiseless</span><span class="p">,</span> <span class="n">_b_noiseless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">generate_imaging</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-665"><a href="#ExperimentParametrisation-665"><span class="linenos"> 665</span></a>                <span class="n">modality</span><span class="o">=</span><span class="n">modality_name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-666"><a href="#ExperimentParametrisation-666"><span class="linenos"> 666</span></a>                <span class="n">noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exp_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-667"><a href="#ExperimentParametrisation-667"><span class="linenos"> 667</span></a>
</span><span id="ExperimentParametrisation-668"><a href="#ExperimentParametrisation-668"><span class="linenos"> 668</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generators_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator_name</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-669"><a href="#ExperimentParametrisation-669"><span class="linenos"> 669</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-670"><a href="#ExperimentParametrisation-670"><span class="linenos"> 670</span></a><span class="sd">        Return the status of the specified generator.</span>
</span><span id="ExperimentParametrisation-671"><a href="#ExperimentParametrisation-671"><span class="linenos"> 671</span></a>
</span><span id="ExperimentParametrisation-672"><a href="#ExperimentParametrisation-672"><span class="linenos"> 672</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-673"><a href="#ExperimentParametrisation-673"><span class="linenos"> 673</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-674"><a href="#ExperimentParametrisation-674"><span class="linenos"> 674</span></a><span class="sd">        :param generator_name : str</span>
</span><span id="ExperimentParametrisation-675"><a href="#ExperimentParametrisation-675"><span class="linenos"> 675</span></a><span class="sd">            The name of the generator whose status is to be retrieved.</span>
</span><span id="ExperimentParametrisation-676"><a href="#ExperimentParametrisation-676"><span class="linenos"> 676</span></a>
</span><span id="ExperimentParametrisation-677"><a href="#ExperimentParametrisation-677"><span class="linenos"> 677</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-678"><a href="#ExperimentParametrisation-678"><span class="linenos"> 678</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-679"><a href="#ExperimentParametrisation-679"><span class="linenos"> 679</span></a><span class="sd">        object</span>
</span><span id="ExperimentParametrisation-680"><a href="#ExperimentParametrisation-680"><span class="linenos"> 680</span></a><span class="sd">            The status or object associated with the given generator name from the objects_created dictionary.</span>
</span><span id="ExperimentParametrisation-681"><a href="#ExperimentParametrisation-681"><span class="linenos"> 681</span></a>
</span><span id="ExperimentParametrisation-682"><a href="#ExperimentParametrisation-682"><span class="linenos"> 682</span></a><span class="sd">        Raises</span>
</span><span id="ExperimentParametrisation-683"><a href="#ExperimentParametrisation-683"><span class="linenos"> 683</span></a><span class="sd">        ------</span>
</span><span id="ExperimentParametrisation-684"><a href="#ExperimentParametrisation-684"><span class="linenos"> 684</span></a><span class="sd">        KeyError</span>
</span><span id="ExperimentParametrisation-685"><a href="#ExperimentParametrisation-685"><span class="linenos"> 685</span></a><span class="sd">            If the specified generator_name does not exist in objects_created.</span>
</span><span id="ExperimentParametrisation-686"><a href="#ExperimentParametrisation-686"><span class="linenos"> 686</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-687"><a href="#ExperimentParametrisation-687"><span class="linenos"> 687</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="n">generator_name</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-688"><a href="#ExperimentParametrisation-688"><span class="linenos"> 688</span></a>
</span><span id="ExperimentParametrisation-689"><a href="#ExperimentParametrisation-689"><span class="linenos"> 689</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-690"><a href="#ExperimentParametrisation-690"><span class="linenos"> 690</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-691"><a href="#ExperimentParametrisation-691"><span class="linenos"> 691</span></a>        <span class="n">use_locals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-692"><a href="#ExperimentParametrisation-692"><span class="linenos"> 692</span></a>        <span class="n">modules</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ExperimentParametrisation-693"><a href="#ExperimentParametrisation-693"><span class="linenos"> 693</span></a>            <span class="s2">&quot;all&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-694"><a href="#ExperimentParametrisation-694"><span class="linenos"> 694</span></a>        <span class="p">],</span>
</span><span id="ExperimentParametrisation-695"><a href="#ExperimentParametrisation-695"><span class="linenos"> 695</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-696"><a href="#ExperimentParametrisation-696"><span class="linenos"> 696</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-697"><a href="#ExperimentParametrisation-697"><span class="linenos"> 697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-698"><a href="#ExperimentParametrisation-698"><span class="linenos"> 698</span></a><span class="sd">        Build various simulation objects based on the specified modules.</span>
</span><span id="ExperimentParametrisation-699"><a href="#ExperimentParametrisation-699"><span class="linenos"> 699</span></a>
</span><span id="ExperimentParametrisation-700"><a href="#ExperimentParametrisation-700"><span class="linenos"> 700</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-701"><a href="#ExperimentParametrisation-701"><span class="linenos"> 701</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-702"><a href="#ExperimentParametrisation-702"><span class="linenos"> 702</span></a><span class="sd">        :param use_locals : bool, optional</span>
</span><span id="ExperimentParametrisation-703"><a href="#ExperimentParametrisation-703"><span class="linenos"> 703</span></a><span class="sd">            Determines whether to use local variables or attributes when building objects. Default is True.</span>
</span><span id="ExperimentParametrisation-704"><a href="#ExperimentParametrisation-704"><span class="linenos"> 704</span></a><span class="sd">        :param modules : list, optional</span>
</span><span id="ExperimentParametrisation-705"><a href="#ExperimentParametrisation-705"><span class="linenos"> 705</span></a><span class="sd">            List of module names to build. If &quot;all&quot; is included, builds all available modules: &quot;structure&quot;, &quot;particle&quot;, &quot;coordinate_field&quot;, and &quot;imager&quot;. Default is [&quot;all&quot;].</span>
</span><span id="ExperimentParametrisation-706"><a href="#ExperimentParametrisation-706"><span class="linenos"> 706</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-707"><a href="#ExperimentParametrisation-707"><span class="linenos"> 707</span></a><span class="sd">            Additional keyword arguments for building modules.</span>
</span><span id="ExperimentParametrisation-708"><a href="#ExperimentParametrisation-708"><span class="linenos"> 708</span></a>
</span><span id="ExperimentParametrisation-709"><a href="#ExperimentParametrisation-709"><span class="linenos"> 709</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation-710"><a href="#ExperimentParametrisation-710"><span class="linenos"> 710</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation-711"><a href="#ExperimentParametrisation-711"><span class="linenos"> 711</span></a><span class="sd">        The order of building is: structure, particle, coordinate_field, imager.</span>
</span><span id="ExperimentParametrisation-712"><a href="#ExperimentParametrisation-712"><span class="linenos"> 712</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-713"><a href="#ExperimentParametrisation-713"><span class="linenos"> 713</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building objects&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-714"><a href="#ExperimentParametrisation-714"><span class="linenos"> 714</span></a>        <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-715"><a href="#ExperimentParametrisation-715"><span class="linenos"> 715</span></a>            <span class="n">build_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ExperimentParametrisation-716"><a href="#ExperimentParametrisation-716"><span class="linenos"> 716</span></a>                <span class="s2">&quot;structure&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-717"><a href="#ExperimentParametrisation-717"><span class="linenos"> 717</span></a>                <span class="s2">&quot;particle&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-718"><a href="#ExperimentParametrisation-718"><span class="linenos"> 718</span></a>                <span class="s2">&quot;coordinate_field&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-719"><a href="#ExperimentParametrisation-719"><span class="linenos"> 719</span></a>                <span class="s2">&quot;imager&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-720"><a href="#ExperimentParametrisation-720"><span class="linenos"> 720</span></a>            <span class="p">]</span>
</span><span id="ExperimentParametrisation-721"><a href="#ExperimentParametrisation-721"><span class="linenos"> 721</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-722"><a href="#ExperimentParametrisation-722"><span class="linenos"> 722</span></a>            <span class="n">build_list</span> <span class="o">=</span> <span class="n">modules</span>
</span><span id="ExperimentParametrisation-723"><a href="#ExperimentParametrisation-723"><span class="linenos"> 723</span></a>        <span class="k">if</span> <span class="s2">&quot;structure&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-724"><a href="#ExperimentParametrisation-724"><span class="linenos"> 724</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_structure</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-725"><a href="#ExperimentParametrisation-725"><span class="linenos"> 725</span></a>        <span class="k">if</span> <span class="s2">&quot;particle&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-726"><a href="#ExperimentParametrisation-726"><span class="linenos"> 726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_particle</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="n">use_locals</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-727"><a href="#ExperimentParametrisation-727"><span class="linenos"> 727</span></a>        <span class="k">if</span> <span class="s2">&quot;coordinate_field&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-728"><a href="#ExperimentParametrisation-728"><span class="linenos"> 728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_coordinate_field</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-729"><a href="#ExperimentParametrisation-729"><span class="linenos"> 729</span></a>                <span class="n">use_self_particle</span><span class="o">=</span><span class="n">use_locals</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="n">use_locals</span>
</span><span id="ExperimentParametrisation-730"><a href="#ExperimentParametrisation-730"><span class="linenos"> 730</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-731"><a href="#ExperimentParametrisation-731"><span class="linenos"> 731</span></a>        <span class="k">if</span> <span class="s2">&quot;imager&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-732"><a href="#ExperimentParametrisation-732"><span class="linenos"> 732</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_imager</span><span class="p">(</span><span class="n">use_local_field</span><span class="o">=</span><span class="n">use_locals</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-733"><a href="#ExperimentParametrisation-733"><span class="linenos"> 733</span></a>
</span><span id="ExperimentParametrisation-734"><a href="#ExperimentParametrisation-734"><span class="linenos"> 734</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_reference</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-735"><a href="#ExperimentParametrisation-735"><span class="linenos"> 735</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ref_acq_pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modality_wise</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ExperimentParametrisation-736"><a href="#ExperimentParametrisation-736"><span class="linenos"> 736</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-737"><a href="#ExperimentParametrisation-737"><span class="linenos"> 737</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-738"><a href="#ExperimentParametrisation-738"><span class="linenos"> 738</span></a><span class="sd">        Calculate a reference image of the virtual sample by using the ideal parameters for each of the parameters to sweep.</span>
</span><span id="ExperimentParametrisation-739"><a href="#ExperimentParametrisation-739"><span class="linenos"> 739</span></a>
</span><span id="ExperimentParametrisation-740"><a href="#ExperimentParametrisation-740"><span class="linenos"> 740</span></a><span class="sd">        Requires the dictionary of the params2sweep. If modality_wise is True (default), a reference is calculated for each modality with that modality&#39;s parameters. Otherwise, it will use the Reference modality configuration to generate an idealised image as reference.</span>
</span><span id="ExperimentParametrisation-741"><a href="#ExperimentParametrisation-741"><span class="linenos"> 741</span></a>
</span><span id="ExperimentParametrisation-742"><a href="#ExperimentParametrisation-742"><span class="linenos"> 742</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-743"><a href="#ExperimentParametrisation-743"><span class="linenos"> 743</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-744"><a href="#ExperimentParametrisation-744"><span class="linenos"> 744</span></a><span class="sd">        :param write : bool, optional</span>
</span><span id="ExperimentParametrisation-745"><a href="#ExperimentParametrisation-745"><span class="linenos"> 745</span></a><span class="sd">            Whether to write the reference image to disk. Default is False.</span>
</span><span id="ExperimentParametrisation-746"><a href="#ExperimentParametrisation-746"><span class="linenos"> 746</span></a><span class="sd">        :param keep : bool, optional</span>
</span><span id="ExperimentParametrisation-747"><a href="#ExperimentParametrisation-747"><span class="linenos"> 747</span></a><span class="sd">            If True, store the reference in the experiment. Default is False.</span>
</span><span id="ExperimentParametrisation-748"><a href="#ExperimentParametrisation-748"><span class="linenos"> 748</span></a><span class="sd">        :param ref_acq_pars : dict or None, optional</span>
</span><span id="ExperimentParametrisation-749"><a href="#ExperimentParametrisation-749"><span class="linenos"> 749</span></a><span class="sd">            Acquisition parameters for the reference. Default is None.</span>
</span><span id="ExperimentParametrisation-750"><a href="#ExperimentParametrisation-750"><span class="linenos"> 750</span></a><span class="sd">        :param modality_wise : bool, optional</span>
</span><span id="ExperimentParametrisation-751"><a href="#ExperimentParametrisation-751"><span class="linenos"> 751</span></a><span class="sd">            If True, calculate reference for each modality. Default is False.</span>
</span><span id="ExperimentParametrisation-752"><a href="#ExperimentParametrisation-752"><span class="linenos"> 752</span></a>
</span><span id="ExperimentParametrisation-753"><a href="#ExperimentParametrisation-753"><span class="linenos"> 753</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-754"><a href="#ExperimentParametrisation-754"><span class="linenos"> 754</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-755"><a href="#ExperimentParametrisation-755"><span class="linenos"> 755</span></a><span class="sd">        tuple</span>
</span><span id="ExperimentParametrisation-756"><a href="#ExperimentParametrisation-756"><span class="linenos"> 756</span></a><span class="sd">            (_reference, _reference_parameters)</span>
</span><span id="ExperimentParametrisation-757"><a href="#ExperimentParametrisation-757"><span class="linenos"> 757</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-758"><a href="#ExperimentParametrisation-758"><span class="linenos"> 758</span></a>        <span class="n">reference_pars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-759"><a href="#ExperimentParametrisation-759"><span class="linenos"> 759</span></a>        <span class="n">output_name</span> <span class="o">=</span> <span class="s2">&quot;REFERENCE_&quot;</span>
</span><span id="ExperimentParametrisation-760"><a href="#ExperimentParametrisation-760"><span class="linenos"> 760</span></a>        <span class="c1"># get ideal parameters for virtual sample</span>
</span><span id="ExperimentParametrisation-761"><a href="#ExperimentParametrisation-761"><span class="linenos"> 761</span></a>        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_settings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_pars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-762"><a href="#ExperimentParametrisation-762"><span class="linenos"> 762</span></a>            <span class="n">reference_pars</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_settings</span><span class="p">[</span><span class="s2">&quot;ideal&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-763"><a href="#ExperimentParametrisation-763"><span class="linenos"> 763</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">reference_pars</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-764"><a href="#ExperimentParametrisation-764"><span class="linenos"> 764</span></a>        <span class="c1"># generate particle</span>
</span><span id="ExperimentParametrisation-765"><a href="#ExperimentParametrisation-765"><span class="linenos"> 765</span></a>        <span class="n">tmp_particle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_particle</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-766"><a href="#ExperimentParametrisation-766"><span class="linenos"> 766</span></a>            <span class="n">lab_eff</span><span class="o">=</span><span class="n">reference_pars</span><span class="p">[</span><span class="s2">&quot;labelling_efficiency&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span>
</span><span id="ExperimentParametrisation-767"><a href="#ExperimentParametrisation-767"><span class="linenos"> 767</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-768"><a href="#ExperimentParametrisation-768"><span class="linenos"> 768</span></a>        <span class="c1"># use particle to create new field</span>
</span><span id="ExperimentParametrisation-769"><a href="#ExperimentParametrisation-769"><span class="linenos"> 769</span></a>        <span class="n">tmp_exported_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_coordinate_field</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-770"><a href="#ExperimentParametrisation-770"><span class="linenos"> 770</span></a>        <span class="c1"># create ideal image modality</span>
</span><span id="ExperimentParametrisation-771"><a href="#ExperimentParametrisation-771"><span class="linenos"> 771</span></a>        <span class="k">if</span> <span class="n">modality_wise</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-772"><a href="#ExperimentParametrisation-772"><span class="linenos"> 772</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">import_field</span><span class="p">(</span><span class="o">**</span><span class="n">tmp_exported_field</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-773"><a href="#ExperimentParametrisation-773"><span class="linenos"> 773</span></a>            <span class="n">_reference</span> <span class="o">=</span> <span class="n">generate_multi_imaging_modalities</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-774"><a href="#ExperimentParametrisation-774"><span class="linenos"> 774</span></a>                <span class="n">image_generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-775"><a href="#ExperimentParametrisation-775"><span class="linenos"> 775</span></a>                <span class="n">experiment_name</span><span class="o">=</span><span class="n">output_name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-776"><a href="#ExperimentParametrisation-776"><span class="linenos"> 776</span></a>                <span class="n">savingdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-777"><a href="#ExperimentParametrisation-777"><span class="linenos"> 777</span></a>                <span class="n">write</span><span class="o">=</span><span class="n">write</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-778"><a href="#ExperimentParametrisation-778"><span class="linenos"> 778</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-779"><a href="#ExperimentParametrisation-779"><span class="linenos"> 779</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-780"><a href="#ExperimentParametrisation-780"><span class="linenos"> 780</span></a>            <span class="n">reference_imager</span><span class="p">,</span> <span class="n">ref_modality_parameters</span> <span class="o">=</span> <span class="n">create_imaging_system</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-781"><a href="#ExperimentParametrisation-781"><span class="linenos"> 781</span></a>                <span class="n">modalities_id_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">],</span>
</span><span id="ExperimentParametrisation-782"><a href="#ExperimentParametrisation-782"><span class="linenos"> 782</span></a>                <span class="n">config_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-783"><a href="#ExperimentParametrisation-783"><span class="linenos"> 783</span></a>                <span class="n">fluorophore_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span>
</span><span id="ExperimentParametrisation-784"><a href="#ExperimentParametrisation-784"><span class="linenos"> 784</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-785"><a href="#ExperimentParametrisation-785"><span class="linenos"> 785</span></a>            <span class="n">reference_imager</span><span class="o">.</span><span class="n">import_field</span><span class="p">(</span><span class="o">**</span><span class="n">tmp_exported_field</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-786"><a href="#ExperimentParametrisation-786"><span class="linenos"> 786</span></a>            <span class="c1"># make a copy</span>
</span><span id="ExperimentParametrisation-787"><a href="#ExperimentParametrisation-787"><span class="linenos"> 787</span></a>            <span class="n">_reference</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-788"><a href="#ExperimentParametrisation-788"><span class="linenos"> 788</span></a>            <span class="n">_reference_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-789"><a href="#ExperimentParametrisation-789"><span class="linenos"> 789</span></a>            <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="ExperimentParametrisation-790"><a href="#ExperimentParametrisation-790"><span class="linenos"> 790</span></a>                <span class="n">_reference_iteration</span> <span class="o">=</span> <span class="n">generate_multi_imaging_modalities</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-791"><a href="#ExperimentParametrisation-791"><span class="linenos"> 791</span></a>                    <span class="n">image_generator</span><span class="o">=</span><span class="n">reference_imager</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-792"><a href="#ExperimentParametrisation-792"><span class="linenos"> 792</span></a>                    <span class="n">experiment_name</span><span class="o">=</span><span class="n">output_name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-793"><a href="#ExperimentParametrisation-793"><span class="linenos"> 793</span></a>                    <span class="n">acquisition_param</span><span class="o">=</span><span class="n">ref_acq_pars</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-794"><a href="#ExperimentParametrisation-794"><span class="linenos"> 794</span></a>                    <span class="n">savingdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-795"><a href="#ExperimentParametrisation-795"><span class="linenos"> 795</span></a>                    <span class="n">write</span><span class="o">=</span><span class="n">write</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-796"><a href="#ExperimentParametrisation-796"><span class="linenos"> 796</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-797"><a href="#ExperimentParametrisation-797"><span class="linenos"> 797</span></a>                <span class="n">_reference</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_reference_iteration</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-798"><a href="#ExperimentParametrisation-798"><span class="linenos"> 798</span></a>                <span class="n">imager_scale</span> <span class="o">=</span> <span class="n">reference_imager</span><span class="o">.</span><span class="n">roi_params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-799"><a href="#ExperimentParametrisation-799"><span class="linenos"> 799</span></a>                <span class="n">scalefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-800"><a href="#ExperimentParametrisation-800"><span class="linenos"> 800</span></a>                    <span class="n">imager_scale</span> <span class="o">/</span> <span class="mf">1e-9</span>
</span><span id="ExperimentParametrisation-801"><a href="#ExperimentParametrisation-801"><span class="linenos"> 801</span></a>                <span class="p">)</span>  <span class="c1"># resulting pixel size in nanometers</span>
</span><span id="ExperimentParametrisation-802"><a href="#ExperimentParametrisation-802"><span class="linenos"> 802</span></a>                <span class="n">_reference_parameters</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-803"><a href="#ExperimentParametrisation-803"><span class="linenos"> 803</span></a>                    <span class="n">ref_pixelsize</span><span class="o">=</span><span class="n">reference_imager</span><span class="o">.</span><span class="n">modalities</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-804"><a href="#ExperimentParametrisation-804"><span class="linenos"> 804</span></a>                        <span class="s2">&quot;detector&quot;</span>
</span><span id="ExperimentParametrisation-805"><a href="#ExperimentParametrisation-805"><span class="linenos"> 805</span></a>                    <span class="p">][</span><span class="s2">&quot;pixelsize&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-806"><a href="#ExperimentParametrisation-806"><span class="linenos"> 806</span></a>                    <span class="o">*</span> <span class="n">scalefactor</span>
</span><span id="ExperimentParametrisation-807"><a href="#ExperimentParametrisation-807"><span class="linenos"> 807</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation-808"><a href="#ExperimentParametrisation-808"><span class="linenos"> 808</span></a>        <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-809"><a href="#ExperimentParametrisation-809"><span class="linenos"> 809</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">experiment_reference</span> <span class="o">=</span> <span class="n">_reference</span>
</span><span id="ExperimentParametrisation-810"><a href="#ExperimentParametrisation-810"><span class="linenos"> 810</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;output_reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-811"><a href="#ExperimentParametrisation-811"><span class="linenos"> 811</span></a>        <span class="k">return</span> <span class="n">_reference</span><span class="p">,</span> <span class="n">_reference_parameters</span>
</span><span id="ExperimentParametrisation-812"><a href="#ExperimentParametrisation-812"><span class="linenos"> 812</span></a>
</span><span id="ExperimentParametrisation-813"><a href="#ExperimentParametrisation-813"><span class="linenos"> 813</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_labelled_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-814"><a href="#ExperimentParametrisation-814"><span class="linenos"> 814</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">remove_probes</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-815"><a href="#ExperimentParametrisation-815"><span class="linenos"> 815</span></a>
</span><span id="ExperimentParametrisation-816"><a href="#ExperimentParametrisation-816"><span class="linenos"> 816</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_virtual_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-817"><a href="#ExperimentParametrisation-817"><span class="linenos"> 817</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-818"><a href="#ExperimentParametrisation-818"><span class="linenos"> 818</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-819"><a href="#ExperimentParametrisation-819"><span class="linenos"> 819</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;exported_coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation-820"><a href="#ExperimentParametrisation-820"><span class="linenos"> 820</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Virtual sample cleared&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-821"><a href="#ExperimentParametrisation-821"><span class="linenos"> 821</span></a>
</span><span id="ExperimentParametrisation-822"><a href="#ExperimentParametrisation-822"><span class="linenos"> 822</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_example_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-823"><a href="#ExperimentParametrisation-823"><span class="linenos"> 823</span></a>        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">capture_output</span><span class="p">()</span> <span class="k">as</span> <span class="n">captured</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-824"><a href="#ExperimentParametrisation-824"><span class="linenos"> 824</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">select_structure</span><span class="p">(</span><span class="s2">&quot;1XI5&quot;</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-825"><a href="#ExperimentParametrisation-825"><span class="linenos"> 825</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_probe</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-826"><a href="#ExperimentParametrisation-826"><span class="linenos"> 826</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_virtualsample_params</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-827"><a href="#ExperimentParametrisation-827"><span class="linenos"> 827</span></a>            <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">example_modalities</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-828"><a href="#ExperimentParametrisation-828"><span class="linenos"> 828</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">modality_name</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-829"><a href="#ExperimentParametrisation-829"><span class="linenos"> 829</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-830"><a href="#ExperimentParametrisation-830"><span class="linenos"> 830</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Experiment created with default parameters&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-831"><a href="#ExperimentParametrisation-831"><span class="linenos"> 831</span></a>
</span><span id="ExperimentParametrisation-832"><a href="#ExperimentParametrisation-832"><span class="linenos"> 832</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-833"><a href="#ExperimentParametrisation-833"><span class="linenos"> 833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-834"><a href="#ExperimentParametrisation-834"><span class="linenos"> 834</span></a><span class="sd">        Clear the current experiment by resetting all parameters and objects.</span>
</span><span id="ExperimentParametrisation-835"><a href="#ExperimentParametrisation-835"><span class="linenos"> 835</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-836"><a href="#ExperimentParametrisation-836"><span class="linenos"> 836</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_structure</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-837"><a href="#ExperimentParametrisation-837"><span class="linenos"> 837</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_labelled_structure</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-838"><a href="#ExperimentParametrisation-838"><span class="linenos"> 838</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_virtual_sample</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-839"><a href="#ExperimentParametrisation-839"><span class="linenos"> 839</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_modalities</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-840"><a href="#ExperimentParametrisation-840"><span class="linenos"> 840</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-841"><a href="#ExperimentParametrisation-841"><span class="linenos"> 841</span></a>
</span><span id="ExperimentParametrisation-842"><a href="#ExperimentParametrisation-842"><span class="linenos"> 842</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-843"><a href="#ExperimentParametrisation-843"><span class="linenos"> 843</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-844"><a href="#ExperimentParametrisation-844"><span class="linenos"> 844</span></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vlab4mic_experiment&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-845"><a href="#ExperimentParametrisation-845"><span class="linenos"> 845</span></a>        <span class="n">acq_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-846"><a href="#ExperimentParametrisation-846"><span class="linenos"> 846</span></a>        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-847"><a href="#ExperimentParametrisation-847"><span class="linenos"> 847</span></a>        <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-848"><a href="#ExperimentParametrisation-848"><span class="linenos"> 848</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-849"><a href="#ExperimentParametrisation-849"><span class="linenos"> 849</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-850"><a href="#ExperimentParametrisation-850"><span class="linenos"> 850</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-851"><a href="#ExperimentParametrisation-851"><span class="linenos"> 851</span></a><span class="sd">        Run a simulation for the specified imaging modality or all modalities.</span>
</span><span id="ExperimentParametrisation-852"><a href="#ExperimentParametrisation-852"><span class="linenos"> 852</span></a>
</span><span id="ExperimentParametrisation-853"><a href="#ExperimentParametrisation-853"><span class="linenos"> 853</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-854"><a href="#ExperimentParametrisation-854"><span class="linenos"> 854</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-855"><a href="#ExperimentParametrisation-855"><span class="linenos"> 855</span></a><span class="sd">        :param name : str, optional</span>
</span><span id="ExperimentParametrisation-856"><a href="#ExperimentParametrisation-856"><span class="linenos"> 856</span></a><span class="sd">            Name of the experiment or simulation. Default is &quot;vlab4mic_experiment&quot;.</span>
</span><span id="ExperimentParametrisation-857"><a href="#ExperimentParametrisation-857"><span class="linenos"> 857</span></a><span class="sd">        :param acq_params : dict or None, optional</span>
</span><span id="ExperimentParametrisation-858"><a href="#ExperimentParametrisation-858"><span class="linenos"> 858</span></a><span class="sd">            Acquisition parameters for the simulation. If None and modality is &quot;All&quot;, uses self.selected_mods.</span>
</span><span id="ExperimentParametrisation-859"><a href="#ExperimentParametrisation-859"><span class="linenos"> 859</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="ExperimentParametrisation-860"><a href="#ExperimentParametrisation-860"><span class="linenos"> 860</span></a><span class="sd">            Whether to save the simulation output to disk. Default is False.</span>
</span><span id="ExperimentParametrisation-861"><a href="#ExperimentParametrisation-861"><span class="linenos"> 861</span></a><span class="sd">        :param modality : str, optional</span>
</span><span id="ExperimentParametrisation-862"><a href="#ExperimentParametrisation-862"><span class="linenos"> 862</span></a><span class="sd">            The imaging modality to simulate. If &quot;All&quot;, simulates all available modalities. Default is &quot;All&quot;.</span>
</span><span id="ExperimentParametrisation-863"><a href="#ExperimentParametrisation-863"><span class="linenos"> 863</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-864"><a href="#ExperimentParametrisation-864"><span class="linenos"> 864</span></a><span class="sd">            Additional keyword arguments passed to the imaging generator.</span>
</span><span id="ExperimentParametrisation-865"><a href="#ExperimentParametrisation-865"><span class="linenos"> 865</span></a>
</span><span id="ExperimentParametrisation-866"><a href="#ExperimentParametrisation-866"><span class="linenos"> 866</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-867"><a href="#ExperimentParametrisation-867"><span class="linenos"> 867</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-868"><a href="#ExperimentParametrisation-868"><span class="linenos"> 868</span></a><span class="sd">        dict or None</span>
</span><span id="ExperimentParametrisation-869"><a href="#ExperimentParametrisation-869"><span class="linenos"> 869</span></a><span class="sd">            Simulation output as a dictionary mapping modality names to results. Returns None if the imager could not be created.</span>
</span><span id="ExperimentParametrisation-870"><a href="#ExperimentParametrisation-870"><span class="linenos"> 870</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-871"><a href="#ExperimentParametrisation-871"><span class="linenos"> 871</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;imager&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-872"><a href="#ExperimentParametrisation-872"><span class="linenos"> 872</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="s2">&quot;imager&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-873"><a href="#ExperimentParametrisation-873"><span class="linenos"> 873</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-874"><a href="#ExperimentParametrisation-874"><span class="linenos"> 874</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Imager not created. Cannot run simulation.&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-875"><a href="#ExperimentParametrisation-875"><span class="linenos"> 875</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-876"><a href="#ExperimentParametrisation-876"><span class="linenos"> 876</span></a>        <span class="k">if</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-877"><a href="#ExperimentParametrisation-877"><span class="linenos"> 877</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulating all modalities&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-878"><a href="#ExperimentParametrisation-878"><span class="linenos"> 878</span></a>            <span class="k">if</span> <span class="n">acq_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-879"><a href="#ExperimentParametrisation-879"><span class="linenos"> 879</span></a>                <span class="n">acq_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span>
</span><span id="ExperimentParametrisation-880"><a href="#ExperimentParametrisation-880"><span class="linenos"> 880</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-881"><a href="#ExperimentParametrisation-881"><span class="linenos"> 881</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span>
</span><span id="ExperimentParametrisation-882"><a href="#ExperimentParametrisation-882"><span class="linenos"> 882</span></a>            <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span> <span class="o">=</span> <span class="n">generate_multi_imaging_modalities</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-883"><a href="#ExperimentParametrisation-883"><span class="linenos"> 883</span></a>                <span class="n">image_generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-884"><a href="#ExperimentParametrisation-884"><span class="linenos"> 884</span></a>                <span class="n">experiment_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-885"><a href="#ExperimentParametrisation-885"><span class="linenos"> 885</span></a>                <span class="n">savingdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-886"><a href="#ExperimentParametrisation-886"><span class="linenos"> 886</span></a>                <span class="n">write</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-887"><a href="#ExperimentParametrisation-887"><span class="linenos"> 887</span></a>                <span class="n">acquisition_param</span><span class="o">=</span><span class="n">acq_params</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-888"><a href="#ExperimentParametrisation-888"><span class="linenos"> 888</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-889"><a href="#ExperimentParametrisation-889"><span class="linenos"> 889</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">simulation_output</span>
</span><span id="ExperimentParametrisation-890"><a href="#ExperimentParametrisation-890"><span class="linenos"> 890</span></a>            <span class="k">return</span> <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span>
</span><span id="ExperimentParametrisation-891"><a href="#ExperimentParametrisation-891"><span class="linenos"> 891</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-892"><a href="#ExperimentParametrisation-892"><span class="linenos"> 892</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulating: </span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-893"><a href="#ExperimentParametrisation-893"><span class="linenos"> 893</span></a>            <span class="n">acq_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-894"><a href="#ExperimentParametrisation-894"><span class="linenos"> 894</span></a>            <span class="n">timeseries_noise</span><span class="p">,</span> <span class="n">beads_noise</span><span class="p">,</span> <span class="n">timeseries_noiseless</span><span class="p">,</span> <span class="n">beads_noiseless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">generate_imaging</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-895"><a href="#ExperimentParametrisation-895"><span class="linenos"> 895</span></a>                <span class="n">modality</span><span class="o">=</span><span class="n">modality</span><span class="p">,</span> <span class="o">**</span><span class="n">acq_p</span>
</span><span id="ExperimentParametrisation-896"><a href="#ExperimentParametrisation-896"><span class="linenos"> 896</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-897"><a href="#ExperimentParametrisation-897"><span class="linenos"> 897</span></a>            <span class="n">simulation_output</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ExperimentParametrisation-898"><a href="#ExperimentParametrisation-898"><span class="linenos"> 898</span></a>            <span class="n">simulation_output_noiseless</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ExperimentParametrisation-899"><a href="#ExperimentParametrisation-899"><span class="linenos"> 899</span></a>            <span class="n">simulation_output</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries_noise</span>
</span><span id="ExperimentParametrisation-900"><a href="#ExperimentParametrisation-900"><span class="linenos"> 900</span></a>            <span class="n">simulation_output_noiseless</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries_noiseless</span>
</span><span id="ExperimentParametrisation-901"><a href="#ExperimentParametrisation-901"><span class="linenos"> 901</span></a>            <span class="k">return</span> <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span>
</span><span id="ExperimentParametrisation-902"><a href="#ExperimentParametrisation-902"><span class="linenos"> 902</span></a>
</span><span id="ExperimentParametrisation-903"><a href="#ExperimentParametrisation-903"><span class="linenos"> 903</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_probes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-904"><a href="#ExperimentParametrisation-904"><span class="linenos"> 904</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-905"><a href="#ExperimentParametrisation-905"><span class="linenos"> 905</span></a><span class="sd">        Remove all probe-related parameters and update the internal state accordingly.</span>
</span><span id="ExperimentParametrisation-906"><a href="#ExperimentParametrisation-906"><span class="linenos"> 906</span></a>
</span><span id="ExperimentParametrisation-907"><a href="#ExperimentParametrisation-907"><span class="linenos"> 907</span></a><span class="sd">        This method clears the probe parameters, updates the probes, and resets the</span>
</span><span id="ExperimentParametrisation-908"><a href="#ExperimentParametrisation-908"><span class="linenos"> 908</span></a><span class="sd">        particle and structure objects if their respective generators are active.</span>
</span><span id="ExperimentParametrisation-909"><a href="#ExperimentParametrisation-909"><span class="linenos"> 909</span></a><span class="sd">        It also clears any labels associated with the structure.</span>
</span><span id="ExperimentParametrisation-910"><a href="#ExperimentParametrisation-910"><span class="linenos"> 910</span></a>
</span><span id="ExperimentParametrisation-911"><a href="#ExperimentParametrisation-911"><span class="linenos"> 911</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-912"><a href="#ExperimentParametrisation-912"><span class="linenos"> 912</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-913"><a href="#ExperimentParametrisation-913"><span class="linenos"> 913</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-914"><a href="#ExperimentParametrisation-914"><span class="linenos"> 914</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-915"><a href="#ExperimentParametrisation-915"><span class="linenos"> 915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-916"><a href="#ExperimentParametrisation-916"><span class="linenos"> 916</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_probes</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-917"><a href="#ExperimentParametrisation-917"><span class="linenos"> 917</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;particle&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-918"><a href="#ExperimentParametrisation-918"><span class="linenos"> 918</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">particle</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-919"><a href="#ExperimentParametrisation-919"><span class="linenos"> 919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;particle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation-920"><a href="#ExperimentParametrisation-920"><span class="linenos"> 920</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Labelled structure cleared&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-921"><a href="#ExperimentParametrisation-921"><span class="linenos"> 921</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-922"><a href="#ExperimentParametrisation-922"><span class="linenos"> 922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">_clear_labels</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-923"><a href="#ExperimentParametrisation-923"><span class="linenos"> 923</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Probes removed from experiment&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-924"><a href="#ExperimentParametrisation-924"><span class="linenos"> 924</span></a>
</span><span id="ExperimentParametrisation-925"><a href="#ExperimentParametrisation-925"><span class="linenos"> 925</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_probe</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-926"><a href="#ExperimentParametrisation-926"><span class="linenos"> 926</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-927"><a href="#ExperimentParametrisation-927"><span class="linenos"> 927</span></a>        <span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-928"><a href="#ExperimentParametrisation-928"><span class="linenos"> 928</span></a>        <span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-929"><a href="#ExperimentParametrisation-929"><span class="linenos"> 929</span></a>        <span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-930"><a href="#ExperimentParametrisation-930"><span class="linenos"> 930</span></a>        <span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-931"><a href="#ExperimentParametrisation-931"><span class="linenos"> 931</span></a>        <span class="n">probe_target_option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-932"><a href="#ExperimentParametrisation-932"><span class="linenos"> 932</span></a>        <span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-933"><a href="#ExperimentParametrisation-933"><span class="linenos"> 933</span></a>        <span class="n">probe_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-934"><a href="#ExperimentParametrisation-934"><span class="linenos"> 934</span></a>        <span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-935"><a href="#ExperimentParametrisation-935"><span class="linenos"> 935</span></a>        <span class="n">probe_steric_hindrance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-936"><a href="#ExperimentParametrisation-936"><span class="linenos"> 936</span></a>        <span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-937"><a href="#ExperimentParametrisation-937"><span class="linenos"> 937</span></a>        <span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-938"><a href="#ExperimentParametrisation-938"><span class="linenos"> 938</span></a>        <span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-939"><a href="#ExperimentParametrisation-939"><span class="linenos"> 939</span></a>        <span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-940"><a href="#ExperimentParametrisation-940"><span class="linenos"> 940</span></a>        <span class="n">probe_wobble_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-941"><a href="#ExperimentParametrisation-941"><span class="linenos"> 941</span></a>        <span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-942"><a href="#ExperimentParametrisation-942"><span class="linenos"> 942</span></a>        <span class="n">as_primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-943"><a href="#ExperimentParametrisation-943"><span class="linenos"> 943</span></a>        <span class="n">peptide_motif</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-944"><a href="#ExperimentParametrisation-944"><span class="linenos"> 944</span></a>        <span class="n">fluorophore_parameters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-945"><a href="#ExperimentParametrisation-945"><span class="linenos"> 945</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-946"><a href="#ExperimentParametrisation-946"><span class="linenos"> 946</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-947"><a href="#ExperimentParametrisation-947"><span class="linenos"> 947</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-948"><a href="#ExperimentParametrisation-948"><span class="linenos"> 948</span></a><span class="sd">        Add a probe configuration to the experiment.</span>
</span><span id="ExperimentParametrisation-949"><a href="#ExperimentParametrisation-949"><span class="linenos"> 949</span></a>
</span><span id="ExperimentParametrisation-950"><a href="#ExperimentParametrisation-950"><span class="linenos"> 950</span></a><span class="sd">        This method loads a probe configuration from a YAML file, updates its parameters based on the provided arguments,</span>
</span><span id="ExperimentParametrisation-951"><a href="#ExperimentParametrisation-951"><span class="linenos"> 951</span></a><span class="sd">        and stores it in the experiment&#39;s probe parameters. It supports customization of probe properties such as target type,</span>
</span><span id="ExperimentParametrisation-952"><a href="#ExperimentParametrisation-952"><span class="linenos"> 952</span></a><span class="sd">        fluorophore, model, conjugation details, and more.</span>
</span><span id="ExperimentParametrisation-953"><a href="#ExperimentParametrisation-953"><span class="linenos"> 953</span></a>
</span><span id="ExperimentParametrisation-954"><a href="#ExperimentParametrisation-954"><span class="linenos"> 954</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-955"><a href="#ExperimentParametrisation-955"><span class="linenos"> 955</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-956"><a href="#ExperimentParametrisation-956"><span class="linenos"> 956</span></a><span class="sd">        :param probe_name : str, optional</span>
</span><span id="ExperimentParametrisation-957"><a href="#ExperimentParametrisation-957"><span class="linenos"> 957</span></a><span class="sd">            Name of the probe. Default is &quot;NHS_ester&quot;.</span>
</span><span id="ExperimentParametrisation-958"><a href="#ExperimentParametrisation-958"><span class="linenos"> 958</span></a><span class="sd">        :param probe_target_type : str, optional</span>
</span><span id="ExperimentParametrisation-959"><a href="#ExperimentParametrisation-959"><span class="linenos"> 959</span></a><span class="sd">            Type of the probe target (e.g., &quot;Primary&quot;, &quot;Secondary&quot;).</span>
</span><span id="ExperimentParametrisation-960"><a href="#ExperimentParametrisation-960"><span class="linenos"> 960</span></a><span class="sd">        :param probe_target_value : str, optional</span>
</span><span id="ExperimentParametrisation-961"><a href="#ExperimentParametrisation-961"><span class="linenos"> 961</span></a><span class="sd">            Value or identifier of the probe target.</span>
</span><span id="ExperimentParametrisation-962"><a href="#ExperimentParametrisation-962"><span class="linenos"> 962</span></a><span class="sd">        :param probe_target_option : str, optional</span>
</span><span id="ExperimentParametrisation-963"><a href="#ExperimentParametrisation-963"><span class="linenos"> 963</span></a><span class="sd">            Additional option for the probe target, used for secondary epitopes.</span>
</span><span id="ExperimentParametrisation-964"><a href="#ExperimentParametrisation-964"><span class="linenos"> 964</span></a><span class="sd">        :param probe_distance_to_epitope : float, optional</span>
</span><span id="ExperimentParametrisation-965"><a href="#ExperimentParametrisation-965"><span class="linenos"> 965</span></a><span class="sd">            Distance from the probe to the epitope.</span>
</span><span id="ExperimentParametrisation-966"><a href="#ExperimentParametrisation-966"><span class="linenos"> 966</span></a><span class="sd">        :param probe_model : str, optional</span>
</span><span id="ExperimentParametrisation-967"><a href="#ExperimentParametrisation-967"><span class="linenos"> 967</span></a><span class="sd">            List of model identifiers for the probe.</span>
</span><span id="ExperimentParametrisation-968"><a href="#ExperimentParametrisation-968"><span class="linenos"> 968</span></a><span class="sd">        :param probe_fluorophore : str, optional</span>
</span><span id="ExperimentParametrisation-969"><a href="#ExperimentParametrisation-969"><span class="linenos"> 969</span></a><span class="sd">            Identifier for the fluorophore. Default is &quot;AF647&quot;.</span>
</span><span id="ExperimentParametrisation-970"><a href="#ExperimentParametrisation-970"><span class="linenos"> 970</span></a><span class="sd">        :param probe_steric_hindrance : Any, optional</span>
</span><span id="ExperimentParametrisation-971"><a href="#ExperimentParametrisation-971"><span class="linenos"> 971</span></a><span class="sd">            Steric hindrance value or configuration.</span>
</span><span id="ExperimentParametrisation-972"><a href="#ExperimentParametrisation-972"><span class="linenos"> 972</span></a><span class="sd">        :param probe_paratope : str, optional</span>
</span><span id="ExperimentParametrisation-973"><a href="#ExperimentParametrisation-973"><span class="linenos"> 973</span></a><span class="sd">            Paratope identifier or information.</span>
</span><span id="ExperimentParametrisation-974"><a href="#ExperimentParametrisation-974"><span class="linenos"> 974</span></a><span class="sd">        :param probe_conjugation_target_info : Any, optional</span>
</span><span id="ExperimentParametrisation-975"><a href="#ExperimentParametrisation-975"><span class="linenos"> 975</span></a><span class="sd">            Information about the conjugation target.</span>
</span><span id="ExperimentParametrisation-976"><a href="#ExperimentParametrisation-976"><span class="linenos"> 976</span></a><span class="sd">        :param probe_DoL : float, optional</span>
</span><span id="ExperimentParametrisation-977"><a href="#ExperimentParametrisation-977"><span class="linenos"> 977</span></a><span class="sd">            Efficiency of the probe conjugation.</span>
</span><span id="ExperimentParametrisation-978"><a href="#ExperimentParametrisation-978"><span class="linenos"> 978</span></a><span class="sd">        :param probe_seconday_epitope : Any, optional</span>
</span><span id="ExperimentParametrisation-979"><a href="#ExperimentParametrisation-979"><span class="linenos"> 979</span></a><span class="sd">            Information about a secondary epitope target.</span>
</span><span id="ExperimentParametrisation-980"><a href="#ExperimentParametrisation-980"><span class="linenos"> 980</span></a><span class="sd">        :param probe_wobbling : bool, optional</span>
</span><span id="ExperimentParametrisation-981"><a href="#ExperimentParametrisation-981"><span class="linenos"> 981</span></a><span class="sd">            Whether to enable probe wobbling. Default is False.</span>
</span><span id="ExperimentParametrisation-982"><a href="#ExperimentParametrisation-982"><span class="linenos"> 982</span></a><span class="sd">        :param labelling_efficiency : float, optional</span>
</span><span id="ExperimentParametrisation-983"><a href="#ExperimentParametrisation-983"><span class="linenos"> 983</span></a><span class="sd">            Efficiency of probe labelling. Default is 1.0.</span>
</span><span id="ExperimentParametrisation-984"><a href="#ExperimentParametrisation-984"><span class="linenos"> 984</span></a><span class="sd">        :param as_primary : bool, optional</span>
</span><span id="ExperimentParametrisation-985"><a href="#ExperimentParametrisation-985"><span class="linenos"> 985</span></a><span class="sd">            Whether to treat the probe as a primary linker. Default is False.</span>
</span><span id="ExperimentParametrisation-986"><a href="#ExperimentParametrisation-986"><span class="linenos"> 986</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-987"><a href="#ExperimentParametrisation-987"><span class="linenos"> 987</span></a><span class="sd">            Additional keyword arguments for future extensions.</span>
</span><span id="ExperimentParametrisation-988"><a href="#ExperimentParametrisation-988"><span class="linenos"> 988</span></a>
</span><span id="ExperimentParametrisation-989"><a href="#ExperimentParametrisation-989"><span class="linenos"> 989</span></a><span class="sd">        Raises</span>
</span><span id="ExperimentParametrisation-990"><a href="#ExperimentParametrisation-990"><span class="linenos"> 990</span></a><span class="sd">        ------</span>
</span><span id="ExperimentParametrisation-991"><a href="#ExperimentParametrisation-991"><span class="linenos"> 991</span></a><span class="sd">        FileNotFoundError</span>
</span><span id="ExperimentParametrisation-992"><a href="#ExperimentParametrisation-992"><span class="linenos"> 992</span></a><span class="sd">            If the probe configuration YAML file does not exist.</span>
</span><span id="ExperimentParametrisation-993"><a href="#ExperimentParametrisation-993"><span class="linenos"> 993</span></a><span class="sd">        KeyError</span>
</span><span id="ExperimentParametrisation-994"><a href="#ExperimentParametrisation-994"><span class="linenos"> 994</span></a><span class="sd">            If required keys are missing in the configuration or probe parameters.</span>
</span><span id="ExperimentParametrisation-995"><a href="#ExperimentParametrisation-995"><span class="linenos"> 995</span></a>
</span><span id="ExperimentParametrisation-996"><a href="#ExperimentParametrisation-996"><span class="linenos"> 996</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation-997"><a href="#ExperimentParametrisation-997"><span class="linenos"> 997</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation-998"><a href="#ExperimentParametrisation-998"><span class="linenos"> 998</span></a><span class="sd">        Updates the ``probe_parameters`` attribute with the new or modified probe configuration and calls the :meth:`_update_probes` method to refresh internal probe state.</span>
</span><span id="ExperimentParametrisation-999"><a href="#ExperimentParametrisation-999"><span class="linenos"> 999</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1000"><a href="#ExperimentParametrisation-1000"><span class="linenos">1000</span></a>        <span class="n">probe_configuration</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1001"><a href="#ExperimentParametrisation-1001"><span class="linenos">1001</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">probe_template</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-1002"><a href="#ExperimentParametrisation-1002"><span class="linenos">1002</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-1003"><a href="#ExperimentParametrisation-1003"><span class="linenos">1003</span></a>        <span class="k">if</span> <span class="n">probe_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1004"><a href="#ExperimentParametrisation-1004"><span class="linenos">1004</span></a>            <span class="n">probe_name</span> <span class="o">=</span> <span class="n">probe_template</span>
</span><span id="ExperimentParametrisation-1005"><a href="#ExperimentParametrisation-1005"><span class="linenos">1005</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1006"><a href="#ExperimentParametrisation-1006"><span class="linenos">1006</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_name</span>
</span><span id="ExperimentParametrisation-1007"><a href="#ExperimentParametrisation-1007"><span class="linenos">1007</span></a>        <span class="k">if</span> <span class="n">peptide_motif</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1008"><a href="#ExperimentParametrisation-1008"><span class="linenos">1008</span></a>            <span class="n">protein_name</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1009"><a href="#ExperimentParametrisation-1009"><span class="linenos">1009</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_peptide_motif</span><span class="p">(</span><span class="o">**</span><span class="n">peptide_motif</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1010"><a href="#ExperimentParametrisation-1010"><span class="linenos">1010</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1011"><a href="#ExperimentParametrisation-1011"><span class="linenos">1011</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1012"><a href="#ExperimentParametrisation-1012"><span class="linenos">1012</span></a>                <span class="n">probe_target_type</span> <span class="o">=</span> <span class="s2">&quot;Sequence&quot;</span>
</span><span id="ExperimentParametrisation-1013"><a href="#ExperimentParametrisation-1013"><span class="linenos">1013</span></a>                <span class="n">probe_target_value</span> <span class="o">=</span> <span class="n">sequence</span>
</span><span id="ExperimentParametrisation-1014"><a href="#ExperimentParametrisation-1014"><span class="linenos">1014</span></a>        <span class="k">if</span> <span class="n">probe_target_type</span> <span class="ow">and</span> <span class="n">probe_target_value</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1015"><a href="#ExperimentParametrisation-1015"><span class="linenos">1015</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1016"><a href="#ExperimentParametrisation-1016"><span class="linenos">1016</span></a>                <span class="nb">type</span><span class="o">=</span><span class="n">probe_target_type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">probe_target_value</span>
</span><span id="ExperimentParametrisation-1017"><a href="#ExperimentParametrisation-1017"><span class="linenos">1017</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1018"><a href="#ExperimentParametrisation-1018"><span class="linenos">1018</span></a>            <span class="k">if</span> <span class="n">probe_target_type</span> <span class="o">==</span> <span class="s2">&quot;Primary&quot;</span> <span class="ow">and</span> <span class="n">probe_target_option</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1019"><a href="#ExperimentParametrisation-1019"><span class="linenos">1019</span></a>                <span class="k">if</span> <span class="n">probe_target_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-1020"><a href="#ExperimentParametrisation-1020"><span class="linenos">1020</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1021"><a href="#ExperimentParametrisation-1021"><span class="linenos">1021</span></a>                        <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">probe_target_option</span><span class="si">}</span><span class="s2"> as epitope on </span><span class="si">{</span><span class="n">probe_target_value</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ExperimentParametrisation-1022"><a href="#ExperimentParametrisation-1022"><span class="linenos">1022</span></a>                    <span class="p">)</span>
</span><span id="ExperimentParametrisation-1023"><a href="#ExperimentParametrisation-1023"><span class="linenos">1023</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="p">[</span><span class="n">probe_target_value</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-1024"><a href="#ExperimentParametrisation-1024"><span class="linenos">1024</span></a>                        <span class="s2">&quot;probe_seconday_epitope&quot;</span>
</span><span id="ExperimentParametrisation-1025"><a href="#ExperimentParametrisation-1025"><span class="linenos">1025</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">probe_target_option</span>
</span><span id="ExperimentParametrisation-1026"><a href="#ExperimentParametrisation-1026"><span class="linenos">1026</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1027"><a href="#ExperimentParametrisation-1027"><span class="linenos">1027</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-1028"><a href="#ExperimentParametrisation-1028"><span class="linenos">1028</span></a>            <span class="ow">or</span> <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-1029"><a href="#ExperimentParametrisation-1029"><span class="linenos">1029</span></a>        <span class="p">):</span>
</span><span id="ExperimentParametrisation-1030"><a href="#ExperimentParametrisation-1030"><span class="linenos">1030</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1031"><a href="#ExperimentParametrisation-1031"><span class="linenos">1031</span></a>                <span class="s2">&quot;No target info provided for the probe. Retrieving random sequence.&quot;</span>
</span><span id="ExperimentParametrisation-1032"><a href="#ExperimentParametrisation-1032"><span class="linenos">1032</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1033"><a href="#ExperimentParametrisation-1033"><span class="linenos">1033</span></a>            <span class="c1"># probe has no target info</span>
</span><span id="ExperimentParametrisation-1034"><a href="#ExperimentParametrisation-1034"><span class="linenos">1034</span></a>            <span class="c1"># a random target will be used</span>
</span><span id="ExperimentParametrisation-1035"><a href="#ExperimentParametrisation-1035"><span class="linenos">1035</span></a>            <span class="n">protein_name</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1036"><a href="#ExperimentParametrisation-1036"><span class="linenos">1036</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_peptide_motif</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="s2">&quot;cterminal&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1037"><a href="#ExperimentParametrisation-1037"><span class="linenos">1037</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1038"><a href="#ExperimentParametrisation-1038"><span class="linenos">1038</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1039"><a href="#ExperimentParametrisation-1039"><span class="linenos">1039</span></a>                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Sequence&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sequence</span>
</span><span id="ExperimentParametrisation-1040"><a href="#ExperimentParametrisation-1040"><span class="linenos">1040</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1041"><a href="#ExperimentParametrisation-1041"><span class="linenos">1041</span></a>            <span class="c1"># probe_configuration[&quot;target&quot;][&quot;type&quot;] = &quot;Sequence&quot;</span>
</span><span id="ExperimentParametrisation-1042"><a href="#ExperimentParametrisation-1042"><span class="linenos">1042</span></a>            <span class="c1"># probe_configuration[&quot;target&quot;][&quot;value&quot;] = sequence</span>
</span><span id="ExperimentParametrisation-1043"><a href="#ExperimentParametrisation-1043"><span class="linenos">1043</span></a>        <span class="k">if</span> <span class="n">probe_distance_to_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1044"><a href="#ExperimentParametrisation-1044"><span class="linenos">1044</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;distance_to_epitope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1045"><a href="#ExperimentParametrisation-1045"><span class="linenos">1045</span></a>                <span class="n">probe_distance_to_epitope</span>
</span><span id="ExperimentParametrisation-1046"><a href="#ExperimentParametrisation-1046"><span class="linenos">1046</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1047"><a href="#ExperimentParametrisation-1047"><span class="linenos">1047</span></a>        <span class="k">if</span> <span class="n">probe_fluorophore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1048"><a href="#ExperimentParametrisation-1048"><span class="linenos">1048</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;fluorophore_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_fluorophore</span>
</span><span id="ExperimentParametrisation-1049"><a href="#ExperimentParametrisation-1049"><span class="linenos">1049</span></a>        <span class="k">if</span> <span class="n">fluorophore_parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1050"><a href="#ExperimentParametrisation-1050"><span class="linenos">1050</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_fluorophore_parameters</span><span class="p">(</span><span class="n">fluorophoe_id</span><span class="o">=</span><span class="n">probe_fluorophore</span><span class="p">,</span> <span class="o">**</span><span class="n">fluorophore_parameters</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1051"><a href="#ExperimentParametrisation-1051"><span class="linenos">1051</span></a>        <span class="k">if</span> <span class="n">labelling_efficiency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1052"><a href="#ExperimentParametrisation-1052"><span class="linenos">1052</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;labelling_efficiency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelling_efficiency</span>
</span><span id="ExperimentParametrisation-1053"><a href="#ExperimentParametrisation-1053"><span class="linenos">1053</span></a>        <span class="k">if</span> <span class="n">probe_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1054"><a href="#ExperimentParametrisation-1054"><span class="linenos">1054</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;model_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_model</span>
</span><span id="ExperimentParametrisation-1055"><a href="#ExperimentParametrisation-1055"><span class="linenos">1055</span></a>        <span class="k">if</span> <span class="n">probe_paratope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1056"><a href="#ExperimentParametrisation-1056"><span class="linenos">1056</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;paratope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_paratope</span>
</span><span id="ExperimentParametrisation-1057"><a href="#ExperimentParametrisation-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="n">probe_conjugation_target_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1058"><a href="#ExperimentParametrisation-1058"><span class="linenos">1058</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1059"><a href="#ExperimentParametrisation-1059"><span class="linenos">1059</span></a>                <span class="n">probe_conjugation_target_info</span>
</span><span id="ExperimentParametrisation-1060"><a href="#ExperimentParametrisation-1060"><span class="linenos">1060</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1061"><a href="#ExperimentParametrisation-1061"><span class="linenos">1061</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1062"><a href="#ExperimentParametrisation-1062"><span class="linenos">1062</span></a>                <span class="n">probe_conjugation_target_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-1063"><a href="#ExperimentParametrisation-1063"><span class="linenos">1063</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1064"><a href="#ExperimentParametrisation-1064"><span class="linenos">1064</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1065"><a href="#ExperimentParametrisation-1065"><span class="linenos">1065</span></a>                <span class="n">probe_conjugation_target_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation-1066"><a href="#ExperimentParametrisation-1066"><span class="linenos">1066</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1067"><a href="#ExperimentParametrisation-1067"><span class="linenos">1067</span></a>        <span class="k">if</span> <span class="n">probe_DoL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1068"><a href="#ExperimentParametrisation-1068"><span class="linenos">1068</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting probe DoL to: </span><span class="si">{</span><span class="n">probe_DoL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1069"><a href="#ExperimentParametrisation-1069"><span class="linenos">1069</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;DoL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1070"><a href="#ExperimentParametrisation-1070"><span class="linenos">1070</span></a>                <span class="n">probe_DoL</span>
</span><span id="ExperimentParametrisation-1071"><a href="#ExperimentParametrisation-1071"><span class="linenos">1071</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1072"><a href="#ExperimentParametrisation-1072"><span class="linenos">1072</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1073"><a href="#ExperimentParametrisation-1073"><span class="linenos">1073</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Add_probe: Using default probe DoL from template&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1074"><a href="#ExperimentParametrisation-1074"><span class="linenos">1074</span></a>        <span class="k">if</span> <span class="n">probe_seconday_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1075"><a href="#ExperimentParametrisation-1075"><span class="linenos">1075</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;epitope_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_seconday_epitope</span>
</span><span id="ExperimentParametrisation-1076"><a href="#ExperimentParametrisation-1076"><span class="linenos">1076</span></a>        <span class="k">if</span> <span class="n">probe_wobble_theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1077"><a href="#ExperimentParametrisation-1077"><span class="linenos">1077</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;enable_wobble&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-1078"><a href="#ExperimentParametrisation-1078"><span class="linenos">1078</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;wobble_theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_wobble_theta</span>
</span><span id="ExperimentParametrisation-1079"><a href="#ExperimentParametrisation-1079"><span class="linenos">1079</span></a>        <span class="k">if</span> <span class="n">as_primary</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1080"><a href="#ExperimentParametrisation-1080"><span class="linenos">1080</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding probe as primary linker&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1081"><a href="#ExperimentParametrisation-1081"><span class="linenos">1081</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;as_linker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation-1082"><a href="#ExperimentParametrisation-1082"><span class="linenos">1082</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1083"><a href="#ExperimentParametrisation-1083"><span class="linenos">1083</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;as_linker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation-1084"><a href="#ExperimentParametrisation-1084"><span class="linenos">1084</span></a>        <span class="k">if</span> <span class="n">probe_steric_hindrance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1085"><a href="#ExperimentParametrisation-1085"><span class="linenos">1085</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;distance_between_epitope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1086"><a href="#ExperimentParametrisation-1086"><span class="linenos">1086</span></a>                <span class="n">probe_steric_hindrance</span>
</span><span id="ExperimentParametrisation-1087"><a href="#ExperimentParametrisation-1087"><span class="linenos">1087</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1088"><a href="#ExperimentParametrisation-1088"><span class="linenos">1088</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;binding&quot;</span><span class="p">][</span><span class="s2">&quot;distance&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation-1089"><a href="#ExperimentParametrisation-1089"><span class="linenos">1089</span></a>                <span class="s2">&quot;between_targets&quot;</span>
</span><span id="ExperimentParametrisation-1090"><a href="#ExperimentParametrisation-1090"><span class="linenos">1090</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">probe_steric_hindrance</span>
</span><span id="ExperimentParametrisation-1091"><a href="#ExperimentParametrisation-1091"><span class="linenos">1091</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="p">[</span><span class="n">probe_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_configuration</span>
</span><span id="ExperimentParametrisation-1092"><a href="#ExperimentParametrisation-1092"><span class="linenos">1092</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_probes</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-1093"><a href="#ExperimentParametrisation-1093"><span class="linenos">1093</span></a>
</span><span id="ExperimentParametrisation-1094"><a href="#ExperimentParametrisation-1094"><span class="linenos">1094</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_probes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-1095"><a href="#ExperimentParametrisation-1095"><span class="linenos">1095</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1096"><a href="#ExperimentParametrisation-1096"><span class="linenos">1096</span></a><span class="sd">        Update the structure_label attribute based on the current probe_parameters.</span>
</span><span id="ExperimentParametrisation-1097"><a href="#ExperimentParametrisation-1097"><span class="linenos">1097</span></a>
</span><span id="ExperimentParametrisation-1098"><a href="#ExperimentParametrisation-1098"><span class="linenos">1098</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-1099"><a href="#ExperimentParametrisation-1099"><span class="linenos">1099</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-1100"><a href="#ExperimentParametrisation-1100"><span class="linenos">1100</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-1101"><a href="#ExperimentParametrisation-1101"><span class="linenos">1101</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1102"><a href="#ExperimentParametrisation-1102"><span class="linenos">1102</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1103"><a href="#ExperimentParametrisation-1103"><span class="linenos">1103</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-1104"><a href="#ExperimentParametrisation-1104"><span class="linenos">1104</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1105"><a href="#ExperimentParametrisation-1105"><span class="linenos">1105</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="ExperimentParametrisation-1106"><a href="#ExperimentParametrisation-1106"><span class="linenos">1106</span></a>
</span><span id="ExperimentParametrisation-1107"><a href="#ExperimentParametrisation-1107"><span class="linenos">1107</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_fluorophore_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1108"><a href="#ExperimentParametrisation-1108"><span class="linenos">1108</span></a>                                <span class="n">fluorophoe_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1109"><a href="#ExperimentParametrisation-1109"><span class="linenos">1109</span></a>                                <span class="n">emission</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1110"><a href="#ExperimentParametrisation-1110"><span class="linenos">1110</span></a>                                <span class="n">blinking_rates</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1111"><a href="#ExperimentParametrisation-1111"><span class="linenos">1111</span></a>                                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-1112"><a href="#ExperimentParametrisation-1112"><span class="linenos">1112</span></a>        <span class="k">if</span> <span class="n">fluorophoe_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-1113"><a href="#ExperimentParametrisation-1113"><span class="linenos">1113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-1114"><a href="#ExperimentParametrisation-1114"><span class="linenos">1114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-1115"><a href="#ExperimentParametrisation-1115"><span class="linenos">1115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span>
</span><span id="ExperimentParametrisation-1116"><a href="#ExperimentParametrisation-1116"><span class="linenos">1116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation-1117"><a href="#ExperimentParametrisation-1117"><span class="linenos">1117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;kon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span>
</span><span id="ExperimentParametrisation-1118"><a href="#ExperimentParametrisation-1118"><span class="linenos">1118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;koff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
</span><span id="ExperimentParametrisation-1119"><a href="#ExperimentParametrisation-1119"><span class="linenos">1119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;kbleach&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ExperimentParametrisation-1120"><a href="#ExperimentParametrisation-1120"><span class="linenos">1120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;initial_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ExperimentParametrisation-1121"><a href="#ExperimentParametrisation-1121"><span class="linenos">1121</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;photons_per_blink&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="ExperimentParametrisation-1122"><a href="#ExperimentParametrisation-1122"><span class="linenos">1122</span></a>        <span class="k">if</span> <span class="n">emission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1123"><a href="#ExperimentParametrisation-1123"><span class="linenos">1123</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">emission</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1124"><a href="#ExperimentParametrisation-1124"><span class="linenos">1124</span></a>        <span class="k">if</span> <span class="n">blinking_rates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1125"><a href="#ExperimentParametrisation-1125"><span class="linenos">1125</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blinking_rates</span>
</span><span id="ExperimentParametrisation-1126"><a href="#ExperimentParametrisation-1126"><span class="linenos">1126</span></a>
</span><span id="ExperimentParametrisation-1127"><a href="#ExperimentParametrisation-1127"><span class="linenos">1127</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_virtualsample_params</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1128"><a href="#ExperimentParametrisation-1128"><span class="linenos">1128</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1129"><a href="#ExperimentParametrisation-1129"><span class="linenos">1129</span></a>        <span class="n">virtualsample_template</span><span class="o">=</span><span class="s2">&quot;square1x1um_randomised&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1130"><a href="#ExperimentParametrisation-1130"><span class="linenos">1130</span></a>        <span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1131"><a href="#ExperimentParametrisation-1131"><span class="linenos">1131</span></a>        <span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1132"><a href="#ExperimentParametrisation-1132"><span class="linenos">1132</span></a>        <span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1133"><a href="#ExperimentParametrisation-1133"><span class="linenos">1133</span></a>        <span class="n">random_orientations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1134"><a href="#ExperimentParametrisation-1134"><span class="linenos">1134</span></a>        <span class="n">random_placing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1135"><a href="#ExperimentParametrisation-1135"><span class="linenos">1135</span></a>        <span class="n">minimal_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1136"><a href="#ExperimentParametrisation-1136"><span class="linenos">1136</span></a>        <span class="n">update_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1137"><a href="#ExperimentParametrisation-1137"><span class="linenos">1137</span></a>        <span class="n">random_rotations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1138"><a href="#ExperimentParametrisation-1138"><span class="linenos">1138</span></a>        <span class="n">rotation_angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1139"><a href="#ExperimentParametrisation-1139"><span class="linenos">1139</span></a>        <span class="n">xy_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1140"><a href="#ExperimentParametrisation-1140"><span class="linenos">1140</span></a>        <span class="n">xz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1141"><a href="#ExperimentParametrisation-1141"><span class="linenos">1141</span></a>        <span class="n">yz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1142"><a href="#ExperimentParametrisation-1142"><span class="linenos">1142</span></a>        <span class="n">axial_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1143"><a href="#ExperimentParametrisation-1143"><span class="linenos">1143</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1144"><a href="#ExperimentParametrisation-1144"><span class="linenos">1144</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-1145"><a href="#ExperimentParametrisation-1145"><span class="linenos">1145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1146"><a href="#ExperimentParametrisation-1146"><span class="linenos">1146</span></a><span class="sd">        Set parameters for the virtual sample by loading a template configuration and optionally overriding specific values.</span>
</span><span id="ExperimentParametrisation-1147"><a href="#ExperimentParametrisation-1147"><span class="linenos">1147</span></a>
</span><span id="ExperimentParametrisation-1148"><a href="#ExperimentParametrisation-1148"><span class="linenos">1148</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-1149"><a href="#ExperimentParametrisation-1149"><span class="linenos">1149</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-1150"><a href="#ExperimentParametrisation-1150"><span class="linenos">1150</span></a><span class="sd">        :param virtualsample_template : str, optional</span>
</span><span id="ExperimentParametrisation-1151"><a href="#ExperimentParametrisation-1151"><span class="linenos">1151</span></a><span class="sd">            Name of the virtual sample template YAML file (without extension) to load. Default is &quot;square1x1um_randomised&quot;.</span>
</span><span id="ExperimentParametrisation-1152"><a href="#ExperimentParametrisation-1152"><span class="linenos">1152</span></a><span class="sd">        :param sample_dimensions : list of int, optional</span>
</span><span id="ExperimentParametrisation-1153"><a href="#ExperimentParametrisation-1153"><span class="linenos">1153</span></a><span class="sd">            Dimensions of the sample to override the template value.</span>
</span><span id="ExperimentParametrisation-1154"><a href="#ExperimentParametrisation-1154"><span class="linenos">1154</span></a><span class="sd">        :param number_of_particles : int, optional</span>
</span><span id="ExperimentParametrisation-1155"><a href="#ExperimentParametrisation-1155"><span class="linenos">1155</span></a><span class="sd">            Number of particles to override the template value.</span>
</span><span id="ExperimentParametrisation-1156"><a href="#ExperimentParametrisation-1156"><span class="linenos">1156</span></a><span class="sd">        :param particle_positions : list, optional</span>
</span><span id="ExperimentParametrisation-1157"><a href="#ExperimentParametrisation-1157"><span class="linenos">1157</span></a><span class="sd">            List of particle positions to override the template value.</span>
</span><span id="ExperimentParametrisation-1158"><a href="#ExperimentParametrisation-1158"><span class="linenos">1158</span></a><span class="sd">        :param random_orientations : bool, optional</span>
</span><span id="ExperimentParametrisation-1159"><a href="#ExperimentParametrisation-1159"><span class="linenos">1159</span></a><span class="sd">            Whether to randomize particle orientations, overrides the template value.</span>
</span><span id="ExperimentParametrisation-1160"><a href="#ExperimentParametrisation-1160"><span class="linenos">1160</span></a><span class="sd">        :param random_placing : bool, optional</span>
</span><span id="ExperimentParametrisation-1161"><a href="#ExperimentParametrisation-1161"><span class="linenos">1161</span></a><span class="sd">            Whether to randomize particle placement, overrides the template value.</span>
</span><span id="ExperimentParametrisation-1162"><a href="#ExperimentParametrisation-1162"><span class="linenos">1162</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-1163"><a href="#ExperimentParametrisation-1163"><span class="linenos">1163</span></a><span class="sd">            Additional keyword arguments (currently unused).</span>
</span><span id="ExperimentParametrisation-1164"><a href="#ExperimentParametrisation-1164"><span class="linenos">1164</span></a>
</span><span id="ExperimentParametrisation-1165"><a href="#ExperimentParametrisation-1165"><span class="linenos">1165</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-1166"><a href="#ExperimentParametrisation-1166"><span class="linenos">1166</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-1167"><a href="#ExperimentParametrisation-1167"><span class="linenos">1167</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-1168"><a href="#ExperimentParametrisation-1168"><span class="linenos">1168</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1169"><a href="#ExperimentParametrisation-1169"><span class="linenos">1169</span></a>        <span class="c1"># load default configuration for virtual sample</span>
</span><span id="ExperimentParametrisation-1170"><a href="#ExperimentParametrisation-1170"><span class="linenos">1170</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1171"><a href="#ExperimentParametrisation-1171"><span class="linenos">1171</span></a>            <span class="n">particle_minimal_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span><span class="o">.</span><span class="n">molecules_params</span><span class="p">[</span>
</span><span id="ExperimentParametrisation-1172"><a href="#ExperimentParametrisation-1172"><span class="linenos">1172</span></a>                <span class="s2">&quot;minimal_distance&quot;</span>
</span><span id="ExperimentParametrisation-1173"><a href="#ExperimentParametrisation-1173"><span class="linenos">1173</span></a>            <span class="p">]</span>
</span><span id="ExperimentParametrisation-1174"><a href="#ExperimentParametrisation-1174"><span class="linenos">1174</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1175"><a href="#ExperimentParametrisation-1175"><span class="linenos">1175</span></a>            <span class="n">particle_minimal_distance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation-1176"><a href="#ExperimentParametrisation-1176"><span class="linenos">1176</span></a>        <span class="k">if</span> <span class="n">update_mode</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1177"><a href="#ExperimentParametrisation-1177"><span class="linenos">1177</span></a>            <span class="k">pass</span>
</span><span id="ExperimentParametrisation-1178"><a href="#ExperimentParametrisation-1178"><span class="linenos">1178</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1179"><a href="#ExperimentParametrisation-1179"><span class="linenos">1179</span></a>            <span class="n">virtual_sample_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1180"><a href="#ExperimentParametrisation-1180"><span class="linenos">1180</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1181"><a href="#ExperimentParametrisation-1181"><span class="linenos">1181</span></a>                <span class="s2">&quot;virtualsample&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1182"><a href="#ExperimentParametrisation-1182"><span class="linenos">1182</span></a>                <span class="n">virtualsample_template</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1183"><a href="#ExperimentParametrisation-1183"><span class="linenos">1183</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1184"><a href="#ExperimentParametrisation-1184"><span class="linenos">1184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">virtual_sample_template</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1185"><a href="#ExperimentParametrisation-1185"><span class="linenos">1185</span></a>        <span class="k">if</span> <span class="n">sample_dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1186"><a href="#ExperimentParametrisation-1186"><span class="linenos">1186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;sample_dimensions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_dimensions</span>
</span><span id="ExperimentParametrisation-1187"><a href="#ExperimentParametrisation-1187"><span class="linenos">1187</span></a>        <span class="k">if</span> <span class="n">number_of_particles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1188"><a href="#ExperimentParametrisation-1188"><span class="linenos">1188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;number_of_particles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_of_particles</span>
</span><span id="ExperimentParametrisation-1189"><a href="#ExperimentParametrisation-1189"><span class="linenos">1189</span></a>        <span class="k">if</span> <span class="n">particle_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1190"><a href="#ExperimentParametrisation-1190"><span class="linenos">1190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;relative_positions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_positions</span>
</span><span id="ExperimentParametrisation-1191"><a href="#ExperimentParametrisation-1191"><span class="linenos">1191</span></a>        <span class="k">if</span> <span class="n">random_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1192"><a href="#ExperimentParametrisation-1192"><span class="linenos">1192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_orientations</span>
</span><span id="ExperimentParametrisation-1193"><a href="#ExperimentParametrisation-1193"><span class="linenos">1193</span></a>        <span class="k">if</span> <span class="n">random_placing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1194"><a href="#ExperimentParametrisation-1194"><span class="linenos">1194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_placing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_placing</span>
</span><span id="ExperimentParametrisation-1195"><a href="#ExperimentParametrisation-1195"><span class="linenos">1195</span></a>        <span class="k">if</span> <span class="n">minimal_distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1196"><a href="#ExperimentParametrisation-1196"><span class="linenos">1196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minimal_distance</span>
</span><span id="ExperimentParametrisation-1197"><a href="#ExperimentParametrisation-1197"><span class="linenos">1197</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1198"><a href="#ExperimentParametrisation-1198"><span class="linenos">1198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1199"><a href="#ExperimentParametrisation-1199"><span class="linenos">1199</span></a>                <span class="n">particle_minimal_distance</span>
</span><span id="ExperimentParametrisation-1200"><a href="#ExperimentParametrisation-1200"><span class="linenos">1200</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1201"><a href="#ExperimentParametrisation-1201"><span class="linenos">1201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_rotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_rotations</span>
</span><span id="ExperimentParametrisation-1202"><a href="#ExperimentParametrisation-1202"><span class="linenos">1202</span></a>        <span class="k">if</span> <span class="n">rotation_angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1203"><a href="#ExperimentParametrisation-1203"><span class="linenos">1203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;rotation_angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_angles</span>
</span><span id="ExperimentParametrisation-1204"><a href="#ExperimentParametrisation-1204"><span class="linenos">1204</span></a>        <span class="k">if</span> <span class="n">xy_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1205"><a href="#ExperimentParametrisation-1205"><span class="linenos">1205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;xy_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_orientations</span>
</span><span id="ExperimentParametrisation-1206"><a href="#ExperimentParametrisation-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="n">xz_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1207"><a href="#ExperimentParametrisation-1207"><span class="linenos">1207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;xz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz_orientations</span>
</span><span id="ExperimentParametrisation-1208"><a href="#ExperimentParametrisation-1208"><span class="linenos">1208</span></a>        <span class="k">if</span> <span class="n">yz_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1209"><a href="#ExperimentParametrisation-1209"><span class="linenos">1209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;yz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz_orientations</span>
</span><span id="ExperimentParametrisation-1210"><a href="#ExperimentParametrisation-1210"><span class="linenos">1210</span></a>        <span class="k">if</span> <span class="n">axial_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1211"><a href="#ExperimentParametrisation-1211"><span class="linenos">1211</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;axial_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axial_offset</span>
</span><span id="ExperimentParametrisation-1212"><a href="#ExperimentParametrisation-1212"><span class="linenos">1212</span></a>
</span><span id="ExperimentParametrisation-1213"><a href="#ExperimentParametrisation-1213"><span class="linenos">1213</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">use_image_for_positioning</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1214"><a href="#ExperimentParametrisation-1214"><span class="linenos">1214</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1215"><a href="#ExperimentParametrisation-1215"><span class="linenos">1215</span></a>        <span class="n">img</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1216"><a href="#ExperimentParametrisation-1216"><span class="linenos">1216</span></a>        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;localmaxima&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1217"><a href="#ExperimentParametrisation-1217"><span class="linenos">1217</span></a>        <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1218"><a href="#ExperimentParametrisation-1218"><span class="linenos">1218</span></a>        <span class="n">background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1219"><a href="#ExperimentParametrisation-1219"><span class="linenos">1219</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1220"><a href="#ExperimentParametrisation-1220"><span class="linenos">1220</span></a>        <span class="n">pixelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1221"><a href="#ExperimentParametrisation-1221"><span class="linenos">1221</span></a>        <span class="n">min_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1222"><a href="#ExperimentParametrisation-1222"><span class="linenos">1222</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1223"><a href="#ExperimentParametrisation-1223"><span class="linenos">1223</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-1224"><a href="#ExperimentParametrisation-1224"><span class="linenos">1224</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1225"><a href="#ExperimentParametrisation-1225"><span class="linenos">1225</span></a><span class="sd">        Generate and set relative positions for a virtual sample based on features detected in an input image.</span>
</span><span id="ExperimentParametrisation-1226"><a href="#ExperimentParametrisation-1226"><span class="linenos">1226</span></a>
</span><span id="ExperimentParametrisation-1227"><a href="#ExperimentParametrisation-1227"><span class="linenos">1227</span></a><span class="sd">        This method processes the provided image to extract feature coordinates using the specified detection mode</span>
</span><span id="ExperimentParametrisation-1228"><a href="#ExperimentParametrisation-1228"><span class="linenos">1228</span></a><span class="sd">        and parameters. The resulting positions are stored in `self.virtualsample_params[&quot;relative_positions&quot;]`,</span>
</span><span id="ExperimentParametrisation-1229"><a href="#ExperimentParametrisation-1229"><span class="linenos">1229</span></a><span class="sd">        and the sample&#39;s physical dimensions are updated accordingly. The method then triggers the build process</span>
</span><span id="ExperimentParametrisation-1230"><a href="#ExperimentParametrisation-1230"><span class="linenos">1230</span></a><span class="sd">        for the &#39;coordinate_field&#39; and &#39;imager&#39; modules.</span>
</span><span id="ExperimentParametrisation-1231"><a href="#ExperimentParametrisation-1231"><span class="linenos">1231</span></a>
</span><span id="ExperimentParametrisation-1232"><a href="#ExperimentParametrisation-1232"><span class="linenos">1232</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation-1233"><a href="#ExperimentParametrisation-1233"><span class="linenos">1233</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation-1234"><a href="#ExperimentParametrisation-1234"><span class="linenos">1234</span></a><span class="sd">        :param img : array-like</span>
</span><span id="ExperimentParametrisation-1235"><a href="#ExperimentParametrisation-1235"><span class="linenos">1235</span></a><span class="sd">            The input image (as a NumPy array or compatible format) to be analyzed for feature detection.</span>
</span><span id="ExperimentParametrisation-1236"><a href="#ExperimentParametrisation-1236"><span class="linenos">1236</span></a><span class="sd">        :param mode : str, optional</span>
</span><span id="ExperimentParametrisation-1237"><a href="#ExperimentParametrisation-1237"><span class="linenos">1237</span></a><span class="sd">            The feature detection mode to use (e.g., &quot;localmaxima&quot;). Default is &quot;localmaxima&quot;.</span>
</span><span id="ExperimentParametrisation-1238"><a href="#ExperimentParametrisation-1238"><span class="linenos">1238</span></a><span class="sd">        :param sigma : float or None, optional</span>
</span><span id="ExperimentParametrisation-1239"><a href="#ExperimentParametrisation-1239"><span class="linenos">1239</span></a><span class="sd">            Standard deviation for Gaussian smoothing. If None, no smoothing is applied.</span>
</span><span id="ExperimentParametrisation-1240"><a href="#ExperimentParametrisation-1240"><span class="linenos">1240</span></a><span class="sd">        :param background : float or None, optional</span>
</span><span id="ExperimentParametrisation-1241"><a href="#ExperimentParametrisation-1241"><span class="linenos">1241</span></a><span class="sd">            Background intensity to subtract from the image. If None, no subtraction.</span>
</span><span id="ExperimentParametrisation-1242"><a href="#ExperimentParametrisation-1242"><span class="linenos">1242</span></a><span class="sd">        :param threshold : float or None, optional</span>
</span><span id="ExperimentParametrisation-1243"><a href="#ExperimentParametrisation-1243"><span class="linenos">1243</span></a><span class="sd">            Minimum intensity threshold for feature detection. If None, uses default.</span>
</span><span id="ExperimentParametrisation-1244"><a href="#ExperimentParametrisation-1244"><span class="linenos">1244</span></a><span class="sd">        :param pixelsize : float or None, optional</span>
</span><span id="ExperimentParametrisation-1245"><a href="#ExperimentParametrisation-1245"><span class="linenos">1245</span></a><span class="sd">            Pixel size of the input image. If None, uses default.</span>
</span><span id="ExperimentParametrisation-1246"><a href="#ExperimentParametrisation-1246"><span class="linenos">1246</span></a><span class="sd">        :param min_distance : float or None, optional</span>
</span><span id="ExperimentParametrisation-1247"><a href="#ExperimentParametrisation-1247"><span class="linenos">1247</span></a><span class="sd">            Minimum distance between detected features. If None, uses default.</span>
</span><span id="ExperimentParametrisation-1248"><a href="#ExperimentParametrisation-1248"><span class="linenos">1248</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation-1249"><a href="#ExperimentParametrisation-1249"><span class="linenos">1249</span></a><span class="sd">            Additional keyword arguments passed to the feature detection function.</span>
</span><span id="ExperimentParametrisation-1250"><a href="#ExperimentParametrisation-1250"><span class="linenos">1250</span></a>
</span><span id="ExperimentParametrisation-1251"><a href="#ExperimentParametrisation-1251"><span class="linenos">1251</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation-1252"><a href="#ExperimentParametrisation-1252"><span class="linenos">1252</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation-1253"><a href="#ExperimentParametrisation-1253"><span class="linenos">1253</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation-1254"><a href="#ExperimentParametrisation-1254"><span class="linenos">1254</span></a>
</span><span id="ExperimentParametrisation-1255"><a href="#ExperimentParametrisation-1255"><span class="linenos">1255</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation-1256"><a href="#ExperimentParametrisation-1256"><span class="linenos">1256</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation-1257"><a href="#ExperimentParametrisation-1257"><span class="linenos">1257</span></a><span class="sd">        Updates `self.virtualsample_params` with new relative positions and sample dimensions. Calls `self.build()` for the specified modules.</span>
</span><span id="ExperimentParametrisation-1258"><a href="#ExperimentParametrisation-1258"><span class="linenos">1258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1259"><a href="#ExperimentParametrisation-1259"><span class="linenos">1259</span></a>        <span class="n">xyz_relative</span><span class="p">,</span> <span class="n">image_physical_size</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation-1260"><a href="#ExperimentParametrisation-1260"><span class="linenos">1260</span></a>            <span class="n">coordinates_field</span><span class="o">.</span><span class="n">gen_positions_from_image</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1261"><a href="#ExperimentParametrisation-1261"><span class="linenos">1261</span></a>                <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1262"><a href="#ExperimentParametrisation-1262"><span class="linenos">1262</span></a>                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1263"><a href="#ExperimentParametrisation-1263"><span class="linenos">1263</span></a>                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1264"><a href="#ExperimentParametrisation-1264"><span class="linenos">1264</span></a>                <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1265"><a href="#ExperimentParametrisation-1265"><span class="linenos">1265</span></a>                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1266"><a href="#ExperimentParametrisation-1266"><span class="linenos">1266</span></a>                <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1267"><a href="#ExperimentParametrisation-1267"><span class="linenos">1267</span></a>                <span class="n">min_distance</span><span class="o">=</span><span class="n">min_distance</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1268"><a href="#ExperimentParametrisation-1268"><span class="linenos">1268</span></a>                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1269"><a href="#ExperimentParametrisation-1269"><span class="linenos">1269</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation-1270"><a href="#ExperimentParametrisation-1270"><span class="linenos">1270</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-1271"><a href="#ExperimentParametrisation-1271"><span class="linenos">1271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_virtualsample_params</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1272"><a href="#ExperimentParametrisation-1272"><span class="linenos">1272</span></a>            <span class="n">sample_dimensions</span><span class="o">=</span><span class="p">[</span>
</span><span id="ExperimentParametrisation-1273"><a href="#ExperimentParametrisation-1273"><span class="linenos">1273</span></a>                <span class="n">image_physical_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="ExperimentParametrisation-1274"><a href="#ExperimentParametrisation-1274"><span class="linenos">1274</span></a>                <span class="n">image_physical_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="ExperimentParametrisation-1275"><a href="#ExperimentParametrisation-1275"><span class="linenos">1275</span></a>                <span class="mi">100</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1276"><a href="#ExperimentParametrisation-1276"><span class="linenos">1276</span></a>            <span class="p">],</span>
</span><span id="ExperimentParametrisation-1277"><a href="#ExperimentParametrisation-1277"><span class="linenos">1277</span></a>            <span class="n">particle_positions</span><span class="o">=</span><span class="n">xyz_relative</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1278"><a href="#ExperimentParametrisation-1278"><span class="linenos">1278</span></a>            <span class="n">number_of_particles</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_relative</span><span class="p">),</span>
</span><span id="ExperimentParametrisation-1279"><a href="#ExperimentParametrisation-1279"><span class="linenos">1279</span></a>            <span class="n">random_orientations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1280"><a href="#ExperimentParametrisation-1280"><span class="linenos">1280</span></a>            <span class="n">random_placing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1281"><a href="#ExperimentParametrisation-1281"><span class="linenos">1281</span></a>            <span class="n">minimal_distance</span><span class="o">=</span><span class="n">min_distance</span><span class="p">,</span>
</span><span id="ExperimentParametrisation-1282"><a href="#ExperimentParametrisation-1282"><span class="linenos">1282</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation-1283"><a href="#ExperimentParametrisation-1283"><span class="linenos">1283</span></a>        <span class="c1"># self.virtualsample_params[&quot;relative_positions&quot;] = xyz_relative</span>
</span><span id="ExperimentParametrisation-1284"><a href="#ExperimentParametrisation-1284"><span class="linenos">1284</span></a>        <span class="c1"># self.virtualsample_params[&quot;sample_dimensions&quot;] = [</span>
</span><span id="ExperimentParametrisation-1285"><a href="#ExperimentParametrisation-1285"><span class="linenos">1285</span></a>        <span class="c1">#    image_physical_size[0],</span>
</span><span id="ExperimentParametrisation-1286"><a href="#ExperimentParametrisation-1286"><span class="linenos">1286</span></a>        <span class="c1">#    image_physical_size[1],</span>
</span><span id="ExperimentParametrisation-1287"><a href="#ExperimentParametrisation-1287"><span class="linenos">1287</span></a>        <span class="c1">#    100,</span>
</span><span id="ExperimentParametrisation-1288"><a href="#ExperimentParametrisation-1288"><span class="linenos">1288</span></a>        <span class="c1"># ]</span>
</span><span id="ExperimentParametrisation-1289"><a href="#ExperimentParametrisation-1289"><span class="linenos">1289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">,</span> <span class="s2">&quot;imager&quot;</span><span class="p">])</span>
</span><span id="ExperimentParametrisation-1290"><a href="#ExperimentParametrisation-1290"><span class="linenos">1290</span></a>
</span><span id="ExperimentParametrisation-1291"><a href="#ExperimentParametrisation-1291"><span class="linenos">1291</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">current_settings</span><span class="p">(</span>
</span><span id="ExperimentParametrisation-1292"><a href="#ExperimentParametrisation-1292"><span class="linenos">1292</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">,</span> <span class="n">modalities_acq_params</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ExperimentParametrisation-1293"><a href="#ExperimentParametrisation-1293"><span class="linenos">1293</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation-1294"><a href="#ExperimentParametrisation-1294"><span class="linenos">1294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1295"><a href="#ExperimentParametrisation-1295"><span class="linenos">1295</span></a><span class="sd">        Print the current settings of the experiment, including structure, particle, coordinate field, and imaging modalities.</span>
</span><span id="ExperimentParametrisation-1296"><a href="#ExperimentParametrisation-1296"><span class="linenos">1296</span></a>
</span><span id="ExperimentParametrisation-1297"><a href="#ExperimentParametrisation-1297"><span class="linenos">1297</span></a><span class="sd">    Returns</span>
</span><span id="ExperimentParametrisation-1298"><a href="#ExperimentParametrisation-1298"><span class="linenos">1298</span></a><span class="sd">    -------</span>
</span><span id="ExperimentParametrisation-1299"><a href="#ExperimentParametrisation-1299"><span class="linenos">1299</span></a><span class="sd">    None</span>
</span><span id="ExperimentParametrisation-1300"><a href="#ExperimentParametrisation-1300"><span class="linenos">1300</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation-1301"><a href="#ExperimentParametrisation-1301"><span class="linenos">1301</span></a>        <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Current settings of the experiment:&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation-1302"><a href="#ExperimentParametrisation-1302"><span class="linenos">1302</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Structure ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation-1303"><a href="#ExperimentParametrisation-1303"><span class="linenos">1303</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Probes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation-1304"><a href="#ExperimentParametrisation-1304"><span class="linenos">1304</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Virtual sample: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation-1305"><a href="#ExperimentParametrisation-1305"><span class="linenos">1305</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;Imaging Modalities: &quot;</span>
</span><span id="ExperimentParametrisation-1306"><a href="#ExperimentParametrisation-1306"><span class="linenos">1306</span></a>        <span class="k">for</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">acqparams</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ExperimentParametrisation-1307"><a href="#ExperimentParametrisation-1307"><span class="linenos">1307</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">modality_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ExperimentParametrisation-1308"><a href="#ExperimentParametrisation-1308"><span class="linenos">1308</span></a>            <span class="k">if</span> <span class="n">modalities_acq_params</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1309"><a href="#ExperimentParametrisation-1309"><span class="linenos">1309</span></a>                <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">acqparams</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation-1310"><a href="#ExperimentParametrisation-1310"><span class="linenos">1310</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1311"><a href="#ExperimentParametrisation-1311"><span class="linenos">1311</span></a>                <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span>
</span><span id="ExperimentParametrisation-1312"><a href="#ExperimentParametrisation-1312"><span class="linenos">1312</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation-1313"><a href="#ExperimentParametrisation-1313"><span class="linenos">1313</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">as_string</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1314"><a href="#ExperimentParametrisation-1314"><span class="linenos">1314</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1315"><a href="#ExperimentParametrisation-1315"><span class="linenos">1315</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1316"><a href="#ExperimentParametrisation-1316"><span class="linenos">1316</span></a>            <span class="k">return</span> <span class="n">string</span>
</span><span id="ExperimentParametrisation-1317"><a href="#ExperimentParametrisation-1317"><span class="linenos">1317</span></a>
</span><span id="ExperimentParametrisation-1318"><a href="#ExperimentParametrisation-1318"><span class="linenos">1318</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expand_virtual_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="ExperimentParametrisation-1319"><a href="#ExperimentParametrisation-1319"><span class="linenos">1319</span></a>        <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ExperimentParametrisation-1320"><a href="#ExperimentParametrisation-1320"><span class="linenos">1320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span><span class="o">.</span><span class="n">expand_isotropically</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span><span id="ExperimentParametrisation-1321"><a href="#ExperimentParametrisation-1321"><span class="linenos">1321</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;imager&quot;</span><span class="p">,])</span>
</span></pre></div>


    

                            <div id="ExperimentParametrisation.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">ExperimentParametrisation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">experiment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;vLab4mic_experiment&#39;</span>,</span><span class="param">	<span class="n">structure_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1XI5&#39;</span>,</span><span class="param">	<span class="n">structure_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;CIF&#39;</span>,</span><span class="param">	<span class="n">configuration_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">structure_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;NHS_ester&#39;</span>,</span><span class="param">	<span class="n">fluorophore_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;AF647&#39;</span>,</span><span class="param">	<span class="n">coordinate_field_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;square1x1um_randomised&#39;</span>,</span><span class="param">	<span class="n">selected_mods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">imaging_modalities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">probe_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">structural_integrity_eps</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">sweep_pars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">objects_created</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">output_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.__init__"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.experiment_id" class="classattr">
                                <div class="attr variable">
            <span class="name">experiment_id</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;vLab4mic_experiment&#39;</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.experiment_id"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.structure_id" class="classattr">
                                <div class="attr variable">
            <span class="name">structure_id</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;1XI5&#39;</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.structure_id"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.structure_format" class="classattr">
                                <div class="attr variable">
            <span class="name">structure_format</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;CIF&#39;</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.structure_format"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.configuration_path" class="classattr">
                                <div class="attr variable">
            <span class="name">configuration_path</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;&#39;</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.configuration_path"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.structure_label" class="classattr">
                                <div class="attr variable">
            <span class="name">structure_label</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;NHS_ester&#39;</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.structure_label"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.fluorophore_id" class="classattr">
                                <div class="attr variable">
            <span class="name">fluorophore_id</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;AF647&#39;</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.fluorophore_id"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.coordinate_field_id" class="classattr">
                                <div class="attr variable">
            <span class="name">coordinate_field_id</span><span class="annotation">: str</span>        =
<span class="default_value">&#39;square1x1um_randomised&#39;</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.coordinate_field_id"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.selected_mods" class="classattr">
                                <div class="attr variable">
            <span class="name">selected_mods</span><span class="annotation">: Dict[str, int]</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.selected_mods"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.imaging_modalities" class="classattr">
                                <div class="attr variable">
            <span class="name">imaging_modalities</span><span class="annotation">: Dict[str, int]</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.imaging_modalities"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.probe_parameters" class="classattr">
                                <div class="attr variable">
            <span class="name">probe_parameters</span><span class="annotation">: Dict[str, int]</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.probe_parameters"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.structural_integrity_eps" class="classattr">
                                <div class="attr variable">
            <span class="name">structural_integrity_eps</span><span class="annotation">: Dict[str, int]</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.structural_integrity_eps"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.sweep_pars" class="classattr">
                                <div class="attr variable">
            <span class="name">sweep_pars</span><span class="annotation">: Dict[str, int]</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.sweep_pars"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.objects_created" class="classattr">
                                <div class="attr variable">
            <span class="name">objects_created</span><span class="annotation">: Dict[str, int]</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.objects_created"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.output_directory" class="classattr">
                                <div class="attr variable">
            <span class="name">output_directory</span><span class="annotation">: str</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.output_directory"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.example_structures" class="classattr">
                                <div class="attr variable">
            <span class="name">example_structures</span>        =
<span class="default_value">[&#39;3J3Y&#39;, &#39;7R5K&#39;, &#39;1XI5&#39;, &#39;8GMO&#39;]</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.example_structures"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.example_modalities" class="classattr">
                                <div class="attr variable">
            <span class="name">example_modalities</span>        =
<span class="default_value">[&#39;Widefield&#39;, &#39;Confocal&#39;, &#39;AiryScan&#39;, &#39;STED&#39;, &#39;SMLM&#39;]</span>

        
    </div>
    <a class="headerlink" href="#ExperimentParametrisation.example_modalities"></a>
    
    

                            </div>
                            <div id="ExperimentParametrisation.select_structure" class="classattr">
                                        <input id="ExperimentParametrisation.select_structure-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">select_structure</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">structure_id</span><span class="o">=</span><span class="s1">&#39;1XI5&#39;</span>, </span><span class="param"><span class="n">build</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">structure_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.select_structure-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.select_structure"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.select_structure-181"><a href="#ExperimentParametrisation.select_structure-181"><span class="linenos">181</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">select_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure_id</span><span class="o">=</span><span class="s2">&quot;1XI5&quot;</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">structure_path</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.select_structure-182"><a href="#ExperimentParametrisation.select_structure-182"><span class="linenos">182</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.select_structure-183"><a href="#ExperimentParametrisation.select_structure-183"><span class="linenos">183</span></a><span class="sd">        Select a molecular structure by its identifier and optionally build the structure module.</span>
</span><span id="ExperimentParametrisation.select_structure-184"><a href="#ExperimentParametrisation.select_structure-184"><span class="linenos">184</span></a>
</span><span id="ExperimentParametrisation.select_structure-185"><a href="#ExperimentParametrisation.select_structure-185"><span class="linenos">185</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.select_structure-186"><a href="#ExperimentParametrisation.select_structure-186"><span class="linenos">186</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.select_structure-187"><a href="#ExperimentParametrisation.select_structure-187"><span class="linenos">187</span></a><span class="sd">        :param structure_id : str, optional</span>
</span><span id="ExperimentParametrisation.select_structure-188"><a href="#ExperimentParametrisation.select_structure-188"><span class="linenos">188</span></a><span class="sd">            The identifier of the structure to select. Default is &quot;1XI5&quot;.</span>
</span><span id="ExperimentParametrisation.select_structure-189"><a href="#ExperimentParametrisation.select_structure-189"><span class="linenos">189</span></a><span class="sd">        :param build : bool, optional</span>
</span><span id="ExperimentParametrisation.select_structure-190"><a href="#ExperimentParametrisation.select_structure-190"><span class="linenos">190</span></a><span class="sd">            If True, triggers the build process for the structure module. Default is True.</span>
</span><span id="ExperimentParametrisation.select_structure-191"><a href="#ExperimentParametrisation.select_structure-191"><span class="linenos">191</span></a>
</span><span id="ExperimentParametrisation.select_structure-192"><a href="#ExperimentParametrisation.select_structure-192"><span class="linenos">192</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.select_structure-193"><a href="#ExperimentParametrisation.select_structure-193"><span class="linenos">193</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.select_structure-194"><a href="#ExperimentParametrisation.select_structure-194"><span class="linenos">194</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation.select_structure-195"><a href="#ExperimentParametrisation.select_structure-195"><span class="linenos">195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.select_structure-196"><a href="#ExperimentParametrisation.select_structure-196"><span class="linenos">196</span></a>        <span class="k">if</span> <span class="n">structure_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.select_structure-197"><a href="#ExperimentParametrisation.select_structure-197"><span class="linenos">197</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="n">structure_path</span>
</span><span id="ExperimentParametrisation.select_structure-198"><a href="#ExperimentParametrisation.select_structure-198"><span class="linenos">198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="n">structure_id</span>
</span><span id="ExperimentParametrisation.select_structure-199"><a href="#ExperimentParametrisation.select_structure-199"><span class="linenos">199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_format</span> <span class="o">=</span> <span class="n">structure_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.select_structure-200"><a href="#ExperimentParametrisation.select_structure-200"><span class="linenos">200</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.select_structure-201"><a href="#ExperimentParametrisation.select_structure-201"><span class="linenos">201</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="n">structure_id</span>
</span><span id="ExperimentParametrisation.select_structure-202"><a href="#ExperimentParametrisation.select_structure-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="n">build</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.select_structure-203"><a href="#ExperimentParametrisation.select_structure-203"><span class="linenos">203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Select a molecular structure by its identifier and optionally build the structure module.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>structure_id</strong>:  str, optional
The identifier of the structure to select. Default is "1XI5".</li>
<li><strong>build</strong>:  bool, optional
If True, triggers the build process for the structure module. Default is True.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.clear_structure" class="classattr">
                                        <input id="ExperimentParametrisation.clear_structure-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_structure</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.clear_structure-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.clear_structure"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.clear_structure-205"><a href="#ExperimentParametrisation.clear_structure-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.clear_structure-206"><a href="#ExperimentParametrisation.clear_structure-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.clear_structure-207"><a href="#ExperimentParametrisation.clear_structure-207"><span class="linenos">207</span></a><span class="sd">        Clear the current structure by resetting the structure ID and related parameters.</span>
</span><span id="ExperimentParametrisation.clear_structure-208"><a href="#ExperimentParametrisation.clear_structure-208"><span class="linenos">208</span></a><span class="sd">        This method sets the structure ID to None and resets the structure object if it exists.</span>
</span><span id="ExperimentParametrisation.clear_structure-209"><a href="#ExperimentParametrisation.clear_structure-209"><span class="linenos">209</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.clear_structure-210"><a href="#ExperimentParametrisation.clear_structure-210"><span class="linenos">210</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.clear_structure-211"><a href="#ExperimentParametrisation.clear_structure-211"><span class="linenos">211</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation.clear_structure-212"><a href="#ExperimentParametrisation.clear_structure-212"><span class="linenos">212</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.clear_structure-213"><a href="#ExperimentParametrisation.clear_structure-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.clear_structure-214"><a href="#ExperimentParametrisation.clear_structure-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.clear_structure-215"><a href="#ExperimentParametrisation.clear_structure-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.clear_structure-216"><a href="#ExperimentParametrisation.clear_structure-216"><span class="linenos">216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.clear_structure-217"><a href="#ExperimentParametrisation.clear_structure-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation.clear_structure-218"><a href="#ExperimentParametrisation.clear_structure-218"><span class="linenos">218</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Structure cleared&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Clear the current structure by resetting the structure ID and related parameters.
This method sets the structure ID to None and resets the structure object if it exists.</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.add_modality" class="classattr">
                                        <input id="ExperimentParametrisation.add_modality-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_modality</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">modality_name</span>, </span><span class="param"><span class="n">save</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">modality_template</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.add_modality-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.add_modality"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.add_modality-220"><a href="#ExperimentParametrisation.add_modality-220"><span class="linenos">220</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_modality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">modality_template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.add_modality-221"><a href="#ExperimentParametrisation.add_modality-221"><span class="linenos">221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.add_modality-222"><a href="#ExperimentParametrisation.add_modality-222"><span class="linenos">222</span></a><span class="sd">        Add a new imaging modality to the experiment.</span>
</span><span id="ExperimentParametrisation.add_modality-223"><a href="#ExperimentParametrisation.add_modality-223"><span class="linenos">223</span></a>
</span><span id="ExperimentParametrisation.add_modality-224"><a href="#ExperimentParametrisation.add_modality-224"><span class="linenos">224</span></a><span class="sd">        If the specified modality name exists in the local modalities, it copies the parameters from the local template.</span>
</span><span id="ExperimentParametrisation.add_modality-225"><a href="#ExperimentParametrisation.add_modality-225"><span class="linenos">225</span></a><span class="sd">        Otherwise, it uses the &#39;Widefield&#39; modality parameters as a template to create a new modality.</span>
</span><span id="ExperimentParametrisation.add_modality-226"><a href="#ExperimentParametrisation.add_modality-226"><span class="linenos">226</span></a><span class="sd">        Additional parameters for the modality can be specified via keyword arguments and will override the defaults.</span>
</span><span id="ExperimentParametrisation.add_modality-227"><a href="#ExperimentParametrisation.add_modality-227"><span class="linenos">227</span></a><span class="sd">        Optionally, the modality output can be saved by setting `save` to True.</span>
</span><span id="ExperimentParametrisation.add_modality-228"><a href="#ExperimentParametrisation.add_modality-228"><span class="linenos">228</span></a>
</span><span id="ExperimentParametrisation.add_modality-229"><a href="#ExperimentParametrisation.add_modality-229"><span class="linenos">229</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.add_modality-230"><a href="#ExperimentParametrisation.add_modality-230"><span class="linenos">230</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.add_modality-231"><a href="#ExperimentParametrisation.add_modality-231"><span class="linenos">231</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="ExperimentParametrisation.add_modality-232"><a href="#ExperimentParametrisation.add_modality-232"><span class="linenos">232</span></a><span class="sd">            The name of the modality to add.</span>
</span><span id="ExperimentParametrisation.add_modality-233"><a href="#ExperimentParametrisation.add_modality-233"><span class="linenos">233</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="ExperimentParametrisation.add_modality-234"><a href="#ExperimentParametrisation.add_modality-234"><span class="linenos">234</span></a><span class="sd">            If True, saves the modality output. Default is False.</span>
</span><span id="ExperimentParametrisation.add_modality-235"><a href="#ExperimentParametrisation.add_modality-235"><span class="linenos">235</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation.add_modality-236"><a href="#ExperimentParametrisation.add_modality-236"><span class="linenos">236</span></a><span class="sd">            Arbitrary keyword arguments to override or set specific modality parameters.</span>
</span><span id="ExperimentParametrisation.add_modality-237"><a href="#ExperimentParametrisation.add_modality-237"><span class="linenos">237</span></a>
</span><span id="ExperimentParametrisation.add_modality-238"><a href="#ExperimentParametrisation.add_modality-238"><span class="linenos">238</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.add_modality-239"><a href="#ExperimentParametrisation.add_modality-239"><span class="linenos">239</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.add_modality-240"><a href="#ExperimentParametrisation.add_modality-240"><span class="linenos">240</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation.add_modality-241"><a href="#ExperimentParametrisation.add_modality-241"><span class="linenos">241</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.add_modality-242"><a href="#ExperimentParametrisation.add_modality-242"><span class="linenos">242</span></a>        <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_names</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_modality-243"><a href="#ExperimentParametrisation.add_modality-243"><span class="linenos">243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_modality-244"><a href="#ExperimentParametrisation.add_modality-244"><span class="linenos">244</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.add_modality-245"><a href="#ExperimentParametrisation.add_modality-245"><span class="linenos">245</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_modality-246"><a href="#ExperimentParametrisation.add_modality-246"><span class="linenos">246</span></a>            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ExperimentParametrisation.add_modality-247"><a href="#ExperimentParametrisation.add_modality-247"><span class="linenos">247</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="ExperimentParametrisation.add_modality-248"><a href="#ExperimentParametrisation.add_modality-248"><span class="linenos">248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_modality-249"><a href="#ExperimentParametrisation.add_modality-249"><span class="linenos">249</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_modality-250"><a href="#ExperimentParametrisation.add_modality-250"><span class="linenos">250</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_modality-251"><a href="#ExperimentParametrisation.add_modality-251"><span class="linenos">251</span></a>                <span class="sa">f</span><span class="s2">&quot;Modality </span><span class="si">{</span><span class="n">modality_name</span><span class="si">}</span><span class="s2"> not found in demo modalities. Using template to create new.&quot;</span>
</span><span id="ExperimentParametrisation.add_modality-252"><a href="#ExperimentParametrisation.add_modality-252"><span class="linenos">252</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_modality-253"><a href="#ExperimentParametrisation.add_modality-253"><span class="linenos">253</span></a>            <span class="k">if</span> <span class="n">modality_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_modality-254"><a href="#ExperimentParametrisation.add_modality-254"><span class="linenos">254</span></a>                <span class="n">template_modality</span> <span class="o">=</span> <span class="n">modality_template</span>
</span><span id="ExperimentParametrisation.add_modality-255"><a href="#ExperimentParametrisation.add_modality-255"><span class="linenos">255</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_modality-256"><a href="#ExperimentParametrisation.add_modality-256"><span class="linenos">256</span></a>                <span class="n">template_modality</span> <span class="o">=</span> <span class="s2">&quot;Widefield&quot;</span>
</span><span id="ExperimentParametrisation.add_modality-257"><a href="#ExperimentParametrisation.add_modality-257"><span class="linenos">257</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">template_modality</span><span class="si">}</span><span class="s2"> as template.&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_modality-258"><a href="#ExperimentParametrisation.add_modality-258"><span class="linenos">258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_modality-259"><a href="#ExperimentParametrisation.add_modality-259"><span class="linenos">259</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">template_modality</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.add_modality-260"><a href="#ExperimentParametrisation.add_modality-260"><span class="linenos">260</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_modality-261"><a href="#ExperimentParametrisation.add_modality-261"><span class="linenos">261</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;modality&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modality_name</span>
</span><span id="ExperimentParametrisation.add_modality-262"><a href="#ExperimentParametrisation.add_modality-262"><span class="linenos">262</span></a>            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ExperimentParametrisation.add_modality-263"><a href="#ExperimentParametrisation.add_modality-263"><span class="linenos">263</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="ExperimentParametrisation.add_modality-264"><a href="#ExperimentParametrisation.add_modality-264"><span class="linenos">264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_modality-265"><a href="#ExperimentParametrisation.add_modality-265"><span class="linenos">265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modality_name</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_modality-266"><a href="#ExperimentParametrisation.add_modality-266"><span class="linenos">266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_modality-267"><a href="#ExperimentParametrisation.add_modality-267"><span class="linenos">267</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.add_modality-268"><a href="#ExperimentParametrisation.add_modality-268"><span class="linenos">268</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add a new imaging modality to the experiment.</p>

<p>If the specified modality name exists in the local modalities, it copies the parameters from the local template.
Otherwise, it uses the 'Widefield' modality parameters as a template to create a new modality.
Additional parameters for the modality can be specified via keyword arguments and will override the defaults.
Optionally, the modality output can be saved by setting <code>save</code> to True.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>modality_name</strong>:  str
The name of the modality to add.</li>
<li><strong>save</strong>:  bool, optional
If True, saves the modality output. Default is False.
:param **kwargs
Arbitrary keyword arguments to override or set specific modality parameters.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.update_modality" class="classattr">
                                        <input id="ExperimentParametrisation.update_modality-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_modality</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">modality_name</span>,</span><span class="param">	<span class="n">pixelsize_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">lateral_resolution_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">axial_resolution_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">psf_voxel_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">depth_of_field_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">remove</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.update_modality-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.update_modality"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.update_modality-270"><a href="#ExperimentParametrisation.update_modality-270"><span class="linenos">270</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_modality</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.update_modality-271"><a href="#ExperimentParametrisation.update_modality-271"><span class="linenos">271</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-272"><a href="#ExperimentParametrisation.update_modality-272"><span class="linenos">272</span></a>        <span class="n">modality_name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-273"><a href="#ExperimentParametrisation.update_modality-273"><span class="linenos">273</span></a>        <span class="n">pixelsize_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-274"><a href="#ExperimentParametrisation.update_modality-274"><span class="linenos">274</span></a>        <span class="n">lateral_resolution_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-275"><a href="#ExperimentParametrisation.update_modality-275"><span class="linenos">275</span></a>        <span class="n">axial_resolution_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-276"><a href="#ExperimentParametrisation.update_modality-276"><span class="linenos">276</span></a>        <span class="n">psf_voxel_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-277"><a href="#ExperimentParametrisation.update_modality-277"><span class="linenos">277</span></a>        <span class="n">depth_of_field_nm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-278"><a href="#ExperimentParametrisation.update_modality-278"><span class="linenos">278</span></a>        <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-279"><a href="#ExperimentParametrisation.update_modality-279"><span class="linenos">279</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-280"><a href="#ExperimentParametrisation.update_modality-280"><span class="linenos">280</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation.update_modality-281"><a href="#ExperimentParametrisation.update_modality-281"><span class="linenos">281</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-282"><a href="#ExperimentParametrisation.update_modality-282"><span class="linenos">282</span></a><span class="sd">        Update or remove an imaging modality&#39;s parameters.</span>
</span><span id="ExperimentParametrisation.update_modality-283"><a href="#ExperimentParametrisation.update_modality-283"><span class="linenos">283</span></a>
</span><span id="ExperimentParametrisation.update_modality-284"><a href="#ExperimentParametrisation.update_modality-284"><span class="linenos">284</span></a><span class="sd">        This method allows updating specific parameters of an imaging modality, such as pixel size, lateral and axial resolution, and PSF voxel size.</span>
</span><span id="ExperimentParametrisation.update_modality-285"><a href="#ExperimentParametrisation.update_modality-285"><span class="linenos">285</span></a><span class="sd">        If `remove` is True, the modality is removed from the internal dictionaries.</span>
</span><span id="ExperimentParametrisation.update_modality-286"><a href="#ExperimentParametrisation.update_modality-286"><span class="linenos">286</span></a>
</span><span id="ExperimentParametrisation.update_modality-287"><a href="#ExperimentParametrisation.update_modality-287"><span class="linenos">287</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.update_modality-288"><a href="#ExperimentParametrisation.update_modality-288"><span class="linenos">288</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.update_modality-289"><a href="#ExperimentParametrisation.update_modality-289"><span class="linenos">289</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="ExperimentParametrisation.update_modality-290"><a href="#ExperimentParametrisation.update_modality-290"><span class="linenos">290</span></a><span class="sd">            The name of the imaging modality to update or remove.</span>
</span><span id="ExperimentParametrisation.update_modality-291"><a href="#ExperimentParametrisation.update_modality-291"><span class="linenos">291</span></a><span class="sd">        :param pixelsize_nm : int, optional</span>
</span><span id="ExperimentParametrisation.update_modality-292"><a href="#ExperimentParametrisation.update_modality-292"><span class="linenos">292</span></a><span class="sd">            The new pixel size in nanometers. If provided, updates the detector pixel size.</span>
</span><span id="ExperimentParametrisation.update_modality-293"><a href="#ExperimentParametrisation.update_modality-293"><span class="linenos">293</span></a><span class="sd">        :param lateral_resolution_nm : int, optional</span>
</span><span id="ExperimentParametrisation.update_modality-294"><a href="#ExperimentParametrisation.update_modality-294"><span class="linenos">294</span></a><span class="sd">            The new lateral resolution in nanometers. If provided, updates the lateral standard deviations of the PSF.</span>
</span><span id="ExperimentParametrisation.update_modality-295"><a href="#ExperimentParametrisation.update_modality-295"><span class="linenos">295</span></a><span class="sd">        :param axial_resolution_nm : int, optional</span>
</span><span id="ExperimentParametrisation.update_modality-296"><a href="#ExperimentParametrisation.update_modality-296"><span class="linenos">296</span></a><span class="sd">            The new axial resolution in nanometers. If provided, updates the axial standard deviation of the PSF.</span>
</span><span id="ExperimentParametrisation.update_modality-297"><a href="#ExperimentParametrisation.update_modality-297"><span class="linenos">297</span></a><span class="sd">        :param psf_voxel_nm : int, optional</span>
</span><span id="ExperimentParametrisation.update_modality-298"><a href="#ExperimentParametrisation.update_modality-298"><span class="linenos">298</span></a><span class="sd">            The new PSF voxel size in nanometers. If provided, updates the PSF voxel size for all axes.</span>
</span><span id="ExperimentParametrisation.update_modality-299"><a href="#ExperimentParametrisation.update_modality-299"><span class="linenos">299</span></a><span class="sd">        :param remove : bool, optional</span>
</span><span id="ExperimentParametrisation.update_modality-300"><a href="#ExperimentParametrisation.update_modality-300"><span class="linenos">300</span></a><span class="sd">            If True, removes the specified modality from the internal dictionaries. Default is False.</span>
</span><span id="ExperimentParametrisation.update_modality-301"><a href="#ExperimentParametrisation.update_modality-301"><span class="linenos">301</span></a>
</span><span id="ExperimentParametrisation.update_modality-302"><a href="#ExperimentParametrisation.update_modality-302"><span class="linenos">302</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation.update_modality-303"><a href="#ExperimentParametrisation.update_modality-303"><span class="linenos">303</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation.update_modality-304"><a href="#ExperimentParametrisation.update_modality-304"><span class="linenos">304</span></a><span class="sd">        After updating any parameters, the imaging modality is reconfigured in the imager.</span>
</span><span id="ExperimentParametrisation.update_modality-305"><a href="#ExperimentParametrisation.update_modality-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-306"><a href="#ExperimentParametrisation.update_modality-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.update_modality-307"><a href="#ExperimentParametrisation.update_modality-307"><span class="linenos">307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.update_modality-308"><a href="#ExperimentParametrisation.update_modality-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.update_modality-309"><a href="#ExperimentParametrisation.update_modality-309"><span class="linenos">309</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.update_modality-310"><a href="#ExperimentParametrisation.update_modality-310"><span class="linenos">310</span></a>            <span class="n">changes</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation.update_modality-311"><a href="#ExperimentParametrisation.update_modality-311"><span class="linenos">311</span></a>            <span class="k">if</span> <span class="n">pixelsize_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.update_modality-312"><a href="#ExperimentParametrisation.update_modality-312"><span class="linenos">312</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;detector&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-313"><a href="#ExperimentParametrisation.update_modality-313"><span class="linenos">313</span></a>                    <span class="s2">&quot;pixelsize&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-314"><a href="#ExperimentParametrisation.update_modality-314"><span class="linenos">314</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixelsize_nm</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.update_modality-315"><a href="#ExperimentParametrisation.update_modality-315"><span class="linenos">315</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation.update_modality-316"><a href="#ExperimentParametrisation.update_modality-316"><span class="linenos">316</span></a>            <span class="k">if</span> <span class="n">lateral_resolution_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.update_modality-317"><a href="#ExperimentParametrisation.update_modality-317"><span class="linenos">317</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-318"><a href="#ExperimentParametrisation.update_modality-318"><span class="linenos">318</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-319"><a href="#ExperimentParametrisation.update_modality-319"><span class="linenos">319</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.update_modality-320"><a href="#ExperimentParametrisation.update_modality-320"><span class="linenos">320</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-321"><a href="#ExperimentParametrisation.update_modality-321"><span class="linenos">321</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-322"><a href="#ExperimentParametrisation.update_modality-322"><span class="linenos">322</span></a>                <span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lateral_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.update_modality-323"><a href="#ExperimentParametrisation.update_modality-323"><span class="linenos">323</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-324"><a href="#ExperimentParametrisation.update_modality-324"><span class="linenos">324</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-325"><a href="#ExperimentParametrisation.update_modality-325"><span class="linenos">325</span></a>                <span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lateral_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.update_modality-326"><a href="#ExperimentParametrisation.update_modality-326"><span class="linenos">326</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation.update_modality-327"><a href="#ExperimentParametrisation.update_modality-327"><span class="linenos">327</span></a>            <span class="k">if</span> <span class="n">axial_resolution_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.update_modality-328"><a href="#ExperimentParametrisation.update_modality-328"><span class="linenos">328</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-329"><a href="#ExperimentParametrisation.update_modality-329"><span class="linenos">329</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-330"><a href="#ExperimentParametrisation.update_modality-330"><span class="linenos">330</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.update_modality-331"><a href="#ExperimentParametrisation.update_modality-331"><span class="linenos">331</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-332"><a href="#ExperimentParametrisation.update_modality-332"><span class="linenos">332</span></a>                    <span class="s2">&quot;std_devs&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-333"><a href="#ExperimentParametrisation.update_modality-333"><span class="linenos">333</span></a>                <span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">axial_resolution_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.update_modality-334"><a href="#ExperimentParametrisation.update_modality-334"><span class="linenos">334</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation.update_modality-335"><a href="#ExperimentParametrisation.update_modality-335"><span class="linenos">335</span></a>            <span class="k">if</span> <span class="n">psf_voxel_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.update_modality-336"><a href="#ExperimentParametrisation.update_modality-336"><span class="linenos">336</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-337"><a href="#ExperimentParametrisation.update_modality-337"><span class="linenos">337</span></a>                    <span class="s2">&quot;voxelsize&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-338"><a href="#ExperimentParametrisation.update_modality-338"><span class="linenos">338</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ExperimentParametrisation.update_modality-339"><a href="#ExperimentParametrisation.update_modality-339"><span class="linenos">339</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-340"><a href="#ExperimentParametrisation.update_modality-340"><span class="linenos">340</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-341"><a href="#ExperimentParametrisation.update_modality-341"><span class="linenos">341</span></a>                    <span class="n">psf_voxel_nm</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.update_modality-342"><a href="#ExperimentParametrisation.update_modality-342"><span class="linenos">342</span></a>                <span class="p">]</span>
</span><span id="ExperimentParametrisation.update_modality-343"><a href="#ExperimentParametrisation.update_modality-343"><span class="linenos">343</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation.update_modality-344"><a href="#ExperimentParametrisation.update_modality-344"><span class="linenos">344</span></a>            <span class="k">if</span> <span class="n">depth_of_field_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.update_modality-345"><a href="#ExperimentParametrisation.update_modality-345"><span class="linenos">345</span></a>                <span class="n">depth_in_slices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.update_modality-346"><a href="#ExperimentParametrisation.update_modality-346"><span class="linenos">346</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_modalities_parameters</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-347"><a href="#ExperimentParametrisation.update_modality-347"><span class="linenos">347</span></a>                    <span class="s2">&quot;psf_params&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-348"><a href="#ExperimentParametrisation.update_modality-348"><span class="linenos">348</span></a>                <span class="p">][</span><span class="s2">&quot;voxelsize&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.update_modality-349"><a href="#ExperimentParametrisation.update_modality-349"><span class="linenos">349</span></a>                <span class="n">depth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">depth_of_field_nm</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.update_modality-350"><a href="#ExperimentParametrisation.update_modality-350"><span class="linenos">350</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">][</span><span class="s2">&quot;psf_params&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.update_modality-351"><a href="#ExperimentParametrisation.update_modality-351"><span class="linenos">351</span></a>                    <span class="s2">&quot;depth&quot;</span>
</span><span id="ExperimentParametrisation.update_modality-352"><a href="#ExperimentParametrisation.update_modality-352"><span class="linenos">352</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="n">depth</span>
</span><span id="ExperimentParametrisation.update_modality-353"><a href="#ExperimentParametrisation.update_modality-353"><span class="linenos">353</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation.update_modality-354"><a href="#ExperimentParametrisation.update_modality-354"><span class="linenos">354</span></a>            <span class="k">if</span> <span class="n">changes</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.update_modality-355"><a href="#ExperimentParametrisation.update_modality-355"><span class="linenos">355</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">set_imaging_modality</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.update_modality-356"><a href="#ExperimentParametrisation.update_modality-356"><span class="linenos">356</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.update_modality-357"><a href="#ExperimentParametrisation.update_modality-357"><span class="linenos">357</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update or remove an imaging modality's parameters.</p>

<p>This method allows updating specific parameters of an imaging modality, such as pixel size, lateral and axial resolution, and PSF voxel size.
If <code>remove</code> is True, the modality is removed from the internal dictionaries.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>modality_name</strong>:  str
The name of the imaging modality to update or remove.</li>
<li><strong>pixelsize_nm</strong>:  int, optional
The new pixel size in nanometers. If provided, updates the detector pixel size.</li>
<li><strong>lateral_resolution_nm</strong>:  int, optional
The new lateral resolution in nanometers. If provided, updates the lateral standard deviations of the PSF.</li>
<li><strong>axial_resolution_nm</strong>:  int, optional
The new axial resolution in nanometers. If provided, updates the axial standard deviation of the PSF.</li>
<li><strong>psf_voxel_nm</strong>:  int, optional
The new PSF voxel size in nanometers. If provided, updates the PSF voxel size for all axes.</li>
<li><strong>remove</strong>:  bool, optional
If True, removes the specified modality from the internal dictionaries. Default is False.</li>
</ul>

<h2 id="notes">Notes</h2>

<p>After updating any parameters, the imaging modality is reconfigured in the imager.</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.set_modality_acq" class="classattr">
                                        <input id="ExperimentParametrisation.set_modality_acq-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_modality_acq</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">modality_name</span>,</span><span class="param">	<span class="n">exp_time</span><span class="o">=</span><span class="mf">0.001</span>,</span><span class="param">	<span class="n">noise</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">save</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">nframes</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ch0&#39;</span><span class="p">]</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.set_modality_acq-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.set_modality_acq"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.set_modality_acq-359"><a href="#ExperimentParametrisation.set_modality_acq-359"><span class="linenos">359</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_modality_acq</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.set_modality_acq-360"><a href="#ExperimentParametrisation.set_modality_acq-360"><span class="linenos">360</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_modality_acq-361"><a href="#ExperimentParametrisation.set_modality_acq-361"><span class="linenos">361</span></a>        <span class="n">modality_name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_modality_acq-362"><a href="#ExperimentParametrisation.set_modality_acq-362"><span class="linenos">362</span></a>        <span class="n">exp_time</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_modality_acq-363"><a href="#ExperimentParametrisation.set_modality_acq-363"><span class="linenos">363</span></a>        <span class="n">noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_modality_acq-364"><a href="#ExperimentParametrisation.set_modality_acq-364"><span class="linenos">364</span></a>        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_modality_acq-365"><a href="#ExperimentParametrisation.set_modality_acq-365"><span class="linenos">365</span></a>        <span class="n">nframes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_modality_acq-366"><a href="#ExperimentParametrisation.set_modality_acq-366"><span class="linenos">366</span></a>        <span class="n">channels</span><span class="o">=</span><span class="p">[</span>
</span><span id="ExperimentParametrisation.set_modality_acq-367"><a href="#ExperimentParametrisation.set_modality_acq-367"><span class="linenos">367</span></a>            <span class="s2">&quot;ch0&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_modality_acq-368"><a href="#ExperimentParametrisation.set_modality_acq-368"><span class="linenos">368</span></a>        <span class="p">],</span>
</span><span id="ExperimentParametrisation.set_modality_acq-369"><a href="#ExperimentParametrisation.set_modality_acq-369"><span class="linenos">369</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_modality_acq-370"><a href="#ExperimentParametrisation.set_modality_acq-370"><span class="linenos">370</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation.set_modality_acq-371"><a href="#ExperimentParametrisation.set_modality_acq-371"><span class="linenos">371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.set_modality_acq-372"><a href="#ExperimentParametrisation.set_modality_acq-372"><span class="linenos">372</span></a><span class="sd">        Configure and set acquisition parameters for a specified imaging modality.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-373"><a href="#ExperimentParametrisation.set_modality_acq-373"><span class="linenos">373</span></a>
</span><span id="ExperimentParametrisation.set_modality_acq-374"><a href="#ExperimentParametrisation.set_modality_acq-374"><span class="linenos">374</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.set_modality_acq-375"><a href="#ExperimentParametrisation.set_modality_acq-375"><span class="linenos">375</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.set_modality_acq-376"><a href="#ExperimentParametrisation.set_modality_acq-376"><span class="linenos">376</span></a><span class="sd">        :param modality_name : str</span>
</span><span id="ExperimentParametrisation.set_modality_acq-377"><a href="#ExperimentParametrisation.set_modality_acq-377"><span class="linenos">377</span></a><span class="sd">            The name of the imaging modality to configure.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-378"><a href="#ExperimentParametrisation.set_modality_acq-378"><span class="linenos">378</span></a><span class="sd">        :param exp_time : float, optional</span>
</span><span id="ExperimentParametrisation.set_modality_acq-379"><a href="#ExperimentParametrisation.set_modality_acq-379"><span class="linenos">379</span></a><span class="sd">            Exposure time for the acquisition in seconds. Default is 0.001.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-380"><a href="#ExperimentParametrisation.set_modality_acq-380"><span class="linenos">380</span></a><span class="sd">        :param noise : bool, optional</span>
</span><span id="ExperimentParametrisation.set_modality_acq-381"><a href="#ExperimentParametrisation.set_modality_acq-381"><span class="linenos">381</span></a><span class="sd">            Whether to include noise in the acquisition. Default is True.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-382"><a href="#ExperimentParametrisation.set_modality_acq-382"><span class="linenos">382</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="ExperimentParametrisation.set_modality_acq-383"><a href="#ExperimentParametrisation.set_modality_acq-383"><span class="linenos">383</span></a><span class="sd">            Whether to save the acquired data. Default is False.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-384"><a href="#ExperimentParametrisation.set_modality_acq-384"><span class="linenos">384</span></a><span class="sd">        :param nframes : int, optional</span>
</span><span id="ExperimentParametrisation.set_modality_acq-385"><a href="#ExperimentParametrisation.set_modality_acq-385"><span class="linenos">385</span></a><span class="sd">            Number of frames to acquire. Default is 1.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-386"><a href="#ExperimentParametrisation.set_modality_acq-386"><span class="linenos">386</span></a><span class="sd">        :param channels : list of str, optional</span>
</span><span id="ExperimentParametrisation.set_modality_acq-387"><a href="#ExperimentParametrisation.set_modality_acq-387"><span class="linenos">387</span></a><span class="sd">            List of channel names to use. Default is [&quot;ch0&quot;].</span>
</span><span id="ExperimentParametrisation.set_modality_acq-388"><a href="#ExperimentParametrisation.set_modality_acq-388"><span class="linenos">388</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation.set_modality_acq-389"><a href="#ExperimentParametrisation.set_modality_acq-389"><span class="linenos">389</span></a><span class="sd">            Additional keyword arguments for modality-specific parameters.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-390"><a href="#ExperimentParametrisation.set_modality_acq-390"><span class="linenos">390</span></a>
</span><span id="ExperimentParametrisation.set_modality_acq-391"><a href="#ExperimentParametrisation.set_modality_acq-391"><span class="linenos">391</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation.set_modality_acq-392"><a href="#ExperimentParametrisation.set_modality_acq-392"><span class="linenos">392</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation.set_modality_acq-393"><a href="#ExperimentParametrisation.set_modality_acq-393"><span class="linenos">393</span></a><span class="sd">        If the specified modality is not available in `self.imaging_modalities`, a message is printed and no action is taken.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-394"><a href="#ExperimentParametrisation.set_modality_acq-394"><span class="linenos">394</span></a><span class="sd">        Acquisition parameters are formatted using `configuration_format.format_modality_acquisition_params` and stored in `self.selected_mods`.</span>
</span><span id="ExperimentParametrisation.set_modality_acq-395"><a href="#ExperimentParametrisation.set_modality_acq-395"><span class="linenos">395</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.set_modality_acq-396"><a href="#ExperimentParametrisation.set_modality_acq-396"><span class="linenos">396</span></a>        <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation.set_modality_acq-397"><a href="#ExperimentParametrisation.set_modality_acq-397"><span class="linenos">397</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.set_modality_acq-398"><a href="#ExperimentParametrisation.set_modality_acq-398"><span class="linenos">398</span></a>                <span class="n">configuration_format</span><span class="o">.</span><span class="n">format_modality_acquisition_params</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.set_modality_acq-399"><a href="#ExperimentParametrisation.set_modality_acq-399"><span class="linenos">399</span></a>                    <span class="n">exp_time</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">nframes</span><span class="p">,</span> <span class="n">channels</span>
</span><span id="ExperimentParametrisation.set_modality_acq-400"><a href="#ExperimentParametrisation.set_modality_acq-400"><span class="linenos">400</span></a>                <span class="p">)</span>
</span><span id="ExperimentParametrisation.set_modality_acq-401"><a href="#ExperimentParametrisation.set_modality_acq-401"><span class="linenos">401</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.set_modality_acq-402"><a href="#ExperimentParametrisation.set_modality_acq-402"><span class="linenos">402</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_modality_acq-403"><a href="#ExperimentParametrisation.set_modality_acq-403"><span class="linenos">403</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modality not selected&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Configure and set acquisition parameters for a specified imaging modality.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>modality_name</strong>:  str
The name of the imaging modality to configure.</li>
<li><strong>exp_time</strong>:  float, optional
Exposure time for the acquisition in seconds. Default is 0.001.</li>
<li><strong>noise</strong>:  bool, optional
Whether to include noise in the acquisition. Default is True.</li>
<li><strong>save</strong>:  bool, optional
Whether to save the acquired data. Default is False.</li>
<li><strong>nframes</strong>:  int, optional
Number of frames to acquire. Default is 1.</li>
<li><strong>channels</strong>:  list of str, optional
List of channel names to use. Default is ["ch0"].
:param **kwargs
Additional keyword arguments for modality-specific parameters.</li>
</ul>

<h2 id="notes">Notes</h2>

<p>If the specified modality is not available in <code>self.imaging_modalities</code>, a message is printed and no action is taken.
Acquisition parameters are formatted using <code>configuration_format.format_modality_acquisition_params</code> and stored in <code>self.selected_mods</code>.</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.clear_modalities" class="classattr">
                                        <input id="ExperimentParametrisation.clear_modalities-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_modalities</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.clear_modalities-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.clear_modalities"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.clear_modalities-405"><a href="#ExperimentParametrisation.clear_modalities-405"><span class="linenos">405</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_modalities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.clear_modalities-406"><a href="#ExperimentParametrisation.clear_modalities-406"><span class="linenos">406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.clear_modalities-407"><a href="#ExperimentParametrisation.clear_modalities-407"><span class="linenos">407</span></a><span class="sd">        Clear all selected imaging modalities and their acquisition parameters.</span>
</span><span id="ExperimentParametrisation.clear_modalities-408"><a href="#ExperimentParametrisation.clear_modalities-408"><span class="linenos">408</span></a><span class="sd">        This method resets the `imaging_modalities` and `selected_mods` dictionaries to empty states,</span>
</span><span id="ExperimentParametrisation.clear_modalities-409"><a href="#ExperimentParametrisation.clear_modalities-409"><span class="linenos">409</span></a><span class="sd">        effectively removing all configured modalities from the experiment.</span>
</span><span id="ExperimentParametrisation.clear_modalities-410"><a href="#ExperimentParametrisation.clear_modalities-410"><span class="linenos">410</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.clear_modalities-411"><a href="#ExperimentParametrisation.clear_modalities-411"><span class="linenos">411</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.clear_modalities-412"><a href="#ExperimentParametrisation.clear_modalities-412"><span class="linenos">412</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation.clear_modalities-413"><a href="#ExperimentParametrisation.clear_modalities-413"><span class="linenos">413</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.clear_modalities-414"><a href="#ExperimentParametrisation.clear_modalities-414"><span class="linenos">414</span></a>        <span class="n">modality_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="ExperimentParametrisation.clear_modalities-415"><a href="#ExperimentParametrisation.clear_modalities-415"><span class="linenos">415</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">modality_names</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.clear_modalities-416"><a href="#ExperimentParametrisation.clear_modalities-416"><span class="linenos">416</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_modality</span><span class="p">(</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.clear_modalities-417"><a href="#ExperimentParametrisation.clear_modalities-417"><span class="linenos">417</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;imager&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.clear_modalities-418"><a href="#ExperimentParametrisation.clear_modalities-418"><span class="linenos">418</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">imager</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.clear_modalities-419"><a href="#ExperimentParametrisation.clear_modalities-419"><span class="linenos">419</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;imager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation.clear_modalities-420"><a href="#ExperimentParametrisation.clear_modalities-420"><span class="linenos">420</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All modalities cleared&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Clear all selected imaging modalities and their acquisition parameters.
This method resets the <code><a href="#ExperimentParametrisation.imaging_modalities">imaging_modalities</a></code> and <code><a href="#ExperimentParametrisation.selected_mods">selected_mods</a></code> dictionaries to empty states,
effectively removing all configured modalities from the experiment.</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.reset_to_defaults" class="classattr">
                                        <input id="ExperimentParametrisation.reset_to_defaults-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reset_to_defaults</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">module</span><span class="o">=</span><span class="s1">&#39;acquisitions&#39;</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.reset_to_defaults-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.reset_to_defaults"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.reset_to_defaults-422"><a href="#ExperimentParametrisation.reset_to_defaults-422"><span class="linenos">422</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_to_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;acquisitions&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-423"><a href="#ExperimentParametrisation.reset_to_defaults-423"><span class="linenos">423</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-424"><a href="#ExperimentParametrisation.reset_to_defaults-424"><span class="linenos">424</span></a><span class="sd">        Reset acquisition parameters or other module settings to their default values.</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-425"><a href="#ExperimentParametrisation.reset_to_defaults-425"><span class="linenos">425</span></a>
</span><span id="ExperimentParametrisation.reset_to_defaults-426"><a href="#ExperimentParametrisation.reset_to_defaults-426"><span class="linenos">426</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-427"><a href="#ExperimentParametrisation.reset_to_defaults-427"><span class="linenos">427</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-428"><a href="#ExperimentParametrisation.reset_to_defaults-428"><span class="linenos">428</span></a><span class="sd">        :param module : str, optional</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-429"><a href="#ExperimentParametrisation.reset_to_defaults-429"><span class="linenos">429</span></a><span class="sd">            The module to reset. Default is &quot;acquisitions&quot;.</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-430"><a href="#ExperimentParametrisation.reset_to_defaults-430"><span class="linenos">430</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-431"><a href="#ExperimentParametrisation.reset_to_defaults-431"><span class="linenos">431</span></a><span class="sd">            Additional keyword arguments passed to the reset function.</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-432"><a href="#ExperimentParametrisation.reset_to_defaults-432"><span class="linenos">432</span></a>
</span><span id="ExperimentParametrisation.reset_to_defaults-433"><a href="#ExperimentParametrisation.reset_to_defaults-433"><span class="linenos">433</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-434"><a href="#ExperimentParametrisation.reset_to_defaults-434"><span class="linenos">434</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-435"><a href="#ExperimentParametrisation.reset_to_defaults-435"><span class="linenos">435</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-436"><a href="#ExperimentParametrisation.reset_to_defaults-436"><span class="linenos">436</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-437"><a href="#ExperimentParametrisation.reset_to_defaults-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;acquisitions&quot;</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-438"><a href="#ExperimentParametrisation.reset_to_defaults-438"><span class="linenos">438</span></a>            <span class="k">for</span> <span class="n">mod_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation.reset_to_defaults-439"><a href="#ExperimentParametrisation.reset_to_defaults-439"><span class="linenos">439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reset acquisition parameters or other module settings to their default values.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>module</strong>:  str, optional
The module to reset. Default is "acquisitions".
:param **kwargs
Additional keyword arguments passed to the reset function.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.generators_status" class="classattr">
                                        <input id="ExperimentParametrisation.generators_status-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generators_status</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">generator_name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.generators_status-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.generators_status"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.generators_status-668"><a href="#ExperimentParametrisation.generators_status-668"><span class="linenos">668</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generators_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator_name</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.generators_status-669"><a href="#ExperimentParametrisation.generators_status-669"><span class="linenos">669</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.generators_status-670"><a href="#ExperimentParametrisation.generators_status-670"><span class="linenos">670</span></a><span class="sd">        Return the status of the specified generator.</span>
</span><span id="ExperimentParametrisation.generators_status-671"><a href="#ExperimentParametrisation.generators_status-671"><span class="linenos">671</span></a>
</span><span id="ExperimentParametrisation.generators_status-672"><a href="#ExperimentParametrisation.generators_status-672"><span class="linenos">672</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.generators_status-673"><a href="#ExperimentParametrisation.generators_status-673"><span class="linenos">673</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.generators_status-674"><a href="#ExperimentParametrisation.generators_status-674"><span class="linenos">674</span></a><span class="sd">        :param generator_name : str</span>
</span><span id="ExperimentParametrisation.generators_status-675"><a href="#ExperimentParametrisation.generators_status-675"><span class="linenos">675</span></a><span class="sd">            The name of the generator whose status is to be retrieved.</span>
</span><span id="ExperimentParametrisation.generators_status-676"><a href="#ExperimentParametrisation.generators_status-676"><span class="linenos">676</span></a>
</span><span id="ExperimentParametrisation.generators_status-677"><a href="#ExperimentParametrisation.generators_status-677"><span class="linenos">677</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.generators_status-678"><a href="#ExperimentParametrisation.generators_status-678"><span class="linenos">678</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.generators_status-679"><a href="#ExperimentParametrisation.generators_status-679"><span class="linenos">679</span></a><span class="sd">        object</span>
</span><span id="ExperimentParametrisation.generators_status-680"><a href="#ExperimentParametrisation.generators_status-680"><span class="linenos">680</span></a><span class="sd">            The status or object associated with the given generator name from the objects_created dictionary.</span>
</span><span id="ExperimentParametrisation.generators_status-681"><a href="#ExperimentParametrisation.generators_status-681"><span class="linenos">681</span></a>
</span><span id="ExperimentParametrisation.generators_status-682"><a href="#ExperimentParametrisation.generators_status-682"><span class="linenos">682</span></a><span class="sd">        Raises</span>
</span><span id="ExperimentParametrisation.generators_status-683"><a href="#ExperimentParametrisation.generators_status-683"><span class="linenos">683</span></a><span class="sd">        ------</span>
</span><span id="ExperimentParametrisation.generators_status-684"><a href="#ExperimentParametrisation.generators_status-684"><span class="linenos">684</span></a><span class="sd">        KeyError</span>
</span><span id="ExperimentParametrisation.generators_status-685"><a href="#ExperimentParametrisation.generators_status-685"><span class="linenos">685</span></a><span class="sd">            If the specified generator_name does not exist in objects_created.</span>
</span><span id="ExperimentParametrisation.generators_status-686"><a href="#ExperimentParametrisation.generators_status-686"><span class="linenos">686</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.generators_status-687"><a href="#ExperimentParametrisation.generators_status-687"><span class="linenos">687</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="n">generator_name</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return the status of the specified generator.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>generator_name</strong>:  str
The name of the generator whose status is to be retrieved.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>object
    The status or object associated with the given generator name from the objects_created dictionary.</p>

<h2 id="raises">Raises</h2>

<p>KeyError
    If the specified generator_name does not exist in objects_created.</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.build" class="classattr">
                                        <input id="ExperimentParametrisation.build-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">use_locals</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">modules</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.build-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.build"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.build-689"><a href="#ExperimentParametrisation.build-689"><span class="linenos">689</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.build-690"><a href="#ExperimentParametrisation.build-690"><span class="linenos">690</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.build-691"><a href="#ExperimentParametrisation.build-691"><span class="linenos">691</span></a>        <span class="n">use_locals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.build-692"><a href="#ExperimentParametrisation.build-692"><span class="linenos">692</span></a>        <span class="n">modules</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ExperimentParametrisation.build-693"><a href="#ExperimentParametrisation.build-693"><span class="linenos">693</span></a>            <span class="s2">&quot;all&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.build-694"><a href="#ExperimentParametrisation.build-694"><span class="linenos">694</span></a>        <span class="p">],</span>
</span><span id="ExperimentParametrisation.build-695"><a href="#ExperimentParametrisation.build-695"><span class="linenos">695</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.build-696"><a href="#ExperimentParametrisation.build-696"><span class="linenos">696</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation.build-697"><a href="#ExperimentParametrisation.build-697"><span class="linenos">697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.build-698"><a href="#ExperimentParametrisation.build-698"><span class="linenos">698</span></a><span class="sd">        Build various simulation objects based on the specified modules.</span>
</span><span id="ExperimentParametrisation.build-699"><a href="#ExperimentParametrisation.build-699"><span class="linenos">699</span></a>
</span><span id="ExperimentParametrisation.build-700"><a href="#ExperimentParametrisation.build-700"><span class="linenos">700</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.build-701"><a href="#ExperimentParametrisation.build-701"><span class="linenos">701</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.build-702"><a href="#ExperimentParametrisation.build-702"><span class="linenos">702</span></a><span class="sd">        :param use_locals : bool, optional</span>
</span><span id="ExperimentParametrisation.build-703"><a href="#ExperimentParametrisation.build-703"><span class="linenos">703</span></a><span class="sd">            Determines whether to use local variables or attributes when building objects. Default is True.</span>
</span><span id="ExperimentParametrisation.build-704"><a href="#ExperimentParametrisation.build-704"><span class="linenos">704</span></a><span class="sd">        :param modules : list, optional</span>
</span><span id="ExperimentParametrisation.build-705"><a href="#ExperimentParametrisation.build-705"><span class="linenos">705</span></a><span class="sd">            List of module names to build. If &quot;all&quot; is included, builds all available modules: &quot;structure&quot;, &quot;particle&quot;, &quot;coordinate_field&quot;, and &quot;imager&quot;. Default is [&quot;all&quot;].</span>
</span><span id="ExperimentParametrisation.build-706"><a href="#ExperimentParametrisation.build-706"><span class="linenos">706</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation.build-707"><a href="#ExperimentParametrisation.build-707"><span class="linenos">707</span></a><span class="sd">            Additional keyword arguments for building modules.</span>
</span><span id="ExperimentParametrisation.build-708"><a href="#ExperimentParametrisation.build-708"><span class="linenos">708</span></a>
</span><span id="ExperimentParametrisation.build-709"><a href="#ExperimentParametrisation.build-709"><span class="linenos">709</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation.build-710"><a href="#ExperimentParametrisation.build-710"><span class="linenos">710</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation.build-711"><a href="#ExperimentParametrisation.build-711"><span class="linenos">711</span></a><span class="sd">        The order of building is: structure, particle, coordinate_field, imager.</span>
</span><span id="ExperimentParametrisation.build-712"><a href="#ExperimentParametrisation.build-712"><span class="linenos">712</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.build-713"><a href="#ExperimentParametrisation.build-713"><span class="linenos">713</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building objects&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.build-714"><a href="#ExperimentParametrisation.build-714"><span class="linenos">714</span></a>        <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.build-715"><a href="#ExperimentParametrisation.build-715"><span class="linenos">715</span></a>            <span class="n">build_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ExperimentParametrisation.build-716"><a href="#ExperimentParametrisation.build-716"><span class="linenos">716</span></a>                <span class="s2">&quot;structure&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.build-717"><a href="#ExperimentParametrisation.build-717"><span class="linenos">717</span></a>                <span class="s2">&quot;particle&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.build-718"><a href="#ExperimentParametrisation.build-718"><span class="linenos">718</span></a>                <span class="s2">&quot;coordinate_field&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.build-719"><a href="#ExperimentParametrisation.build-719"><span class="linenos">719</span></a>                <span class="s2">&quot;imager&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.build-720"><a href="#ExperimentParametrisation.build-720"><span class="linenos">720</span></a>            <span class="p">]</span>
</span><span id="ExperimentParametrisation.build-721"><a href="#ExperimentParametrisation.build-721"><span class="linenos">721</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.build-722"><a href="#ExperimentParametrisation.build-722"><span class="linenos">722</span></a>            <span class="n">build_list</span> <span class="o">=</span> <span class="n">modules</span>
</span><span id="ExperimentParametrisation.build-723"><a href="#ExperimentParametrisation.build-723"><span class="linenos">723</span></a>        <span class="k">if</span> <span class="s2">&quot;structure&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.build-724"><a href="#ExperimentParametrisation.build-724"><span class="linenos">724</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_structure</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.build-725"><a href="#ExperimentParametrisation.build-725"><span class="linenos">725</span></a>        <span class="k">if</span> <span class="s2">&quot;particle&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.build-726"><a href="#ExperimentParametrisation.build-726"><span class="linenos">726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_particle</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="n">use_locals</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.build-727"><a href="#ExperimentParametrisation.build-727"><span class="linenos">727</span></a>        <span class="k">if</span> <span class="s2">&quot;coordinate_field&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.build-728"><a href="#ExperimentParametrisation.build-728"><span class="linenos">728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_coordinate_field</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.build-729"><a href="#ExperimentParametrisation.build-729"><span class="linenos">729</span></a>                <span class="n">use_self_particle</span><span class="o">=</span><span class="n">use_locals</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="n">use_locals</span>
</span><span id="ExperimentParametrisation.build-730"><a href="#ExperimentParametrisation.build-730"><span class="linenos">730</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.build-731"><a href="#ExperimentParametrisation.build-731"><span class="linenos">731</span></a>        <span class="k">if</span> <span class="s2">&quot;imager&quot;</span> <span class="ow">in</span> <span class="n">build_list</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.build-732"><a href="#ExperimentParametrisation.build-732"><span class="linenos">732</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_imager</span><span class="p">(</span><span class="n">use_local_field</span><span class="o">=</span><span class="n">use_locals</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Build various simulation objects based on the specified modules.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>use_locals</strong>:  bool, optional
Determines whether to use local variables or attributes when building objects. Default is True.</li>
<li><strong>modules</strong>:  list, optional
List of module names to build. If "all" is included, builds all available modules: "structure", "particle", "coordinate_field", and "imager". Default is ["all"].
:param **kwargs
Additional keyword arguments for building modules.</li>
</ul>

<h2 id="notes">Notes</h2>

<p>The order of building is: structure, particle, coordinate_field, imager.</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.clear_labelled_structure" class="classattr">
                                        <input id="ExperimentParametrisation.clear_labelled_structure-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_labelled_structure</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.clear_labelled_structure-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.clear_labelled_structure"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.clear_labelled_structure-813"><a href="#ExperimentParametrisation.clear_labelled_structure-813"><span class="linenos">813</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_labelled_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.clear_labelled_structure-814"><a href="#ExperimentParametrisation.clear_labelled_structure-814"><span class="linenos">814</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">remove_probes</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="ExperimentParametrisation.clear_virtual_sample" class="classattr">
                                        <input id="ExperimentParametrisation.clear_virtual_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_virtual_sample</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.clear_virtual_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.clear_virtual_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.clear_virtual_sample-816"><a href="#ExperimentParametrisation.clear_virtual_sample-816"><span class="linenos">816</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_virtual_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.clear_virtual_sample-817"><a href="#ExperimentParametrisation.clear_virtual_sample-817"><span class="linenos">817</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.clear_virtual_sample-818"><a href="#ExperimentParametrisation.clear_virtual_sample-818"><span class="linenos">818</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">exported_coordinate_field</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.clear_virtual_sample-819"><a href="#ExperimentParametrisation.clear_virtual_sample-819"><span class="linenos">819</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;exported_coordinate_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation.clear_virtual_sample-820"><a href="#ExperimentParametrisation.clear_virtual_sample-820"><span class="linenos">820</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Virtual sample cleared&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ExperimentParametrisation.create_example_experiment" class="classattr">
                                        <input id="ExperimentParametrisation.create_example_experiment-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_example_experiment</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.create_example_experiment-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.create_example_experiment"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.create_example_experiment-822"><a href="#ExperimentParametrisation.create_example_experiment-822"><span class="linenos">822</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_example_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.create_example_experiment-823"><a href="#ExperimentParametrisation.create_example_experiment-823"><span class="linenos">823</span></a>        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">capture_output</span><span class="p">()</span> <span class="k">as</span> <span class="n">captured</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.create_example_experiment-824"><a href="#ExperimentParametrisation.create_example_experiment-824"><span class="linenos">824</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">select_structure</span><span class="p">(</span><span class="s2">&quot;1XI5&quot;</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.create_example_experiment-825"><a href="#ExperimentParametrisation.create_example_experiment-825"><span class="linenos">825</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_probe</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.create_example_experiment-826"><a href="#ExperimentParametrisation.create_example_experiment-826"><span class="linenos">826</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_virtualsample_params</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.create_example_experiment-827"><a href="#ExperimentParametrisation.create_example_experiment-827"><span class="linenos">827</span></a>            <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">example_modalities</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.create_example_experiment-828"><a href="#ExperimentParametrisation.create_example_experiment-828"><span class="linenos">828</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">modality_name</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.create_example_experiment-829"><a href="#ExperimentParametrisation.create_example_experiment-829"><span class="linenos">829</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.create_example_experiment-830"><a href="#ExperimentParametrisation.create_example_experiment-830"><span class="linenos">830</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Experiment created with default parameters&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ExperimentParametrisation.clear_experiment" class="classattr">
                                        <input id="ExperimentParametrisation.clear_experiment-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_experiment</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.clear_experiment-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.clear_experiment"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.clear_experiment-832"><a href="#ExperimentParametrisation.clear_experiment-832"><span class="linenos">832</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.clear_experiment-833"><a href="#ExperimentParametrisation.clear_experiment-833"><span class="linenos">833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.clear_experiment-834"><a href="#ExperimentParametrisation.clear_experiment-834"><span class="linenos">834</span></a><span class="sd">        Clear the current experiment by resetting all parameters and objects.</span>
</span><span id="ExperimentParametrisation.clear_experiment-835"><a href="#ExperimentParametrisation.clear_experiment-835"><span class="linenos">835</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.clear_experiment-836"><a href="#ExperimentParametrisation.clear_experiment-836"><span class="linenos">836</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_structure</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.clear_experiment-837"><a href="#ExperimentParametrisation.clear_experiment-837"><span class="linenos">837</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_labelled_structure</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.clear_experiment-838"><a href="#ExperimentParametrisation.clear_experiment-838"><span class="linenos">838</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_virtual_sample</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.clear_experiment-839"><a href="#ExperimentParametrisation.clear_experiment-839"><span class="linenos">839</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_modalities</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.clear_experiment-840"><a href="#ExperimentParametrisation.clear_experiment-840"><span class="linenos">840</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Clear the current experiment by resetting all parameters and objects.</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.run_simulation" class="classattr">
                                        <input id="ExperimentParametrisation.run_simulation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_simulation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">name</span><span class="o">=</span><span class="s1">&#39;vlab4mic_experiment&#39;</span>,</span><span class="param">	<span class="n">acq_params</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">save</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">modality</span><span class="o">=</span><span class="s1">&#39;All&#39;</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.run_simulation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.run_simulation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.run_simulation-842"><a href="#ExperimentParametrisation.run_simulation-842"><span class="linenos">842</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.run_simulation-843"><a href="#ExperimentParametrisation.run_simulation-843"><span class="linenos">843</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-844"><a href="#ExperimentParametrisation.run_simulation-844"><span class="linenos">844</span></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vlab4mic_experiment&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-845"><a href="#ExperimentParametrisation.run_simulation-845"><span class="linenos">845</span></a>        <span class="n">acq_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-846"><a href="#ExperimentParametrisation.run_simulation-846"><span class="linenos">846</span></a>        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-847"><a href="#ExperimentParametrisation.run_simulation-847"><span class="linenos">847</span></a>        <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-848"><a href="#ExperimentParametrisation.run_simulation-848"><span class="linenos">848</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-849"><a href="#ExperimentParametrisation.run_simulation-849"><span class="linenos">849</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation.run_simulation-850"><a href="#ExperimentParametrisation.run_simulation-850"><span class="linenos">850</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.run_simulation-851"><a href="#ExperimentParametrisation.run_simulation-851"><span class="linenos">851</span></a><span class="sd">        Run a simulation for the specified imaging modality or all modalities.</span>
</span><span id="ExperimentParametrisation.run_simulation-852"><a href="#ExperimentParametrisation.run_simulation-852"><span class="linenos">852</span></a>
</span><span id="ExperimentParametrisation.run_simulation-853"><a href="#ExperimentParametrisation.run_simulation-853"><span class="linenos">853</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.run_simulation-854"><a href="#ExperimentParametrisation.run_simulation-854"><span class="linenos">854</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.run_simulation-855"><a href="#ExperimentParametrisation.run_simulation-855"><span class="linenos">855</span></a><span class="sd">        :param name : str, optional</span>
</span><span id="ExperimentParametrisation.run_simulation-856"><a href="#ExperimentParametrisation.run_simulation-856"><span class="linenos">856</span></a><span class="sd">            Name of the experiment or simulation. Default is &quot;vlab4mic_experiment&quot;.</span>
</span><span id="ExperimentParametrisation.run_simulation-857"><a href="#ExperimentParametrisation.run_simulation-857"><span class="linenos">857</span></a><span class="sd">        :param acq_params : dict or None, optional</span>
</span><span id="ExperimentParametrisation.run_simulation-858"><a href="#ExperimentParametrisation.run_simulation-858"><span class="linenos">858</span></a><span class="sd">            Acquisition parameters for the simulation. If None and modality is &quot;All&quot;, uses self.selected_mods.</span>
</span><span id="ExperimentParametrisation.run_simulation-859"><a href="#ExperimentParametrisation.run_simulation-859"><span class="linenos">859</span></a><span class="sd">        :param save : bool, optional</span>
</span><span id="ExperimentParametrisation.run_simulation-860"><a href="#ExperimentParametrisation.run_simulation-860"><span class="linenos">860</span></a><span class="sd">            Whether to save the simulation output to disk. Default is False.</span>
</span><span id="ExperimentParametrisation.run_simulation-861"><a href="#ExperimentParametrisation.run_simulation-861"><span class="linenos">861</span></a><span class="sd">        :param modality : str, optional</span>
</span><span id="ExperimentParametrisation.run_simulation-862"><a href="#ExperimentParametrisation.run_simulation-862"><span class="linenos">862</span></a><span class="sd">            The imaging modality to simulate. If &quot;All&quot;, simulates all available modalities. Default is &quot;All&quot;.</span>
</span><span id="ExperimentParametrisation.run_simulation-863"><a href="#ExperimentParametrisation.run_simulation-863"><span class="linenos">863</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation.run_simulation-864"><a href="#ExperimentParametrisation.run_simulation-864"><span class="linenos">864</span></a><span class="sd">            Additional keyword arguments passed to the imaging generator.</span>
</span><span id="ExperimentParametrisation.run_simulation-865"><a href="#ExperimentParametrisation.run_simulation-865"><span class="linenos">865</span></a>
</span><span id="ExperimentParametrisation.run_simulation-866"><a href="#ExperimentParametrisation.run_simulation-866"><span class="linenos">866</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.run_simulation-867"><a href="#ExperimentParametrisation.run_simulation-867"><span class="linenos">867</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.run_simulation-868"><a href="#ExperimentParametrisation.run_simulation-868"><span class="linenos">868</span></a><span class="sd">        dict or None</span>
</span><span id="ExperimentParametrisation.run_simulation-869"><a href="#ExperimentParametrisation.run_simulation-869"><span class="linenos">869</span></a><span class="sd">            Simulation output as a dictionary mapping modality names to results. Returns None if the imager could not be created.</span>
</span><span id="ExperimentParametrisation.run_simulation-870"><a href="#ExperimentParametrisation.run_simulation-870"><span class="linenos">870</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.run_simulation-871"><a href="#ExperimentParametrisation.run_simulation-871"><span class="linenos">871</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;imager&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.run_simulation-872"><a href="#ExperimentParametrisation.run_simulation-872"><span class="linenos">872</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="s2">&quot;imager&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.run_simulation-873"><a href="#ExperimentParametrisation.run_simulation-873"><span class="linenos">873</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.run_simulation-874"><a href="#ExperimentParametrisation.run_simulation-874"><span class="linenos">874</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Imager not created. Cannot run simulation.&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.run_simulation-875"><a href="#ExperimentParametrisation.run_simulation-875"><span class="linenos">875</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.run_simulation-876"><a href="#ExperimentParametrisation.run_simulation-876"><span class="linenos">876</span></a>        <span class="k">if</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;All&quot;</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.run_simulation-877"><a href="#ExperimentParametrisation.run_simulation-877"><span class="linenos">877</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulating all modalities&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.run_simulation-878"><a href="#ExperimentParametrisation.run_simulation-878"><span class="linenos">878</span></a>            <span class="k">if</span> <span class="n">acq_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.run_simulation-879"><a href="#ExperimentParametrisation.run_simulation-879"><span class="linenos">879</span></a>                <span class="n">acq_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span>
</span><span id="ExperimentParametrisation.run_simulation-880"><a href="#ExperimentParametrisation.run_simulation-880"><span class="linenos">880</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.run_simulation-881"><a href="#ExperimentParametrisation.run_simulation-881"><span class="linenos">881</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span>
</span><span id="ExperimentParametrisation.run_simulation-882"><a href="#ExperimentParametrisation.run_simulation-882"><span class="linenos">882</span></a>            <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span> <span class="o">=</span> <span class="n">generate_multi_imaging_modalities</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.run_simulation-883"><a href="#ExperimentParametrisation.run_simulation-883"><span class="linenos">883</span></a>                <span class="n">image_generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-884"><a href="#ExperimentParametrisation.run_simulation-884"><span class="linenos">884</span></a>                <span class="n">experiment_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-885"><a href="#ExperimentParametrisation.run_simulation-885"><span class="linenos">885</span></a>                <span class="n">savingdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-886"><a href="#ExperimentParametrisation.run_simulation-886"><span class="linenos">886</span></a>                <span class="n">write</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-887"><a href="#ExperimentParametrisation.run_simulation-887"><span class="linenos">887</span></a>                <span class="n">acquisition_param</span><span class="o">=</span><span class="n">acq_params</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.run_simulation-888"><a href="#ExperimentParametrisation.run_simulation-888"><span class="linenos">888</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.run_simulation-889"><a href="#ExperimentParametrisation.run_simulation-889"><span class="linenos">889</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">simulation_output</span>
</span><span id="ExperimentParametrisation.run_simulation-890"><a href="#ExperimentParametrisation.run_simulation-890"><span class="linenos">890</span></a>            <span class="k">return</span> <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span>
</span><span id="ExperimentParametrisation.run_simulation-891"><a href="#ExperimentParametrisation.run_simulation-891"><span class="linenos">891</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.run_simulation-892"><a href="#ExperimentParametrisation.run_simulation-892"><span class="linenos">892</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulating: </span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.run_simulation-893"><a href="#ExperimentParametrisation.run_simulation-893"><span class="linenos">893</span></a>            <span class="n">acq_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.run_simulation-894"><a href="#ExperimentParametrisation.run_simulation-894"><span class="linenos">894</span></a>            <span class="n">timeseries_noise</span><span class="p">,</span> <span class="n">beads_noise</span><span class="p">,</span> <span class="n">timeseries_noiseless</span><span class="p">,</span> <span class="n">beads_noiseless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">generate_imaging</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.run_simulation-895"><a href="#ExperimentParametrisation.run_simulation-895"><span class="linenos">895</span></a>                <span class="n">modality</span><span class="o">=</span><span class="n">modality</span><span class="p">,</span> <span class="o">**</span><span class="n">acq_p</span>
</span><span id="ExperimentParametrisation.run_simulation-896"><a href="#ExperimentParametrisation.run_simulation-896"><span class="linenos">896</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.run_simulation-897"><a href="#ExperimentParametrisation.run_simulation-897"><span class="linenos">897</span></a>            <span class="n">simulation_output</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ExperimentParametrisation.run_simulation-898"><a href="#ExperimentParametrisation.run_simulation-898"><span class="linenos">898</span></a>            <span class="n">simulation_output_noiseless</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ExperimentParametrisation.run_simulation-899"><a href="#ExperimentParametrisation.run_simulation-899"><span class="linenos">899</span></a>            <span class="n">simulation_output</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries_noise</span>
</span><span id="ExperimentParametrisation.run_simulation-900"><a href="#ExperimentParametrisation.run_simulation-900"><span class="linenos">900</span></a>            <span class="n">simulation_output_noiseless</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeseries_noiseless</span>
</span><span id="ExperimentParametrisation.run_simulation-901"><a href="#ExperimentParametrisation.run_simulation-901"><span class="linenos">901</span></a>            <span class="k">return</span> <span class="n">simulation_output</span><span class="p">,</span> <span class="n">simulation_output_noiseless</span>
</span></pre></div>


            <div class="docstring"><p>Run a simulation for the specified imaging modality or all modalities.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>name</strong>:  str, optional
Name of the experiment or simulation. Default is "vlab4mic_experiment".</li>
<li><strong>acq_params</strong>:  dict or None, optional
Acquisition parameters for the simulation. If None and modality is "All", uses self.selected_mods.</li>
<li><strong>save</strong>:  bool, optional
Whether to save the simulation output to disk. Default is False.</li>
<li><strong>modality</strong>:  str, optional
The imaging modality to simulate. If "All", simulates all available modalities. Default is "All".
:param **kwargs
Additional keyword arguments passed to the imaging generator.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>dict or None
    Simulation output as a dictionary mapping modality names to results. Returns None if the imager could not be created.</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.remove_probes" class="classattr">
                                        <input id="ExperimentParametrisation.remove_probes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">remove_probes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.remove_probes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.remove_probes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.remove_probes-903"><a href="#ExperimentParametrisation.remove_probes-903"><span class="linenos">903</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_probes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.remove_probes-904"><a href="#ExperimentParametrisation.remove_probes-904"><span class="linenos">904</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.remove_probes-905"><a href="#ExperimentParametrisation.remove_probes-905"><span class="linenos">905</span></a><span class="sd">        Remove all probe-related parameters and update the internal state accordingly.</span>
</span><span id="ExperimentParametrisation.remove_probes-906"><a href="#ExperimentParametrisation.remove_probes-906"><span class="linenos">906</span></a>
</span><span id="ExperimentParametrisation.remove_probes-907"><a href="#ExperimentParametrisation.remove_probes-907"><span class="linenos">907</span></a><span class="sd">        This method clears the probe parameters, updates the probes, and resets the</span>
</span><span id="ExperimentParametrisation.remove_probes-908"><a href="#ExperimentParametrisation.remove_probes-908"><span class="linenos">908</span></a><span class="sd">        particle and structure objects if their respective generators are active.</span>
</span><span id="ExperimentParametrisation.remove_probes-909"><a href="#ExperimentParametrisation.remove_probes-909"><span class="linenos">909</span></a><span class="sd">        It also clears any labels associated with the structure.</span>
</span><span id="ExperimentParametrisation.remove_probes-910"><a href="#ExperimentParametrisation.remove_probes-910"><span class="linenos">910</span></a>
</span><span id="ExperimentParametrisation.remove_probes-911"><a href="#ExperimentParametrisation.remove_probes-911"><span class="linenos">911</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.remove_probes-912"><a href="#ExperimentParametrisation.remove_probes-912"><span class="linenos">912</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.remove_probes-913"><a href="#ExperimentParametrisation.remove_probes-913"><span class="linenos">913</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation.remove_probes-914"><a href="#ExperimentParametrisation.remove_probes-914"><span class="linenos">914</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.remove_probes-915"><a href="#ExperimentParametrisation.remove_probes-915"><span class="linenos">915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.remove_probes-916"><a href="#ExperimentParametrisation.remove_probes-916"><span class="linenos">916</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_probes</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.remove_probes-917"><a href="#ExperimentParametrisation.remove_probes-917"><span class="linenos">917</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;particle&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.remove_probes-918"><a href="#ExperimentParametrisation.remove_probes-918"><span class="linenos">918</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">particle</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.remove_probes-919"><a href="#ExperimentParametrisation.remove_probes-919"><span class="linenos">919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objects_created</span><span class="p">[</span><span class="s2">&quot;particle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation.remove_probes-920"><a href="#ExperimentParametrisation.remove_probes-920"><span class="linenos">920</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Labelled structure cleared&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.remove_probes-921"><a href="#ExperimentParametrisation.remove_probes-921"><span class="linenos">921</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators_status</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.remove_probes-922"><a href="#ExperimentParametrisation.remove_probes-922"><span class="linenos">922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">_clear_labels</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.remove_probes-923"><a href="#ExperimentParametrisation.remove_probes-923"><span class="linenos">923</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Probes removed from experiment&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Remove all probe-related parameters and update the internal state accordingly.</p>

<p>This method clears the probe parameters, updates the probes, and resets the
particle and structure objects if their respective generators are active.
It also clears any labels associated with the structure.</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.add_probe" class="classattr">
                                        <input id="ExperimentParametrisation.add_probe-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_probe</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;NHS_ester&#39;</span>,</span><span class="param">	<span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_target_option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;AF647&#39;</span>,</span><span class="param">	<span class="n">probe_steric_hindrance</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_wobble_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">as_primary</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">peptide_motif</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">fluorophore_parameters</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.add_probe-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.add_probe"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.add_probe-925"><a href="#ExperimentParametrisation.add_probe-925"><span class="linenos"> 925</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_probe</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-926"><a href="#ExperimentParametrisation.add_probe-926"><span class="linenos"> 926</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-927"><a href="#ExperimentParametrisation.add_probe-927"><span class="linenos"> 927</span></a>        <span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-928"><a href="#ExperimentParametrisation.add_probe-928"><span class="linenos"> 928</span></a>        <span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-929"><a href="#ExperimentParametrisation.add_probe-929"><span class="linenos"> 929</span></a>        <span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-930"><a href="#ExperimentParametrisation.add_probe-930"><span class="linenos"> 930</span></a>        <span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-931"><a href="#ExperimentParametrisation.add_probe-931"><span class="linenos"> 931</span></a>        <span class="n">probe_target_option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-932"><a href="#ExperimentParametrisation.add_probe-932"><span class="linenos"> 932</span></a>        <span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-933"><a href="#ExperimentParametrisation.add_probe-933"><span class="linenos"> 933</span></a>        <span class="n">probe_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-934"><a href="#ExperimentParametrisation.add_probe-934"><span class="linenos"> 934</span></a>        <span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-935"><a href="#ExperimentParametrisation.add_probe-935"><span class="linenos"> 935</span></a>        <span class="n">probe_steric_hindrance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-936"><a href="#ExperimentParametrisation.add_probe-936"><span class="linenos"> 936</span></a>        <span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-937"><a href="#ExperimentParametrisation.add_probe-937"><span class="linenos"> 937</span></a>        <span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-938"><a href="#ExperimentParametrisation.add_probe-938"><span class="linenos"> 938</span></a>        <span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-939"><a href="#ExperimentParametrisation.add_probe-939"><span class="linenos"> 939</span></a>        <span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-940"><a href="#ExperimentParametrisation.add_probe-940"><span class="linenos"> 940</span></a>        <span class="n">probe_wobble_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-941"><a href="#ExperimentParametrisation.add_probe-941"><span class="linenos"> 941</span></a>        <span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-942"><a href="#ExperimentParametrisation.add_probe-942"><span class="linenos"> 942</span></a>        <span class="n">as_primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-943"><a href="#ExperimentParametrisation.add_probe-943"><span class="linenos"> 943</span></a>        <span class="n">peptide_motif</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-944"><a href="#ExperimentParametrisation.add_probe-944"><span class="linenos"> 944</span></a>        <span class="n">fluorophore_parameters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-945"><a href="#ExperimentParametrisation.add_probe-945"><span class="linenos"> 945</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_probe-946"><a href="#ExperimentParametrisation.add_probe-946"><span class="linenos"> 946</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation.add_probe-947"><a href="#ExperimentParametrisation.add_probe-947"><span class="linenos"> 947</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.add_probe-948"><a href="#ExperimentParametrisation.add_probe-948"><span class="linenos"> 948</span></a><span class="sd">        Add a probe configuration to the experiment.</span>
</span><span id="ExperimentParametrisation.add_probe-949"><a href="#ExperimentParametrisation.add_probe-949"><span class="linenos"> 949</span></a>
</span><span id="ExperimentParametrisation.add_probe-950"><a href="#ExperimentParametrisation.add_probe-950"><span class="linenos"> 950</span></a><span class="sd">        This method loads a probe configuration from a YAML file, updates its parameters based on the provided arguments,</span>
</span><span id="ExperimentParametrisation.add_probe-951"><a href="#ExperimentParametrisation.add_probe-951"><span class="linenos"> 951</span></a><span class="sd">        and stores it in the experiment&#39;s probe parameters. It supports customization of probe properties such as target type,</span>
</span><span id="ExperimentParametrisation.add_probe-952"><a href="#ExperimentParametrisation.add_probe-952"><span class="linenos"> 952</span></a><span class="sd">        fluorophore, model, conjugation details, and more.</span>
</span><span id="ExperimentParametrisation.add_probe-953"><a href="#ExperimentParametrisation.add_probe-953"><span class="linenos"> 953</span></a>
</span><span id="ExperimentParametrisation.add_probe-954"><a href="#ExperimentParametrisation.add_probe-954"><span class="linenos"> 954</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.add_probe-955"><a href="#ExperimentParametrisation.add_probe-955"><span class="linenos"> 955</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.add_probe-956"><a href="#ExperimentParametrisation.add_probe-956"><span class="linenos"> 956</span></a><span class="sd">        :param probe_name : str, optional</span>
</span><span id="ExperimentParametrisation.add_probe-957"><a href="#ExperimentParametrisation.add_probe-957"><span class="linenos"> 957</span></a><span class="sd">            Name of the probe. Default is &quot;NHS_ester&quot;.</span>
</span><span id="ExperimentParametrisation.add_probe-958"><a href="#ExperimentParametrisation.add_probe-958"><span class="linenos"> 958</span></a><span class="sd">        :param probe_target_type : str, optional</span>
</span><span id="ExperimentParametrisation.add_probe-959"><a href="#ExperimentParametrisation.add_probe-959"><span class="linenos"> 959</span></a><span class="sd">            Type of the probe target (e.g., &quot;Primary&quot;, &quot;Secondary&quot;).</span>
</span><span id="ExperimentParametrisation.add_probe-960"><a href="#ExperimentParametrisation.add_probe-960"><span class="linenos"> 960</span></a><span class="sd">        :param probe_target_value : str, optional</span>
</span><span id="ExperimentParametrisation.add_probe-961"><a href="#ExperimentParametrisation.add_probe-961"><span class="linenos"> 961</span></a><span class="sd">            Value or identifier of the probe target.</span>
</span><span id="ExperimentParametrisation.add_probe-962"><a href="#ExperimentParametrisation.add_probe-962"><span class="linenos"> 962</span></a><span class="sd">        :param probe_target_option : str, optional</span>
</span><span id="ExperimentParametrisation.add_probe-963"><a href="#ExperimentParametrisation.add_probe-963"><span class="linenos"> 963</span></a><span class="sd">            Additional option for the probe target, used for secondary epitopes.</span>
</span><span id="ExperimentParametrisation.add_probe-964"><a href="#ExperimentParametrisation.add_probe-964"><span class="linenos"> 964</span></a><span class="sd">        :param probe_distance_to_epitope : float, optional</span>
</span><span id="ExperimentParametrisation.add_probe-965"><a href="#ExperimentParametrisation.add_probe-965"><span class="linenos"> 965</span></a><span class="sd">            Distance from the probe to the epitope.</span>
</span><span id="ExperimentParametrisation.add_probe-966"><a href="#ExperimentParametrisation.add_probe-966"><span class="linenos"> 966</span></a><span class="sd">        :param probe_model : str, optional</span>
</span><span id="ExperimentParametrisation.add_probe-967"><a href="#ExperimentParametrisation.add_probe-967"><span class="linenos"> 967</span></a><span class="sd">            List of model identifiers for the probe.</span>
</span><span id="ExperimentParametrisation.add_probe-968"><a href="#ExperimentParametrisation.add_probe-968"><span class="linenos"> 968</span></a><span class="sd">        :param probe_fluorophore : str, optional</span>
</span><span id="ExperimentParametrisation.add_probe-969"><a href="#ExperimentParametrisation.add_probe-969"><span class="linenos"> 969</span></a><span class="sd">            Identifier for the fluorophore. Default is &quot;AF647&quot;.</span>
</span><span id="ExperimentParametrisation.add_probe-970"><a href="#ExperimentParametrisation.add_probe-970"><span class="linenos"> 970</span></a><span class="sd">        :param probe_steric_hindrance : Any, optional</span>
</span><span id="ExperimentParametrisation.add_probe-971"><a href="#ExperimentParametrisation.add_probe-971"><span class="linenos"> 971</span></a><span class="sd">            Steric hindrance value or configuration.</span>
</span><span id="ExperimentParametrisation.add_probe-972"><a href="#ExperimentParametrisation.add_probe-972"><span class="linenos"> 972</span></a><span class="sd">        :param probe_paratope : str, optional</span>
</span><span id="ExperimentParametrisation.add_probe-973"><a href="#ExperimentParametrisation.add_probe-973"><span class="linenos"> 973</span></a><span class="sd">            Paratope identifier or information.</span>
</span><span id="ExperimentParametrisation.add_probe-974"><a href="#ExperimentParametrisation.add_probe-974"><span class="linenos"> 974</span></a><span class="sd">        :param probe_conjugation_target_info : Any, optional</span>
</span><span id="ExperimentParametrisation.add_probe-975"><a href="#ExperimentParametrisation.add_probe-975"><span class="linenos"> 975</span></a><span class="sd">            Information about the conjugation target.</span>
</span><span id="ExperimentParametrisation.add_probe-976"><a href="#ExperimentParametrisation.add_probe-976"><span class="linenos"> 976</span></a><span class="sd">        :param probe_DoL : float, optional</span>
</span><span id="ExperimentParametrisation.add_probe-977"><a href="#ExperimentParametrisation.add_probe-977"><span class="linenos"> 977</span></a><span class="sd">            Efficiency of the probe conjugation.</span>
</span><span id="ExperimentParametrisation.add_probe-978"><a href="#ExperimentParametrisation.add_probe-978"><span class="linenos"> 978</span></a><span class="sd">        :param probe_seconday_epitope : Any, optional</span>
</span><span id="ExperimentParametrisation.add_probe-979"><a href="#ExperimentParametrisation.add_probe-979"><span class="linenos"> 979</span></a><span class="sd">            Information about a secondary epitope target.</span>
</span><span id="ExperimentParametrisation.add_probe-980"><a href="#ExperimentParametrisation.add_probe-980"><span class="linenos"> 980</span></a><span class="sd">        :param probe_wobbling : bool, optional</span>
</span><span id="ExperimentParametrisation.add_probe-981"><a href="#ExperimentParametrisation.add_probe-981"><span class="linenos"> 981</span></a><span class="sd">            Whether to enable probe wobbling. Default is False.</span>
</span><span id="ExperimentParametrisation.add_probe-982"><a href="#ExperimentParametrisation.add_probe-982"><span class="linenos"> 982</span></a><span class="sd">        :param labelling_efficiency : float, optional</span>
</span><span id="ExperimentParametrisation.add_probe-983"><a href="#ExperimentParametrisation.add_probe-983"><span class="linenos"> 983</span></a><span class="sd">            Efficiency of probe labelling. Default is 1.0.</span>
</span><span id="ExperimentParametrisation.add_probe-984"><a href="#ExperimentParametrisation.add_probe-984"><span class="linenos"> 984</span></a><span class="sd">        :param as_primary : bool, optional</span>
</span><span id="ExperimentParametrisation.add_probe-985"><a href="#ExperimentParametrisation.add_probe-985"><span class="linenos"> 985</span></a><span class="sd">            Whether to treat the probe as a primary linker. Default is False.</span>
</span><span id="ExperimentParametrisation.add_probe-986"><a href="#ExperimentParametrisation.add_probe-986"><span class="linenos"> 986</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation.add_probe-987"><a href="#ExperimentParametrisation.add_probe-987"><span class="linenos"> 987</span></a><span class="sd">            Additional keyword arguments for future extensions.</span>
</span><span id="ExperimentParametrisation.add_probe-988"><a href="#ExperimentParametrisation.add_probe-988"><span class="linenos"> 988</span></a>
</span><span id="ExperimentParametrisation.add_probe-989"><a href="#ExperimentParametrisation.add_probe-989"><span class="linenos"> 989</span></a><span class="sd">        Raises</span>
</span><span id="ExperimentParametrisation.add_probe-990"><a href="#ExperimentParametrisation.add_probe-990"><span class="linenos"> 990</span></a><span class="sd">        ------</span>
</span><span id="ExperimentParametrisation.add_probe-991"><a href="#ExperimentParametrisation.add_probe-991"><span class="linenos"> 991</span></a><span class="sd">        FileNotFoundError</span>
</span><span id="ExperimentParametrisation.add_probe-992"><a href="#ExperimentParametrisation.add_probe-992"><span class="linenos"> 992</span></a><span class="sd">            If the probe configuration YAML file does not exist.</span>
</span><span id="ExperimentParametrisation.add_probe-993"><a href="#ExperimentParametrisation.add_probe-993"><span class="linenos"> 993</span></a><span class="sd">        KeyError</span>
</span><span id="ExperimentParametrisation.add_probe-994"><a href="#ExperimentParametrisation.add_probe-994"><span class="linenos"> 994</span></a><span class="sd">            If required keys are missing in the configuration or probe parameters.</span>
</span><span id="ExperimentParametrisation.add_probe-995"><a href="#ExperimentParametrisation.add_probe-995"><span class="linenos"> 995</span></a>
</span><span id="ExperimentParametrisation.add_probe-996"><a href="#ExperimentParametrisation.add_probe-996"><span class="linenos"> 996</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation.add_probe-997"><a href="#ExperimentParametrisation.add_probe-997"><span class="linenos"> 997</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation.add_probe-998"><a href="#ExperimentParametrisation.add_probe-998"><span class="linenos"> 998</span></a><span class="sd">        Updates the ``probe_parameters`` attribute with the new or modified probe configuration and calls the :meth:`_update_probes` method to refresh internal probe state.</span>
</span><span id="ExperimentParametrisation.add_probe-999"><a href="#ExperimentParametrisation.add_probe-999"><span class="linenos"> 999</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.add_probe-1000"><a href="#ExperimentParametrisation.add_probe-1000"><span class="linenos">1000</span></a>        <span class="n">probe_configuration</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1001"><a href="#ExperimentParametrisation.add_probe-1001"><span class="linenos">1001</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config_probe_params</span><span class="p">[</span><span class="n">probe_template</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.add_probe-1002"><a href="#ExperimentParametrisation.add_probe-1002"><span class="linenos">1002</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1003"><a href="#ExperimentParametrisation.add_probe-1003"><span class="linenos">1003</span></a>        <span class="k">if</span> <span class="n">probe_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1004"><a href="#ExperimentParametrisation.add_probe-1004"><span class="linenos">1004</span></a>            <span class="n">probe_name</span> <span class="o">=</span> <span class="n">probe_template</span>
</span><span id="ExperimentParametrisation.add_probe-1005"><a href="#ExperimentParametrisation.add_probe-1005"><span class="linenos">1005</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1006"><a href="#ExperimentParametrisation.add_probe-1006"><span class="linenos">1006</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_name</span>
</span><span id="ExperimentParametrisation.add_probe-1007"><a href="#ExperimentParametrisation.add_probe-1007"><span class="linenos">1007</span></a>        <span class="k">if</span> <span class="n">peptide_motif</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1008"><a href="#ExperimentParametrisation.add_probe-1008"><span class="linenos">1008</span></a>            <span class="n">protein_name</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1009"><a href="#ExperimentParametrisation.add_probe-1009"><span class="linenos">1009</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_peptide_motif</span><span class="p">(</span><span class="o">**</span><span class="n">peptide_motif</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1010"><a href="#ExperimentParametrisation.add_probe-1010"><span class="linenos">1010</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1011"><a href="#ExperimentParametrisation.add_probe-1011"><span class="linenos">1011</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1012"><a href="#ExperimentParametrisation.add_probe-1012"><span class="linenos">1012</span></a>                <span class="n">probe_target_type</span> <span class="o">=</span> <span class="s2">&quot;Sequence&quot;</span>
</span><span id="ExperimentParametrisation.add_probe-1013"><a href="#ExperimentParametrisation.add_probe-1013"><span class="linenos">1013</span></a>                <span class="n">probe_target_value</span> <span class="o">=</span> <span class="n">sequence</span>
</span><span id="ExperimentParametrisation.add_probe-1014"><a href="#ExperimentParametrisation.add_probe-1014"><span class="linenos">1014</span></a>        <span class="k">if</span> <span class="n">probe_target_type</span> <span class="ow">and</span> <span class="n">probe_target_value</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1015"><a href="#ExperimentParametrisation.add_probe-1015"><span class="linenos">1015</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1016"><a href="#ExperimentParametrisation.add_probe-1016"><span class="linenos">1016</span></a>                <span class="nb">type</span><span class="o">=</span><span class="n">probe_target_type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">probe_target_value</span>
</span><span id="ExperimentParametrisation.add_probe-1017"><a href="#ExperimentParametrisation.add_probe-1017"><span class="linenos">1017</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1018"><a href="#ExperimentParametrisation.add_probe-1018"><span class="linenos">1018</span></a>            <span class="k">if</span> <span class="n">probe_target_type</span> <span class="o">==</span> <span class="s2">&quot;Primary&quot;</span> <span class="ow">and</span> <span class="n">probe_target_option</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1019"><a href="#ExperimentParametrisation.add_probe-1019"><span class="linenos">1019</span></a>                <span class="k">if</span> <span class="n">probe_target_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation.add_probe-1020"><a href="#ExperimentParametrisation.add_probe-1020"><span class="linenos">1020</span></a>                    <span class="nb">print</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1021"><a href="#ExperimentParametrisation.add_probe-1021"><span class="linenos">1021</span></a>                        <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">probe_target_option</span><span class="si">}</span><span class="s2"> as epitope on </span><span class="si">{</span><span class="n">probe_target_value</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ExperimentParametrisation.add_probe-1022"><a href="#ExperimentParametrisation.add_probe-1022"><span class="linenos">1022</span></a>                    <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1023"><a href="#ExperimentParametrisation.add_probe-1023"><span class="linenos">1023</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="p">[</span><span class="n">probe_target_value</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.add_probe-1024"><a href="#ExperimentParametrisation.add_probe-1024"><span class="linenos">1024</span></a>                        <span class="s2">&quot;probe_seconday_epitope&quot;</span>
</span><span id="ExperimentParametrisation.add_probe-1025"><a href="#ExperimentParametrisation.add_probe-1025"><span class="linenos">1025</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">probe_target_option</span>
</span><span id="ExperimentParametrisation.add_probe-1026"><a href="#ExperimentParametrisation.add_probe-1026"><span class="linenos">1026</span></a>        <span class="k">elif</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1027"><a href="#ExperimentParametrisation.add_probe-1027"><span class="linenos">1027</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.add_probe-1028"><a href="#ExperimentParametrisation.add_probe-1028"><span class="linenos">1028</span></a>            <span class="ow">or</span> <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.add_probe-1029"><a href="#ExperimentParametrisation.add_probe-1029"><span class="linenos">1029</span></a>        <span class="p">):</span>
</span><span id="ExperimentParametrisation.add_probe-1030"><a href="#ExperimentParametrisation.add_probe-1030"><span class="linenos">1030</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1031"><a href="#ExperimentParametrisation.add_probe-1031"><span class="linenos">1031</span></a>                <span class="s2">&quot;No target info provided for the probe. Retrieving random sequence.&quot;</span>
</span><span id="ExperimentParametrisation.add_probe-1032"><a href="#ExperimentParametrisation.add_probe-1032"><span class="linenos">1032</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1033"><a href="#ExperimentParametrisation.add_probe-1033"><span class="linenos">1033</span></a>            <span class="c1"># probe has no target info</span>
</span><span id="ExperimentParametrisation.add_probe-1034"><a href="#ExperimentParametrisation.add_probe-1034"><span class="linenos">1034</span></a>            <span class="c1"># a random target will be used</span>
</span><span id="ExperimentParametrisation.add_probe-1035"><a href="#ExperimentParametrisation.add_probe-1035"><span class="linenos">1035</span></a>            <span class="n">protein_name</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1036"><a href="#ExperimentParametrisation.add_probe-1036"><span class="linenos">1036</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">get_peptide_motif</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="s2">&quot;cterminal&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1037"><a href="#ExperimentParametrisation.add_probe-1037"><span class="linenos">1037</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1038"><a href="#ExperimentParametrisation.add_probe-1038"><span class="linenos">1038</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1039"><a href="#ExperimentParametrisation.add_probe-1039"><span class="linenos">1039</span></a>                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;Sequence&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">sequence</span>
</span><span id="ExperimentParametrisation.add_probe-1040"><a href="#ExperimentParametrisation.add_probe-1040"><span class="linenos">1040</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1041"><a href="#ExperimentParametrisation.add_probe-1041"><span class="linenos">1041</span></a>            <span class="c1"># probe_configuration[&quot;target&quot;][&quot;type&quot;] = &quot;Sequence&quot;</span>
</span><span id="ExperimentParametrisation.add_probe-1042"><a href="#ExperimentParametrisation.add_probe-1042"><span class="linenos">1042</span></a>            <span class="c1"># probe_configuration[&quot;target&quot;][&quot;value&quot;] = sequence</span>
</span><span id="ExperimentParametrisation.add_probe-1043"><a href="#ExperimentParametrisation.add_probe-1043"><span class="linenos">1043</span></a>        <span class="k">if</span> <span class="n">probe_distance_to_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1044"><a href="#ExperimentParametrisation.add_probe-1044"><span class="linenos">1044</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;distance_to_epitope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1045"><a href="#ExperimentParametrisation.add_probe-1045"><span class="linenos">1045</span></a>                <span class="n">probe_distance_to_epitope</span>
</span><span id="ExperimentParametrisation.add_probe-1046"><a href="#ExperimentParametrisation.add_probe-1046"><span class="linenos">1046</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1047"><a href="#ExperimentParametrisation.add_probe-1047"><span class="linenos">1047</span></a>        <span class="k">if</span> <span class="n">probe_fluorophore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1048"><a href="#ExperimentParametrisation.add_probe-1048"><span class="linenos">1048</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;fluorophore_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_fluorophore</span>
</span><span id="ExperimentParametrisation.add_probe-1049"><a href="#ExperimentParametrisation.add_probe-1049"><span class="linenos">1049</span></a>        <span class="k">if</span> <span class="n">fluorophore_parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1050"><a href="#ExperimentParametrisation.add_probe-1050"><span class="linenos">1050</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_fluorophore_parameters</span><span class="p">(</span><span class="n">fluorophoe_id</span><span class="o">=</span><span class="n">probe_fluorophore</span><span class="p">,</span> <span class="o">**</span><span class="n">fluorophore_parameters</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1051"><a href="#ExperimentParametrisation.add_probe-1051"><span class="linenos">1051</span></a>        <span class="k">if</span> <span class="n">labelling_efficiency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1052"><a href="#ExperimentParametrisation.add_probe-1052"><span class="linenos">1052</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;labelling_efficiency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelling_efficiency</span>
</span><span id="ExperimentParametrisation.add_probe-1053"><a href="#ExperimentParametrisation.add_probe-1053"><span class="linenos">1053</span></a>        <span class="k">if</span> <span class="n">probe_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1054"><a href="#ExperimentParametrisation.add_probe-1054"><span class="linenos">1054</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;model_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_model</span>
</span><span id="ExperimentParametrisation.add_probe-1055"><a href="#ExperimentParametrisation.add_probe-1055"><span class="linenos">1055</span></a>        <span class="k">if</span> <span class="n">probe_paratope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1056"><a href="#ExperimentParametrisation.add_probe-1056"><span class="linenos">1056</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;paratope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_paratope</span>
</span><span id="ExperimentParametrisation.add_probe-1057"><a href="#ExperimentParametrisation.add_probe-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="n">probe_conjugation_target_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1058"><a href="#ExperimentParametrisation.add_probe-1058"><span class="linenos">1058</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1059"><a href="#ExperimentParametrisation.add_probe-1059"><span class="linenos">1059</span></a>                <span class="n">probe_conjugation_target_info</span>
</span><span id="ExperimentParametrisation.add_probe-1060"><a href="#ExperimentParametrisation.add_probe-1060"><span class="linenos">1060</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1061"><a href="#ExperimentParametrisation.add_probe-1061"><span class="linenos">1061</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1062"><a href="#ExperimentParametrisation.add_probe-1062"><span class="linenos">1062</span></a>                <span class="n">probe_conjugation_target_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.add_probe-1063"><a href="#ExperimentParametrisation.add_probe-1063"><span class="linenos">1063</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1064"><a href="#ExperimentParametrisation.add_probe-1064"><span class="linenos">1064</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1065"><a href="#ExperimentParametrisation.add_probe-1065"><span class="linenos">1065</span></a>                <span class="n">probe_conjugation_target_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
</span><span id="ExperimentParametrisation.add_probe-1066"><a href="#ExperimentParametrisation.add_probe-1066"><span class="linenos">1066</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1067"><a href="#ExperimentParametrisation.add_probe-1067"><span class="linenos">1067</span></a>        <span class="k">if</span> <span class="n">probe_DoL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1068"><a href="#ExperimentParametrisation.add_probe-1068"><span class="linenos">1068</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting probe DoL to: </span><span class="si">{</span><span class="n">probe_DoL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1069"><a href="#ExperimentParametrisation.add_probe-1069"><span class="linenos">1069</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_sites&quot;</span><span class="p">][</span><span class="s2">&quot;DoL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1070"><a href="#ExperimentParametrisation.add_probe-1070"><span class="linenos">1070</span></a>                <span class="n">probe_DoL</span>
</span><span id="ExperimentParametrisation.add_probe-1071"><a href="#ExperimentParametrisation.add_probe-1071"><span class="linenos">1071</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1072"><a href="#ExperimentParametrisation.add_probe-1072"><span class="linenos">1072</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1073"><a href="#ExperimentParametrisation.add_probe-1073"><span class="linenos">1073</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Add_probe: Using default probe DoL from template&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1074"><a href="#ExperimentParametrisation.add_probe-1074"><span class="linenos">1074</span></a>        <span class="k">if</span> <span class="n">probe_seconday_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1075"><a href="#ExperimentParametrisation.add_probe-1075"><span class="linenos">1075</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;epitope_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_seconday_epitope</span>
</span><span id="ExperimentParametrisation.add_probe-1076"><a href="#ExperimentParametrisation.add_probe-1076"><span class="linenos">1076</span></a>        <span class="k">if</span> <span class="n">probe_wobble_theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1077"><a href="#ExperimentParametrisation.add_probe-1077"><span class="linenos">1077</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;enable_wobble&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation.add_probe-1078"><a href="#ExperimentParametrisation.add_probe-1078"><span class="linenos">1078</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;wobble_theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_wobble_theta</span>
</span><span id="ExperimentParametrisation.add_probe-1079"><a href="#ExperimentParametrisation.add_probe-1079"><span class="linenos">1079</span></a>        <span class="k">if</span> <span class="n">as_primary</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1080"><a href="#ExperimentParametrisation.add_probe-1080"><span class="linenos">1080</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding probe as primary linker&quot;</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1081"><a href="#ExperimentParametrisation.add_probe-1081"><span class="linenos">1081</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;as_linker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ExperimentParametrisation.add_probe-1082"><a href="#ExperimentParametrisation.add_probe-1082"><span class="linenos">1082</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1083"><a href="#ExperimentParametrisation.add_probe-1083"><span class="linenos">1083</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;as_linker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ExperimentParametrisation.add_probe-1084"><a href="#ExperimentParametrisation.add_probe-1084"><span class="linenos">1084</span></a>        <span class="k">if</span> <span class="n">probe_steric_hindrance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_probe-1085"><a href="#ExperimentParametrisation.add_probe-1085"><span class="linenos">1085</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;distance_between_epitope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.add_probe-1086"><a href="#ExperimentParametrisation.add_probe-1086"><span class="linenos">1086</span></a>                <span class="n">probe_steric_hindrance</span>
</span><span id="ExperimentParametrisation.add_probe-1087"><a href="#ExperimentParametrisation.add_probe-1087"><span class="linenos">1087</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.add_probe-1088"><a href="#ExperimentParametrisation.add_probe-1088"><span class="linenos">1088</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;binding&quot;</span><span class="p">][</span><span class="s2">&quot;distance&quot;</span><span class="p">][</span>
</span><span id="ExperimentParametrisation.add_probe-1089"><a href="#ExperimentParametrisation.add_probe-1089"><span class="linenos">1089</span></a>                <span class="s2">&quot;between_targets&quot;</span>
</span><span id="ExperimentParametrisation.add_probe-1090"><a href="#ExperimentParametrisation.add_probe-1090"><span class="linenos">1090</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">probe_steric_hindrance</span>
</span><span id="ExperimentParametrisation.add_probe-1091"><a href="#ExperimentParametrisation.add_probe-1091"><span class="linenos">1091</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="p">[</span><span class="n">probe_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_configuration</span>
</span><span id="ExperimentParametrisation.add_probe-1092"><a href="#ExperimentParametrisation.add_probe-1092"><span class="linenos">1092</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_probes</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Add a probe configuration to the experiment.</p>

<p>This method loads a probe configuration from a YAML file, updates its parameters based on the provided arguments,
and stores it in the experiment's probe parameters. It supports customization of probe properties such as target type,
fluorophore, model, conjugation details, and more.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>probe_name</strong>:  str, optional
Name of the probe. Default is "NHS_ester".</li>
<li><strong>probe_target_type</strong>:  str, optional
Type of the probe target (e.g., "Primary", "Secondary").</li>
<li><strong>probe_target_value</strong>:  str, optional
Value or identifier of the probe target.</li>
<li><strong>probe_target_option</strong>:  str, optional
Additional option for the probe target, used for secondary epitopes.</li>
<li><strong>probe_distance_to_epitope</strong>:  float, optional
Distance from the probe to the epitope.</li>
<li><strong>probe_model</strong>:  str, optional
List of model identifiers for the probe.</li>
<li><strong>probe_fluorophore</strong>:  str, optional
Identifier for the fluorophore. Default is "AF647".</li>
<li><strong>probe_steric_hindrance</strong>:  Any, optional
Steric hindrance value or configuration.</li>
<li><strong>probe_paratope</strong>:  str, optional
Paratope identifier or information.</li>
<li><strong>probe_conjugation_target_info</strong>:  Any, optional
Information about the conjugation target.</li>
<li><strong>probe_DoL</strong>:  float, optional
Efficiency of the probe conjugation.</li>
<li><strong>probe_seconday_epitope</strong>:  Any, optional
Information about a secondary epitope target.</li>
<li><strong>probe_wobbling</strong>:  bool, optional
Whether to enable probe wobbling. Default is False.</li>
<li><strong>labelling_efficiency</strong>:  float, optional
Efficiency of probe labelling. Default is 1.0.</li>
<li><strong>as_primary</strong>:  bool, optional
Whether to treat the probe as a primary linker. Default is False.
:param **kwargs
Additional keyword arguments for future extensions.</li>
</ul>

<h2 id="raises">Raises</h2>

<p>FileNotFoundError
    If the probe configuration YAML file does not exist.
KeyError
    If required keys are missing in the configuration or probe parameters.</p>

<h2 id="notes">Notes</h2>

<p>Updates the <code><a href="#ExperimentParametrisation.probe_parameters">probe_parameters</a></code> attribute with the new or modified probe configuration and calls the <code>_update_probes()</code> method to refresh internal probe state.</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.add_fluorophore_parameters" class="classattr">
                                        <input id="ExperimentParametrisation.add_fluorophore_parameters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_fluorophore_parameters</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">fluorophoe_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">emission</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">blinking_rates</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.add_fluorophore_parameters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.add_fluorophore_parameters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.add_fluorophore_parameters-1107"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1107"><span class="linenos">1107</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_fluorophore_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1108"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1108"><span class="linenos">1108</span></a>                                <span class="n">fluorophoe_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1109"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1109"><span class="linenos">1109</span></a>                                <span class="n">emission</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1110"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1110"><span class="linenos">1110</span></a>                                <span class="n">blinking_rates</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1111"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1111"><span class="linenos">1111</span></a>                                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1112"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1112"><span class="linenos">1112</span></a>        <span class="k">if</span> <span class="n">fluorophoe_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1113"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1113"><span class="linenos">1113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1114"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1114"><span class="linenos">1114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1115"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1115"><span class="linenos">1115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1116"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1116"><span class="linenos">1116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1117"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1117"><span class="linenos">1117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;kon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.99</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1118"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1118"><span class="linenos">1118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;koff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1119"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1119"><span class="linenos">1119</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;kbleach&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1120"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1120"><span class="linenos">1120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;initial_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1121"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1121"><span class="linenos">1121</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">][</span><span class="s2">&quot;photons_per_blink&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1122"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1122"><span class="linenos">1122</span></a>        <span class="k">if</span> <span class="n">emission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1123"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1123"><span class="linenos">1123</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;emission&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">emission</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1124"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1124"><span class="linenos">1124</span></a>        <span class="k">if</span> <span class="n">blinking_rates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.add_fluorophore_parameters-1125"><a href="#ExperimentParametrisation.add_fluorophore_parameters-1125"><span class="linenos">1125</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fluorophore_parameters</span><span class="p">[</span><span class="n">fluorophoe_id</span><span class="p">][</span><span class="s2">&quot;blinking_rates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blinking_rates</span>
</span></pre></div>


    

                            </div>
                            <div id="ExperimentParametrisation.set_virtualsample_params" class="classattr">
                                        <input id="ExperimentParametrisation.set_virtualsample_params-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_virtualsample_params</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">virtualsample_template</span><span class="o">=</span><span class="s1">&#39;square1x1um_randomised&#39;</span>,</span><span class="param">	<span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">random_orientations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">random_placing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">minimal_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">update_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">random_rotations</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">rotation_angles</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">xy_orientations</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">xz_orientations</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">yz_orientations</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">axial_offset</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.set_virtualsample_params-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.set_virtualsample_params"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.set_virtualsample_params-1127"><a href="#ExperimentParametrisation.set_virtualsample_params-1127"><span class="linenos">1127</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_virtualsample_params</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1128"><a href="#ExperimentParametrisation.set_virtualsample_params-1128"><span class="linenos">1128</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1129"><a href="#ExperimentParametrisation.set_virtualsample_params-1129"><span class="linenos">1129</span></a>        <span class="n">virtualsample_template</span><span class="o">=</span><span class="s2">&quot;square1x1um_randomised&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1130"><a href="#ExperimentParametrisation.set_virtualsample_params-1130"><span class="linenos">1130</span></a>        <span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1131"><a href="#ExperimentParametrisation.set_virtualsample_params-1131"><span class="linenos">1131</span></a>        <span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1132"><a href="#ExperimentParametrisation.set_virtualsample_params-1132"><span class="linenos">1132</span></a>        <span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1133"><a href="#ExperimentParametrisation.set_virtualsample_params-1133"><span class="linenos">1133</span></a>        <span class="n">random_orientations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1134"><a href="#ExperimentParametrisation.set_virtualsample_params-1134"><span class="linenos">1134</span></a>        <span class="n">random_placing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1135"><a href="#ExperimentParametrisation.set_virtualsample_params-1135"><span class="linenos">1135</span></a>        <span class="n">minimal_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1136"><a href="#ExperimentParametrisation.set_virtualsample_params-1136"><span class="linenos">1136</span></a>        <span class="n">update_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1137"><a href="#ExperimentParametrisation.set_virtualsample_params-1137"><span class="linenos">1137</span></a>        <span class="n">random_rotations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1138"><a href="#ExperimentParametrisation.set_virtualsample_params-1138"><span class="linenos">1138</span></a>        <span class="n">rotation_angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1139"><a href="#ExperimentParametrisation.set_virtualsample_params-1139"><span class="linenos">1139</span></a>        <span class="n">xy_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1140"><a href="#ExperimentParametrisation.set_virtualsample_params-1140"><span class="linenos">1140</span></a>        <span class="n">xz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1141"><a href="#ExperimentParametrisation.set_virtualsample_params-1141"><span class="linenos">1141</span></a>        <span class="n">yz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1142"><a href="#ExperimentParametrisation.set_virtualsample_params-1142"><span class="linenos">1142</span></a>        <span class="n">axial_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1143"><a href="#ExperimentParametrisation.set_virtualsample_params-1143"><span class="linenos">1143</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1144"><a href="#ExperimentParametrisation.set_virtualsample_params-1144"><span class="linenos">1144</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1145"><a href="#ExperimentParametrisation.set_virtualsample_params-1145"><span class="linenos">1145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1146"><a href="#ExperimentParametrisation.set_virtualsample_params-1146"><span class="linenos">1146</span></a><span class="sd">        Set parameters for the virtual sample by loading a template configuration and optionally overriding specific values.</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1147"><a href="#ExperimentParametrisation.set_virtualsample_params-1147"><span class="linenos">1147</span></a>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1148"><a href="#ExperimentParametrisation.set_virtualsample_params-1148"><span class="linenos">1148</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1149"><a href="#ExperimentParametrisation.set_virtualsample_params-1149"><span class="linenos">1149</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1150"><a href="#ExperimentParametrisation.set_virtualsample_params-1150"><span class="linenos">1150</span></a><span class="sd">        :param virtualsample_template : str, optional</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1151"><a href="#ExperimentParametrisation.set_virtualsample_params-1151"><span class="linenos">1151</span></a><span class="sd">            Name of the virtual sample template YAML file (without extension) to load. Default is &quot;square1x1um_randomised&quot;.</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1152"><a href="#ExperimentParametrisation.set_virtualsample_params-1152"><span class="linenos">1152</span></a><span class="sd">        :param sample_dimensions : list of int, optional</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1153"><a href="#ExperimentParametrisation.set_virtualsample_params-1153"><span class="linenos">1153</span></a><span class="sd">            Dimensions of the sample to override the template value.</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1154"><a href="#ExperimentParametrisation.set_virtualsample_params-1154"><span class="linenos">1154</span></a><span class="sd">        :param number_of_particles : int, optional</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1155"><a href="#ExperimentParametrisation.set_virtualsample_params-1155"><span class="linenos">1155</span></a><span class="sd">            Number of particles to override the template value.</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1156"><a href="#ExperimentParametrisation.set_virtualsample_params-1156"><span class="linenos">1156</span></a><span class="sd">        :param particle_positions : list, optional</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1157"><a href="#ExperimentParametrisation.set_virtualsample_params-1157"><span class="linenos">1157</span></a><span class="sd">            List of particle positions to override the template value.</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1158"><a href="#ExperimentParametrisation.set_virtualsample_params-1158"><span class="linenos">1158</span></a><span class="sd">        :param random_orientations : bool, optional</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1159"><a href="#ExperimentParametrisation.set_virtualsample_params-1159"><span class="linenos">1159</span></a><span class="sd">            Whether to randomize particle orientations, overrides the template value.</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1160"><a href="#ExperimentParametrisation.set_virtualsample_params-1160"><span class="linenos">1160</span></a><span class="sd">        :param random_placing : bool, optional</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1161"><a href="#ExperimentParametrisation.set_virtualsample_params-1161"><span class="linenos">1161</span></a><span class="sd">            Whether to randomize particle placement, overrides the template value.</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1162"><a href="#ExperimentParametrisation.set_virtualsample_params-1162"><span class="linenos">1162</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1163"><a href="#ExperimentParametrisation.set_virtualsample_params-1163"><span class="linenos">1163</span></a><span class="sd">            Additional keyword arguments (currently unused).</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1164"><a href="#ExperimentParametrisation.set_virtualsample_params-1164"><span class="linenos">1164</span></a>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1165"><a href="#ExperimentParametrisation.set_virtualsample_params-1165"><span class="linenos">1165</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1166"><a href="#ExperimentParametrisation.set_virtualsample_params-1166"><span class="linenos">1166</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1167"><a href="#ExperimentParametrisation.set_virtualsample_params-1167"><span class="linenos">1167</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1168"><a href="#ExperimentParametrisation.set_virtualsample_params-1168"><span class="linenos">1168</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1169"><a href="#ExperimentParametrisation.set_virtualsample_params-1169"><span class="linenos">1169</span></a>        <span class="c1"># load default configuration for virtual sample</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1170"><a href="#ExperimentParametrisation.set_virtualsample_params-1170"><span class="linenos">1170</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1171"><a href="#ExperimentParametrisation.set_virtualsample_params-1171"><span class="linenos">1171</span></a>            <span class="n">particle_minimal_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span><span class="o">.</span><span class="n">molecules_params</span><span class="p">[</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1172"><a href="#ExperimentParametrisation.set_virtualsample_params-1172"><span class="linenos">1172</span></a>                <span class="s2">&quot;minimal_distance&quot;</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1173"><a href="#ExperimentParametrisation.set_virtualsample_params-1173"><span class="linenos">1173</span></a>            <span class="p">]</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1174"><a href="#ExperimentParametrisation.set_virtualsample_params-1174"><span class="linenos">1174</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1175"><a href="#ExperimentParametrisation.set_virtualsample_params-1175"><span class="linenos">1175</span></a>            <span class="n">particle_minimal_distance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1176"><a href="#ExperimentParametrisation.set_virtualsample_params-1176"><span class="linenos">1176</span></a>        <span class="k">if</span> <span class="n">update_mode</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1177"><a href="#ExperimentParametrisation.set_virtualsample_params-1177"><span class="linenos">1177</span></a>            <span class="k">pass</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1178"><a href="#ExperimentParametrisation.set_virtualsample_params-1178"><span class="linenos">1178</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1179"><a href="#ExperimentParametrisation.set_virtualsample_params-1179"><span class="linenos">1179</span></a>            <span class="n">virtual_sample_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1180"><a href="#ExperimentParametrisation.set_virtualsample_params-1180"><span class="linenos">1180</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1181"><a href="#ExperimentParametrisation.set_virtualsample_params-1181"><span class="linenos">1181</span></a>                <span class="s2">&quot;virtualsample&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1182"><a href="#ExperimentParametrisation.set_virtualsample_params-1182"><span class="linenos">1182</span></a>                <span class="n">virtualsample_template</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1183"><a href="#ExperimentParametrisation.set_virtualsample_params-1183"><span class="linenos">1183</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1184"><a href="#ExperimentParametrisation.set_virtualsample_params-1184"><span class="linenos">1184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">virtual_sample_template</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1185"><a href="#ExperimentParametrisation.set_virtualsample_params-1185"><span class="linenos">1185</span></a>        <span class="k">if</span> <span class="n">sample_dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1186"><a href="#ExperimentParametrisation.set_virtualsample_params-1186"><span class="linenos">1186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;sample_dimensions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_dimensions</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1187"><a href="#ExperimentParametrisation.set_virtualsample_params-1187"><span class="linenos">1187</span></a>        <span class="k">if</span> <span class="n">number_of_particles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1188"><a href="#ExperimentParametrisation.set_virtualsample_params-1188"><span class="linenos">1188</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;number_of_particles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_of_particles</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1189"><a href="#ExperimentParametrisation.set_virtualsample_params-1189"><span class="linenos">1189</span></a>        <span class="k">if</span> <span class="n">particle_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1190"><a href="#ExperimentParametrisation.set_virtualsample_params-1190"><span class="linenos">1190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;relative_positions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_positions</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1191"><a href="#ExperimentParametrisation.set_virtualsample_params-1191"><span class="linenos">1191</span></a>        <span class="k">if</span> <span class="n">random_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1192"><a href="#ExperimentParametrisation.set_virtualsample_params-1192"><span class="linenos">1192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_orientations</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1193"><a href="#ExperimentParametrisation.set_virtualsample_params-1193"><span class="linenos">1193</span></a>        <span class="k">if</span> <span class="n">random_placing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1194"><a href="#ExperimentParametrisation.set_virtualsample_params-1194"><span class="linenos">1194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_placing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_placing</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1195"><a href="#ExperimentParametrisation.set_virtualsample_params-1195"><span class="linenos">1195</span></a>        <span class="k">if</span> <span class="n">minimal_distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1196"><a href="#ExperimentParametrisation.set_virtualsample_params-1196"><span class="linenos">1196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minimal_distance</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1197"><a href="#ExperimentParametrisation.set_virtualsample_params-1197"><span class="linenos">1197</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1198"><a href="#ExperimentParametrisation.set_virtualsample_params-1198"><span class="linenos">1198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;minimal_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1199"><a href="#ExperimentParametrisation.set_virtualsample_params-1199"><span class="linenos">1199</span></a>                <span class="n">particle_minimal_distance</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1200"><a href="#ExperimentParametrisation.set_virtualsample_params-1200"><span class="linenos">1200</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1201"><a href="#ExperimentParametrisation.set_virtualsample_params-1201"><span class="linenos">1201</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;random_rotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_rotations</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1202"><a href="#ExperimentParametrisation.set_virtualsample_params-1202"><span class="linenos">1202</span></a>        <span class="k">if</span> <span class="n">rotation_angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1203"><a href="#ExperimentParametrisation.set_virtualsample_params-1203"><span class="linenos">1203</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;rotation_angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_angles</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1204"><a href="#ExperimentParametrisation.set_virtualsample_params-1204"><span class="linenos">1204</span></a>        <span class="k">if</span> <span class="n">xy_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1205"><a href="#ExperimentParametrisation.set_virtualsample_params-1205"><span class="linenos">1205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;xy_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_orientations</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1206"><a href="#ExperimentParametrisation.set_virtualsample_params-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="n">xz_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1207"><a href="#ExperimentParametrisation.set_virtualsample_params-1207"><span class="linenos">1207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;xz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz_orientations</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1208"><a href="#ExperimentParametrisation.set_virtualsample_params-1208"><span class="linenos">1208</span></a>        <span class="k">if</span> <span class="n">yz_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1209"><a href="#ExperimentParametrisation.set_virtualsample_params-1209"><span class="linenos">1209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;yz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz_orientations</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1210"><a href="#ExperimentParametrisation.set_virtualsample_params-1210"><span class="linenos">1210</span></a>        <span class="k">if</span> <span class="n">axial_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.set_virtualsample_params-1211"><a href="#ExperimentParametrisation.set_virtualsample_params-1211"><span class="linenos">1211</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virtualsample_params</span><span class="p">[</span><span class="s2">&quot;axial_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axial_offset</span>
</span></pre></div>


            <div class="docstring"><p>Set parameters for the virtual sample by loading a template configuration and optionally overriding specific values.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>virtualsample_template</strong>:  str, optional
Name of the virtual sample template YAML file (without extension) to load. Default is "square1x1um_randomised".</li>
<li><strong>sample_dimensions</strong>:  list of int, optional
Dimensions of the sample to override the template value.</li>
<li><strong>number_of_particles</strong>:  int, optional
Number of particles to override the template value.</li>
<li><strong>particle_positions</strong>:  list, optional
List of particle positions to override the template value.</li>
<li><strong>random_orientations</strong>:  bool, optional
Whether to randomize particle orientations, overrides the template value.</li>
<li><strong>random_placing</strong>:  bool, optional
Whether to randomize particle placement, overrides the template value.
:param **kwargs
Additional keyword arguments (currently unused).</li>
</ul>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.use_image_for_positioning" class="classattr">
                                        <input id="ExperimentParametrisation.use_image_for_positioning-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">use_image_for_positioning</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">img</span>,</span><span class="param">	<span class="n">mode</span><span class="o">=</span><span class="s1">&#39;localmaxima&#39;</span>,</span><span class="param">	<span class="n">sigma</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">background</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">threshold</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">pixelsize</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">min_distance</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.use_image_for_positioning-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.use_image_for_positioning"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.use_image_for_positioning-1213"><a href="#ExperimentParametrisation.use_image_for_positioning-1213"><span class="linenos">1213</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">use_image_for_positioning</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1214"><a href="#ExperimentParametrisation.use_image_for_positioning-1214"><span class="linenos">1214</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1215"><a href="#ExperimentParametrisation.use_image_for_positioning-1215"><span class="linenos">1215</span></a>        <span class="n">img</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1216"><a href="#ExperimentParametrisation.use_image_for_positioning-1216"><span class="linenos">1216</span></a>        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;localmaxima&quot;</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1217"><a href="#ExperimentParametrisation.use_image_for_positioning-1217"><span class="linenos">1217</span></a>        <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1218"><a href="#ExperimentParametrisation.use_image_for_positioning-1218"><span class="linenos">1218</span></a>        <span class="n">background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1219"><a href="#ExperimentParametrisation.use_image_for_positioning-1219"><span class="linenos">1219</span></a>        <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1220"><a href="#ExperimentParametrisation.use_image_for_positioning-1220"><span class="linenos">1220</span></a>        <span class="n">pixelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1221"><a href="#ExperimentParametrisation.use_image_for_positioning-1221"><span class="linenos">1221</span></a>        <span class="n">min_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1222"><a href="#ExperimentParametrisation.use_image_for_positioning-1222"><span class="linenos">1222</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1223"><a href="#ExperimentParametrisation.use_image_for_positioning-1223"><span class="linenos">1223</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1224"><a href="#ExperimentParametrisation.use_image_for_positioning-1224"><span class="linenos">1224</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1225"><a href="#ExperimentParametrisation.use_image_for_positioning-1225"><span class="linenos">1225</span></a><span class="sd">        Generate and set relative positions for a virtual sample based on features detected in an input image.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1226"><a href="#ExperimentParametrisation.use_image_for_positioning-1226"><span class="linenos">1226</span></a>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1227"><a href="#ExperimentParametrisation.use_image_for_positioning-1227"><span class="linenos">1227</span></a><span class="sd">        This method processes the provided image to extract feature coordinates using the specified detection mode</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1228"><a href="#ExperimentParametrisation.use_image_for_positioning-1228"><span class="linenos">1228</span></a><span class="sd">        and parameters. The resulting positions are stored in `self.virtualsample_params[&quot;relative_positions&quot;]`,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1229"><a href="#ExperimentParametrisation.use_image_for_positioning-1229"><span class="linenos">1229</span></a><span class="sd">        and the sample&#39;s physical dimensions are updated accordingly. The method then triggers the build process</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1230"><a href="#ExperimentParametrisation.use_image_for_positioning-1230"><span class="linenos">1230</span></a><span class="sd">        for the &#39;coordinate_field&#39; and &#39;imager&#39; modules.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1231"><a href="#ExperimentParametrisation.use_image_for_positioning-1231"><span class="linenos">1231</span></a>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1232"><a href="#ExperimentParametrisation.use_image_for_positioning-1232"><span class="linenos">1232</span></a><span class="sd">        Parameters</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1233"><a href="#ExperimentParametrisation.use_image_for_positioning-1233"><span class="linenos">1233</span></a><span class="sd">        ----------</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1234"><a href="#ExperimentParametrisation.use_image_for_positioning-1234"><span class="linenos">1234</span></a><span class="sd">        :param img : array-like</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1235"><a href="#ExperimentParametrisation.use_image_for_positioning-1235"><span class="linenos">1235</span></a><span class="sd">            The input image (as a NumPy array or compatible format) to be analyzed for feature detection.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1236"><a href="#ExperimentParametrisation.use_image_for_positioning-1236"><span class="linenos">1236</span></a><span class="sd">        :param mode : str, optional</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1237"><a href="#ExperimentParametrisation.use_image_for_positioning-1237"><span class="linenos">1237</span></a><span class="sd">            The feature detection mode to use (e.g., &quot;localmaxima&quot;). Default is &quot;localmaxima&quot;.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1238"><a href="#ExperimentParametrisation.use_image_for_positioning-1238"><span class="linenos">1238</span></a><span class="sd">        :param sigma : float or None, optional</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1239"><a href="#ExperimentParametrisation.use_image_for_positioning-1239"><span class="linenos">1239</span></a><span class="sd">            Standard deviation for Gaussian smoothing. If None, no smoothing is applied.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1240"><a href="#ExperimentParametrisation.use_image_for_positioning-1240"><span class="linenos">1240</span></a><span class="sd">        :param background : float or None, optional</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1241"><a href="#ExperimentParametrisation.use_image_for_positioning-1241"><span class="linenos">1241</span></a><span class="sd">            Background intensity to subtract from the image. If None, no subtraction.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1242"><a href="#ExperimentParametrisation.use_image_for_positioning-1242"><span class="linenos">1242</span></a><span class="sd">        :param threshold : float or None, optional</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1243"><a href="#ExperimentParametrisation.use_image_for_positioning-1243"><span class="linenos">1243</span></a><span class="sd">            Minimum intensity threshold for feature detection. If None, uses default.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1244"><a href="#ExperimentParametrisation.use_image_for_positioning-1244"><span class="linenos">1244</span></a><span class="sd">        :param pixelsize : float or None, optional</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1245"><a href="#ExperimentParametrisation.use_image_for_positioning-1245"><span class="linenos">1245</span></a><span class="sd">            Pixel size of the input image. If None, uses default.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1246"><a href="#ExperimentParametrisation.use_image_for_positioning-1246"><span class="linenos">1246</span></a><span class="sd">        :param min_distance : float or None, optional</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1247"><a href="#ExperimentParametrisation.use_image_for_positioning-1247"><span class="linenos">1247</span></a><span class="sd">            Minimum distance between detected features. If None, uses default.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1248"><a href="#ExperimentParametrisation.use_image_for_positioning-1248"><span class="linenos">1248</span></a><span class="sd">        :param **kwargs</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1249"><a href="#ExperimentParametrisation.use_image_for_positioning-1249"><span class="linenos">1249</span></a><span class="sd">            Additional keyword arguments passed to the feature detection function.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1250"><a href="#ExperimentParametrisation.use_image_for_positioning-1250"><span class="linenos">1250</span></a>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1251"><a href="#ExperimentParametrisation.use_image_for_positioning-1251"><span class="linenos">1251</span></a><span class="sd">        Returns</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1252"><a href="#ExperimentParametrisation.use_image_for_positioning-1252"><span class="linenos">1252</span></a><span class="sd">        -------</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1253"><a href="#ExperimentParametrisation.use_image_for_positioning-1253"><span class="linenos">1253</span></a><span class="sd">        None</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1254"><a href="#ExperimentParametrisation.use_image_for_positioning-1254"><span class="linenos">1254</span></a>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1255"><a href="#ExperimentParametrisation.use_image_for_positioning-1255"><span class="linenos">1255</span></a><span class="sd">        Notes</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1256"><a href="#ExperimentParametrisation.use_image_for_positioning-1256"><span class="linenos">1256</span></a><span class="sd">        -----</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1257"><a href="#ExperimentParametrisation.use_image_for_positioning-1257"><span class="linenos">1257</span></a><span class="sd">        Updates `self.virtualsample_params` with new relative positions and sample dimensions. Calls `self.build()` for the specified modules.</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1258"><a href="#ExperimentParametrisation.use_image_for_positioning-1258"><span class="linenos">1258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1259"><a href="#ExperimentParametrisation.use_image_for_positioning-1259"><span class="linenos">1259</span></a>        <span class="n">xyz_relative</span><span class="p">,</span> <span class="n">image_physical_size</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1260"><a href="#ExperimentParametrisation.use_image_for_positioning-1260"><span class="linenos">1260</span></a>            <span class="n">coordinates_field</span><span class="o">.</span><span class="n">gen_positions_from_image</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1261"><a href="#ExperimentParametrisation.use_image_for_positioning-1261"><span class="linenos">1261</span></a>                <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1262"><a href="#ExperimentParametrisation.use_image_for_positioning-1262"><span class="linenos">1262</span></a>                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1263"><a href="#ExperimentParametrisation.use_image_for_positioning-1263"><span class="linenos">1263</span></a>                <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1264"><a href="#ExperimentParametrisation.use_image_for_positioning-1264"><span class="linenos">1264</span></a>                <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1265"><a href="#ExperimentParametrisation.use_image_for_positioning-1265"><span class="linenos">1265</span></a>                <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1266"><a href="#ExperimentParametrisation.use_image_for_positioning-1266"><span class="linenos">1266</span></a>                <span class="n">pixelsize</span><span class="o">=</span><span class="n">pixelsize</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1267"><a href="#ExperimentParametrisation.use_image_for_positioning-1267"><span class="linenos">1267</span></a>                <span class="n">min_distance</span><span class="o">=</span><span class="n">min_distance</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1268"><a href="#ExperimentParametrisation.use_image_for_positioning-1268"><span class="linenos">1268</span></a>                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1269"><a href="#ExperimentParametrisation.use_image_for_positioning-1269"><span class="linenos">1269</span></a>            <span class="p">)</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1270"><a href="#ExperimentParametrisation.use_image_for_positioning-1270"><span class="linenos">1270</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1271"><a href="#ExperimentParametrisation.use_image_for_positioning-1271"><span class="linenos">1271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_virtualsample_params</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1272"><a href="#ExperimentParametrisation.use_image_for_positioning-1272"><span class="linenos">1272</span></a>            <span class="n">sample_dimensions</span><span class="o">=</span><span class="p">[</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1273"><a href="#ExperimentParametrisation.use_image_for_positioning-1273"><span class="linenos">1273</span></a>                <span class="n">image_physical_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1274"><a href="#ExperimentParametrisation.use_image_for_positioning-1274"><span class="linenos">1274</span></a>                <span class="n">image_physical_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1275"><a href="#ExperimentParametrisation.use_image_for_positioning-1275"><span class="linenos">1275</span></a>                <span class="mi">100</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1276"><a href="#ExperimentParametrisation.use_image_for_positioning-1276"><span class="linenos">1276</span></a>            <span class="p">],</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1277"><a href="#ExperimentParametrisation.use_image_for_positioning-1277"><span class="linenos">1277</span></a>            <span class="n">particle_positions</span><span class="o">=</span><span class="n">xyz_relative</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1278"><a href="#ExperimentParametrisation.use_image_for_positioning-1278"><span class="linenos">1278</span></a>            <span class="n">number_of_particles</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_relative</span><span class="p">),</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1279"><a href="#ExperimentParametrisation.use_image_for_positioning-1279"><span class="linenos">1279</span></a>            <span class="n">random_orientations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1280"><a href="#ExperimentParametrisation.use_image_for_positioning-1280"><span class="linenos">1280</span></a>            <span class="n">random_placing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1281"><a href="#ExperimentParametrisation.use_image_for_positioning-1281"><span class="linenos">1281</span></a>            <span class="n">minimal_distance</span><span class="o">=</span><span class="n">min_distance</span><span class="p">,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1282"><a href="#ExperimentParametrisation.use_image_for_positioning-1282"><span class="linenos">1282</span></a>        <span class="p">)</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1283"><a href="#ExperimentParametrisation.use_image_for_positioning-1283"><span class="linenos">1283</span></a>        <span class="c1"># self.virtualsample_params[&quot;relative_positions&quot;] = xyz_relative</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1284"><a href="#ExperimentParametrisation.use_image_for_positioning-1284"><span class="linenos">1284</span></a>        <span class="c1"># self.virtualsample_params[&quot;sample_dimensions&quot;] = [</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1285"><a href="#ExperimentParametrisation.use_image_for_positioning-1285"><span class="linenos">1285</span></a>        <span class="c1">#    image_physical_size[0],</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1286"><a href="#ExperimentParametrisation.use_image_for_positioning-1286"><span class="linenos">1286</span></a>        <span class="c1">#    image_physical_size[1],</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1287"><a href="#ExperimentParametrisation.use_image_for_positioning-1287"><span class="linenos">1287</span></a>        <span class="c1">#    100,</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1288"><a href="#ExperimentParametrisation.use_image_for_positioning-1288"><span class="linenos">1288</span></a>        <span class="c1"># ]</span>
</span><span id="ExperimentParametrisation.use_image_for_positioning-1289"><a href="#ExperimentParametrisation.use_image_for_positioning-1289"><span class="linenos">1289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;coordinate_field&quot;</span><span class="p">,</span> <span class="s2">&quot;imager&quot;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Generate and set relative positions for a virtual sample based on features detected in an input image.</p>

<p>This method processes the provided image to extract feature coordinates using the specified detection mode
and parameters. The resulting positions are stored in <code>self.virtualsample_params["relative_positions"]</code>,
and the sample's physical dimensions are updated accordingly. The method then triggers the build process
for the 'coordinate_field' and 'imager' modules.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>img</strong>:  array-like
The input image (as a NumPy array or compatible format) to be analyzed for feature detection.</li>
<li><strong>mode</strong>:  str, optional
The feature detection mode to use (e.g., "localmaxima"). Default is "localmaxima".</li>
<li><strong>sigma</strong>:  float or None, optional
Standard deviation for Gaussian smoothing. If None, no smoothing is applied.</li>
<li><strong>background</strong>:  float or None, optional
Background intensity to subtract from the image. If None, no subtraction.</li>
<li><strong>threshold</strong>:  float or None, optional
Minimum intensity threshold for feature detection. If None, uses default.</li>
<li><strong>pixelsize</strong>:  float or None, optional
Pixel size of the input image. If None, uses default.</li>
<li><strong>min_distance</strong>:  float or None, optional
Minimum distance between detected features. If None, uses default.
:param **kwargs
Additional keyword arguments passed to the feature detection function.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>None</p>

<h2 id="notes">Notes</h2>

<p>Updates <code>self.virtualsample_params</code> with new relative positions and sample dimensions. Calls <code>self.build()</code> for the specified modules.</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.current_settings" class="classattr">
                                        <input id="ExperimentParametrisation.current_settings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">current_settings</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&lt;br&gt;&#39;</span>, </span><span class="param"><span class="n">modalities_acq_params</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.current_settings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.current_settings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.current_settings-1291"><a href="#ExperimentParametrisation.current_settings-1291"><span class="linenos">1291</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">current_settings</span><span class="p">(</span>
</span><span id="ExperimentParametrisation.current_settings-1292"><a href="#ExperimentParametrisation.current_settings-1292"><span class="linenos">1292</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">,</span> <span class="n">modalities_acq_params</span><span class="o">=</span><span class="kc">False</span>
</span><span id="ExperimentParametrisation.current_settings-1293"><a href="#ExperimentParametrisation.current_settings-1293"><span class="linenos">1293</span></a>    <span class="p">):</span>
</span><span id="ExperimentParametrisation.current_settings-1294"><a href="#ExperimentParametrisation.current_settings-1294"><span class="linenos">1294</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.current_settings-1295"><a href="#ExperimentParametrisation.current_settings-1295"><span class="linenos">1295</span></a><span class="sd">        Print the current settings of the experiment, including structure, particle, coordinate field, and imaging modalities.</span>
</span><span id="ExperimentParametrisation.current_settings-1296"><a href="#ExperimentParametrisation.current_settings-1296"><span class="linenos">1296</span></a>
</span><span id="ExperimentParametrisation.current_settings-1297"><a href="#ExperimentParametrisation.current_settings-1297"><span class="linenos">1297</span></a><span class="sd">    Returns</span>
</span><span id="ExperimentParametrisation.current_settings-1298"><a href="#ExperimentParametrisation.current_settings-1298"><span class="linenos">1298</span></a><span class="sd">    -------</span>
</span><span id="ExperimentParametrisation.current_settings-1299"><a href="#ExperimentParametrisation.current_settings-1299"><span class="linenos">1299</span></a><span class="sd">    None</span>
</span><span id="ExperimentParametrisation.current_settings-1300"><a href="#ExperimentParametrisation.current_settings-1300"><span class="linenos">1300</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ExperimentParametrisation.current_settings-1301"><a href="#ExperimentParametrisation.current_settings-1301"><span class="linenos">1301</span></a>        <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;Current settings of the experiment:&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation.current_settings-1302"><a href="#ExperimentParametrisation.current_settings-1302"><span class="linenos">1302</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Structure ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation.current_settings-1303"><a href="#ExperimentParametrisation.current_settings-1303"><span class="linenos">1303</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Probes: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probe_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation.current_settings-1304"><a href="#ExperimentParametrisation.current_settings-1304"><span class="linenos">1304</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Virtual sample: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation.current_settings-1305"><a href="#ExperimentParametrisation.current_settings-1305"><span class="linenos">1305</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;Imaging Modalities: &quot;</span>
</span><span id="ExperimentParametrisation.current_settings-1306"><a href="#ExperimentParametrisation.current_settings-1306"><span class="linenos">1306</span></a>        <span class="k">for</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">acqparams</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_mods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ExperimentParametrisation.current_settings-1307"><a href="#ExperimentParametrisation.current_settings-1307"><span class="linenos">1307</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">modality_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ExperimentParametrisation.current_settings-1308"><a href="#ExperimentParametrisation.current_settings-1308"><span class="linenos">1308</span></a>            <span class="k">if</span> <span class="n">modalities_acq_params</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.current_settings-1309"><a href="#ExperimentParametrisation.current_settings-1309"><span class="linenos">1309</span></a>                <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">acqparams</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation.current_settings-1310"><a href="#ExperimentParametrisation.current_settings-1310"><span class="linenos">1310</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.current_settings-1311"><a href="#ExperimentParametrisation.current_settings-1311"><span class="linenos">1311</span></a>                <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span>
</span><span id="ExperimentParametrisation.current_settings-1312"><a href="#ExperimentParametrisation.current_settings-1312"><span class="linenos">1312</span></a>        <span class="n">string</span> <span class="o">+=</span> <span class="n">newline</span>
</span><span id="ExperimentParametrisation.current_settings-1313"><a href="#ExperimentParametrisation.current_settings-1313"><span class="linenos">1313</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">as_string</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.current_settings-1314"><a href="#ExperimentParametrisation.current_settings-1314"><span class="linenos">1314</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.current_settings-1315"><a href="#ExperimentParametrisation.current_settings-1315"><span class="linenos">1315</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.current_settings-1316"><a href="#ExperimentParametrisation.current_settings-1316"><span class="linenos">1316</span></a>            <span class="k">return</span> <span class="n">string</span>
</span></pre></div>


            <div class="docstring"><p>Print the current settings of the experiment, including structure, particle, coordinate field, and imaging modalities.</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="ExperimentParametrisation.expand_virtual_sample" class="classattr">
                                        <input id="ExperimentParametrisation.expand_virtual_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">expand_virtual_sample</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">factor</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExperimentParametrisation.expand_virtual_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExperimentParametrisation.expand_virtual_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExperimentParametrisation.expand_virtual_sample-1318"><a href="#ExperimentParametrisation.expand_virtual_sample-1318"><span class="linenos">1318</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">expand_virtual_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="ExperimentParametrisation.expand_virtual_sample-1319"><a href="#ExperimentParametrisation.expand_virtual_sample-1319"><span class="linenos">1319</span></a>        <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ExperimentParametrisation.expand_virtual_sample-1320"><a href="#ExperimentParametrisation.expand_virtual_sample-1320"><span class="linenos">1320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_field</span><span class="o">.</span><span class="n">expand_isotropically</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span><span id="ExperimentParametrisation.expand_virtual_sample-1321"><a href="#ExperimentParametrisation.expand_virtual_sample-1321"><span class="linenos">1321</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;imager&quot;</span><span class="p">,])</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="generate_virtual_sample">
                            <input id="generate_virtual_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_virtual_sample</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">structure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1XI5&#39;</span>,</span><span class="param">	<span class="n">structure_is_path</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;NHS_ester&#39;</span>,</span><span class="param">	<span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_model</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;AF647&#39;</span>,</span><span class="param">	<span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_wobble_theta</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">structural_integrity_small_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">structural_integrity_large_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">structural_integrity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">virtual_sample_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;square1x1um_randomised&#39;</span>,</span><span class="param">	<span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">random_orientations</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">xy_orientations</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">xz_orientations</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">yz_orientations</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">axial_offset</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">random_placing</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">random_rotations</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">rotation_angles</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">expansion_factor</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">clear_probes</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">clear_experiment</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">primary_probe</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">secondary_probe</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_list</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="generate_virtual_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_virtual_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_virtual_sample-1323"><a href="#generate_virtual_sample-1323"><span class="linenos">1323</span></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_virtual_sample</span><span class="p">(</span>
</span><span id="generate_virtual_sample-1324"><a href="#generate_virtual_sample-1324"><span class="linenos">1324</span></a>    <span class="n">structure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1XI5&quot;</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1325"><a href="#generate_virtual_sample-1325"><span class="linenos">1325</span></a>    <span class="n">structure_is_path</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1326"><a href="#generate_virtual_sample-1326"><span class="linenos">1326</span></a>    <span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1327"><a href="#generate_virtual_sample-1327"><span class="linenos">1327</span></a>    <span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1328"><a href="#generate_virtual_sample-1328"><span class="linenos">1328</span></a>    <span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1329"><a href="#generate_virtual_sample-1329"><span class="linenos">1329</span></a>    <span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1330"><a href="#generate_virtual_sample-1330"><span class="linenos">1330</span></a>    <span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1331"><a href="#generate_virtual_sample-1331"><span class="linenos">1331</span></a>    <span class="n">probe_model</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1332"><a href="#generate_virtual_sample-1332"><span class="linenos">1332</span></a>    <span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1333"><a href="#generate_virtual_sample-1333"><span class="linenos">1333</span></a>    <span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1334"><a href="#generate_virtual_sample-1334"><span class="linenos">1334</span></a>    <span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1335"><a href="#generate_virtual_sample-1335"><span class="linenos">1335</span></a>    <span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1336"><a href="#generate_virtual_sample-1336"><span class="linenos">1336</span></a>    <span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1337"><a href="#generate_virtual_sample-1337"><span class="linenos">1337</span></a>    <span class="n">probe_wobble_theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1338"><a href="#generate_virtual_sample-1338"><span class="linenos">1338</span></a>    <span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1339"><a href="#generate_virtual_sample-1339"><span class="linenos">1339</span></a>    <span class="n">structural_integrity_small_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1340"><a href="#generate_virtual_sample-1340"><span class="linenos">1340</span></a>    <span class="n">structural_integrity_large_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1341"><a href="#generate_virtual_sample-1341"><span class="linenos">1341</span></a>    <span class="n">structural_integrity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1342"><a href="#generate_virtual_sample-1342"><span class="linenos">1342</span></a>    <span class="n">virtual_sample_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;square1x1um_randomised&quot;</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1343"><a href="#generate_virtual_sample-1343"><span class="linenos">1343</span></a>    <span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1344"><a href="#generate_virtual_sample-1344"><span class="linenos">1344</span></a>    <span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1345"><a href="#generate_virtual_sample-1345"><span class="linenos">1345</span></a>    <span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1346"><a href="#generate_virtual_sample-1346"><span class="linenos">1346</span></a>    <span class="n">random_orientations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1347"><a href="#generate_virtual_sample-1347"><span class="linenos">1347</span></a>    <span class="n">xy_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1348"><a href="#generate_virtual_sample-1348"><span class="linenos">1348</span></a>    <span class="n">xz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1349"><a href="#generate_virtual_sample-1349"><span class="linenos">1349</span></a>    <span class="n">yz_orientations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1350"><a href="#generate_virtual_sample-1350"><span class="linenos">1350</span></a>    <span class="n">axial_offset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1351"><a href="#generate_virtual_sample-1351"><span class="linenos">1351</span></a>    <span class="n">random_placing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1352"><a href="#generate_virtual_sample-1352"><span class="linenos">1352</span></a>    <span class="n">random_rotations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1353"><a href="#generate_virtual_sample-1353"><span class="linenos">1353</span></a>    <span class="n">rotation_angles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1354"><a href="#generate_virtual_sample-1354"><span class="linenos">1354</span></a>    <span class="n">expansion_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1355"><a href="#generate_virtual_sample-1355"><span class="linenos">1355</span></a>    <span class="n">clear_probes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1356"><a href="#generate_virtual_sample-1356"><span class="linenos">1356</span></a>    <span class="n">clear_experiment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1357"><a href="#generate_virtual_sample-1357"><span class="linenos">1357</span></a>    <span class="c1"># secondary</span>
</span><span id="generate_virtual_sample-1358"><a href="#generate_virtual_sample-1358"><span class="linenos">1358</span></a>    <span class="n">primary_probe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1359"><a href="#generate_virtual_sample-1359"><span class="linenos">1359</span></a>    <span class="n">secondary_probe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1360"><a href="#generate_virtual_sample-1360"><span class="linenos">1360</span></a>    <span class="n">probe_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1361"><a href="#generate_virtual_sample-1361"><span class="linenos">1361</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1362"><a href="#generate_virtual_sample-1362"><span class="linenos">1362</span></a><span class="p">):</span>
</span><span id="generate_virtual_sample-1363"><a href="#generate_virtual_sample-1363"><span class="linenos">1363</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="generate_virtual_sample-1364"><a href="#generate_virtual_sample-1364"><span class="linenos">1364</span></a><span class="sd">    Create a virtual sample from a structure model.</span>
</span><span id="generate_virtual_sample-1365"><a href="#generate_virtual_sample-1365"><span class="linenos">1365</span></a>
</span><span id="generate_virtual_sample-1366"><a href="#generate_virtual_sample-1366"><span class="linenos">1366</span></a><span class="sd">    Parameters</span>
</span><span id="generate_virtual_sample-1367"><a href="#generate_virtual_sample-1367"><span class="linenos">1367</span></a><span class="sd">    ----------</span>
</span><span id="generate_virtual_sample-1368"><a href="#generate_virtual_sample-1368"><span class="linenos">1368</span></a><span class="sd">    :param structure : str, optional</span>
</span><span id="generate_virtual_sample-1369"><a href="#generate_virtual_sample-1369"><span class="linenos">1369</span></a><span class="sd">        4-letter ID of PDB/CIF model. Default is &quot;1XI5&quot;.</span>
</span><span id="generate_virtual_sample-1370"><a href="#generate_virtual_sample-1370"><span class="linenos">1370</span></a><span class="sd">    :param structure_is_path : logical</span>
</span><span id="generate_virtual_sample-1371"><a href="#generate_virtual_sample-1371"><span class="linenos">1371</span></a><span class="sd">        Use structure value as absolute path for the PDB/CIF file.</span>
</span><span id="generate_virtual_sample-1372"><a href="#generate_virtual_sample-1372"><span class="linenos">1372</span></a><span class="sd">    :param probe_name : str, optional</span>
</span><span id="generate_virtual_sample-1373"><a href="#generate_virtual_sample-1373"><span class="linenos">1373</span></a><span class="sd">        Name ID of probe configuration file (filename).</span>
</span><span id="generate_virtual_sample-1374"><a href="#generate_virtual_sample-1374"><span class="linenos">1374</span></a><span class="sd">    :param probe_target_type : str, optional</span>
</span><span id="generate_virtual_sample-1375"><a href="#generate_virtual_sample-1375"><span class="linenos">1375</span></a><span class="sd">        Options: &quot;Sequence&quot;, &quot;Atom_residue&quot;, or &quot;Primary&quot;.</span>
</span><span id="generate_virtual_sample-1376"><a href="#generate_virtual_sample-1376"><span class="linenos">1376</span></a><span class="sd">    :param probe_target_value : str or dict, optional</span>
</span><span id="generate_virtual_sample-1377"><a href="#generate_virtual_sample-1377"><span class="linenos">1377</span></a><span class="sd">        For target type &quot;Sequence&quot; or &quot;Primary&quot;, a string. For &quot;Atom_residue&quot;, a dictionary with keys &quot;Atom&quot; and &quot;Residue&quot;.</span>
</span><span id="generate_virtual_sample-1378"><a href="#generate_virtual_sample-1378"><span class="linenos">1378</span></a><span class="sd">    :param probe_distance_to_epitope : float, optional</span>
</span><span id="generate_virtual_sample-1379"><a href="#generate_virtual_sample-1379"><span class="linenos">1379</span></a><span class="sd">        Minimal distance set from epitope and probe paratope.</span>
</span><span id="generate_virtual_sample-1380"><a href="#generate_virtual_sample-1380"><span class="linenos">1380</span></a><span class="sd">    :param probe_model : list of str, optional</span>
</span><span id="generate_virtual_sample-1381"><a href="#generate_virtual_sample-1381"><span class="linenos">1381</span></a><span class="sd">        4-letter ID(s) of PDB/CIF model(s).</span>
</span><span id="generate_virtual_sample-1382"><a href="#generate_virtual_sample-1382"><span class="linenos">1382</span></a><span class="sd">    :param probe_fluorophore : str, optional</span>
</span><span id="generate_virtual_sample-1383"><a href="#generate_virtual_sample-1383"><span class="linenos">1383</span></a><span class="sd">        Fluorophore name (e.g., &quot;AF647&quot;). Default is &quot;AF647&quot;.</span>
</span><span id="generate_virtual_sample-1384"><a href="#generate_virtual_sample-1384"><span class="linenos">1384</span></a><span class="sd">    :param probe_paratope : str, optional</span>
</span><span id="generate_virtual_sample-1385"><a href="#generate_virtual_sample-1385"><span class="linenos">1385</span></a><span class="sd">        Sequence of the paratope site for when probe includes a model.</span>
</span><span id="generate_virtual_sample-1386"><a href="#generate_virtual_sample-1386"><span class="linenos">1386</span></a><span class="sd">    :param probe_conjugation_target_info : Any, optional</span>
</span><span id="generate_virtual_sample-1387"><a href="#generate_virtual_sample-1387"><span class="linenos">1387</span></a><span class="sd">        Information about the probe conjugation target.</span>
</span><span id="generate_virtual_sample-1388"><a href="#generate_virtual_sample-1388"><span class="linenos">1388</span></a><span class="sd">    :param probe_DoL : float, optional</span>
</span><span id="generate_virtual_sample-1389"><a href="#generate_virtual_sample-1389"><span class="linenos">1389</span></a><span class="sd">        Efficiency of conjugation of emitters.</span>
</span><span id="generate_virtual_sample-1390"><a href="#generate_virtual_sample-1390"><span class="linenos">1390</span></a><span class="sd">    :param probe_seconday_epitope : str, optional</span>
</span><span id="generate_virtual_sample-1391"><a href="#generate_virtual_sample-1391"><span class="linenos">1391</span></a><span class="sd">        Sequence within probe model to be used as epitope for a secondary.</span>
</span><span id="generate_virtual_sample-1392"><a href="#generate_virtual_sample-1392"><span class="linenos">1392</span></a><span class="sd">    :param probe_wobbling : bool, optional</span>
</span><span id="generate_virtual_sample-1393"><a href="#generate_virtual_sample-1393"><span class="linenos">1393</span></a><span class="sd">        Enable probe wobbling. Default is False.</span>
</span><span id="generate_virtual_sample-1394"><a href="#generate_virtual_sample-1394"><span class="linenos">1394</span></a><span class="sd">    :param labelling_efficiency : float, optional</span>
</span><span id="generate_virtual_sample-1395"><a href="#generate_virtual_sample-1395"><span class="linenos">1395</span></a><span class="sd">        Labelling efficiency of probe. Default is 1.0.</span>
</span><span id="generate_virtual_sample-1396"><a href="#generate_virtual_sample-1396"><span class="linenos">1396</span></a><span class="sd">    :param structural_integrity_small_cluster : float, optional</span>
</span><span id="generate_virtual_sample-1397"><a href="#generate_virtual_sample-1397"><span class="linenos">1397</span></a><span class="sd">        In , distance used to group epitopes into multimers.</span>
</span><span id="generate_virtual_sample-1398"><a href="#generate_virtual_sample-1398"><span class="linenos">1398</span></a><span class="sd">    :param structural_integrity_large_cluster : float, optional</span>
</span><span id="generate_virtual_sample-1399"><a href="#generate_virtual_sample-1399"><span class="linenos">1399</span></a><span class="sd">        In , distance within multimers to consider neighbors.</span>
</span><span id="generate_virtual_sample-1400"><a href="#generate_virtual_sample-1400"><span class="linenos">1400</span></a><span class="sd">    :param structural_integrity : float, optional</span>
</span><span id="generate_virtual_sample-1401"><a href="#generate_virtual_sample-1401"><span class="linenos">1401</span></a><span class="sd">        Fraction of structural_integrity to model.</span>
</span><span id="generate_virtual_sample-1402"><a href="#generate_virtual_sample-1402"><span class="linenos">1402</span></a><span class="sd">    :param virtual_sample_template : str, optional</span>
</span><span id="generate_virtual_sample-1403"><a href="#generate_virtual_sample-1403"><span class="linenos">1403</span></a><span class="sd">        Name of the configuration file for template. Default is &quot;square1x1um_randomised&quot;.</span>
</span><span id="generate_virtual_sample-1404"><a href="#generate_virtual_sample-1404"><span class="linenos">1404</span></a><span class="sd">    :param sample_dimensions : list of float, optional</span>
</span><span id="generate_virtual_sample-1405"><a href="#generate_virtual_sample-1405"><span class="linenos">1405</span></a><span class="sd">        In nanometers, define the X, Y, and Z sizes of the field.</span>
</span><span id="generate_virtual_sample-1406"><a href="#generate_virtual_sample-1406"><span class="linenos">1406</span></a><span class="sd">    :param number_of_particles : int, optional</span>
</span><span id="generate_virtual_sample-1407"><a href="#generate_virtual_sample-1407"><span class="linenos">1407</span></a><span class="sd">        Number of independent copies of a particle to create and distribute.</span>
</span><span id="generate_virtual_sample-1408"><a href="#generate_virtual_sample-1408"><span class="linenos">1408</span></a><span class="sd">    :param particle_positions : list of np.array, optional</span>
</span><span id="generate_virtual_sample-1409"><a href="#generate_virtual_sample-1409"><span class="linenos">1409</span></a><span class="sd">        Relative positions of particles in the field.</span>
</span><span id="generate_virtual_sample-1410"><a href="#generate_virtual_sample-1410"><span class="linenos">1410</span></a><span class="sd">    :param random_orientations : bool, optional</span>
</span><span id="generate_virtual_sample-1411"><a href="#generate_virtual_sample-1411"><span class="linenos">1411</span></a><span class="sd">        If True, each particle will be randomly assigned a new orientation. Default is False.</span>
</span><span id="generate_virtual_sample-1412"><a href="#generate_virtual_sample-1412"><span class="linenos">1412</span></a><span class="sd">    :param random_placing : bool, optional</span>
</span><span id="generate_virtual_sample-1413"><a href="#generate_virtual_sample-1413"><span class="linenos">1413</span></a><span class="sd">        Define if position in field is random or the center of field. Default is False.</span>
</span><span id="generate_virtual_sample-1414"><a href="#generate_virtual_sample-1414"><span class="linenos">1414</span></a><span class="sd">    :param clear_probes : bool, optional</span>
</span><span id="generate_virtual_sample-1415"><a href="#generate_virtual_sample-1415"><span class="linenos">1415</span></a><span class="sd">        If True, default parameters will be cleared. Default is False.</span>
</span><span id="generate_virtual_sample-1416"><a href="#generate_virtual_sample-1416"><span class="linenos">1416</span></a><span class="sd">    :param **kwargs</span>
</span><span id="generate_virtual_sample-1417"><a href="#generate_virtual_sample-1417"><span class="linenos">1417</span></a><span class="sd">        Additional keyword arguments.</span>
</span><span id="generate_virtual_sample-1418"><a href="#generate_virtual_sample-1418"><span class="linenos">1418</span></a>
</span><span id="generate_virtual_sample-1419"><a href="#generate_virtual_sample-1419"><span class="linenos">1419</span></a><span class="sd">    Returns</span>
</span><span id="generate_virtual_sample-1420"><a href="#generate_virtual_sample-1420"><span class="linenos">1420</span></a><span class="sd">    -------</span>
</span><span id="generate_virtual_sample-1421"><a href="#generate_virtual_sample-1421"><span class="linenos">1421</span></a><span class="sd">    tuple</span>
</span><span id="generate_virtual_sample-1422"><a href="#generate_virtual_sample-1422"><span class="linenos">1422</span></a><span class="sd">        - dict: The virtual sample as exported format. This can be used as input for the `image_vsample` method.</span>
</span><span id="generate_virtual_sample-1423"><a href="#generate_virtual_sample-1423"><span class="linenos">1423</span></a><span class="sd">        - ExperimentParametrisation: The experiment containing all modules that were generated to build the virtual sample, and the virtual sample module itself. This experiment can be further used and tweaked for subsequent analysis or branching workflows.</span>
</span><span id="generate_virtual_sample-1424"><a href="#generate_virtual_sample-1424"><span class="linenos">1424</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="generate_virtual_sample-1425"><a href="#generate_virtual_sample-1425"><span class="linenos">1425</span></a>    <span class="n">myexperiment</span> <span class="o">=</span> <span class="n">ExperimentParametrisation</span><span class="p">()</span>
</span><span id="generate_virtual_sample-1426"><a href="#generate_virtual_sample-1426"><span class="linenos">1426</span></a>    <span class="k">if</span> <span class="n">clear_experiment</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1427"><a href="#generate_virtual_sample-1427"><span class="linenos">1427</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">clear_experiment</span><span class="p">()</span>
</span><span id="generate_virtual_sample-1428"><a href="#generate_virtual_sample-1428"><span class="linenos">1428</span></a>    <span class="c1"># select structure</span>
</span><span id="generate_virtual_sample-1429"><a href="#generate_virtual_sample-1429"><span class="linenos">1429</span></a>    <span class="k">if</span> <span class="n">structure_is_path</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1430"><a href="#generate_virtual_sample-1430"><span class="linenos">1430</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selecting structure from path: </span><span class="si">{</span><span class="n">structure</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1431"><a href="#generate_virtual_sample-1431"><span class="linenos">1431</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">select_structure</span><span class="p">(</span>
</span><span id="generate_virtual_sample-1432"><a href="#generate_virtual_sample-1432"><span class="linenos">1432</span></a>            <span class="n">structure_id</span><span class="o">=</span><span class="n">structure</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> 
</span><span id="generate_virtual_sample-1433"><a href="#generate_virtual_sample-1433"><span class="linenos">1433</span></a>            <span class="n">structure_path</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1434"><a href="#generate_virtual_sample-1434"><span class="linenos">1434</span></a>            <span class="n">build</span><span class="o">=</span><span class="kc">True</span>
</span><span id="generate_virtual_sample-1435"><a href="#generate_virtual_sample-1435"><span class="linenos">1435</span></a>        <span class="p">)</span>
</span><span id="generate_virtual_sample-1436"><a href="#generate_virtual_sample-1436"><span class="linenos">1436</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1437"><a href="#generate_virtual_sample-1437"><span class="linenos">1437</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selecting structure from ID:&quot;</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1438"><a href="#generate_virtual_sample-1438"><span class="linenos">1438</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">select_structure</span><span class="p">(</span>
</span><span id="generate_virtual_sample-1439"><a href="#generate_virtual_sample-1439"><span class="linenos">1439</span></a>            <span class="n">structure_id</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> 
</span><span id="generate_virtual_sample-1440"><a href="#generate_virtual_sample-1440"><span class="linenos">1440</span></a>            <span class="n">structure_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1441"><a href="#generate_virtual_sample-1441"><span class="linenos">1441</span></a>            <span class="n">build</span><span class="o">=</span><span class="kc">True</span>
</span><span id="generate_virtual_sample-1442"><a href="#generate_virtual_sample-1442"><span class="linenos">1442</span></a>        <span class="p">)</span>
</span><span id="generate_virtual_sample-1443"><a href="#generate_virtual_sample-1443"><span class="linenos">1443</span></a>    <span class="c1"># load default configuration for probe</span>
</span><span id="generate_virtual_sample-1444"><a href="#generate_virtual_sample-1444"><span class="linenos">1444</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">primary_probe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">secondary_probe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="generate_virtual_sample-1445"><a href="#generate_virtual_sample-1445"><span class="linenos">1445</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding primary and secondary probes&quot;</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1446"><a href="#generate_virtual_sample-1446"><span class="linenos">1446</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">add_probe</span><span class="p">(</span><span class="n">as_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">primary_probe</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1447"><a href="#generate_virtual_sample-1447"><span class="linenos">1447</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">add_probe</span><span class="p">(</span><span class="n">as_primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">secondary_probe</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1448"><a href="#generate_virtual_sample-1448"><span class="linenos">1448</span></a>    <span class="k">elif</span> <span class="n">probe_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1449"><a href="#generate_virtual_sample-1449"><span class="linenos">1449</span></a>        <span class="k">for</span> <span class="n">probe</span> <span class="ow">in</span> <span class="n">probe_list</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1450"><a href="#generate_virtual_sample-1450"><span class="linenos">1450</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding probe: </span><span class="si">{</span><span class="n">probe</span><span class="p">[</span><span class="s1">&#39;probe_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1451"><a href="#generate_virtual_sample-1451"><span class="linenos">1451</span></a>            <span class="n">myexperiment</span><span class="o">.</span><span class="n">add_probe</span><span class="p">(</span><span class="o">**</span><span class="n">probe</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1452"><a href="#generate_virtual_sample-1452"><span class="linenos">1452</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1453"><a href="#generate_virtual_sample-1453"><span class="linenos">1453</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">clear_probes</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1454"><a href="#generate_virtual_sample-1454"><span class="linenos">1454</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">probe_template</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1455"><a href="#generate_virtual_sample-1455"><span class="linenos">1455</span></a>            <span class="n">probe_configuration_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="generate_virtual_sample-1456"><a href="#generate_virtual_sample-1456"><span class="linenos">1456</span></a>                <span class="n">myexperiment</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span> <span class="s2">&quot;probes&quot;</span><span class="p">,</span> <span class="n">probe_template</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span>
</span><span id="generate_virtual_sample-1457"><a href="#generate_virtual_sample-1457"><span class="linenos">1457</span></a>            <span class="p">)</span>
</span><span id="generate_virtual_sample-1458"><a href="#generate_virtual_sample-1458"><span class="linenos">1458</span></a>            <span class="n">probe_configuration</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">probe_configuration_file</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1459"><a href="#generate_virtual_sample-1459"><span class="linenos">1459</span></a>            <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_template</span>
</span><span id="generate_virtual_sample-1460"><a href="#generate_virtual_sample-1460"><span class="linenos">1460</span></a>            <span class="k">if</span> <span class="n">probe_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1461"><a href="#generate_virtual_sample-1461"><span class="linenos">1461</span></a>                <span class="n">probe_name</span> <span class="o">=</span> <span class="n">probe_template</span>
</span><span id="generate_virtual_sample-1462"><a href="#generate_virtual_sample-1462"><span class="linenos">1462</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1463"><a href="#generate_virtual_sample-1463"><span class="linenos">1463</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;label_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_name</span>
</span><span id="generate_virtual_sample-1464"><a href="#generate_virtual_sample-1464"><span class="linenos">1464</span></a>            <span class="k">if</span> <span class="n">probe_target_type</span> <span class="ow">and</span> <span class="n">probe_target_value</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1465"><a href="#generate_virtual_sample-1465"><span class="linenos">1465</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">probe_target_type</span><span class="p">,</span> <span class="n">probe_target_value</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1466"><a href="#generate_virtual_sample-1466"><span class="linenos">1466</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_target_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_target_type</span>
</span><span id="generate_virtual_sample-1467"><a href="#generate_virtual_sample-1467"><span class="linenos">1467</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_target_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_target_value</span>
</span><span id="generate_virtual_sample-1468"><a href="#generate_virtual_sample-1468"><span class="linenos">1468</span></a>            <span class="k">if</span> <span class="n">probe_distance_to_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1469"><a href="#generate_virtual_sample-1469"><span class="linenos">1469</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;distance_to_epitope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="generate_virtual_sample-1470"><a href="#generate_virtual_sample-1470"><span class="linenos">1470</span></a>                    <span class="n">probe_distance_to_epitope</span>
</span><span id="generate_virtual_sample-1471"><a href="#generate_virtual_sample-1471"><span class="linenos">1471</span></a>                <span class="p">)</span>
</span><span id="generate_virtual_sample-1472"><a href="#generate_virtual_sample-1472"><span class="linenos">1472</span></a>            <span class="k">if</span> <span class="n">probe_fluorophore</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1473"><a href="#generate_virtual_sample-1473"><span class="linenos">1473</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;fluorophore_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_fluorophore</span>
</span><span id="generate_virtual_sample-1474"><a href="#generate_virtual_sample-1474"><span class="linenos">1474</span></a>            <span class="k">if</span> <span class="n">labelling_efficiency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1475"><a href="#generate_virtual_sample-1475"><span class="linenos">1475</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;labelling_efficiency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelling_efficiency</span>
</span><span id="generate_virtual_sample-1476"><a href="#generate_virtual_sample-1476"><span class="linenos">1476</span></a>            <span class="k">if</span> <span class="n">probe_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1477"><a href="#generate_virtual_sample-1477"><span class="linenos">1477</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;model_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_model</span>
</span><span id="generate_virtual_sample-1478"><a href="#generate_virtual_sample-1478"><span class="linenos">1478</span></a>            <span class="k">if</span> <span class="n">probe_paratope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1479"><a href="#generate_virtual_sample-1479"><span class="linenos">1479</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;paratope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_paratope</span>
</span><span id="generate_virtual_sample-1480"><a href="#generate_virtual_sample-1480"><span class="linenos">1480</span></a>            <span class="k">if</span> <span class="n">probe_conjugation_target_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1481"><a href="#generate_virtual_sample-1481"><span class="linenos">1481</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;conjugation_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="generate_virtual_sample-1482"><a href="#generate_virtual_sample-1482"><span class="linenos">1482</span></a>                    <span class="n">probe_conjugation_target_info</span>
</span><span id="generate_virtual_sample-1483"><a href="#generate_virtual_sample-1483"><span class="linenos">1483</span></a>                <span class="p">)</span>
</span><span id="generate_virtual_sample-1484"><a href="#generate_virtual_sample-1484"><span class="linenos">1484</span></a>            <span class="k">if</span> <span class="n">probe_DoL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1485"><a href="#generate_virtual_sample-1485"><span class="linenos">1485</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_DoL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="generate_virtual_sample-1486"><a href="#generate_virtual_sample-1486"><span class="linenos">1486</span></a>                    <span class="n">probe_DoL</span>
</span><span id="generate_virtual_sample-1487"><a href="#generate_virtual_sample-1487"><span class="linenos">1487</span></a>                <span class="p">)</span>
</span><span id="generate_virtual_sample-1488"><a href="#generate_virtual_sample-1488"><span class="linenos">1488</span></a>            <span class="k">if</span> <span class="n">probe_seconday_epitope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1489"><a href="#generate_virtual_sample-1489"><span class="linenos">1489</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;epitope_target_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_seconday_epitope</span>
</span><span id="generate_virtual_sample-1490"><a href="#generate_virtual_sample-1490"><span class="linenos">1490</span></a>            <span class="k">if</span> <span class="n">probe_wobble_theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1491"><a href="#generate_virtual_sample-1491"><span class="linenos">1491</span></a>                <span class="n">probe_configuration</span><span class="p">[</span><span class="s2">&quot;probe_wobble_theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probe_wobble_theta</span>
</span><span id="generate_virtual_sample-1492"><a href="#generate_virtual_sample-1492"><span class="linenos">1492</span></a>            <span class="n">myexperiment</span><span class="o">.</span><span class="n">add_probe</span><span class="p">(</span><span class="o">**</span><span class="n">probe_configuration</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1493"><a href="#generate_virtual_sample-1493"><span class="linenos">1493</span></a>    <span class="c1"># load default configuration for virtual sample</span>
</span><span id="generate_virtual_sample-1494"><a href="#generate_virtual_sample-1494"><span class="linenos">1494</span></a>    <span class="n">virtual_sample_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="generate_virtual_sample-1495"><a href="#generate_virtual_sample-1495"><span class="linenos">1495</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">configuration_path</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1496"><a href="#generate_virtual_sample-1496"><span class="linenos">1496</span></a>        <span class="s2">&quot;virtualsample&quot;</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1497"><a href="#generate_virtual_sample-1497"><span class="linenos">1497</span></a>        <span class="n">virtual_sample_template</span> <span class="o">+</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1498"><a href="#generate_virtual_sample-1498"><span class="linenos">1498</span></a>    <span class="p">)</span>
</span><span id="generate_virtual_sample-1499"><a href="#generate_virtual_sample-1499"><span class="linenos">1499</span></a>    <span class="n">vsample_configuration</span> <span class="o">=</span> <span class="n">load_yaml</span><span class="p">(</span><span class="n">virtual_sample_template</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1500"><a href="#generate_virtual_sample-1500"><span class="linenos">1500</span></a>    <span class="c1">#myexperiment.configuration_path</span>
</span><span id="generate_virtual_sample-1501"><a href="#generate_virtual_sample-1501"><span class="linenos">1501</span></a>    <span class="k">if</span> <span class="n">structural_integrity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">structural_integrity_large_cluster</span> <span class="ow">and</span> <span class="n">structural_integrity_small_cluster</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1502"><a href="#generate_virtual_sample-1502"><span class="linenos">1502</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structural_integrity_small_cluster</span>
</span><span id="generate_virtual_sample-1503"><a href="#generate_virtual_sample-1503"><span class="linenos">1503</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;eps2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structural_integrity_large_cluster</span>
</span><span id="generate_virtual_sample-1504"><a href="#generate_virtual_sample-1504"><span class="linenos">1504</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structural_integrity</span>
</span><span id="generate_virtual_sample-1505"><a href="#generate_virtual_sample-1505"><span class="linenos">1505</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">structural_integrity_eps</span><span class="p">[</span><span class="s2">&quot;use_structural_integrity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="generate_virtual_sample-1506"><a href="#generate_virtual_sample-1506"><span class="linenos">1506</span></a>
</span><span id="generate_virtual_sample-1507"><a href="#generate_virtual_sample-1507"><span class="linenos">1507</span></a>    <span class="k">if</span> <span class="n">sample_dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1508"><a href="#generate_virtual_sample-1508"><span class="linenos">1508</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;sample_dimensions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_dimensions</span>
</span><span id="generate_virtual_sample-1509"><a href="#generate_virtual_sample-1509"><span class="linenos">1509</span></a>    <span class="k">if</span> <span class="n">number_of_particles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1510"><a href="#generate_virtual_sample-1510"><span class="linenos">1510</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;number_of_particles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_of_particles</span>
</span><span id="generate_virtual_sample-1511"><a href="#generate_virtual_sample-1511"><span class="linenos">1511</span></a>    <span class="k">if</span> <span class="n">particle_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1512"><a href="#generate_virtual_sample-1512"><span class="linenos">1512</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;relative_positions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_positions</span>
</span><span id="generate_virtual_sample-1513"><a href="#generate_virtual_sample-1513"><span class="linenos">1513</span></a>    <span class="k">if</span> <span class="n">random_orientations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1514"><a href="#generate_virtual_sample-1514"><span class="linenos">1514</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;random_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_orientations</span>
</span><span id="generate_virtual_sample-1515"><a href="#generate_virtual_sample-1515"><span class="linenos">1515</span></a>    <span class="k">if</span> <span class="n">random_placing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1516"><a href="#generate_virtual_sample-1516"><span class="linenos">1516</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;random_placing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_placing</span>
</span><span id="generate_virtual_sample-1517"><a href="#generate_virtual_sample-1517"><span class="linenos">1517</span></a>    <span class="k">if</span> <span class="n">random_rotations</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1518"><a href="#generate_virtual_sample-1518"><span class="linenos">1518</span></a>        <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;random_rotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_rotations</span>
</span><span id="generate_virtual_sample-1519"><a href="#generate_virtual_sample-1519"><span class="linenos">1519</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;rotation_angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_angles</span>
</span><span id="generate_virtual_sample-1520"><a href="#generate_virtual_sample-1520"><span class="linenos">1520</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;xy_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_orientations</span>
</span><span id="generate_virtual_sample-1521"><a href="#generate_virtual_sample-1521"><span class="linenos">1521</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;xz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xz_orientations</span>
</span><span id="generate_virtual_sample-1522"><a href="#generate_virtual_sample-1522"><span class="linenos">1522</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;yz_orientations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yz_orientations</span>
</span><span id="generate_virtual_sample-1523"><a href="#generate_virtual_sample-1523"><span class="linenos">1523</span></a>    <span class="n">vsample_configuration</span><span class="p">[</span><span class="s2">&quot;axial_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axial_offset</span>
</span><span id="generate_virtual_sample-1524"><a href="#generate_virtual_sample-1524"><span class="linenos">1524</span></a>    <span class="n">myexperiment</span><span class="o">.</span><span class="n">virtualsample_params</span> <span class="o">=</span> <span class="n">vsample_configuration</span>
</span><span id="generate_virtual_sample-1525"><a href="#generate_virtual_sample-1525"><span class="linenos">1525</span></a>    <span class="n">myexperiment</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">modules</span><span class="o">=</span><span class="p">[</span>
</span><span id="generate_virtual_sample-1526"><a href="#generate_virtual_sample-1526"><span class="linenos">1526</span></a>                <span class="s2">&quot;particle&quot;</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1527"><a href="#generate_virtual_sample-1527"><span class="linenos">1527</span></a>                <span class="s2">&quot;coordinate_field&quot;</span><span class="p">,</span>
</span><span id="generate_virtual_sample-1528"><a href="#generate_virtual_sample-1528"><span class="linenos">1528</span></a>                <span class="s2">&quot;imager&quot;</span><span class="p">],</span> <span class="n">use_locals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1529"><a href="#generate_virtual_sample-1529"><span class="linenos">1529</span></a>    <span class="k">if</span> <span class="n">expansion_factor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="generate_virtual_sample-1530"><a href="#generate_virtual_sample-1530"><span class="linenos">1530</span></a>        <span class="n">myexperiment</span><span class="o">.</span><span class="n">expand_virtual_sample</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="n">expansion_factor</span><span class="p">)</span>
</span><span id="generate_virtual_sample-1531"><a href="#generate_virtual_sample-1531"><span class="linenos">1531</span></a>    <span class="c1"># myexperiment.coordinate_field_id = virtual_sample</span>
</span><span id="generate_virtual_sample-1532"><a href="#generate_virtual_sample-1532"><span class="linenos">1532</span></a>    <span class="k">return</span> <span class="n">myexperiment</span><span class="o">.</span><span class="n">exported_coordinate_field</span><span class="p">,</span> <span class="n">myexperiment</span>
</span></pre></div>


            <div class="docstring"><p>Create a virtual sample from a structure model.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>structure</strong>:  str, optional
4-letter ID of PDB/CIF model. Default is "1XI5".</li>
<li><strong>structure_is_path</strong>:  logical
Use structure value as absolute path for the PDB/CIF file.</li>
<li><strong>probe_name</strong>:  str, optional
Name ID of probe configuration file (filename).</li>
<li><strong>probe_target_type</strong>:  str, optional
Options: "Sequence", "Atom_residue", or "Primary".</li>
<li><strong>probe_target_value</strong>:  str or dict, optional
For target type "Sequence" or "Primary", a string. For "Atom_residue", a dictionary with keys "Atom" and "Residue".</li>
<li><strong>probe_distance_to_epitope</strong>:  float, optional
Minimal distance set from epitope and probe paratope.</li>
<li><strong>probe_model</strong>:  list of str, optional
4-letter ID(s) of PDB/CIF model(s).</li>
<li><strong>probe_fluorophore</strong>:  str, optional
Fluorophore name (e.g., "AF647"). Default is "AF647".</li>
<li><strong>probe_paratope</strong>:  str, optional
Sequence of the paratope site for when probe includes a model.</li>
<li><strong>probe_conjugation_target_info</strong>:  Any, optional
Information about the probe conjugation target.</li>
<li><strong>probe_DoL</strong>:  float, optional
Efficiency of conjugation of emitters.</li>
<li><strong>probe_seconday_epitope</strong>:  str, optional
Sequence within probe model to be used as epitope for a secondary.</li>
<li><strong>probe_wobbling</strong>:  bool, optional
Enable probe wobbling. Default is False.</li>
<li><strong>labelling_efficiency</strong>:  float, optional
Labelling efficiency of probe. Default is 1.0.</li>
<li><strong>structural_integrity_small_cluster</strong>:  float, optional
In , distance used to group epitopes into multimers.</li>
<li><strong>structural_integrity_large_cluster</strong>:  float, optional
In , distance within multimers to consider neighbors.</li>
<li><strong>structural_integrity</strong>:  float, optional
Fraction of structural_integrity to model.</li>
<li><strong>virtual_sample_template</strong>:  str, optional
Name of the configuration file for template. Default is "square1x1um_randomised".</li>
<li><strong>sample_dimensions</strong>:  list of float, optional
In nanometers, define the X, Y, and Z sizes of the field.</li>
<li><strong>number_of_particles</strong>:  int, optional
Number of independent copies of a particle to create and distribute.</li>
<li><strong>particle_positions</strong>:  list of np.array, optional
Relative positions of particles in the field.</li>
<li><strong>random_orientations</strong>:  bool, optional
If True, each particle will be randomly assigned a new orientation. Default is False.</li>
<li><strong>random_placing</strong>:  bool, optional
Define if position in field is random or the center of field. Default is False.</li>
<li><strong>clear_probes</strong>:  bool, optional
If True, default parameters will be cleared. Default is False.
:param **kwargs
Additional keyword arguments.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>tuple
    - dict: The virtual sample as exported format. This can be used as input for the <code><a href="#image_vsample">image_vsample</a></code> method.
    - ExperimentParametrisation: The experiment containing all modules that were generated to build the virtual sample, and the virtual sample module itself. This experiment can be further used and tweaked for subsequent analysis or branching workflows.</p>
</div>


                </section>
                <section id="build_virtual_microscope">
                            <input id="build_virtual_microscope-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_virtual_microscope</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">modality</span><span class="o">=</span><span class="s1">&#39;STED&#39;</span>,</span><span class="param">	<span class="n">multimodal</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">experiment</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="build_virtual_microscope-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#build_virtual_microscope"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="build_virtual_microscope-1535"><a href="#build_virtual_microscope-1535"><span class="linenos">1535</span></a><span class="k">def</span><span class="w"> </span><span class="nf">build_virtual_microscope</span><span class="p">(</span>
</span><span id="build_virtual_microscope-1536"><a href="#build_virtual_microscope-1536"><span class="linenos">1536</span></a>    <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;STED&quot;</span><span class="p">,</span> <span class="n">multimodal</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="build_virtual_microscope-1537"><a href="#build_virtual_microscope-1537"><span class="linenos">1537</span></a><span class="p">):</span>
</span><span id="build_virtual_microscope-1538"><a href="#build_virtual_microscope-1538"><span class="linenos">1538</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="build_virtual_microscope-1539"><a href="#build_virtual_microscope-1539"><span class="linenos">1539</span></a><span class="sd">    Initialise a virtual microscope for single or multimodal imaging.</span>
</span><span id="build_virtual_microscope-1540"><a href="#build_virtual_microscope-1540"><span class="linenos">1540</span></a>
</span><span id="build_virtual_microscope-1541"><a href="#build_virtual_microscope-1541"><span class="linenos">1541</span></a><span class="sd">    Parameters</span>
</span><span id="build_virtual_microscope-1542"><a href="#build_virtual_microscope-1542"><span class="linenos">1542</span></a><span class="sd">    ----------</span>
</span><span id="build_virtual_microscope-1543"><a href="#build_virtual_microscope-1543"><span class="linenos">1543</span></a><span class="sd">    :param modality : str, optional</span>
</span><span id="build_virtual_microscope-1544"><a href="#build_virtual_microscope-1544"><span class="linenos">1544</span></a><span class="sd">        Modality name. Default is &quot;STED&quot;.</span>
</span><span id="build_virtual_microscope-1545"><a href="#build_virtual_microscope-1545"><span class="linenos">1545</span></a><span class="sd">    :param multimodal : list of str, optional</span>
</span><span id="build_virtual_microscope-1546"><a href="#build_virtual_microscope-1546"><span class="linenos">1546</span></a><span class="sd">        List of modality names. Overrides the `modality` parameter if provided.</span>
</span><span id="build_virtual_microscope-1547"><a href="#build_virtual_microscope-1547"><span class="linenos">1547</span></a><span class="sd">    :param experiment : ExperimentParametrisation, optional</span>
</span><span id="build_virtual_microscope-1548"><a href="#build_virtual_microscope-1548"><span class="linenos">1548</span></a><span class="sd">        An Experiment object. If None, a new one is created.</span>
</span><span id="build_virtual_microscope-1549"><a href="#build_virtual_microscope-1549"><span class="linenos">1549</span></a><span class="sd">    :param **kwargs</span>
</span><span id="build_virtual_microscope-1550"><a href="#build_virtual_microscope-1550"><span class="linenos">1550</span></a><span class="sd">        Additional arguments passed to `add_modality`.</span>
</span><span id="build_virtual_microscope-1551"><a href="#build_virtual_microscope-1551"><span class="linenos">1551</span></a>
</span><span id="build_virtual_microscope-1552"><a href="#build_virtual_microscope-1552"><span class="linenos">1552</span></a><span class="sd">    Returns</span>
</span><span id="build_virtual_microscope-1553"><a href="#build_virtual_microscope-1553"><span class="linenos">1553</span></a><span class="sd">    -------</span>
</span><span id="build_virtual_microscope-1554"><a href="#build_virtual_microscope-1554"><span class="linenos">1554</span></a><span class="sd">    tuple</span>
</span><span id="build_virtual_microscope-1555"><a href="#build_virtual_microscope-1555"><span class="linenos">1555</span></a><span class="sd">        - Imager: The virtual microscope with the specified modality models. Contains a default sample.</span>
</span><span id="build_virtual_microscope-1556"><a href="#build_virtual_microscope-1556"><span class="linenos">1556</span></a><span class="sd">        - ExperimentParametrisation: The experiment containing the virtual microscope. All other modules are not initialised. This experiment can be further used and tweaked for subsequent analysis or branching workflows.</span>
</span><span id="build_virtual_microscope-1557"><a href="#build_virtual_microscope-1557"><span class="linenos">1557</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="build_virtual_microscope-1558"><a href="#build_virtual_microscope-1558"><span class="linenos">1558</span></a>    <span class="k">if</span> <span class="n">experiment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="build_virtual_microscope-1559"><a href="#build_virtual_microscope-1559"><span class="linenos">1559</span></a>        <span class="n">experiment</span> <span class="o">=</span> <span class="n">ExperimentParametrisation</span><span class="p">()</span>
</span><span id="build_virtual_microscope-1560"><a href="#build_virtual_microscope-1560"><span class="linenos">1560</span></a>    <span class="k">if</span> <span class="n">multimodal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="build_virtual_microscope-1561"><a href="#build_virtual_microscope-1561"><span class="linenos">1561</span></a>        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">multimodal</span><span class="p">:</span>
</span><span id="build_virtual_microscope-1562"><a href="#build_virtual_microscope-1562"><span class="linenos">1562</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</span><span id="build_virtual_microscope-1563"><a href="#build_virtual_microscope-1563"><span class="linenos">1563</span></a>            <span class="n">experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="build_virtual_microscope-1564"><a href="#build_virtual_microscope-1564"><span class="linenos">1564</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="build_virtual_microscope-1565"><a href="#build_virtual_microscope-1565"><span class="linenos">1565</span></a>        <span class="n">experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">modality</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="build_virtual_microscope-1566"><a href="#build_virtual_microscope-1566"><span class="linenos">1566</span></a>    <span class="k">if</span> <span class="s2">&quot;use_local_field&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="build_virtual_microscope-1567"><a href="#build_virtual_microscope-1567"><span class="linenos">1567</span></a>        <span class="n">experiment</span><span class="o">.</span><span class="n">_build_imager</span><span class="p">(</span><span class="n">use_local_field</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;use_local_field&quot;</span><span class="p">])</span>
</span><span id="build_virtual_microscope-1568"><a href="#build_virtual_microscope-1568"><span class="linenos">1568</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="build_virtual_microscope-1569"><a href="#build_virtual_microscope-1569"><span class="linenos">1569</span></a>        <span class="n">experiment</span><span class="o">.</span><span class="n">_build_imager</span><span class="p">()</span>
</span><span id="build_virtual_microscope-1570"><a href="#build_virtual_microscope-1570"><span class="linenos">1570</span></a>    <span class="k">return</span> <span class="n">experiment</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span> <span class="n">experiment</span>
</span></pre></div>


            <div class="docstring"><p>Initialise a virtual microscope for single or multimodal imaging.</p>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>modality</strong>:  str, optional
Modality name. Default is "STED".</li>
<li><strong>multimodal</strong>:  list of str, optional
List of modality names. Overrides the <code>modality</code> parameter if provided.</li>
<li><strong>experiment</strong>:  ExperimentParametrisation, optional
An Experiment object. If None, a new one is created.
:param **kwargs
Additional arguments passed to <code>add_modality</code>.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>tuple
    - Imager: The virtual microscope with the specified modality models. Contains a default sample.
    - ExperimentParametrisation: The experiment containing the virtual microscope. All other modules are not initialised. This experiment can be further used and tweaked for subsequent analysis or branching workflows.</p>
</div>


                </section>
                <section id="image_vsample">
                            <input id="image_vsample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">image_vsample</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">vsample</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">modality</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;STED&#39;</span>,</span><span class="param">	<span class="n">multimodal</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">run_simulation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">structure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1XI5&#39;</span>,</span><span class="param">	<span class="n">structure_is_path</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;NHS_ester&#39;</span>,</span><span class="param">	<span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_model</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;AF647&#39;</span>,</span><span class="param">	<span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_wobble_theta</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">structural_integrity_small_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">structural_integrity_large_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">structural_integrity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">virtual_sample_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;square1x1um_randomised&#39;</span>,</span><span class="param">	<span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">random_orientations</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">xy_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">xz_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">yz_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">axial_offset</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">random_placing</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">random_rotations</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">rotation_angles</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">expansion_factor</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">clear_probes</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">clear_experiment</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">primary_probe</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">secondary_probe</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">probe_list</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="image_vsample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#image_vsample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="image_vsample-1573"><a href="#image_vsample-1573"><span class="linenos">1573</span></a><span class="k">def</span><span class="w"> </span><span class="nf">image_vsample</span><span class="p">(</span>
</span><span id="image_vsample-1574"><a href="#image_vsample-1574"><span class="linenos">1574</span></a>    <span class="n">vsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1575"><a href="#image_vsample-1575"><span class="linenos">1575</span></a>    <span class="n">modality</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;STED&quot;</span><span class="p">,</span>
</span><span id="image_vsample-1576"><a href="#image_vsample-1576"><span class="linenos">1576</span></a>    <span class="n">multimodal</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1577"><a href="#image_vsample-1577"><span class="linenos">1577</span></a>    <span class="n">run_simulation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="image_vsample-1578"><a href="#image_vsample-1578"><span class="linenos">1578</span></a>    <span class="n">structure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1XI5&quot;</span><span class="p">,</span>
</span><span id="image_vsample-1579"><a href="#image_vsample-1579"><span class="linenos">1579</span></a>    <span class="n">structure_is_path</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_vsample-1580"><a href="#image_vsample-1580"><span class="linenos">1580</span></a>    <span class="n">probe_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NHS_ester&quot;</span><span class="p">,</span>
</span><span id="image_vsample-1581"><a href="#image_vsample-1581"><span class="linenos">1581</span></a>    <span class="n">probe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1582"><a href="#image_vsample-1582"><span class="linenos">1582</span></a>    <span class="n">probe_target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1583"><a href="#image_vsample-1583"><span class="linenos">1583</span></a>    <span class="n">probe_target_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1584"><a href="#image_vsample-1584"><span class="linenos">1584</span></a>    <span class="n">probe_distance_to_epitope</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1585"><a href="#image_vsample-1585"><span class="linenos">1585</span></a>    <span class="n">probe_model</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1586"><a href="#image_vsample-1586"><span class="linenos">1586</span></a>    <span class="n">probe_fluorophore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AF647&quot;</span><span class="p">,</span>
</span><span id="image_vsample-1587"><a href="#image_vsample-1587"><span class="linenos">1587</span></a>    <span class="n">probe_paratope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1588"><a href="#image_vsample-1588"><span class="linenos">1588</span></a>    <span class="n">probe_conjugation_target_info</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1589"><a href="#image_vsample-1589"><span class="linenos">1589</span></a>    <span class="n">probe_DoL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1590"><a href="#image_vsample-1590"><span class="linenos">1590</span></a>    <span class="n">probe_seconday_epitope</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1591"><a href="#image_vsample-1591"><span class="linenos">1591</span></a>    <span class="n">probe_wobble_theta</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1592"><a href="#image_vsample-1592"><span class="linenos">1592</span></a>    <span class="n">labelling_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="image_vsample-1593"><a href="#image_vsample-1593"><span class="linenos">1593</span></a>    <span class="n">structural_integrity_small_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1594"><a href="#image_vsample-1594"><span class="linenos">1594</span></a>    <span class="n">structural_integrity_large_cluster</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1595"><a href="#image_vsample-1595"><span class="linenos">1595</span></a>    <span class="n">structural_integrity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1596"><a href="#image_vsample-1596"><span class="linenos">1596</span></a>    <span class="n">virtual_sample_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;square1x1um_randomised&quot;</span><span class="p">,</span>
</span><span id="image_vsample-1597"><a href="#image_vsample-1597"><span class="linenos">1597</span></a>    <span class="n">sample_dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1598"><a href="#image_vsample-1598"><span class="linenos">1598</span></a>    <span class="n">number_of_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1599"><a href="#image_vsample-1599"><span class="linenos">1599</span></a>    <span class="n">particle_positions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1600"><a href="#image_vsample-1600"><span class="linenos">1600</span></a>    <span class="n">random_orientations</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_vsample-1601"><a href="#image_vsample-1601"><span class="linenos">1601</span></a>    <span class="n">xy_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1602"><a href="#image_vsample-1602"><span class="linenos">1602</span></a>    <span class="n">xz_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1603"><a href="#image_vsample-1603"><span class="linenos">1603</span></a>    <span class="n">yz_orientations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1604"><a href="#image_vsample-1604"><span class="linenos">1604</span></a>    <span class="n">axial_offset</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1605"><a href="#image_vsample-1605"><span class="linenos">1605</span></a>    <span class="n">random_placing</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_vsample-1606"><a href="#image_vsample-1606"><span class="linenos">1606</span></a>    <span class="n">random_rotations</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_vsample-1607"><a href="#image_vsample-1607"><span class="linenos">1607</span></a>    <span class="n">rotation_angles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1608"><a href="#image_vsample-1608"><span class="linenos">1608</span></a>    <span class="n">expansion_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="image_vsample-1609"><a href="#image_vsample-1609"><span class="linenos">1609</span></a>    <span class="n">clear_probes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_vsample-1610"><a href="#image_vsample-1610"><span class="linenos">1610</span></a>    <span class="n">clear_experiment</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_vsample-1611"><a href="#image_vsample-1611"><span class="linenos">1611</span></a>    <span class="n">primary_probe</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1612"><a href="#image_vsample-1612"><span class="linenos">1612</span></a>    <span class="n">secondary_probe</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1613"><a href="#image_vsample-1613"><span class="linenos">1613</span></a>    <span class="n">probe_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="image_vsample-1614"><a href="#image_vsample-1614"><span class="linenos">1614</span></a>    <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_vsample-1615"><a href="#image_vsample-1615"><span class="linenos">1615</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="image_vsample-1616"><a href="#image_vsample-1616"><span class="linenos">1616</span></a><span class="p">):</span>
</span><span id="image_vsample-1617"><a href="#image_vsample-1617"><span class="linenos">1617</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="image_vsample-1618"><a href="#image_vsample-1618"><span class="linenos">1618</span></a><span class="sd">    Generate imaging simulations of the specified virtual sample and imaging modalities.</span>
</span><span id="image_vsample-1619"><a href="#image_vsample-1619"><span class="linenos">1619</span></a>
</span><span id="image_vsample-1620"><a href="#image_vsample-1620"><span class="linenos">1620</span></a><span class="sd">    This function can either:</span>
</span><span id="image_vsample-1621"><a href="#image_vsample-1621"><span class="linenos">1621</span></a><span class="sd">    1. Take an existing virtual sample (as a dictionary) and wrap it in a new experiment, adding the specified imaging modalities.</span>
</span><span id="image_vsample-1622"><a href="#image_vsample-1622"><span class="linenos">1622</span></a><span class="sd">    2. Or, generate a new virtual sample and experiment from scratch using the provided parameters (matching those of `generate_virtual_sample`).</span>
</span><span id="image_vsample-1623"><a href="#image_vsample-1623"><span class="linenos">1623</span></a>
</span><span id="image_vsample-1624"><a href="#image_vsample-1624"><span class="linenos">1624</span></a><span class="sd">    Parameters</span>
</span><span id="image_vsample-1625"><a href="#image_vsample-1625"><span class="linenos">1625</span></a><span class="sd">    ----------</span>
</span><span id="image_vsample-1626"><a href="#image_vsample-1626"><span class="linenos">1626</span></a><span class="sd">    :param vsample : dict, optional</span>
</span><span id="image_vsample-1627"><a href="#image_vsample-1627"><span class="linenos">1627</span></a><span class="sd">        Dictionary specifying sample parameters. Corresponds to Experiment attribute &quot;exported_coordinate_field&quot;. If None, a new sample is generated.</span>
</span><span id="image_vsample-1628"><a href="#image_vsample-1628"><span class="linenos">1628</span></a><span class="sd">    :param modality : str, optional</span>
</span><span id="image_vsample-1629"><a href="#image_vsample-1629"><span class="linenos">1629</span></a><span class="sd">        Modality name to use for imaging. Default is &quot;STED&quot;.</span>
</span><span id="image_vsample-1630"><a href="#image_vsample-1630"><span class="linenos">1630</span></a><span class="sd">    :param multimodal : list of str, optional</span>
</span><span id="image_vsample-1631"><a href="#image_vsample-1631"><span class="linenos">1631</span></a><span class="sd">        List of modality names. If provided, overrides the `modality` parameter and adds all listed modalities.</span>
</span><span id="image_vsample-1632"><a href="#image_vsample-1632"><span class="linenos">1632</span></a><span class="sd">    :param run_simulation : bool, optional</span>
</span><span id="image_vsample-1633"><a href="#image_vsample-1633"><span class="linenos">1633</span></a><span class="sd">        If True, generates image simulation for each modality set. Default is True.</span>
</span><span id="image_vsample-1634"><a href="#image_vsample-1634"><span class="linenos">1634</span></a><span class="sd">    </span>
</span><span id="image_vsample-1635"><a href="#image_vsample-1635"><span class="linenos">1635</span></a><span class="sd">    ### Parameters for virtual sample generation (see `generate_virtual_sample` for details):</span>
</span><span id="image_vsample-1636"><a href="#image_vsample-1636"><span class="linenos">1636</span></a><span class="sd">    </span>
</span><span id="image_vsample-1637"><a href="#image_vsample-1637"><span class="linenos">1637</span></a><span class="sd">    :param structure : str, optional</span>
</span><span id="image_vsample-1638"><a href="#image_vsample-1638"><span class="linenos">1638</span></a><span class="sd">        4-letter ID of PDB/CIF model. Default is &quot;1XI5&quot;.</span>
</span><span id="image_vsample-1639"><a href="#image_vsample-1639"><span class="linenos">1639</span></a><span class="sd">    :param structure_is_path : bool, optional</span>
</span><span id="image_vsample-1640"><a href="#image_vsample-1640"><span class="linenos">1640</span></a><span class="sd">        Use structure value as absolute path for the PDB/CIF file.</span>
</span><span id="image_vsample-1641"><a href="#image_vsample-1641"><span class="linenos">1641</span></a><span class="sd">    :param probe_template : str, optional</span>
</span><span id="image_vsample-1642"><a href="#image_vsample-1642"><span class="linenos">1642</span></a><span class="sd">        Name of probe configuration file (filename). Default is &quot;NHS_ester&quot;.</span>
</span><span id="image_vsample-1643"><a href="#image_vsample-1643"><span class="linenos">1643</span></a><span class="sd">    :param probe_name : str, optional</span>
</span><span id="image_vsample-1644"><a href="#image_vsample-1644"><span class="linenos">1644</span></a><span class="sd">        Name for the probe configuration.</span>
</span><span id="image_vsample-1645"><a href="#image_vsample-1645"><span class="linenos">1645</span></a><span class="sd">    :param probe_target_type : str, optional</span>
</span><span id="image_vsample-1646"><a href="#image_vsample-1646"><span class="linenos">1646</span></a><span class="sd">        Options: &quot;Sequence&quot;, &quot;Atom_residue&quot;, or &quot;Primary&quot;.</span>
</span><span id="image_vsample-1647"><a href="#image_vsample-1647"><span class="linenos">1647</span></a><span class="sd">    :param probe_target_value : str or dict, optional</span>
</span><span id="image_vsample-1648"><a href="#image_vsample-1648"><span class="linenos">1648</span></a><span class="sd">        For target type &quot;Sequence&quot; or &quot;Primary&quot;, a string. For &quot;Atom_residue&quot;, a dictionary with keys &quot;Atom&quot; and &quot;Residue&quot;.</span>
</span><span id="image_vsample-1649"><a href="#image_vsample-1649"><span class="linenos">1649</span></a><span class="sd">    :param probe_distance_to_epitope : float, optional</span>
</span><span id="image_vsample-1650"><a href="#image_vsample-1650"><span class="linenos">1650</span></a><span class="sd">        Minimal distance set from epitope and probe paratope.</span>
</span><span id="image_vsample-1651"><a href="#image_vsample-1651"><span class="linenos">1651</span></a><span class="sd">    :param probe_model : list, optional</span>
</span><span id="image_vsample-1652"><a href="#image_vsample-1652"><span class="linenos">1652</span></a><span class="sd">        4-letter ID(s) of PDB/CIF model(s).</span>
</span><span id="image_vsample-1653"><a href="#image_vsample-1653"><span class="linenos">1653</span></a><span class="sd">    :param probe_fluorophore : str, optional</span>
</span><span id="image_vsample-1654"><a href="#image_vsample-1654"><span class="linenos">1654</span></a><span class="sd">        Fluorophore name (e.g., &quot;AF647&quot;). Default is &quot;AF647&quot;.</span>
</span><span id="image_vsample-1655"><a href="#image_vsample-1655"><span class="linenos">1655</span></a><span class="sd">    :param probe_paratope : str, optional</span>
</span><span id="image_vsample-1656"><a href="#image_vsample-1656"><span class="linenos">1656</span></a><span class="sd">        Sequence of the paratope site for when probe includes a model.</span>
</span><span id="image_vsample-1657"><a href="#image_vsample-1657"><span class="linenos">1657</span></a><span class="sd">    :param probe_conjugation_target_info : any, optional</span>
</span><span id="image_vsample-1658"><a href="#image_vsample-1658"><span class="linenos">1658</span></a><span class="sd">        Information about the probe conjugation target.</span>
</span><span id="image_vsample-1659"><a href="#image_vsample-1659"><span class="linenos">1659</span></a><span class="sd">    :param probe_DoL : float, optional</span>
</span><span id="image_vsample-1660"><a href="#image_vsample-1660"><span class="linenos">1660</span></a><span class="sd">        Efficiency of conjugation of emitters.</span>
</span><span id="image_vsample-1661"><a href="#image_vsample-1661"><span class="linenos">1661</span></a><span class="sd">    :param probe_seconday_epitope : str, optional</span>
</span><span id="image_vsample-1662"><a href="#image_vsample-1662"><span class="linenos">1662</span></a><span class="sd">        Sequence within probe model to be used as epitope for a secondary.</span>
</span><span id="image_vsample-1663"><a href="#image_vsample-1663"><span class="linenos">1663</span></a><span class="sd">    :param probe_wobble_theta : any, optional</span>
</span><span id="image_vsample-1664"><a href="#image_vsample-1664"><span class="linenos">1664</span></a><span class="sd">        Enable probe wobbling.</span>
</span><span id="image_vsample-1665"><a href="#image_vsample-1665"><span class="linenos">1665</span></a><span class="sd">    :param labelling_efficiency : float, optional</span>
</span><span id="image_vsample-1666"><a href="#image_vsample-1666"><span class="linenos">1666</span></a><span class="sd">        Labelling efficiency of probe. Default is 1.0.</span>
</span><span id="image_vsample-1667"><a href="#image_vsample-1667"><span class="linenos">1667</span></a><span class="sd">    :param structural_integrity_small_cluster : float, optional</span>
</span><span id="image_vsample-1668"><a href="#image_vsample-1668"><span class="linenos">1668</span></a><span class="sd">        In , distance used to group epitopes into multimers.</span>
</span><span id="image_vsample-1669"><a href="#image_vsample-1669"><span class="linenos">1669</span></a><span class="sd">    :param structural_integrity_large_cluster : float, optional</span>
</span><span id="image_vsample-1670"><a href="#image_vsample-1670"><span class="linenos">1670</span></a><span class="sd">        In , distance within multimers to consider neighbors.</span>
</span><span id="image_vsample-1671"><a href="#image_vsample-1671"><span class="linenos">1671</span></a><span class="sd">    :param structural_integrity : float, optional</span>
</span><span id="image_vsample-1672"><a href="#image_vsample-1672"><span class="linenos">1672</span></a><span class="sd">        Fraction of structural_integrity to model.</span>
</span><span id="image_vsample-1673"><a href="#image_vsample-1673"><span class="linenos">1673</span></a><span class="sd">    :param virtual_sample_template : str, optional</span>
</span><span id="image_vsample-1674"><a href="#image_vsample-1674"><span class="linenos">1674</span></a><span class="sd">        Name of the configuration file for template. Default is &quot;square1x1um_randomised&quot;.</span>
</span><span id="image_vsample-1675"><a href="#image_vsample-1675"><span class="linenos">1675</span></a><span class="sd">    :param sample_dimensions : list, optional</span>
</span><span id="image_vsample-1676"><a href="#image_vsample-1676"><span class="linenos">1676</span></a><span class="sd">        In nanometers, define the X, Y, and Z sizes of the field.</span>
</span><span id="image_vsample-1677"><a href="#image_vsample-1677"><span class="linenos">1677</span></a><span class="sd">    :param number_of_particles : int, optional</span>
</span><span id="image_vsample-1678"><a href="#image_vsample-1678"><span class="linenos">1678</span></a><span class="sd">        Number of independent copies of a particle to create and distribute.</span>
</span><span id="image_vsample-1679"><a href="#image_vsample-1679"><span class="linenos">1679</span></a><span class="sd">    :param particle_positions : list, optional</span>
</span><span id="image_vsample-1680"><a href="#image_vsample-1680"><span class="linenos">1680</span></a><span class="sd">        Relative positions of particles in the field.</span>
</span><span id="image_vsample-1681"><a href="#image_vsample-1681"><span class="linenos">1681</span></a><span class="sd">    :param random_orientations : bool, optional</span>
</span><span id="image_vsample-1682"><a href="#image_vsample-1682"><span class="linenos">1682</span></a><span class="sd">        If True, each particle will be randomly assigned a new orientation. Default is False.</span>
</span><span id="image_vsample-1683"><a href="#image_vsample-1683"><span class="linenos">1683</span></a><span class="sd">    :param xy_orientations, xz_orientations, yz_orientations : any, optional</span>
</span><span id="image_vsample-1684"><a href="#image_vsample-1684"><span class="linenos">1684</span></a><span class="sd">        Orientation parameters for the sample.</span>
</span><span id="image_vsample-1685"><a href="#image_vsample-1685"><span class="linenos">1685</span></a><span class="sd">    :param axial_offset : any, optional</span>
</span><span id="image_vsample-1686"><a href="#image_vsample-1686"><span class="linenos">1686</span></a><span class="sd">        Axial offset for the sample.</span>
</span><span id="image_vsample-1687"><a href="#image_vsample-1687"><span class="linenos">1687</span></a><span class="sd">    :param random_placing : bool, optional</span>
</span><span id="image_vsample-1688"><a href="#image_vsample-1688"><span class="linenos">1688</span></a><span class="sd">        Define if position in field is random or the center of field. Default is False.</span>
</span><span id="image_vsample-1689"><a href="#image_vsample-1689"><span class="linenos">1689</span></a><span class="sd">    :param random_rotations : bool, optional</span>
</span><span id="image_vsample-1690"><a href="#image_vsample-1690"><span class="linenos">1690</span></a><span class="sd">        If True, apply random rotations to particles. Default is False.</span>
</span><span id="image_vsample-1691"><a href="#image_vsample-1691"><span class="linenos">1691</span></a><span class="sd">    :param rotation_angles : any, optional</span>
</span><span id="image_vsample-1692"><a href="#image_vsample-1692"><span class="linenos">1692</span></a><span class="sd">        Rotation angles for the sample.</span>
</span><span id="image_vsample-1693"><a href="#image_vsample-1693"><span class="linenos">1693</span></a><span class="sd">    :param clear_probes : bool, optional</span>
</span><span id="image_vsample-1694"><a href="#image_vsample-1694"><span class="linenos">1694</span></a><span class="sd">        If True, default probe parameters will be cleared. Default is False.</span>
</span><span id="image_vsample-1695"><a href="#image_vsample-1695"><span class="linenos">1695</span></a><span class="sd">    :param clear_experiment : bool, optional</span>
</span><span id="image_vsample-1696"><a href="#image_vsample-1696"><span class="linenos">1696</span></a><span class="sd">        If True, clear the experiment before generating a new sample. Default is False.</span>
</span><span id="image_vsample-1697"><a href="#image_vsample-1697"><span class="linenos">1697</span></a><span class="sd">    :param primary_probe, secondary_probe : any, optional</span>
</span><span id="image_vsample-1698"><a href="#image_vsample-1698"><span class="linenos">1698</span></a><span class="sd">        Dictionaries for primary and secondary probe configuration.</span>
</span><span id="image_vsample-1699"><a href="#image_vsample-1699"><span class="linenos">1699</span></a>
</span><span id="image_vsample-1700"><a href="#image_vsample-1700"><span class="linenos">1700</span></a><span class="sd">    Returns</span>
</span><span id="image_vsample-1701"><a href="#image_vsample-1701"><span class="linenos">1701</span></a><span class="sd">    -------</span>
</span><span id="image_vsample-1702"><a href="#image_vsample-1702"><span class="linenos">1702</span></a><span class="sd">    tuple</span>
</span><span id="image_vsample-1703"><a href="#image_vsample-1703"><span class="linenos">1703</span></a><span class="sd">        - dict: Image simulations (per modality).</span>
</span><span id="image_vsample-1704"><a href="#image_vsample-1704"><span class="linenos">1704</span></a><span class="sd">        - dict: Noiseless image simulations (per modality).</span>
</span><span id="image_vsample-1705"><a href="#image_vsample-1705"><span class="linenos">1705</span></a><span class="sd">        - ExperimentParametrisation: The experiment object containing all modules and configuration.</span>
</span><span id="image_vsample-1706"><a href="#image_vsample-1706"><span class="linenos">1706</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="image_vsample-1707"><a href="#image_vsample-1707"><span class="linenos">1707</span></a>    <span class="k">if</span> <span class="n">vsample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="image_vsample-1708"><a href="#image_vsample-1708"><span class="linenos">1708</span></a>        <span class="n">vsample</span><span class="p">,</span> <span class="n">sample_experiment</span> <span class="o">=</span> <span class="n">generate_virtual_sample</span><span class="p">(</span>
</span><span id="image_vsample-1709"><a href="#image_vsample-1709"><span class="linenos">1709</span></a>            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
</span><span id="image_vsample-1710"><a href="#image_vsample-1710"><span class="linenos">1710</span></a>            <span class="n">structure_is_path</span><span class="o">=</span><span class="n">structure_is_path</span><span class="p">,</span>
</span><span id="image_vsample-1711"><a href="#image_vsample-1711"><span class="linenos">1711</span></a>            <span class="n">probe_template</span><span class="o">=</span><span class="n">probe_template</span><span class="p">,</span>
</span><span id="image_vsample-1712"><a href="#image_vsample-1712"><span class="linenos">1712</span></a>            <span class="n">probe_name</span><span class="o">=</span><span class="n">probe_name</span><span class="p">,</span>
</span><span id="image_vsample-1713"><a href="#image_vsample-1713"><span class="linenos">1713</span></a>            <span class="n">probe_target_type</span><span class="o">=</span><span class="n">probe_target_type</span><span class="p">,</span>
</span><span id="image_vsample-1714"><a href="#image_vsample-1714"><span class="linenos">1714</span></a>            <span class="n">probe_target_value</span><span class="o">=</span><span class="n">probe_target_value</span><span class="p">,</span>
</span><span id="image_vsample-1715"><a href="#image_vsample-1715"><span class="linenos">1715</span></a>            <span class="n">probe_distance_to_epitope</span><span class="o">=</span><span class="n">probe_distance_to_epitope</span><span class="p">,</span>
</span><span id="image_vsample-1716"><a href="#image_vsample-1716"><span class="linenos">1716</span></a>            <span class="n">probe_model</span><span class="o">=</span><span class="n">probe_model</span><span class="p">,</span>
</span><span id="image_vsample-1717"><a href="#image_vsample-1717"><span class="linenos">1717</span></a>            <span class="n">probe_fluorophore</span><span class="o">=</span><span class="n">probe_fluorophore</span><span class="p">,</span>
</span><span id="image_vsample-1718"><a href="#image_vsample-1718"><span class="linenos">1718</span></a>            <span class="n">probe_paratope</span><span class="o">=</span><span class="n">probe_paratope</span><span class="p">,</span>
</span><span id="image_vsample-1719"><a href="#image_vsample-1719"><span class="linenos">1719</span></a>            <span class="n">probe_conjugation_target_info</span><span class="o">=</span><span class="n">probe_conjugation_target_info</span><span class="p">,</span>
</span><span id="image_vsample-1720"><a href="#image_vsample-1720"><span class="linenos">1720</span></a>            <span class="n">probe_DoL</span><span class="o">=</span><span class="n">probe_DoL</span><span class="p">,</span>
</span><span id="image_vsample-1721"><a href="#image_vsample-1721"><span class="linenos">1721</span></a>            <span class="n">probe_seconday_epitope</span><span class="o">=</span><span class="n">probe_seconday_epitope</span><span class="p">,</span>
</span><span id="image_vsample-1722"><a href="#image_vsample-1722"><span class="linenos">1722</span></a>            <span class="n">probe_wobble_theta</span><span class="o">=</span><span class="n">probe_wobble_theta</span><span class="p">,</span>
</span><span id="image_vsample-1723"><a href="#image_vsample-1723"><span class="linenos">1723</span></a>            <span class="n">labelling_efficiency</span><span class="o">=</span><span class="n">labelling_efficiency</span><span class="p">,</span>
</span><span id="image_vsample-1724"><a href="#image_vsample-1724"><span class="linenos">1724</span></a>            <span class="n">structural_integrity_small_cluster</span><span class="o">=</span><span class="n">structural_integrity_small_cluster</span><span class="p">,</span>
</span><span id="image_vsample-1725"><a href="#image_vsample-1725"><span class="linenos">1725</span></a>            <span class="n">structural_integrity_large_cluster</span><span class="o">=</span><span class="n">structural_integrity_large_cluster</span><span class="p">,</span>
</span><span id="image_vsample-1726"><a href="#image_vsample-1726"><span class="linenos">1726</span></a>            <span class="n">structural_integrity</span><span class="o">=</span><span class="n">structural_integrity</span><span class="p">,</span>
</span><span id="image_vsample-1727"><a href="#image_vsample-1727"><span class="linenos">1727</span></a>            <span class="n">virtual_sample_template</span><span class="o">=</span><span class="n">virtual_sample_template</span><span class="p">,</span>
</span><span id="image_vsample-1728"><a href="#image_vsample-1728"><span class="linenos">1728</span></a>            <span class="n">sample_dimensions</span><span class="o">=</span><span class="n">sample_dimensions</span><span class="p">,</span>
</span><span id="image_vsample-1729"><a href="#image_vsample-1729"><span class="linenos">1729</span></a>            <span class="n">number_of_particles</span><span class="o">=</span><span class="n">number_of_particles</span><span class="p">,</span>
</span><span id="image_vsample-1730"><a href="#image_vsample-1730"><span class="linenos">1730</span></a>            <span class="n">particle_positions</span><span class="o">=</span><span class="n">particle_positions</span><span class="p">,</span>
</span><span id="image_vsample-1731"><a href="#image_vsample-1731"><span class="linenos">1731</span></a>            <span class="n">random_orientations</span><span class="o">=</span><span class="n">random_orientations</span><span class="p">,</span>
</span><span id="image_vsample-1732"><a href="#image_vsample-1732"><span class="linenos">1732</span></a>            <span class="n">xy_orientations</span><span class="o">=</span><span class="n">xy_orientations</span><span class="p">,</span>
</span><span id="image_vsample-1733"><a href="#image_vsample-1733"><span class="linenos">1733</span></a>            <span class="n">xz_orientations</span><span class="o">=</span><span class="n">xz_orientations</span><span class="p">,</span>
</span><span id="image_vsample-1734"><a href="#image_vsample-1734"><span class="linenos">1734</span></a>            <span class="n">yz_orientations</span><span class="o">=</span><span class="n">yz_orientations</span><span class="p">,</span>
</span><span id="image_vsample-1735"><a href="#image_vsample-1735"><span class="linenos">1735</span></a>            <span class="n">axial_offset</span><span class="o">=</span><span class="n">axial_offset</span><span class="p">,</span>
</span><span id="image_vsample-1736"><a href="#image_vsample-1736"><span class="linenos">1736</span></a>            <span class="n">random_placing</span><span class="o">=</span><span class="n">random_placing</span><span class="p">,</span>
</span><span id="image_vsample-1737"><a href="#image_vsample-1737"><span class="linenos">1737</span></a>            <span class="n">random_rotations</span><span class="o">=</span><span class="n">random_rotations</span><span class="p">,</span>
</span><span id="image_vsample-1738"><a href="#image_vsample-1738"><span class="linenos">1738</span></a>            <span class="n">rotation_angles</span><span class="o">=</span><span class="n">rotation_angles</span><span class="p">,</span>
</span><span id="image_vsample-1739"><a href="#image_vsample-1739"><span class="linenos">1739</span></a>            <span class="n">clear_probes</span><span class="o">=</span><span class="n">clear_probes</span><span class="p">,</span>
</span><span id="image_vsample-1740"><a href="#image_vsample-1740"><span class="linenos">1740</span></a>            <span class="n">clear_experiment</span><span class="o">=</span><span class="n">clear_experiment</span><span class="p">,</span>
</span><span id="image_vsample-1741"><a href="#image_vsample-1741"><span class="linenos">1741</span></a>            <span class="n">primary_probe</span><span class="o">=</span><span class="n">primary_probe</span><span class="p">,</span>
</span><span id="image_vsample-1742"><a href="#image_vsample-1742"><span class="linenos">1742</span></a>            <span class="n">secondary_probe</span><span class="o">=</span><span class="n">secondary_probe</span><span class="p">,</span>
</span><span id="image_vsample-1743"><a href="#image_vsample-1743"><span class="linenos">1743</span></a>            <span class="n">probe_list</span><span class="o">=</span><span class="n">probe_list</span><span class="p">,</span>
</span><span id="image_vsample-1744"><a href="#image_vsample-1744"><span class="linenos">1744</span></a>            <span class="n">expansion_factor</span><span class="o">=</span><span class="n">expansion_factor</span><span class="p">,</span>
</span><span id="image_vsample-1745"><a href="#image_vsample-1745"><span class="linenos">1745</span></a>        <span class="p">)</span>
</span><span id="image_vsample-1746"><a href="#image_vsample-1746"><span class="linenos">1746</span></a>        <span class="n">sample_experiment</span><span class="o">.</span><span class="n">clear_modalities</span><span class="p">()</span>
</span><span id="image_vsample-1747"><a href="#image_vsample-1747"><span class="linenos">1747</span></a>        <span class="k">if</span> <span class="n">multimodal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="image_vsample-1748"><a href="#image_vsample-1748"><span class="linenos">1748</span></a>            <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">multimodal</span><span class="p">:</span>
</span><span id="image_vsample-1749"><a href="#image_vsample-1749"><span class="linenos">1749</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="image_vsample-1750"><a href="#image_vsample-1750"><span class="linenos">1750</span></a>                    <span class="n">mod_template</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="s2">&quot;modality_template&quot;</span><span class="p">]</span>
</span><span id="image_vsample-1751"><a href="#image_vsample-1751"><span class="linenos">1751</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding modality: </span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">mod_template</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="image_vsample-1752"><a href="#image_vsample-1752"><span class="linenos">1752</span></a>                    <span class="n">sample_experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">modality_template</span><span class="o">=</span><span class="n">mod_template</span><span class="p">)</span>
</span><span id="image_vsample-1753"><a href="#image_vsample-1753"><span class="linenos">1753</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="image_vsample-1754"><a href="#image_vsample-1754"><span class="linenos">1754</span></a>                    <span class="n">sample_experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</span><span id="image_vsample-1755"><a href="#image_vsample-1755"><span class="linenos">1755</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="image_vsample-1756"><a href="#image_vsample-1756"><span class="linenos">1756</span></a>            <span class="n">sample_experiment</span><span class="o">.</span><span class="n">add_modality</span><span class="p">(</span><span class="n">modality</span><span class="p">)</span>
</span><span id="image_vsample-1757"><a href="#image_vsample-1757"><span class="linenos">1757</span></a>        <span class="n">sample_experiment</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
</span><span id="image_vsample-1758"><a href="#image_vsample-1758"><span class="linenos">1758</span></a>            <span class="n">modules</span><span class="o">=</span><span class="p">[</span>
</span><span id="image_vsample-1759"><a href="#image_vsample-1759"><span class="linenos">1759</span></a>                <span class="s2">&quot;imager&quot;</span><span class="p">,</span>
</span><span id="image_vsample-1760"><a href="#image_vsample-1760"><span class="linenos">1760</span></a>            <span class="p">]</span>
</span><span id="image_vsample-1761"><a href="#image_vsample-1761"><span class="linenos">1761</span></a>        <span class="p">)</span>
</span><span id="image_vsample-1762"><a href="#image_vsample-1762"><span class="linenos">1762</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">sample_experiment</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="image_vsample-1763"><a href="#image_vsample-1763"><span class="linenos">1763</span></a>            <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="image_vsample-1764"><a href="#image_vsample-1764"><span class="linenos">1764</span></a>                <span class="n">sample_experiment</span><span class="o">.</span><span class="n">update_modality</span><span class="p">(</span>
</span><span id="image_vsample-1765"><a href="#image_vsample-1765"><span class="linenos">1765</span></a>                    <span class="n">modality_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="image_vsample-1766"><a href="#image_vsample-1766"><span class="linenos">1766</span></a>                <span class="p">)</span>
</span><span id="image_vsample-1767"><a href="#image_vsample-1767"><span class="linenos">1767</span></a>                <span class="n">sample_experiment</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span>
</span><span id="image_vsample-1768"><a href="#image_vsample-1768"><span class="linenos">1768</span></a>                    <span class="n">modality_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="image_vsample-1769"><a href="#image_vsample-1769"><span class="linenos">1769</span></a>                <span class="p">)</span>
</span><span id="image_vsample-1770"><a href="#image_vsample-1770"><span class="linenos">1770</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="image_vsample-1771"><a href="#image_vsample-1771"><span class="linenos">1771</span></a>        <span class="c1"># need to create an experiment for it</span>
</span><span id="image_vsample-1772"><a href="#image_vsample-1772"><span class="linenos">1772</span></a>        <span class="k">if</span> <span class="n">multimodal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="image_vsample-1773"><a href="#image_vsample-1773"><span class="linenos">1773</span></a>            <span class="n">vmicroscope</span><span class="p">,</span> <span class="n">sample_experiment</span> <span class="o">=</span> <span class="n">build_virtual_microscope</span><span class="p">(</span>
</span><span id="image_vsample-1774"><a href="#image_vsample-1774"><span class="linenos">1774</span></a>                <span class="n">multimodal</span><span class="o">=</span><span class="n">multimodal</span><span class="p">,</span> <span class="n">use_local_field</span><span class="o">=</span><span class="kc">True</span>
</span><span id="image_vsample-1775"><a href="#image_vsample-1775"><span class="linenos">1775</span></a>            <span class="p">)</span>
</span><span id="image_vsample-1776"><a href="#image_vsample-1776"><span class="linenos">1776</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="image_vsample-1777"><a href="#image_vsample-1777"><span class="linenos">1777</span></a>            <span class="n">vmicroscope</span><span class="p">,</span> <span class="n">sample_experiment</span> <span class="o">=</span> <span class="n">build_virtual_microscope</span><span class="p">(</span>
</span><span id="image_vsample-1778"><a href="#image_vsample-1778"><span class="linenos">1778</span></a>                <span class="n">modality</span><span class="o">=</span><span class="n">modality</span><span class="p">,</span> <span class="n">use_local_field</span><span class="o">=</span><span class="kc">True</span>
</span><span id="image_vsample-1779"><a href="#image_vsample-1779"><span class="linenos">1779</span></a>            <span class="p">)</span>
</span><span id="image_vsample-1780"><a href="#image_vsample-1780"><span class="linenos">1780</span></a>        <span class="k">for</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">sample_experiment</span><span class="o">.</span><span class="n">imaging_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="image_vsample-1781"><a href="#image_vsample-1781"><span class="linenos">1781</span></a>            <span class="k">if</span> <span class="n">modality_name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="image_vsample-1782"><a href="#image_vsample-1782"><span class="linenos">1782</span></a>                <span class="n">sample_experiment</span><span class="o">.</span><span class="n">update_modality</span><span class="p">(</span>
</span><span id="image_vsample-1783"><a href="#image_vsample-1783"><span class="linenos">1783</span></a>                    <span class="n">modality_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="image_vsample-1784"><a href="#image_vsample-1784"><span class="linenos">1784</span></a>                <span class="p">)</span>
</span><span id="image_vsample-1785"><a href="#image_vsample-1785"><span class="linenos">1785</span></a>                <span class="n">sample_experiment</span><span class="o">.</span><span class="n">set_modality_acq</span><span class="p">(</span>
</span><span id="image_vsample-1786"><a href="#image_vsample-1786"><span class="linenos">1786</span></a>                    <span class="n">modality_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span>
</span><span id="image_vsample-1787"><a href="#image_vsample-1787"><span class="linenos">1787</span></a>                <span class="p">)</span>
</span><span id="image_vsample-1788"><a href="#image_vsample-1788"><span class="linenos">1788</span></a>        <span class="n">sample_experiment</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">import_field</span><span class="p">(</span><span class="o">**</span><span class="n">vsample</span><span class="p">)</span>
</span><span id="image_vsample-1789"><a href="#image_vsample-1789"><span class="linenos">1789</span></a>    <span class="n">imaging_output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="image_vsample-1790"><a href="#image_vsample-1790"><span class="linenos">1790</span></a>    <span class="n">imaging_output_noiseless</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="image_vsample-1791"><a href="#image_vsample-1791"><span class="linenos">1791</span></a>    <span class="k">if</span> <span class="n">run_simulation</span><span class="p">:</span>
</span><span id="image_vsample-1792"><a href="#image_vsample-1792"><span class="linenos">1792</span></a>        <span class="n">imaging_output</span><span class="p">,</span> <span class="n">imaging_output_noiseless</span> <span class="o">=</span> <span class="n">sample_experiment</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
</span><span id="image_vsample-1793"><a href="#image_vsample-1793"><span class="linenos">1793</span></a>    <span class="k">return</span> <span class="n">imaging_output</span><span class="p">,</span> <span class="n">imaging_output_noiseless</span><span class="p">,</span> <span class="n">sample_experiment</span>
</span></pre></div>


            <div class="docstring"><p>Generate imaging simulations of the specified virtual sample and imaging modalities.</p>

<p>This function can either:</p>

<ol>
<li>Take an existing virtual sample (as a dictionary) and wrap it in a new experiment, adding the specified imaging modalities.</li>
<li>Or, generate a new virtual sample and experiment from scratch using the provided parameters (matching those of <code><a href="#generate_virtual_sample">generate_virtual_sample</a></code>).</li>
</ol>

<h2 id="parameters">Parameters</h2>

<h6 id="parameters-2">Parameters</h6>

<ul>
<li><strong>vsample</strong>:  dict, optional
Dictionary specifying sample parameters. Corresponds to Experiment attribute "exported_coordinate_field". If None, a new sample is generated.</li>
<li><strong>modality</strong>:  str, optional
Modality name to use for imaging. Default is "STED".</li>
<li><strong>multimodal</strong>:  list of str, optional
List of modality names. If provided, overrides the <code>modality</code> parameter and adds all listed modalities.</li>
<li><strong>run_simulation</strong>:  bool, optional
If True, generates image simulation for each modality set. Default is True.</li>
</ul>

<h3 id="parameters-for-virtual-sample-generation-see-generate_virtual_sample-for-details">Parameters for virtual sample generation (see <code><a href="#generate_virtual_sample">generate_virtual_sample</a></code> for details):</h3>

<ul>
<li><strong>structure</strong>:  str, optional
4-letter ID of PDB/CIF model. Default is "1XI5".</li>
<li><strong>structure_is_path</strong>:  bool, optional
Use structure value as absolute path for the PDB/CIF file.</li>
<li><strong>probe_template</strong>:  str, optional
Name of probe configuration file (filename). Default is "NHS_ester".</li>
<li><strong>probe_name</strong>:  str, optional
Name for the probe configuration.</li>
<li><strong>probe_target_type</strong>:  str, optional
Options: "Sequence", "Atom_residue", or "Primary".</li>
<li><strong>probe_target_value</strong>:  str or dict, optional
For target type "Sequence" or "Primary", a string. For "Atom_residue", a dictionary with keys "Atom" and "Residue".</li>
<li><strong>probe_distance_to_epitope</strong>:  float, optional
Minimal distance set from epitope and probe paratope.</li>
<li><strong>probe_model</strong>:  list, optional
4-letter ID(s) of PDB/CIF model(s).</li>
<li><strong>probe_fluorophore</strong>:  str, optional
Fluorophore name (e.g., "AF647"). Default is "AF647".</li>
<li><strong>probe_paratope</strong>:  str, optional
Sequence of the paratope site for when probe includes a model.</li>
<li><strong>probe_conjugation_target_info</strong>:  any, optional
Information about the probe conjugation target.</li>
<li><strong>probe_DoL</strong>:  float, optional
Efficiency of conjugation of emitters.</li>
<li><strong>probe_seconday_epitope</strong>:  str, optional
Sequence within probe model to be used as epitope for a secondary.</li>
<li><strong>probe_wobble_theta</strong>:  any, optional
Enable probe wobbling.</li>
<li><strong>labelling_efficiency</strong>:  float, optional
Labelling efficiency of probe. Default is 1.0.</li>
<li><strong>structural_integrity_small_cluster</strong>:  float, optional
In , distance used to group epitopes into multimers.</li>
<li><strong>structural_integrity_large_cluster</strong>:  float, optional
In , distance within multimers to consider neighbors.</li>
<li><strong>structural_integrity</strong>:  float, optional
Fraction of structural_integrity to model.</li>
<li><strong>virtual_sample_template</strong>:  str, optional
Name of the configuration file for template. Default is "square1x1um_randomised".</li>
<li><strong>sample_dimensions</strong>:  list, optional
In nanometers, define the X, Y, and Z sizes of the field.</li>
<li><strong>number_of_particles</strong>:  int, optional
Number of independent copies of a particle to create and distribute.</li>
<li><strong>particle_positions</strong>:  list, optional
Relative positions of particles in the field.</li>
<li><strong>random_orientations</strong>:  bool, optional
If True, each particle will be randomly assigned a new orientation. Default is False.</li>
<li><strong>xy_orientations, xz_orientations, yz_orientations</strong>:  any, optional
Orientation parameters for the sample.</li>
<li><strong>axial_offset</strong>:  any, optional
Axial offset for the sample.</li>
<li><strong>random_placing</strong>:  bool, optional
Define if position in field is random or the center of field. Default is False.</li>
<li><strong>random_rotations</strong>:  bool, optional
If True, apply random rotations to particles. Default is False.</li>
<li><strong>rotation_angles</strong>:  any, optional
Rotation angles for the sample.</li>
<li><strong>clear_probes</strong>:  bool, optional
If True, default probe parameters will be cleared. Default is False.</li>
<li><strong>clear_experiment</strong>:  bool, optional
If True, clear the experiment before generating a new sample. Default is False.</li>
<li><strong>primary_probe, secondary_probe</strong>:  any, optional
Dictionaries for primary and secondary probe configuration.</li>
</ul>

<h2 id="returns">Returns</h2>

<p>tuple
    - dict: Image simulations (per modality).
    - dict: Noiseless image simulations (per modality).
    - ExperimentParametrisation: The experiment object containing all modules and configuration.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>